//>>built
define("dojox/rpc/OfflineRest",["dojo","dojox","dojox/data/ClientFilter","dojox/rpc/Rest","dojox/storage"],function(g,d){function l(a){return a.replace(/[^0-9A-Za-z_]/g,"_")}function n(a,c){m&&!q&&(c||a&&a.__id)&&d.storage.put(l(c||a.__id),"object"==typeof a?d.json.ref.toJson(a):a,function(){},"dojox_rpc_OfflineRest")}function t(a){return a instanceof Error&&(503==a.status||12E3<a.status||!a.status)}function u(){if(m){var a=d.storage.get("dirty","dojox_rpc_OfflineRest");if(a)for(var c in a)v(c,a)}}
function r(){f.sendChanges();f.downloadChanges()}function w(a,c,b,e,h){"delete"==a?d.storage.remove(l(c),"dojox_rpc_OfflineRest"):d.storage.put(l(b),e,function(){},"dojox_rpc_OfflineRest");if(a=h&&h._store)a.updateResultSet(a._localBaseResults,a._localBaseFetch),d.storage.put(l(h._getRequest(a._localBaseFetch.query).url),d.json.ref.toJson(a._localBaseResults),function(){},"dojox_rpc_OfflineRest")}function v(a,c){var b=c[a],e=d.rpc.JsonRest.getServiceAndId(b.id),e=x(b.method,e.service,e.id,b.content);
c[a]=b;d.storage.put("dirty",c,function(){},"dojox_rpc_OfflineRest");e.addBoth(function(c){if(t(c))return null;var b=d.storage.get("dirty","dojox_rpc_OfflineRest")||{};delete b[a];d.storage.put("dirty",b,function(){},"dojox_rpc_OfflineRest");return c});return e}var k=d.rpc.Rest,m,p=k._index;d.storage.manager.addOnLoad(function(){m=d.storage.manager.available;for(var a in p)n(p[a],a)});var q,f,z=setInterval(r,15E3);g.connect(document,"ononline",r);f=d.rpc.OfflineRest={turnOffAutoSync:function(){clearInterval(z)},
sync:r,sendChanges:u,downloadChanges:function(){},addStore:function(a,c){f.stores.push(a);a.fetch({queryOptions:{cache:!0},query:c,onComplete:function(c,d){a._localBaseResults=c;a._localBaseFetch=d}})}};f.stores=[];var A=k._get;k._get=function(a,c){try{u();if(window.navigator&&!1===navigator.onLine)throw Error();var b=A(a,c)}catch(e){b=new g.Deferred,b.errback(e)}var h=d.rpc._sync;b.addCallback(function(d){n(d,a._getRequest(c).url);return d});b.addErrback(function(e){if(m){if(t(e)){var y={},f=function(a,
c){if(y[a])return c;var b=g.fromJson(d.storage.get(l(a),"dojox_rpc_OfflineRest"))||c;y[a]=b;for(var e in b){var h=b[e];if(a=h&&h.$ref)a.substring&&"cid:"==a.substring(0,4)&&(a=a.substring(4)),b[e]=f(a,h)}if(b instanceof Array)for(e=0;e<b.length;e++)void 0===b[e]&&b.splice(e--,1);return b};q=!0;var k=f(a._getRequest(c).url);if(!k)return e;q=!1;return k}return e}if(h)return Error("Storage manager not loaded, can not continue");b=new g.Deferred;b.addCallback(arguments.callee);d.storage.manager.addOnLoad(function(){b.callback()});
return b});return b};g.addOnLoad(function(){g.connect(d.data,"restListener",function(a){var c=a.channel,b=a.event.toLowerCase(),e=d.rpc.JsonRest&&d.rpc.JsonRest.getServiceAndId(c).service;w(b,c,"post"==b?c+a.result.id:c,g.toJson(a.result),e)})});var x=k._change;k._change=function(a,c,b,e){if(!m)return x.apply(this,arguments);var h=c._getRequest(b).url;w(a,h,d.rpc.JsonRest._contentId,e,c);var g=d.storage.get("dirty","dojox_rpc_OfflineRest")||{};if("put"==a||"delete"==a)var f=h;else{var f=0,k;for(k in g)isNaN(parseInt(k))||
(f=k);f++}g[f]={method:a,id:h,content:e};return v(f,g)};g.connect(p,"onLoad",n);g.connect(p,"onUpdate",n);return f});