//>>built
define("esri/IdentityManagerBase","dojo/_base/declare dojo/_base/config dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/_base/json dojo/_base/url dojo/sniff dojo/cookie dojo/io-query dojo/regexp ./kernel ./config ./lang ./ServerInfo ./urlUtils ./deferredUtils ./request ./Evented ./OAuthCredential ./arcgis/OAuthInfo".split(" "),function(J,w,q,h,K,A,x,B,L,Q,R,k,C,v,D,t,M,E,N,O,S){var u,z={},F=function(a){var b=(new x(a.owningSystemUrl)).host;a=(new x(a.server)).host;var c=/.+\.arcgis\.com$/i;
return c.test(b)&&c.test(a)},G=function(a,b){return!!(F(a)&&b&&h.some(b,function(b){return b.test(a.server)}))},I=J(N,{declaredClass:"esri.IdentityManagerBase",constructor:function(){this._portalConfig=q.getObject("esriGeowConfig");this.serverInfos=[];this.oAuthInfos=[];this.credentials=[];this._soReqs=[];this._xoReqs=[];this._portals=[];this._getOAuthHash()},defaultTokenValidity:60,tokenValidity:null,signInPage:null,useSignInPage:!0,normalizeWebTierAuth:!1,_busy:null,_oAuthHash:null,_gwTokenUrl:"/sharing/generateToken",
_agsRest:"/rest/services",_agsPortal:/\/sharing(\/|$)/i,_agsAdmin:/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i,_adminSvcs:/\/admin\/services(\/|$)/i,_agolSuffix:".arcgis.com",_gwDomains:[{regex:/https?:\/\/www\.arcgis\.com/i,tokenServiceUrl:"https://www.arcgis.com/sharing/generateToken"},{regex:/https?:\/\/dev\.arcgis\.com/i,tokenServiceUrl:"https://dev.arcgis.com/sharing/generateToken"},{regex:/https?:\/\/.*dev[^.]*\.arcgis\.com/i,tokenServiceUrl:"https://devext.arcgis.com/sharing/generateToken"},
{regex:/https?:\/\/.*qa[^.]*\.arcgis\.com/i,tokenServiceUrl:"https://qaext.arcgis.com/sharing/generateToken"},{regex:/https?:\/\/.*.arcgis\.com/i,tokenServiceUrl:"https://www.arcgis.com/sharing/generateToken"}],_legacyFed:[],_regexSDirUrl:/http.+\/rest\/services\/?/gi,_regexServerType:/(\/(MapServer|GeocodeServer|GPServer|GeometryServer|ImageServer|NAServer|FeatureServer|GeoDataServer|GlobeServer|MobileServer|GeoenrichmentServer|VectorTileServer)).*/gi,_gwUser:/http.+\/users\/([^\/]+)\/?.*/i,_gwItem:/http.+\/items\/([^\/]+)\/?.*/i,
_gwGroup:/http.+\/groups\/([^\/]+)\/?.*/i,_errorCodes:[499,498,403,401],_rePortalTokenSvc:/\/sharing(\/rest)?\/generatetoken/i,_publicUrls:[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],registerServers:function(a){var b=this.serverInfos;b?(a=h.filter(a,function(a){return!this.findServerInfo(a.server)},this),this.serverInfos=b.concat(a)):this.serverInfos=a;h.forEach(a,function(a){if(a.owningSystemUrl&&this._portals.push(a.owningSystemUrl),a.hasPortal){this._portals.push(a.server);
var b=C.defaults.io.corsEnabledServers,e=this._getOrigin(a.tokenServiceUrl);t.canUseXhr(a.server)||b.push(a.server.replace(/^https?:\/\//i,""));t.canUseXhr(e)||b.push(e.replace(/^https?:\/\//i,""))}},this)},registerOAuthInfos:function(a){var b=this.oAuthInfos;b?(a=h.filter(a,function(a){return!this.findOAuthInfo(a.portalUrl)},this),this.oAuthInfos=b.concat(a)):this.oAuthInfos=a},registerToken:function(a){var b,c=this._sanitizeUrl(a.server),d=this.findServerInfo(c),e=!0;d||(d=new D,d.server=this._getServerInstanceRoot(c),
d.tokenServiceUrl=this._getTokenSvcUrl(c),d.hasPortal=!0,this.registerServers([d]));(b=this.findCredential(c,a.userId))?(q.mixin(b,a),e=!1):(b=new u({userId:a.userId,server:d.server,token:a.token,expires:a.expires,ssl:a.ssl,scope:this._isServerRsrc(c)?"server":"portal"}),b.resources=[c],this.credentials.push(b));b.onTokenChange(!1);e||b.refreshServerTokens()},toJson:function(){return v.fixJson({serverInfos:h.map(this.serverInfos,function(a){return a.toJson()}),oAuthInfos:h.map(this.oAuthInfos,function(a){return a.toJson()}),
credentials:h.map(this.credentials,function(a){return a.toJson()})})},initialize:function(a){if(a){q.isString(a)&&(a=A.fromJson(a));var b=a.serverInfos,c=a.oAuthInfos;a=a.credentials;if(b){var d=[];h.forEach(b,function(a){a.server&&a.tokenServiceUrl&&d.push(a.declaredClass?a:new D(a))});d.length&&this.registerServers(d)}if(c){var e=[];h.forEach(c,function(a){a.appId&&e.push(a.declaredClass?a:new S(a))});e.length&&this.registerOAuthInfos(e)}a&&h.forEach(a,function(a){a.userId&&a.server&&a.token&&a.expires&&
a.expires>(new Date).getTime()&&(a=a.declaredClass?a:new u(a),a.onTokenChange(),this.credentials.push(a))},this)}},findServerInfo:function(a){var b;return a=this._sanitizeUrl(a),h.some(this.serverInfos,function(c){return this._hasSameServerInstance(c.server,a)&&(b=c),!!b},this),b},findOAuthInfo:function(a){var b;return a=this._sanitizeUrl(a),h.some(this.oAuthInfos,function(c){return this._hasSameServerInstance(c.portalUrl,a)&&(b=c),!!b},this),b},findCredential:function(a,b){var c,d;return a=this._sanitizeUrl(a),
d=this._isServerRsrc(a)?"server":"portal",b?h.some(this.credentials,function(e){return this._hasSameServerInstance(e.server,a)&&b===e.userId&&e.scope===d&&(c=e),!!c},this):h.some(this.credentials,function(b){return this._hasSameServerInstance(b.server,a)&&-1!==this._getIdenticalSvcIdx(a,b)&&b.scope===d&&(c=b),!!c},this),c},getCredential:function(a,b){var c,d,e=!0;v.isDefined(b)&&(q.isObject(b)?(c=!!b.token,d=b.error,e=!1!==b.prompt):c=b);a=this._sanitizeUrl(a);var f,g=new K(M._dfdCanceller),h=this._isAdminResource(a),
n=c&&this._doPortalSignIn(a)?this._getEsriAuthCookie():null;c=c?this.findCredential(a):null;if(n||c)return f=Error("You are currently signed in as: '"+(n&&n.email||c&&c.userId)+"'. You do not have access to this resource: "+a),f.code="IdentityManagerBase.1",f.httpCode=d&&d.httpCode,f.messageCode=d?d.messageCode:null,f.subcode=d?d.subcode:null,f.details=d?d.details:null,f.log=w.isDebug,g.errback(f),g;if(d=this._findCredential(a,b))return g.callback(d),g;if(d=this.findServerInfo(a))!d.hasServer&&this._isServerRsrc(a)&&
(d._restInfoDfd=this._getTokenSvcUrl(a,!0),d.hasServer=!0);else{n=this._getTokenSvcUrl(a);if(!n)return f=Error("Unknown resource - could not find token service endpoint."),f.code="IdentityManagerBase.2",f.log=w.isDebug,g.errback(f),g;d=new D;d.server=this._getServerInstanceRoot(a);q.isString(n)?(d.tokenServiceUrl=n,e&&!this._findOAuthInfo(a)&&(d._selfDfd=this._getPortalSelf(n.replace(this._rePortalTokenSvc,"/sharing/rest/portals/self"),a)),d.hasPortal=!0):(d._restInfoDfd=n,d.hasServer=!0);this.registerServers([d])}return this._enqueue(a,
d,b,g,h)},getResourceName:function(a){return this._isRESTService(a)?a.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"":this._gwUser.test(a)&&a.replace(this._gwUser,"$1")||this._gwItem.test(a)&&a.replace(this._gwItem,"$1")||this._gwGroup.test(a)&&a.replace(this._gwGroup,"$1")||""},generateToken:function(a,b,c){var d,e,f,g,h,n,r,l,p=this._rePortalTokenSvc.test(a.tokenServiceUrl),y=new x(window.location.href.toLowerCase()),P=this._getEsriAuthCookie(),H=!b,m=a.shortLivedTokenValidity;
b&&(l=k.id.tokenValidity||m||k.id.defaultTokenValidity,l>m&&(l=m));c&&(d=c.isAdmin,e=c.serverUrl,f=c.token,n=c.ssl,a.customParameters=c.customParameters);d?g=a.adminTokenServiceUrl:(g=a.tokenServiceUrl,h=new x(g.toLowerCase()),P&&(r=P.auth_tier,r=r&&r.toLowerCase()),("web"===r||a.webTierAuth)&&c&&c.serverUrl&&!n&&"http"===y.scheme&&(t.hasSameOrigin(y.uri,g,!0)||"https"===h.scheme&&y.host===h.host&&"7080"===y.port&&"7443"===h.port)&&(g=g.replace(/^https:/i,"http:").replace(/:7443/i,":7080")),H&&p&&
(g=g.replace(/\/rest/i,"")));d=q.mixin({url:g,content:q.mixin({request:"getToken",username:b&&b.username,password:b&&b.password,serverUrl:e,token:f,expiration:l,referer:d||p?window.location.host:null,client:d?"referer":null,f:"json"},a.customParameters),handleAs:"json",callbackParamName:H?"callback":void 0},c&&c.ioArgs);c={usePost:!H,disableIdentityLookup:!0,useProxy:this._useProxy(a,c)};p||(d.withCredentials=!1);p=E(d,c);return p.addCallback(function(c){if(!c||!c.token)return c=Error("Unable to generate token"),
c.code="IdentityManagerBase.3",c.log=w.isDebug,c;var d=a.server;return z[d]||(z[d]={}),b&&(z[d][b.username]=b.password),c.validity=l,c}),p.addErrback(function(){}),p},isBusy:function(){return!!this._busy},checkSignInStatus:function(a){return this.getCredential(a,{prompt:!1})},setRedirectionHandler:function(a){this._redirectFunc=a},setProtocolErrorHandler:function(a){this._protocolFunc=a},signIn:function(){},oAuthSignIn:function(){},onCredentialCreate:function(){},onCredentialsDestroy:function(){},
destroyCredentials:function(){if(this.credentials){var a=this.credentials.slice();h.forEach(a,function(a){a.destroy()})}this.onCredentialsDestroy()},_getOAuthHash:function(){var a=window.location.hash;if(a){"#"===a.charAt(0)&&(a=a.substring(1));var a=Q.queryToObject(a),b=!1;a.access_token&&a.expires_in&&a.state&&a.hasOwnProperty("username")?(a.state=A.fromJson(a.state),this._oAuthHash=a,b=!0):a.error&&a.error_description&&(console.log("IdentityManager OAuth Error: ",a.error," - ",a.error_description),
"access_denied"===a.error&&(b=!0));b&&(!B("ie")||8<B("ie"))&&(window.location.hash="")}},_findCredential:function(a,b){var c,d,e,f,g=-1,k=b&&b.token,n=b&&b.resource,r=this._isServerRsrc(a)?"server":"portal",l=h.filter(this.credentials,function(b){return this._hasSameServerInstance(b.server,a)&&b.scope===r},this);if(a=n||a,l.length)if(1===l.length){if(c=l[0],f=this.findServerInfo(c.server),d=f&&f.owningSystemUrl,e=d&&this.findCredential(d,c.userId),g=this._getIdenticalSvcIdx(a,c),!k)return-1===g&&
c.resources.push(a),this._addResource(a,e),c;-1!==g&&(c.resources.splice(g,1),this._removeResource(a,e))}else{var p,y;if(h.some(l,function(b){return y=this._getIdenticalSvcIdx(a,b),-1!==y?(p=b,f=this.findServerInfo(p.server),d=f&&f.owningSystemUrl,e=d&&this.findCredential(d,p.userId),g=y,!0):!1},this),k)p&&(p.resources.splice(g,1),this._removeResource(a,e));else if(p)return this._addResource(a,e),p}},_findOAuthInfo:function(a){var b=this.findOAuthInfo(a);return b||h.some(this.oAuthInfos,function(c){return this._isIdProvider(c.portalUrl,
a)&&(b=c),!!b},this),b},_addResource:function(a,b){b&&-1===this._getIdenticalSvcIdx(a,b)&&b.resources.push(a)},_removeResource:function(a,b){var c=-1;b&&(c=this._getIdenticalSvcIdx(a,b),-1<c&&b.resources.splice(c,1))},_useProxy:function(a,b){return b&&b.isAdmin&&!t.hasSameOrigin(a.adminTokenServiceUrl,window.location.href)||!this._isPortalDomain(a.tokenServiceUrl)&&10.1==a.currentVersion&&!t.hasSameOrigin(a.tokenServiceUrl,window.location.href)},_getOrigin:function(a){a=new x(a);return a.scheme+"://"+
a.host+(v.isDefined(a.port)?":"+a.port:"")},_getServerInstanceRoot:function(a){var b=a.toLowerCase(),c=b.indexOf(this._agsRest);return-1===c&&this._isAdminResource(a)&&(c=b.indexOf("/admin")),-1===c&&(c=b.indexOf("/sharing")),-1===c&&"/"===b.substr(-1)&&(c=b.length-1),-1<c?a.substring(0,c):a},_hasSameServerInstance:function(a,b){return a=a.toLowerCase(),b=this._getServerInstanceRoot(b).toLowerCase(),a=a.substr(a.indexOf(":")),b=b.substr(b.indexOf(":")),a===b},_sanitizeUrl:function(a){a=t.fixUrl(q.trim(a));
var b=(C.defaults.io.proxyUrl||"").toLowerCase(),c=b?a.toLowerCase().indexOf(b+"?"):-1;return-1!==c&&(a=a.substring(c+b.length+1)),t.urlToObject(a).path},_isRESTService:function(a){return-1<a.indexOf(this._agsRest)},_isAdminResource:function(a){return this._agsAdmin.test(a)||this._adminSvcs.test(a)},_isServerRsrc:function(a){return this._isRESTService(a)||this._isAdminResource(a)},_isIdenticalService:function(a,b){var c;if(this._isRESTService(a)&&this._isRESTService(b)){var d=this._getSuffix(a).toLowerCase(),
e=this._getSuffix(b).toLowerCase();(c=d===e,c)||(c=/(.*)\/(MapServer|FeatureServer).*/gi,c=d.replace(c,"$1")===e.replace(c,"$1"))}else this._isAdminResource(a)&&this._isAdminResource(b)?c=!0:this._isServerRsrc(a)||this._isServerRsrc(b)||!this._isPortalDomain(a)||(c=!0);return c},_isPortalDomain:function(a){a=a.toLowerCase();var b=(new x(a)).authority,c=this._portalConfig,d=-1!==b.indexOf(this._agolSuffix);(!d&&c&&(d=this._hasSameServerInstance(this._getServerInstanceRoot(c.restBaseUrl),a)),d)||(this._arcgisUrl||
(c=q.getObject("esri.arcgis.utils.arcgisUrl"))&&(this._arcgisUrl=(new x(c)).authority),this._arcgisUrl&&(d=this._arcgisUrl.toLowerCase()===b));return d||(d=h.some(this._portals,function(b){return this._hasSameServerInstance(b,a)},this)),d=d||this._agsPortal.test(a)},_isIdProvider:function(a,b){var c=-1,d=-1;h.forEach(this._gwDomains,function(e,f){-1===c&&e.regex.test(a)&&(c=f);-1===d&&e.regex.test(b)&&(d=f)});var e=!1;if(-1<c&&-1<d&&(0===c||4===c?(0===d||4===d)&&(e=!0):1===c?(1===d||2===d)&&(e=!0):
2===c?2===d&&(e=!0):3===c&&3===d&&(e=!0)),!e){var f=this.findServerInfo(b),g=f&&f.owningSystemUrl;g&&F(f)&&this._isPortalDomain(g)&&this._isIdProvider(a,g)&&(e=!0)}return e},_isPublic:function(a){return a=this._sanitizeUrl(a),h.some(this._publicUrls,function(b){return b.test(a)})},_getIdenticalSvcIdx:function(a,b){var c=-1;return h.some(b.resources,function(b,e){return this._isIdenticalService(a,b)?(c=e,!0):!1},this),c},_getSuffix:function(a){return a.replace(this._regexSDirUrl,"").replace(this._regexServerType,
"$1")},_getTokenSvcUrl:function(a){var b,c,d,e=this._isRESTService(a);if(e||this._isAdminResource(a))return d=a.toLowerCase().indexOf(e?this._agsRest:"/admin/"),b=a.substring(0,d)+"/admin/generateToken",a=a.substring(0,d)+"/rest/info",c=E({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),c.adminUrl_=b,c;if(this._isPortalDomain(a)){var f="";if(h.some(this._gwDomains,function(b){return b.regex.test(a)&&(f=b.tokenServiceUrl),!!f}),f||h.some(this._portals,function(b){return this._hasSameServerInstance(b,
a)&&(f=b+this._gwTokenUrl),!!f},this),f||(d=a.toLowerCase().indexOf("/sharing"),-1!==d&&(f=a.substring(0,d)+this._gwTokenUrl)),f||(f=this._getOrigin(a)+this._gwTokenUrl),f)b=(new x(a)).port,/^http:\/\//i.test(a)&&"7080"===b&&(f=f.replace(/:7080/i,":7443")),f=f.replace(/http:/i,"https:");return f}return-1!==a.toLowerCase().indexOf("premium.arcgisonline.com")?"https://premium.arcgisonline.com/server/tokens":void 0},_getPortalSelf:function(a,b){return"https:"===window.location.protocol?a=a.replace(/^http:/i,
"https:").replace(/:7080/i,":7443"):/^http:/i.test(b)&&(a=a.replace(/^https:/i,"http:").replace(/:7443/i,":7080")),E({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"},{crossOrigin:!1,disableIdentityLookup:!0})},_hasPortalSession:function(){return!!this._getEsriAuthCookie()},_getEsriAuthCookie:function(){var a;if(L.isSupported()){var b,c=this._getAllCookies("esri_auth");for(b=0;b<c.length;b++){var d=A.fromJson(c[b]);if(d.portalApp){a=d;break}}}return a},_getAllCookies:function(a){var b=
[],c=document.cookie.match(new RegExp("(?:^|; )"+R.escapeString(a)+"\x3d([^;]*)","g"));if(c)for(a=0;a<c.length;a++){var d=c[a],e=d.indexOf("\x3d");-1<e&&(d=d.substring(e+1),b.push(decodeURIComponent(d)))}return b},_doPortalSignIn:function(a){if(L.isSupported()){var b=this._getEsriAuthCookie(),c=this._portalConfig,d=window.location.href,e=this.findServerInfo(a);if(this.useSignInPage&&(c||this._isPortalDomain(d)||b)&&(e?e.hasPortal||e.owningSystemUrl&&this._isPortalDomain(e.owningSystemUrl):this._isPortalDomain(a))&&
(this._isIdProvider(d,a)||c&&(this._hasSameServerInstance(this._getServerInstanceRoot(c.restBaseUrl),a)||this._isIdProvider(c.restBaseUrl,a))||t.hasSameOrigin(d,a,!0)))return!0}return!1},_checkProtocol:function(a,b,c,d){var e=!0;d=d?b.adminTokenServiceUrl:b.tokenServiceUrl;0!==q.trim(d).toLowerCase().indexOf("https:")||0===window.location.href.toLowerCase().indexOf("https:")||C.defaults.io.useCors&&(t.canUseXhr(d)||t.canUseXhr(t.getProxyUrl(!0).path))||(e=this._protocolFunc?!!this._protocolFunc({resourceUrl:a,
serverInfo:b}):!1)||(a=Error("Aborted the Sign-In process to avoid sending password over insecure connection."),a.code="IdentityManagerBase.4",a.log=w.isDebug,console.log(a.message),c(a));return e},_enqueue:function(a,b,c,d,e,f){return d||(d=new K(M._dfdCanceller)),d.resUrl_=a,d.sinfo_=b,d.options_=c,d.admin_=e,d.refresh_=f,this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(a),this._busy.resUrl_)?(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),this._soReqs.push(d)):
this._xoReqs.push(d):this._doSignIn(d),d},_doSignIn:function(a){this._busy=a;var b=this,c=function(c){var d=a.options_&&a.options_.resource,e=a.resUrl_,f=a.refresh_,g=!1;-1===h.indexOf(b.credentials,c)&&(f&&-1!==h.indexOf(b.credentials,f)?(f.userId=c.userId,f.token=c.token,f.expires=c.expires,f.validity=c.validity,f.ssl=c.ssl,f.creationTime=c.creationTime,g=!0,c=f):b.credentials.push(c));c.resources||(c.resources=[]);c.resources.push(d||e);c.scope=b._isServerRsrc(e)?"server":"portal";c.onTokenChange();
var d=b._soReqs,m={};b._soReqs=[];h.forEach(d,function(a){if(!this._isIdenticalService(e,a.resUrl_)){var b=this._getSuffix(a.resUrl_);m[b]||(m[b]=!0,c.resources.push(a.resUrl_))}},b);a.callback(c);h.forEach(d,function(a){a.callback(c)});b._busy=a.resUrl_=a.sinfo_=a.refresh_=null;g||b.onCredentialCreate({credential:c});b._soReqs.length&&b._doSignIn(b._soReqs.shift());b._xoReqs.length&&b._doSignIn(b._xoReqs.shift())},d=function(c){a.errback(c);b._busy=a.resUrl_=a.sinfo_=a.refresh_=null;b._soReqs.length&&
b._doSignIn(b._soReqs.shift());b._xoReqs.length&&b._doSignIn(b._xoReqs.shift())},e=function(l,e,f,g){var h,m;h=a.sinfo_;var k=!a.options_||!1!==a.options_.prompt;if(b._doPortalSignIn(a.resUrl_)){e=b._getEsriAuthCookie();l=b._portalConfig;if(e)return void c(new u({userId:e.email,server:h.server,token:e.token,expires:null}));if(k)return k="",e=window.location.href,k=b.signInPage?b.signInPage:l?l.baseUrl+l.signin:b._isIdProvider(e,a.resUrl_)?b._getOrigin(e)+"/home/signin.html":h.tokenServiceUrl.replace(b._rePortalTokenSvc,
"")+"/home/signin.html",k=k.replace(/http:/i,"https:"),l&&!1===l.useSSL&&(k=k.replace(/https:/i,"http:")),void(0===e.toLowerCase().replace("https","http").indexOf(k.toLowerCase().replace("https","http"))?(m=Error("Cannot redirect to Sign-In page from within Sign-In page. URL of the resource that triggered this workflow: "+a.resUrl_),m.code="IdentityManagerBase.5",m.log=w.isDebug,d(m)):b._redirectFunc?b._redirectFunc({signInPage:k,returnUrlParamName:"returnUrl",returnUrl:e,resourceUrl:a.resUrl_,serverInfo:h}):
window.location=k+"?returnUrl\x3d"+window.escape(e));m=Error("User is not signed in.");m.code="IdentityManagerBase.6";m.log=w.isDebug;d(m)}else l?c(new u({userId:l,server:h.server,token:f,expires:v.isDefined(g)?Number(g):null,ssl:!!e})):r?(l=r._oAuthCred,l||(e=new O(r,window.localStorage),f=new O(r,window.sessionStorage),e.isValid()&&f.isValid()?e.expires>f.expires?(l=e,f.destroy()):(l=f,e.destroy()):l=e.isValid()?e:f,r._oAuthCred=l),l.isValid()?c(new u({userId:l.userId,server:h.server,token:l.token,
expires:l.expires,ssl:l.ssl,_oAuthCred:l})):b._oAuthHash&&b._oAuthHash.state.portalUrl===r.portalUrl?(m=b._oAuthHash,h=new u({userId:m.username,server:h.server,token:m.access_token,expires:(new Date).getTime()+1E3*Number(m.expires_in),ssl:"true"===m.ssl,oAuthState:m.state,_oAuthCred:l}),l.storage=m.persist?window.localStorage:window.sessionStorage,l.token=h.token,l.expires=h.expires,l.userId=h.userId,l.ssl=h.ssl,l.save(),b._oAuthHash=null,c(h)):k?a._pendingDfd=b.oAuthSignIn(a.resUrl_,h,r,a.options_).addCallbacks(c,
d):(m=Error("User is not signed in."),m.code="IdentityManagerBase.6",m.log=w.isDebug,d(m))):k?b._checkProtocol(a.resUrl_,h,d,a.admin_)&&(m=a.options_,a.admin_&&(m=m||{},m.isAdmin=!0),a._pendingDfd=b.signIn(a.resUrl_,h,m).addCallbacks(c,d)):(m=Error("User is not signed in."),m.code="IdentityManagerBase.6",m.log=w.isDebug,d(m))},f=function(){var e,f,g,k=a.sinfo_,n=k.owningSystemUrl,m=a.options_;(m&&(e=m.token,f=m.error),g=b._findCredential(n,{token:e,resource:a.resUrl_}),!g&&F(k)&&h.some(b.credentials,
function(a){return this._isIdProvider(n,a.server)&&(g=a),!!g},b),g)?(e=b.findCredential(a.resUrl_,g.userId))?c(e):G(k,b._legacyFed)?(e=g.toJson(),e.server=k.server,e.resources=null,c(new u(e))):(a._pendingDfd=b.generateToken(b.findServerInfo(g.server),null,{serverUrl:a.resUrl_,token:g.token,ssl:g.ssl})).addCallbacks(function(b){c(new u({userId:g.userId,server:k.server,token:b.token,expires:v.isDefined(b.expires)?Number(b.expires):null,ssl:!!b.ssl,isAdmin:a.admin_,validity:b.validity}))},d):(b._busy=
null,e&&(a.options_.token=null),(a._pendingDfd=b.getCredential(n.replace(/\/?$/,"/sharing"),{resource:a.resUrl_,token:e,error:f})).addCallbacks(function(){b._enqueue(a.resUrl_,a.sinfo_,a.options_,a,a.admin_)},function(a){d(a)}))},g=a.sinfo_.owningSystemUrl,k=this._isServerRsrc(a.resUrl_),n=a.sinfo_._restInfoDfd,r=this._findOAuthInfo(a.resUrl_);n?n.addCallbacks(function(c){var d=a.sinfo_;d.adminTokenServiceUrl=d._restInfoDfd.adminUrl_;d._restInfoDfd=null;d.tokenServiceUrl=q.getObject("authInfo.tokenServicesUrl",
!1,c)||q.getObject("authInfo.tokenServiceUrl",!1,c)||q.getObject("tokenServiceUrl",!1,c);d.shortLivedTokenValidity=q.getObject("authInfo.shortLivedTokenValidity",!1,c);d.currentVersion=c.currentVersion;d.owningTenant=c.owningTenant;(c=d.owningSystemUrl=c.owningSystemUrl)&&b._portals.push(c);k&&c?f():e()},function(){a.sinfo_._restInfoDfd=null;var b=Error("Unknown resource - could not find token service endpoint.");b.code="IdentityManagerBase.2";b.log=w.isDebug;d(b)}):k&&g?f():a.sinfo_._selfDfd?(g=
function(c){a.sinfo_._selfDfd=null;var d=c&&c.user&&c.user.username,f=c&&c.allSSL;(a.sinfo_.webTierAuth=!!d,d&&b.normalizeWebTierAuth)?(a.sinfo_._tokenDfd=b.generateToken(a.sinfo_,null,{ssl:f}),c=function(b){a.sinfo_._tokenDfd=null;e(d,f,b&&b.token,b&&b.expires)},a.sinfo_._tokenDfd.then(c,c)):e(d,f)},a.sinfo_._selfDfd.then(g,g)):e()}});return u=J(N,{declaredClass:"esri.Credential",tokenRefreshBuffer:2,constructor:function(a){q.mixin(this,a);this.resources=this.resources||[];v.isDefined(this.creationTime)||
(this.creationTime=(new Date).getTime())},_oAuthCred:null,refreshToken:function(){var a,b,c=this,d=this.resources&&this.resources[0],e=k.id.findServerInfo(this.server),f=e&&e.owningSystemUrl,g=!!f&&"server"===this.scope,q=g&&G(e,k.id._legacyFed),n=g&&k.id.findServerInfo(f),r=e.webTierAuth,l=r&&k.id.normalizeWebTierAuth,p=z[this.server],p=p&&p[this.userId],t={username:this.userId,password:p};if((!r||l)&&(g&&!n&&h.some(k.id.serverInfos,function(a){return k.id._isIdProvider(f,a.server)&&(n=a),!!n}),
a=n&&k.id.findCredential(n.server,this.userId),!g||a)){if(q)return void a.refreshToken();if(g)b={serverUrl:d,token:a&&a.token,ssl:a&&a.ssl};else if(l)t=null,b={ssl:this.ssl};else{if(!p){var u;return d&&(d=k.id._sanitizeUrl(d),this._enqueued=1,u=k.id._enqueue(d,e,null,null,this.isAdmin,this),u.addCallback(function(){c._enqueued=0;c.refreshServerTokens()}).addErrback(function(){c._enqueued=0})),u}this.isAdmin&&(b={isAdmin:!0})}return k.id.generateToken(g?n:e,g?null:t,b).addCallback(function(a){c.token=
a.token;c.expires=v.isDefined(a.expires)?Number(a.expires):null;c.creationTime=(new Date).getTime();c.validity=a.validity;c.onTokenChange();c.refreshServerTokens()}).addErrback(function(){})}},refreshServerTokens:function(){"portal"===this.scope&&h.forEach(k.id.credentials,function(a){var b=k.id.findServerInfo(a.server),c=b&&b.owningSystemUrl;a!==this&&a.userId===this.userId&&c&&"server"===a.scope&&(k.id._hasSameServerInstance(this.server,c)||k.id._isIdProvider(c,this.server))&&(G(b,k.id._legacyFed)?
(a.token=this.token,a.expires=this.expires,a.creationTime=this.creationTime,a.validity=this.validity,a.onTokenChange()):a.refreshToken())},this)},onTokenChange:function(a){clearTimeout(this._refreshTimer);var b=this.server&&k.id.findServerInfo(this.server),c=(b=b&&b.owningSystemUrl)&&k.id.findServerInfo(b);!1!==a&&(!b||"portal"===this.scope||c&&c.webTierAuth&&!k.id.normalizeWebTierAuth)&&(v.isDefined(this.expires)||v.isDefined(this.validity))&&this._startRefreshTimer()},onDestroy:function(){},destroy:function(){this.userId=
this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null;this._oAuthCred&&(this._oAuthCred.destroy(),this._oAuthCred=null);var a=h.indexOf(k.id.credentials,this);-1<a&&k.id.credentials.splice(a,1);this.onTokenChange();this.onDestroy()},toJson:function(){return this._toJson()},_toJson:function(){var a=v.fixJson({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,
scope:this.scope}),b=this.resources;return b&&0<b.length&&(a.resources=b),a},_startRefreshTimer:function(){clearTimeout(this._refreshTimer);var a=6E4*this.tokenRefreshBuffer,b=(this.validity?this.creationTime+6E4*this.validity:this.expires)-(new Date).getTime();0>b&&(b=0);this._refreshTimer=setTimeout(q.hitch(this,this.refreshToken),b>a?b-a:b)}}),I.Credential=u,B("extend-esri")&&(k.IdentityManagerBase=I),I});