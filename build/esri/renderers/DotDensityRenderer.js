//>>built
define("esri/renderers/DotDensityRenderer","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/dom-construct dojo/has dojox/gfx/_base ../kernel ../lang ../Color ./Renderer ../symbols/PictureFillSymbol ../geometry/ScreenPoint ../geometry/Point".split(" "),function(k,m,r,t,u,v,w,n,p,x,y,z,q){k=k(x,{declaredClass:"esri.renderer.DotDensityRenderer",constructor:function(a){this.dotSize=a.dotSize||3;this.dotValue=a.dotValue;this.fields=a.fields;this.outline=a.outline;this.backgroundColor=a.backgroundColor;
this.exactCount=a.exactCount||!0;this.dotShape=a.dotShape||"square";this.legendOptions=a.legendOptions;this._exactCountMinArea=1E4;this._currentMapScale=this._map=this._canvas=null;this._symbolMap={};this._currentGraphic=this._currentResolution=this._objectIdField=null;this._supportsCanvas=window.CanvasRenderingContext2D?!0:!1;window.CanvasRenderingContext2D||console.log("The DotDensityRenderer requires a Canvas enabled Browser.  IE8 and less does not support Canvas.")},getSymbol:function(a){var b,
d,c;return this._currentGraphic=a,this._supportsCanvas?(this._map||(this._map=a.getLayer()._map,this._objectIdField=a.getLayer().objectIdField,this._currentMapScale=this._map.getScale(),this._currentResolution=this._map.extent.getWidth()/this._map.width,this._map.on("zoom-end",m.hitch(this,function(a){this._currentMapScale=this._map.getScale();this._currentResolution=a.extent.getWidth()/this._map.width;this._symbolMap[this._currentMapScale]={}}))),this._symbolMap[this._currentMapScale]&&this._symbolMap[this._currentMapScale][a.attributes[this._objectIdField]]?
(d=this._symbolMap[this._currentMapScale][a.attributes[this._objectIdField]],c=this._getShapeProperties(a),d.setOffset(c.dx,c.dy),d):(b=this._generateFieldsCount(this.fields,a.attributes,this.dotValue),c=this._getShapeProperties(a),d=new y(this._generateImageSrc(c.width,c.height,b,c.minXY,c.maxXY),this.outline,c.width,c.height),d.setOffset(c.dx,c.dy),this._symbolMap[this._currentMapScale]?this._symbolMap[this._currentMapScale][a.attributes[this._objectIdField]]=d:(this._symbolMap[this._currentMapScale]=
{},this._symbolMap[this._currentMapScale][a.attributes[this._objectIdField]]=d),d)):null},_generateFieldsCount:function(a,b,d){var c,e;for(e=a.length-1;0<=e;e--)c=b[a[e].name]/d,a[e].numPoints=Math.round(c);return a},_getShapeProperties:function(a){var b,d,c,e,f,g,l,h;return b=a.geometry.getExtent(),b.contains(this._map.extent)&&(b=this._map.extent),l=Math.ceil(b.getWidth()/this._currentResolution),h=Math.ceil(b.getHeight()/this._currentResolution),d=this._map.toScreen(new q(b.xmin,b.ymin,b.spatialReference)),
c=this._map.toScreen(new q(b.xmax,b.ymax,b.spatialReference)),g=a.getLayer().getNode().getCTM(),e=(d.x-g.e)%l,f=(c.y-g.f)%h,{minXY:d,maxXY:c,dx:e,dy:f,width:l,height:h}},_generateImageSrc:function(a,b,d,c,e,f){var g,l,h,k=this.dotSize;this._canvas?(this._canvas.width=a,this._canvas.height=b):this._canvas=this._initCanvas(a,b);g=this._canvas.getContext("2d");(f=f||this.backgroundColor)&&(g.fillStyle=f.toCss(!0),g.fillRect(0,0,a,b),g.fill());for(f=d.length-1;0<=f;f--)for(g.fillStyle=d[f].color.toCss(!0),
l=d[f].numPoints-1;0<=l;l--)h=this._getRandomPoint(a,b,c,e),"square"===this.dotShape?g.fillRect(h.x,h.y,k,k):"circle"===this.dotShape&&(g.beginPath(),g.arc(h.x,h.y,k/2,0,2*Math.PI,!0)),g.fill();return this._canvas.toDataURL()},_initCanvas:function(a,b){var d=t.create("canvas",{id:"canvas",width:a+"px",height:b+"px",style:"position: absolute; left: -10000px; top: 0px;"},null);return document.body.appendChild(d),d},_getRandomInt:function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},_getRandomPoint:function(a,
b,d,c){var e={},f=this.outline&&this.outline.width?this.outline.width:0;if(!0===this.exactCount&&a*b>this._exactCountMinArea){do e.x=this._getRandomInt(d.x,c.x),e.y=this._getRandomInt(c.y,d.y),a=new z(e.x,e.y),a=this._checkPointShapeBounds(a,this.dotSize+f,this._currentGraphic.geometry),!0===a&&(e.x-=d.x,e.y-=c.y);while(!1===a)}else e.x=this._getRandomInt(0,a),e.y=this._getRandomInt(0,b);return e},_checkPointShapeBounds:function(a,b,d){var c=null,c=!1,e=!0,f=0;do{switch(f){case 1:a.x+=b;break;case 2:a.y+=
b;break;case 3:a.x-=b}c=this._map.toMap(a);c=d.contains(c);!1===c&&(e=!1);f+=1}while(3>=f&&!0===e);return c},setDotSize:function(a){0<a&&(this.dotSize=a)},setDotValue:function(a){0<a&&(this.dotValue=a)},setOutline:function(a){this.outline=a},setBackgroundColor:function(a){this.backgroundColor=a},toJson:function(){var a=m.mixin(this.inherited(arguments),{type:"dotDensity",backgroundColor:p.toJsonColor(this.backgroundColor),dotShape:this.dotShape,dotSize:0<this.dotSize?v.px2pt(this.dotSize):0,dotValue:this.dotValue,
fields:r.map(this.fields,function(a){return n.fixJson({color:p.toJsonColor(a.color),name:a.name})}),legendOptions:this.legendOptions&&n.fixJson({backgroundColor:p.toJsonColor(this.legendOptions.backgroundColor),dotCoverage:this.legendOptions.dotCoverage,outline:this.legendOptions.outline&&this.legendOptions.outline.toJson(),valueUnit:this.legendOptions.valueUnit}),outline:this.outline&&this.outline.toJson()});return n.fixJson(a)}});return u("extend-esri")&&m.setObject("renderer.DotDensityRenderer",
k,w),k});