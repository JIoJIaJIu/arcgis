//>>built
define("esri/layers/rasterFormats/Png",["./Zlib"],function(w){return function(){function g(b){var a,e,c,d,f;this.data=b;this.pos=8;this.palette=[];this.imgData=[];this.transparency={};this.animation=null;this.text={};for(c=null;;){a=this.readUInt32();f=b=void 0;f=[];for(b=0;4>b;++b)f.push(String.fromCharCode(this.data[this.pos++]));switch(b=f.join("")){case "IHDR":this.width=this.readUInt32();this.height=this.readUInt32();this.bits=this.data[this.pos++];this.colorType=this.data[this.pos++];this.compressionMethod=
this.data[this.pos++];this.filterMethod=this.data[this.pos++];this.interlaceMethod=this.data[this.pos++];break;case "acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case "PLTE":this.palette=this.read(a);break;case "fcTL":c&&this.animation.frames.push(c);this.pos+=4;c={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()};b=this.readUInt16();a=this.readUInt16()||100;c.delay=1E3*b/a;c.disposeOp=this.data[this.pos++];
c.blendOp=this.data[this.pos++];c.data=[];break;case "IDAT":case "fdAT":"fdAT"===b&&(this.pos+=4,a-=4);b=(null!=c?c.data:void 0)||this.imgData;for(f=0;0<=a?a>f:f>a;0<=a?++f:--f)b.push(this.data[this.pos++]);break;case "tRNS":switch(this.transparency={},this.colorType){case 3:if(this.transparency.indexed=this.read(a),d=255-this.transparency.indexed.length,0<d)for(a=0;0<=d?d>a:a>d;0<=d?++a:--a)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(a)[0];break;case 2:this.transparency.rgb=
this.read(a)}break;case "tEXt":f=this.read(a);a=f.indexOf(0);b=String.fromCharCode.apply(String,f.slice(0,a));this.text[b]=String.fromCharCode.apply(String,f.slice(a+1));break;case "IEND":c&&this.animation.frames.push(c);a:{switch(this.colorType){case 0:case 3:case 4:c=1;break a;case 2:case 6:c=3;break a}c=void 0}this.colors=c;this.hasAlphaChannel=4===(e=this.colorType)||6===e;e=this.colors+(this.hasAlphaChannel?1:0);this.pixelBitlength=this.bits*e;a:{switch(this.colors){case 1:e="DeviceGray";break a;
case 3:e="DeviceRGB";break a}e=void 0}return this.colorSpace=e,void(this.imgData=new Uint8Array(this.imgData));default:this.pos+=a}if(this.pos+=4,this.pos>this.data.length)throw Error("Incomplete or corrupt PNG file");}}var v,u,m;return g.load=function(b,a,e){var c;return"function"==typeof a&&(e=a),c=new XMLHttpRequest,c.open("GET",b,!0),c.responseType="arraybuffer",c.onload=function(){var b,f;return b=new Uint8Array(c.response||c.mozResponseArrayBuffer),f=new g(b),"function"==typeof(null!=a?a.getContext:
void 0)&&f.render(a),"function"==typeof e?e(f):void 0},c.send(null)},g.prototype.read=function(b){var a,e;e=[];for(a=0;0<=b?b>a:a>b;0<=b?++a:--a)e.push(this.data[this.pos++]);return e},g.prototype.readUInt32=function(){var b,a,e,c;return b=this.data[this.pos++]<<24,a=this.data[this.pos++]<<16,e=this.data[this.pos++]<<8,c=this.data[this.pos++],b|a|e|c},g.prototype.readUInt16=function(){var b,a;return b=this.data[this.pos++]<<8,a=this.data[this.pos++],b|a},g.prototype.decodePixels=function(b){var a,
e,c,d,f,l,k,h,n,g,r,q,t,m,p;if(null==b&&(b=this.imgData),0===b.length)return new Uint8Array(0);b=new w(b);b=b.getBytes();h=this.pixelBitlength/8;q=h*this.width;n=new Uint8Array(q*this.height);l=b.length;for(e=g=r=0;l>g;){switch(b[g++]){case 0:for(a=0;q>a;a+=1)n[e++]=b[g++];break;case 1:for(d=p=0;q>p;d=p+=1)a=b[g++],f=h>d?0:n[e-h],n[e++]=(a+f)%256;break;case 2:for(d=f=0;q>f;d=f+=1)a=b[g++],c=(d-d%h)/h,t=r&&n[(r-1)*q+c*h+d%h],n[e++]=(t+a)%256;break;case 3:for(d=p=0;q>p;d=p+=1)a=b[g++],c=(d-d%h)/h,f=
h>d?0:n[e-h],t=r&&n[(r-1)*q+c*h+d%h],n[e++]=(a+Math.floor((f+t)/2))%256;break;case 4:for(d=p=0;q>p;d=p+=1)a=b[g++],c=(d-d%h)/h,f=h>d?0:n[e-h],0===r?t=m=0:(t=n[(r-1)*q+c*h+d%h],m=c&&n[(r-1)*q+(c-1)*h+d%h]),k=f+t-m,d=Math.abs(k-f),c=Math.abs(k-t),k=Math.abs(k-m),f=c>=d&&k>=d?f:k>=c?t:m,n[e++]=(a+f)%256;break;default:throw Error("Invalid filter algorithm: "+b[g-1]);}r++}return n},g.prototype.decodePalette=function(){var b,a,e,c,d,f,l,k,h;e=this.palette;f=this.transparency.indexed||[];d=new Uint8Array((f.length||
0)+e.length);a=l=b=c=0;for(k=e.length;k>l;a=l+=3)d[c++]=e[a],d[c++]=e[a+1],d[c++]=e[a+2],d[c++]=null!=(h=f[b++])?h:255;return d},g.prototype.copyToImageData=function(b,a){var e,c,d,f,l,k,h,g,m;if(c=this.colors,g=null,e=this.hasAlphaChannel,this.palette.length&&(g=null!=(m=this._decodedPalette)?m:this._decodedPalette=this.decodePalette(),c=4,e=!0),d=b.data||b,h=d.length,l=g||a,f=k=0,1===c)for(;h>f;)c=g?4*a[f/4]:k,k=l[c++],d[f++]=k,d[f++]=k,d[f++]=k,d[f++]=e?l[c++]:this.transparency.grayscale&&this.transparency.grayscale===
k?0:255,k=c;else for(;h>f;)c=g?4*a[f/4]:k,d[f++]=l[c++],d[f++]=l[c++],d[f++]=l[c++],d[f++]=e?l[c++]:this.transparency.rgb&&this.transparency.rgb[1]===l[c-3]&&this.transparency.rgb[3]===l[c-2]&&this.transparency.rgb[5]===l[c-1]?0:255,k=c},g.prototype.decode=function(){var b;return b=new Uint8Array(this.width*this.height*4),this.copyToImageData(b,this.decodePixels()),b},u=document.createElement("canvas"),m=u.getContext("2d"),v=function(b){var a;return m.width=b.width,m.height=b.height,m.clearRect(0,
0,b.width,b.height),m.putImageData(b,0,0),a=new Image,a.src=u.toDataURL(),a},g.prototype.decodeFrames=function(b){var a,e,c,d,f,g,k;if(this.animation){g=this.animation.frames;k=[];a=d=0;for(f=g.length;f>d;a=++d)a=g[a],e=b.createImageData(a.width,a.height),c=this.decodePixels(new Uint8Array(a.data)),this.copyToImageData(e,c),a.imageData=e,k.push(a.image=v(e));return k}},g.prototype.renderFrame=function(b,a){var e,c,d;return c=this.animation.frames,e=c[a],d=c[a-1],0===a&&b.clearRect(0,0,this.width,
this.height),1===(null!=d?d.disposeOp:void 0)?b.clearRect(d.xOffset,d.yOffset,d.width,d.height):2===(null!=d?d.disposeOp:void 0)&&b.putImageData(d.imageData,d.xOffset,d.yOffset),0===e.blendOp&&b.clearRect(e.xOffset,e.yOffset,e.width,e.height),b.drawImage(e.image,e.xOffset,e.yOffset)},g.prototype.animate=function(b){var a,e,c,d,f,g,k=this;return e=0,g=this.animation,d=g.numFrames,c=g.frames,f=g.numPlays,(a=function(){var g,l;return g=e++%d,l=c[g],k.renderFrame(b,g),1<d&&f>e/d?k.animation._timeout=
setTimeout(a,l.delay):void 0})()},g.prototype.stopAnimation=function(){var b;return clearTimeout(null!=(b=this.animation)?b._timeout:void 0)},g.prototype.render=function(b){var a,e;return b._png&&b._png.stopAnimation(),b._png=this,b.width=this.width,b.height=this.height,a=b.getContext("2d"),this.animation?(this.decodeFrames(a),this.animate(a)):(e=a.createImageData(this.width,this.height),this.copyToImageData(e,this.decodePixels()),a.putImageData(e,0,0))},g}()});