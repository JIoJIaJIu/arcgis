//>>built
define("esri/layers/FeatureLayer","require module dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/Deferred dojo/date/locale dojo/sniff dojo/io-query dojo/dom-construct dojo/i18n dojo/when dojo/promise/all ../kernel ../lang ../request ../config ../deferredUtils ../SpatialReference ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/jsonUtils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/jsonUtils ../tasks/QueryTask ../tasks/query ../tasks/FeatureSet ../tasks/StatisticDefinition ../geometry/Extent ../geometry/jsonUtils ../geometry/normalizeUtils ../geometry/scaleUtils ./GraphicsLayer ./Field ./TimeInfo ./FeatureType ./FeatureTemplate ./FeatureEditResult ./LabelClass ./SnapshotMode ./OnDemandMode ./SelectionMode ./StreamMode ./TrackManager ./HeatmapManager dojo/i18n!../nls/jsapi require".split(" "),
function(M,S,T,D,p,h,F,w,U,G,V,W,wa,N,X,H,r,x,Y,C,J,Z,aa,O,ba,P,ca,da,ea,K,I,fa,Q,ga,ha,ia,ja,ka,la,ma,na,E,oa,L,pa,qa,ra,sa,R,ta){var ua=Y.defaults,v=T(ja,{declaredClass:"esri.layers.FeatureLayer",invalidParams:"query contains one or more unsupported parameters",reHostedFS:/https?:\/\/services.*\.arcgis\.com/i,maxPointCountForAuto:4E3,maxRecordCountForAuto:2E3,maxVertexCountForAuto:25E4,generalizeForScale:4E3,_eventMap:{"add-attachment-complete":["result"],"before-apply-edits":["adds","updates",
"deletes"],"delete-attachments-complete":["results"],"edits-complete":["adds","updates","deletes"],"query-attachment-infos-complete":["results"],"query-count-complete":["count"],"query-features-complete":["featureSet"],"query-ids-complete":["objectIds"],"query-related-features-complete":["featureSets"],"selection-complete":["features","method"],"update-end":["error","info"]},constructor:function(a,c){this._preventInit||this._initFeatureLayer(a,c)},_initFeatureLayer:function(a,c){this.i18n=ta;c=c||
{};this.showLabels=null!=c.showLabels?c.showLabels:!0;this._outFields=c.outFields;this._defnExpr=c.definitionExpression;this._loadCallback=c.loadCallback;var b=c._usePatch;this._usePatch=null===b||void 0===b?!0:b;this._trackIdField=c.trackIdField;this.objectIdField=c.objectIdField;this._maxOffset=null!=c.maxAllowableOffset?c.maxAllowableOffset:this.maxAllowableOffset;this.quantize=null!=c.quantize?c.quantize:!0;this._optEditable=c.editable;this._optAutoGen=c.autoGeneralize;this.editSummaryCallback=
c.editSummaryCallback;this.userId=c.userId;this.userIsAdmin=c.userIsAdmin;this.useMapTime=c.hasOwnProperty("useMapTime")?!!c.useMapTime:!0;this.source=c.source;this.gdbVersion=c.gdbVersion;this.orderByFields=c.orderByFields;this.maxPointCountForAuto=null!=c.maxPointCountForAuto?c.maxPointCountForAuto:this.maxPointCountForAuto;this.maxRecordCountForAuto=null!=c.maxRecordCountForAuto?c.maxRecordCountForAuto:this.maxRecordCountForAuto;this.maxVertexCountForAuto=null!=c.maxVertexCountForAuto?c.maxVertexCountForAuto:
this.maxVertexCountForAuto;this.generalizeForScale=null!=c.generalizeForScale?c.generalizeForScale:this.generalizeForScale;this.queryPagination=null!=c.queryPagination?c.queryPagination:this.url?this.reHostedFS.test(this.url):!1;this.multipatchOption=c.multipatchOption;this._selectedFeatures={};this._selectedFeaturesArr=[];this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();var d=v,b=this.mode=r.isDefined(c.mode)?c.mode:d.MODE_ONDEMAND;switch(this._isStream&&(b=d.MODE_STREAM,
this.mode=d.MODE_STREAM),b){case d.MODE_SNAPSHOT:this.currentMode=d.MODE_SNAPSHOT;this._mode=new L(this);this._isSnapshot=!0;break;case d.MODE_ONDEMAND:case d.MODE_AUTO:this.currentMode=d.MODE_ONDEMAND;this._tileWidth=c.tileWidth||512;this._tileHeight=c.tileHeight||512;this._mode=new pa(this);this.latticeTiling=c.latticeTiling;break;case d.MODE_SELECTION:this.currentMode=d.MODE_SELECTION;this._mode=new qa(this);this._isSelOnly=!0;break;case d.MODE_STREAM:this.currentMode=d.MODE_STREAM,this._mode=
new ra(this),this._isStream=!0}if(this._initLayer=p.hitch(this,this._initLayer),this._selectHandler=p.hitch(this,this._selectHandler),this._editable=!1,p.isObject(a)&&a.layerDefinition)return this._collection=!0,this.mode=this._isStream?d.MODE_STREAM:d.MODE_SNAPSHOT,this._initLayer(a),this;this._task=new ea(this.url,{source:this.source,gdbVersion:this.gdbVersion});b=this._url.path;this._fserver=!1;-1!==b.search(/\/FeatureServer\//i)&&(this._fserver=!0);this.mode===d.MODE_AUTO&&this.reHostedFS.test(this.url)&&
this._queryLimit();(d=c.resourceInfo)?this._initLayer(d):(this.source&&(d={source:this.source.toJson()},this._url.query=p.mixin(this._url.query,{layer:F.toJson(d)})),this.gdbVersion&&(this._url.query=p.mixin(this._url.query,{gdbVersion:this.gdbVersion})),x({url:b,content:p.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}));this.registerConnectEvents()},_initLayer:function(a,c){if(a||c){this._json=a;this._findCredential();((this.credential&&
this.credential.ssl||a&&a._ssl)&&(this._useSSL(),this._task._useSSL()),this.version=a.currentVersion,this.version)||(this.version="capabilities"in a||"drawingInfo"in a||"hasAttachments"in a||"htmlPopupType"in a||"relationships"in a||"timeInfo"in a||"typeIdField"in a||"types"in a?10:9.3);if(this._collection&&(this._isStream||(this.currentMode=v.MODE_SNAPSHOT,this._mode=new L(this)),this._isSnapshot=!0,this._featureSet=a.featureSet,this._nextId=a.nextObjectId,a=a.layerDefinition),this.geometryType=
a.geometryType,"string"!=typeof this.multipatchOption&&"esriGeometryMultiPatch"===this.geometryType&&(this.multipatchOption="xyFootprint"),a.hasOwnProperty("capabilities")){var b=this.capabilities=a.capabilities;this._editable=b&&-1!==b.toLowerCase().indexOf("editing")?!0:!1}else this._collection||(this._editable=this._fserver);r.isDefined(this._optEditable)?(this._editable=this._optEditable,delete this._optEditable):"esriGeometryMultiPatch"===this.geometryType&&(this._editable=!1);this._json=F.toJson(this._json);
this.isEditable()?this._setMaxOffset(null):this.mode===v.MODE_SNAPSHOT||"esriGeometryPolyline"!==this.geometryType&&"esriGeometryPolygon"!==this.geometryType&&!this.hasXYFootprint()||(this._autoGeneralize=r.isDefined(this._optAutoGen)?this._optAutoGen:this.mode===v.MODE_ONDEMAND||this.mode===v.MODE_AUTO,delete this._optAutoGen);var b=a.effectiveMinScale||a.minScale,d=a.effectiveMaxScale||a.maxScale;!this._hasMin&&b&&this.setMinScale(b);!this._hasMax&&d&&this.setMaxScale(d);this.layerId=a.id;this.name=
a.name;this.description=a.description;this.copyright=a.copyrightText;this.type=a.type;this.displayField=a.displayField;this.defaultDefinitionExpression=a.definitionExpression;this.fullExtent=new Q(a.extent);this.initialExtent=new Q(this.fullExtent.toJson());this.fullExtent.spatialReference&&(this.spatialReference=new J(this.fullExtent.spatialReference.toJson()));this.defaultVisibility=a.defaultVisibility;"esriGeometryPoint"!==this.geometryType&&"esriGeometryMultipoint"!==this.geometryType||(this.latticeTiling=
!1);this.hasM=a.hasM||!1;this.hasZ=a.hasZ||!1;this.indexedFields=a.indexedFields;this.maxRecordCount=a.maxRecordCount;this.canModifyLayer=a.canModifyLayer;this.supportsStatistics=a.supportsStatistics;this.supportsAdvancedQueries=this._collection?!1:a.supportsAdvancedQueries;this.supportsCalculate=a.supportsCalculate;this.supportsAttachmentsByUploadId=a.supportsAttachmentsByUploadId;this.supportsCoordinatesQuantization=a.supportsCoordinatesQuantization;this.quantize=this.quantize&&this.supportsCoordinatesQuantization;
this.hasLabels=a.hasLabels;this.canScaleSymbols=a.canScaleSymbols;this.supportsRollbackOnFailureParameter=this.supportsRollbackOnFailure=a.supportsRollbackOnFailure;this.syncCanReturnChanges=a.syncCanReturnChanges;this.isDataVersioned=a.isDataVersioned;this.editFieldsInfo=a.editFieldsInfo;this.ownershipBasedAccessControlForFeatures=a.ownershipBasedAccessControlForFeatures;this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures&&(this.creatorField=this.editFieldsInfo.creatorField);this.relationships=
a.relationships;this.allowGeometryUpdates=r.isDefined(a.allowGeometryUpdates)?a.allowGeometryUpdates:!0;this.advancedQueryCapabilities=a.advancedQueryCapabilities||{supportsStatistics:this.supportsStatistics,supportsOrderBy:this.supportsAdvancedQueries,supportsDistinct:this.supportsAdvancedQueries};this.useStandardizedQueries=a.useStandardizedQueries;this.tileMaxRecordCount=a.tileMaxRecordCount;this.standardMaxRecordCount=a.standardMaxRecordCount;this._setMaxOffset(this._maxOffset,!0);this._isTable=
"Table"===this.type;for(var e=this.fields=[],d=a.fields,b=0;b<d.length;b++)e.push(new ka(d[b]));if(!this.objectIdField){if(this.objectIdField=a.objectIdField,!this.objectIdField)for(d=a.fields,b=0;b<d.length;b++)if(e=d[b],"esriFieldTypeOID"===e.type){this.objectIdField=e.name;break}this.objectIdField||this._isStream||console.debug("esri.layers.FeatureLayer: "+r.substitute({url:this.url},"objectIdField is not set [url: ${url}]"))}if(!r.isDefined(this._nextId)){d=this.objectIdField;e=-1;if(this._collection&&
d)for(var f,g=(b=this._featureSet)&&b.features,k=g?g.length:0,b=0;k>b;b++)f=(f=g[b].attributes)&&f[d],f>e&&(e=f);this._nextId=e+1}this.globalIdField=a.globalIdField;var l;(b=this.typeIdField=a.typeIdField)&&(l=!this._getField(b)&&this._getField(b,!0),l&&(this.typeIdField=l.name));this.visibilityField=a.visibilityField;(l=a.defaultSymbol)&&(this.defaultSymbol=ba.fromJson(l));var n,m,t=this.types=[];f=a.types;d=(b=this.editFieldsInfo)&&b.creatorField;e=b&&b.editorField;k=d||e;g=[];if(f)for(b=0;b<f.length;b++)n=
new ma(f[b]),m=n.templates,k&&m&&m.length&&(g=g.concat(m)),t.push(n);t=a.templates;n=this.templates=[];if(t)for(b=0;b<t.length;b++)f=new na(t[b]),k&&g.push(f),n.push(f);for(b=0;b<g.length;b++)(k=p.getObject("prototype.attributes",!1,g[b]))&&(d&&delete k[d],e&&delete k[e]);(b=a.timeInfo)&&(this.timeInfo=new la(b),this._startTimeField=b.startTimeField,this._endTimeField=b.endTimeField,this._startTimeField&&this._endTimeField&&(this._twoTimeFields=!0),this._trackIdField?b.trackIdField=this._trackIdField:
this._trackIdField=b.trackIdField);this.hasAttachments=!this._collection&&a.hasAttachments?!0:!1;this.htmlPopupType=a.htmlPopupType;var q,d=(b=a.drawingInfo)&&b.labelingInfo;if(d&&!this.labelingInfo&&(this.labelingInfo=h.map(d,function(a){return new oa(a)}),this._fixLabelExpr()),!this.renderer)if(b&&b.renderer){if(q=b.renderer,this.setRenderer(da.fromJson(q)),"classBreaks"===q.type&&this.renderer.setMaxInclusive(!0),!this._collection){var u=q.type;l=[];switch(q=this.renderer,u){case "simple":l.push(q.symbol);
break;case "uniqueValue":case "classBreaks":l.push(q.defaultSymbol),l=l.concat(h.map(q.infos,function(a){return a.symbol}))}l=h.filter(l,r.isDefined);var va=this._url.path+"/images/",y=this._getToken();h.forEach(l,function(a){var b=a.url;b&&(-1===b.search(/https?\:/)&&-1===b.indexOf("data:")&&(a.url=va+b),y&&-1!==a.url.search(/https?\:/)&&(a.url+="?token\x3d"+y))})}}else if(l)f=this.types,0<f.length?(q=new ca(this.defaultSymbol,this.typeIdField),h.forEach(f,function(a){q.addValue(a.id,a.symbol)})):
q=new P(this.defaultSymbol),this.setRenderer(q);else if(!this._isTable){switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":u=new Z;break;case "esriGeometryPolyline":u=new aa;break;case "esriGeometryPolygon":u=new O;break;default:this.hasXYFootprint()&&(u=new O)}this.setRenderer(u?new P(u):null)}u=b&&b.transparency||0;!this.hasOwnProperty("opacity")&&0<u&&(this.opacity=1-u/100);(G("ie")||7<=G("trident")||G("safari"))&&this.isEditable()&&10.02>this.version&&(this._ts=!0);
this.statistics=a.statistics;this._fixRendererFields();this._checkFields();this._updateCaps();var z=function(){this.currentMode!==v.MODE_SNAPSHOT&&(this.queryPagination=!1);null==this._maxOffset||this._isFractionalOffsetAllowed()||this._setMaxOffset(this._maxOffset);this.loaded=!0;this.onLoad(this);var a=this._loadCallback;a&&(delete this._loadCallback,a(this))};this._collection?(u=this._featureSet,this._featureSet=null,this._mode._drawFeatures(new I(u)),this._fcAdded=!0,z.call(this)):this._forceIdentity(this._limitPromise?
function(){var a=this;this._limitPromise.then(function(b){a._checkMode(b)});this._limitPromise.always(function(){a._limitPromise=null;z.call(a)})}:z)}},setShowLabels:function(a){this.showLabels=a;this.onShowLabelsChange()},onShowLabelsChange:function(){},onRendererChange:function(a){this.inherited(arguments);var c=this._map;(this._ager=!!(a&&a.observationAger&&a.observationRenderer),a&&"colors"in a&&"blurRadius"in a&&"maxPixelIntensity"in a)?"esriGeometryPoint"==this.geometryType&&!this._heatmapManager&&
c&&(this._heatmapManager=new R(this),this._heatmapManager.initialize(c)):this.renderer&&this.renderer.getRendererInfo?h.some(this.renderer.rendererInfos,function(a){return a.renderer&&"colors"in a.renderer&&"blurRadius"in a.renderer})||(this._heatmapManager=null):this._heatmapManager=null;if(a){var b=[],c=h.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],r.isDefined),d=function(a){return null!=a&&"function"!=typeof a&&a};h.forEach(c,function(a){var c=d(a.attributeField),
g=d(a.attributeField2);a=d(a.attributeField3);!1!==c&&b.push(c);!1!==g&&b.push(g);!1!==a&&b.push(a)});this._rendererFields=b}else this._rendererFields=[];this.loaded&&(this._fixRendererFields(),this._checkFields(this._rendererFields),this._collection&&(this._typesDirty=!0))},redraw:function(){this.inherited(arguments);this._trackManager&&this._trackManager.container&&this._trackManager.container.redraw()},_evalSDRenderer:function(){this.inherited(arguments);var a=this._getRenderer();this._ager=!!(a&&
a.observationAger&&a.observationRenderer);this._trackManager&&this._trackManager.container&&this._trackManager.container.setRenderer(a&&a.trackRenderer)},_setMap:function(a){var c=this.inherited(arguments),b=this._mode,d=this;return b&&b.initialize(a),this.geometryType&&this.attr("data-geometry-type",this.geometryType.replace(/esriGeometry/i,"").toLowerCase()),this._addHandle=this.on("graphic-node-add",function(a){a=a.graphic.attributes;(a=d._selectedFeatures[a&&a[d.objectIdField]])&&a.attr("data-selected",
"")}),c},_unsetMap:function(){var a=this._mode;a&&a.suspend();this._trackManager&&(this._trackManager.destroy(),this._trackManager=null);D.disconnect(this._zoomConnect);D.disconnect(this._addHandle);this._zoomConnect=this._addHandle=null;this._toggleTime(!1);this.inherited("_unsetMap",arguments)},refresh:function(){this._needsRefresh=!1;var a=this._mode;a&&a.refresh()},hasXYFootprint:function(){return"esriGeometryMultiPatch"===this.geometryType&&"xyFootprint"===this.multipatchOption},getOutFields:function(){return h.filter(this._getOutFields(),
function(a){return"*"===a||!!this._getField(a)},this)},getField:function(a){return this._getField(a,!0)},getDomain:function(a,c){var b,d,e=c&&c.feature,f=e&&this.typeIdField&&e.attributes&&e.attributes[this.typeIdField];return null!=f&&h.some(this.types,function(c){return c.id==f?(b=c.domains&&c.domains[a],b&&"inherited"===b.type&&(b=this._getLayerDomain(a),d=!0),!0):!1},this),d||b||(b=this._getLayerDomain(a)),b},_getLayerDomain:function(a){var c;return h.some(this.fields,function(b){return b.name===
a&&(c=b.domain),!!c}),c},getType:function(a){var c,b=a&&this.typeIdField&&a.attributes&&a.attributes[this.typeIdField];return h.some(this.types,function(a){return a.id==b&&(c=a),!!c}),c},setEditable:function(a){if(!this._collection)return console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service"),this;if(!this.loaded)return this._optEditable=a,this;var c=this._editable;return this._editable=a,this._updateCaps(),c!==a&&this.onCapabilitiesChange(),
this},getEditCapabilities:function(a){var c={canCreate:!1,canUpdate:!1,canDelete:!1};if(!this.loaded||!this.isEditable())return c;var b,d=a&&a.feature;a=a&&a.userId;var e=h.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],p.trim),c=(b=-1<h.indexOf(e,"editing"))&&-1<h.indexOf(e,"create"),f=b&&-1<h.indexOf(e,"update"),e=b&&-1<h.indexOf(e,"delete"),g=this.ownershipBasedAccessControlForFeatures,k=this.editFieldsInfo,l=k&&k.creatorField,k=k&&k.realm,d=(d=d&&d.attributes)&&l?d[l]:void 0,
n=!!this.userIsAdmin,l=!g||n||!(!g.allowOthersToUpdate&&!g.allowUpdateToOthers),g=!g||n||!(!g.allowOthersToDelete&&!g.allowDeleteToOthers);if((n||b&&!(c||f||e))&&(c=f=e=!0),b={canCreate:c,canUpdate:f,canDelete:e},null===d)b.canUpdate=f&&l,b.canDelete=e&&g;else{if(""===d)return b;if(d){if(a=a||this.getUserId(),a&&k&&(a=a+"@"+k),a.toLowerCase()===d.toLowerCase())return b;b.canUpdate=f&&l;b.canDelete=e&&g}}return b},getUserId:function(){var a;return this.loaded&&(a=this.credential&&this.credential.userId||
this.userId||""),a},setUserIsAdmin:function(a){this.userIsAdmin=a},setEditSummaryCallback:function(a){this.editSummaryCallback=a},getEditSummary:function(a,c,b){b=r.isDefined(b)?b:(new Date).getTime();var d="";b=this.getEditInfo(a,c,b);c=c&&c.callback||this.editSummaryCallback;if(c&&(b=c(a,b)||""),p.isString(b))d=b;else{if(b){a=b.action;c=b.userId;var e=b.timeValue,f=0;a&&f++;c&&f++;r.isDefined(e)&&f++;1<f&&(d=("edit"===a?"edit":"create")+(c?"User":"")+(r.isDefined(e)?b.displayPattern:""))}d=d&&r.substitute(b,
this.i18n.layers.FeatureLayer[d])}return d},getEditInfo:function(a,c,b){if(this.loaded){b=r.isDefined(b)?b:(new Date).getTime();var d;c=c&&c.action||"last";var e=this.editFieldsInfo,f=e&&e.creatorField,g=e&&e.creationDateField,k=e&&e.editorField,l=e&&e.editDateField,k=(a=(e&&e.realm,a&&a.attributes))&&k?a[k]:void 0,l=a&&l?a[l]:null,f=this._getEditData(a&&f?a[f]:void 0,a&&g?a[g]:null,b);b=this._getEditData(k,l,b);switch(c){case "creation":d=f;break;case "edit":d=b;break;case "last":d=b||f}return d&&
(d.action=d===b?"edit":"creation"),d}},_getEditData:function(a,c,b){var d,e,f;if(r.isDefined(c)&&(e=b-c,f=0>e?"Full":6E4>e?"Seconds":12E4>e?"Minute":36E5>e?"Minutes":72E5>e?"Hour":864E5>e?"Hours":6048E5>e?"WeekDay":"Full"),(void 0!==a||f)&&(d=d||{},d.userId=a,f))a=U.format,b=new Date(c),d.minutes=Math.floor(e/6E4),d.hours=Math.floor(e/36E5),d.weekDay=a(b,{datePattern:"EEEE",selector:"date"}),d.formattedDate=a(b,{selector:"date"}),d.formattedTime=a(b,{selector:"time"}),d.displayPattern=f,d.timeValue=
c;return d},isEditable:function(){return!(!this._editable&&!this.userIsAdmin)},setMaxAllowableOffset:function(a){return this.isEditable()||this._setMaxOffset(a,!0),this},getMaxAllowableOffset:function(){var a=this._quantizationParameters?this._quantizationParameters.tolerance:void 0;return null!=this._maxOffset?this._maxOffset:a},_setMaxOffset:function(a,c){return null==a?(delete this._maxOffset,delete this._quantizationParameters,this):(this.quantize&&this.supportsCoordinatesQuantization?("esriGeometryPolyline"===
this.geometryType?this._maxOffset=a:delete this._maxOffset,this._quantizationParameters={mode:"view",originPosition:"upperLeft",tolerance:a,extent:this.fullExtent}):(this._isFractionalOffsetAllowed()&&c||(a=Math.floor(a)),isNaN(a)||0===a?delete this._maxOffset:this._maxOffset=a,delete this._quantizationParameters),this)},_isFractionalOffsetAllowed:function(){return null==this.version||10.1<=this.version||navigator.languages&&this._isLangWithDot(navigator.languages[0])},_isLangWithDot:function(a){return a=
a&&a.split("-"),a=a&&a[0]&&a[0].toLowerCase(),-1!==h.indexOf(this._langsWithDot,a)},_langsWithDot:"ar en et fr he ja ko th vi zh".split(" "),setAutoGeneralize:function(a){return this.loaded?this.isEditable()||this.mode===v.MODE_SNAPSHOT||"esriGeometryPolyline"!==this.geometryType&&"esriGeometryPolygon"!==this.geometryType&&!this.hasXYFootprint()||(this._autoGeneralize=a,a?(this._autoSnapshot&&(this._prevScale=null),this._updateMaxOffset()):this._setMaxOffset(null)):this._optAutoGen=a,this},setGDBVersion:function(a){return this._collection||
a===this.gdbVersion||!a&&!this.gdbVersion||(this.gdbVersion=a,this._task.gdbVersion=a,this._url.query=p.mixin(this._url.query,{gdbVersion:a}),this.loaded&&(this.clearSelection(),this._map&&this.refresh()),this.onGDBVersionChange()),this},setDefinitionExpression:function(a){this._defnExpr=a;a=this._mode;return a&&a.propertyChangeHandler(1),this},getDefinitionExpression:function(){return this._defnExpr},setTimeDefinition:function(a){this._isSnapshot?(this._timeDefn=a,(a=this._mode)&&a.propertyChangeHandler(2)):
console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id \x3d "+this.id+", Layer URL \x3d "+this.url);return this},getTimeDefinition:function(){return this._timeDefn},setTimeOffset:function(a,c){this._timeOffset=a;this._timeOffsetUnits=c;var b=this._mode;return b&&b.propertyChangeHandler(0),this},setUseMapTime:function(a){this.useMapTime=a;this._toggleTime(!this.suspended);(a=this._mode)&&a.propertyChangeHandler(0)},selectFeatures:function(a,
c,b,d){c=c||v.SELECTION_NEW;var e;a=this._getShallowClone(a);var f=this._map,g=this,k=C._fixDfd(new w(C._dfdCanceller));if(a.outFields=this.getOutFields(),a.returnGeometry=!0,a.multipatchOption=this.multipatchOption,f&&(a.outSpatialReference=new J(f.spatialReference.toJson())),!this._applyQueryFilters(a,!0))return e={features:[]},this._selectHandler(e,c,b,d,k),k;if(f=this._canDoClientSideQuery(a))return k._pendingDfd=N(this._doQuery(a,f)),k._pendingDfd.then(function(a){e={features:a};g._selectHandler(e,
c,b,d,k)}),k;if(this._collection)return this._resolve([Error("FeatureLayer::selectFeatures - "+this.invalidParams)],null,d,k,!0),k;var l=this;this._ts&&(a._ts=(new Date).getTime());return(k._pendingDfd=this._task.execute(a)).addCallbacks(function(a){l._selectHandler(a,c,b,d,k)},function(a){l._resolve([a],null,d,k,!0)}),k},getSelectedFeatures:function(){var a,c=this._selectedFeatures,b=[];for(a in c)c.hasOwnProperty(a)&&b.push(c[a]);return b},clearSelection:function(a){var c,b=this._selectedFeatures,
d=this._mode;for(c in b)b.hasOwnProperty(c)&&(this._unSelectFeatureIIf(c,d),d._removeFeatureIIf(c));return this._selectedFeatures={},this._isSelOnly&&d._applyTimeFilter(!0),a||this.onSelectionClear(),this},setSelectionSymbol:function(a){if(this._selectionSymbol=a,a){var c,b=this._selectedFeatures;for(c in b)b.hasOwnProperty(c)&&b[c].setSymbol(a)}return this},getSelectionSymbol:function(){return this._selectionSymbol},setLabelingInfo:function(a){a?(this.labelingInfo=a,this._fixLabelExpr()):delete this.labelingInfo;
this._collection&&(this._typesDirty=!0);this.onLabelingInfoChange()},_fixLabelExpr:function(){var a,c=/\[([^\[\]]+)\]/gi,b=this,d=function(a,c){var d=b._getField(c,!0);return"["+(d&&d.name||c)+"]"};h.forEach(this.labelingInfo,function(b){(a=b.labelExpression)&&(b.labelExpression=a.replace(c,d))})},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(a,c,b,d,e,f){var g=f.assembly,k=f.dfd;this._applyNormalized(a,g&&g[0]);this._applyNormalized(c,g&&g[1]);this.onBeforeApplyEdits(a,
c,b);var l={},n=this.objectIdField,g={f:"json"},m=!1;if(this._collection)return f={},f.addResults=a?h.map(a,function(){return m=!0,{objectId:this._nextId++,success:!0}},this):null,f.updateResults=c?h.map(c,function(a){m=!0;var b=a.attributes[n];return l[b]=a,{objectId:b,success:!0}},this):null,f.deleteResults=b?h.map(b,function(a){return m=!0,{objectId:a.attributes[n],success:!0}},this):null,void(m?this._editHandler(f,a,l,d,e,k):this._resolve([f.addResults,f.updateResults,f.deleteResults],null,d,
k));if(a&&0<a.length&&(g.adds=this._convertFeaturesToJson(a,0,1),m=!0),c&&0<c.length){for(f=0;f<c.length;f++){var t=c[f];l[t.attributes[n]]=t}g.updates=this._convertFeaturesToJson(c,0,0,1);m=!0}if(b&&0<b.length){c=[];for(f=0;f<b.length;f++)c.push(b[f].attributes[n]);g.deletes=c.join(",");m=!0}if(m){var q=this;return x({url:this._url.path+"/applyEdits",content:p.mixin(g,this._url.query),callbackParamName:"callback",load:function(b){q._editHandler(b,a,l,d,e,k)},error:function(a){q._resolve([a],null,
e,k,!0)}},{usePost:!0})}this._resolve([],null,d,k)},queryFeatures:function(a,c,b){return this._query("execute","onQueryFeaturesComplete",a,c,b)},queryRelatedFeatures:function(a,c,b){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",a,c,b)},queryIds:function(a,c,b){return this._query("executeForIds","onQueryIdsComplete",a,c,b)},queryCount:function(a,c,b){return this._query("executeForCount","onQueryCountComplete",a,c,b)},queryExtent:function(a,c,b){return this._query("executeForExtent",
"onQueryExtentComplete",a,c,b)},queryAttachmentInfos:function(a,c,b){var d=this._url.path+"/"+a+"/attachments",e=new w(C._dfdCanceller),f=this;return e._pendingDfd=x({url:d,content:p.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(b){var k;b=b.attachmentInfos;h.forEach(b,function(b){k=V.objectToQuery({gdbVersion:f._url.query&&f._url.query.gdbVersion,layer:f._url.query&&f._url.query.layer,token:f._getToken()});b.url=d+"/"+b.id+(k?"?"+k:"");b.objectId=a});f._resolve([b],
"onQueryAttachmentInfosComplete",c,e)},error:function(a){f._resolve([a],null,b,e,!0)}}),e},addAttachment:function(a,c,b,d){return this._sendAttachment("add",a,c,b,d)},updateAttachment:function(a,c,b,d,e){return b.appendChild(W.create("input",{type:"hidden",name:"attachmentId",value:c})),this._sendAttachment("update",a,b,d,e)},deleteAttachments:function(a,c,b,d){var e=this._url.path+"/"+a+"/deleteAttachments",f=new w(C._dfdCanceller),g=this;c={f:"json",attachmentIds:c.join(",")};return f._pendingDfd=
x({url:e,content:p.mixin(c,this._url.query),callbackParamName:"callback",load:p.hitch(this,function(c){c=c.deleteAttachmentResults;c=h.map(c,function(b){b=new E(b);return b.attachmentId=b.objectId,b.objectId=a,b});g._resolve([c],"onDeleteAttachmentsComplete",b,f)}),error:function(a){g._resolve([a],null,d,f,!0)}},{usePost:!0}),f},addType:function(a){var c=this.types;if(c){if(h.some(c,function(b){return b.id==a.id?!0:!1}))return!1;c.push(a)}else this.types=[a];return this._typesDirty=!0,!0},deleteType:function(a){if(this._collection){var c=
this.types;if(c){var b=-1;if(h.some(c,function(c,e){return c.id==a?(b=e,!0):!1}),-1<b)return this._typesDirty=!0,c.splice(b,1)[0]}}},toJson:function(){var a=this._json;if(a=p.isString(a)?F.fromJson(a):p.clone(a)){var a=a.layerDefinition?a:{layerDefinition:a},c=a.layerDefinition,b=this._collection;if(b&&this._typesDirty){c.types=h.map(this.types||[],function(a){return a.toJson()});var d=this.renderer,e=this.labelingInfo,f=c.drawingInfo;!d&&!e||f||(f=c.drawingInfo={});f&&d&&-1===d.declaredClass.indexOf("TemporalRenderer")&&
(f.renderer=d.toJson());e&&(f.labelingInfo=h.map(e,function(a){return a.toJson()}))}d=null;if((!b||this._fcAdded)&&(d={geometryType:c.geometryType,features:this._convertFeaturesToJson(this.graphics,!0)}),a.featureSet=p.mixin({},a.featureSet||{},d),a.featureSet.transform)e=a.featureSet.transform,delete a.featureSet.transform,d=new I(a.featureSet),d.quantize(e),a.featureSet=d.toJson();return b&&(a.nextObjectId=this._nextId,c.capabilities=this.capabilities),a}},onSelectionComplete:function(){},onSelectionClear:function(){},
onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryExtentComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},
onLabelingInfoChange:function(){},_forceIdentity:function(a){function c(a){var b=["allowOthersToUpdate","allowOthersToDelete","allowOthersToQuery"];return a&&h.some(b,function(b){return a.hasOwnProperty(b)&&!a[b]})}var b,d=this,e=this._url&&this._url.path,f=e&&e.toLowerCase().indexOf("/rest/services");(this.userIsAdmin||c(this.ownershipBasedAccessControlForFeatures))&&!this._getToken()&&-1<f&&H.id?(b=e.substring(0,f)+"/rest/info",x({url:b,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}).then(function(a){return a.owningSystemUrl?
H.id.checkSignInStatus(a.owningSystemUrl+"/sharing"):void 0}).then(function(a){return a?H.id.getCredential(e):void 0}).then(function(a){a&&d._findCredential()}).always(function(){a.call(d)})):a.call(this)},_checkMode:function(a){var c=this.geometryType,b=this.maxRecordCount;a=(a=a&&a.features&&a.features[0])&&a.attributes&&a.attributes.exceedslimit;this.mode===v.MODE_AUTO&&!this.isEditable()&&0===a&&(this.queryPagination||("esriGeometryPolyline"===c||"esriGeometryPolygon"===c||"esriGeometryMultipoint"===
c||this.hasXYFootprint())&&b>=this.maxRecordCountForAuto||"esriGeometryPoint"===c&&b>=this.maxPointCountForAuto)&&(this.currentMode=v.MODE_SNAPSHOT,this._mode=new L(this),this._isSnapshot=this._autoSnapshot=!0)},_queryLimit:function(){var a=this,c=new w;this._limitPromise=c.promise;setTimeout(function(){var b=new K,d=new fa;d.statisticType="exceedslimit";d.maxPointCount=a.maxPointCountForAuto;d.maxRecordCount=a.maxRecordCountForAuto;d.maxVertexCount=a.maxVertexCountForAuto;d.outStatisticFieldName=
"exceedslimit";b.outStatistics=[d];a.queryFeatures(b).promise.then(function(a){c.resolve(a)},function(a){c.reject(a)})},0)},_updateCaps:function(){var a,c;c=this._editable;var b=p.trim(this.capabilities||""),d=h.map(b?b.split(","):[],p.trim),e=h.map(b?b.toLowerCase().split(","):[],p.trim),b=h.indexOf(e,"editing"),e={Create:h.indexOf(e,"create"),Update:h.indexOf(e,"update"),Delete:h.indexOf(e,"delete")};if(c&&-1===b)d.push("Editing");else if(!c&&-1<b){c=[b];for(a in e)-1<e[a]&&c.push(e[a]);c.sort();
for(a=c.length-1;0<=a;a--)d.splice(c[a],1)}this.capabilities=d.join(",")},_counter:{value:0},_getUniqueId:function(){return this._counter.value++},onSuspend:function(){this.inherited(arguments);this._toggleTime(!1);var a=this._mode;a&&a.suspend()},onResume:function(a){this.inherited(arguments);this._toggleTime(!0);var c=this._mode,b=this._map,d=this._getRenderer();if(a.firstOccurrence){if(this._fixRendererFields(),this._checkFields(),this.clearSelection(),this.timeInfo&&!this._trackManager&&(this._trackIdField||
d&&(d.latestObservationRenderer||d.trackRenderer))&&(this._trackManager=new sa(this),this._trackManager.initialize(b)),d&&"colors"in d&&"blurRadius"in d&&"maxPixelIntensity"in d&&("esriGeometryPoint"!=this.geometryType||this._heatmapManager||(this._heatmapManager=new R(this),this._heatmapManager.initialize(b))),this._autoSnapshot&&this._autoGeneralize&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint())&&!this.isEditable()&&null==this.getMaxAllowableOffset())d=
this.generalizeForScale,this._calculatedScale=d=this.maxScale?this.maxScale:this.minScale?Math.min(d,this.minScale):Math.min(d,ia.getScale(b,this.initialExtent)),this._calcMaxOffset=b.extent.getWidth()/b.width/b.getScale()*d;this._zoomConnect=D.connect(b,"onZoomEnd",this,this._zoomEndHandler);this._updateMaxOffset();this._needsRefresh=!1;c&&c.startup()}else this._zoomEndHandler(),c&&c.resume()},_zoomEndHandler:function(){var a=this._map;this._updateMaxOffset();this._prevScale=a.getScale();!this.suspended&&
this._needsRefresh&&this.refresh()},_updateMaxOffset:function(){var a=this._map;a&&a.loaded&&this._autoGeneralize&&(this._autoSnapshot?(a=this.getMaxAllowableOffset(),this._setMaxOffset(this._getMaxOffsetForScale(),!0),this._needsRefresh||(this._needsRefresh=a!=this.getMaxAllowableOffset())):this._setMaxOffset(a.extent.getWidth()/a.width,!a.extent.spatialReference.isWebMercator()))},_getMaxOffsetForScale:function(){if(this._map){var a=this._map.getScale(),c=this._calculatedScale,b=this._calcMaxOffset,
d=this._prevScale;return a>=c&&(null==d||c>d)?b:c>a&&(null==d||d>=c)?null:this.getMaxAllowableOffset()}},_toggleTime:function(a){var c=this._map;a&&this.timeInfo&&this.useMapTime&&c?(this._mapTimeExtent=c.timeExtent,this._timeConnect||(this._timeConnect=D.connect(c,"onTimeExtentChange",this,this._timeChangeHandler))):(this._mapTimeExtent=null,D.disconnect(this._timeConnect),this._timeConnect=null)},_timeChangeHandler:function(a){this._mapTimeExtent=a;(a=this._mode)&&a.propertyChangeHandler(0)},_getOffsettedTE:function(a){var c=
this._timeOffset,b=this._timeOffsetUnits;return a&&c&&b?a.offset(-1*c,b):a},_getTimeOverlap:function(a,c){return a&&c?a.intersection(c):a||c},_getTimeFilter:function(a){var c,b=this.getTimeDefinition();if(b&&(c=this._getTimeOverlap(b,null),!c))return[!1];if(a){if(a=c?this._getTimeOverlap(a,c):a,!a)return[!1]}else a=c;return[!0,a]},_getAttributeFilter:function(a){var c=this.getDefinitionExpression();return a?c?"("+c+") AND ("+a+")":a:c},_applyQueryFilters:function(a,c){if(a.where=this._getAttributeFilter(a.where),
a.maxAllowableOffset||(a.maxAllowableOffset=this._maxOffset),a.quantizationParameters=this._quantizationParameters,c&&this.supportsAdvancedQueries&&(a.orderByFields=a.orderByFields||this.getOrderByFields()),this.timeInfo){var b=this._getTimeFilter(a.timeExtent);if(!b[0])return!1;a.timeExtent=b[1]}return!0},_add:function(a){var c=this._selectionSymbol,b=a.attributes,d=this.visibilityField;return c&&this._isSelOnly&&a.setSymbol(c),d&&b&&b.hasOwnProperty(d)&&a[b[d]?"show":"hide"](),this.add.apply(this,
arguments)},_remove:function(){return this.remove.apply(this,arguments)},_canDoClientSideQuery:function(a){var c,b=[],d=this._map;if(!(this._isTable||!d&&!this._collection||a.text||a.where&&a.where!==this.getDefinitionExpression()||a.orderByFields&&a.orderByFields.length&&(c=this.getOrderByFields()||[])&&a.orderByFields.join()!==c.join()||a.outStatistics||a.returnDistinctValues)){c=this._isSnapshot;var e=this._isSelOnly,f=a.geometry;if(f){if(e||a.spatialRelationship!==K.SPATIAL_REL_INTERSECTS||"extent"!==
f.type||!c&&!d.extent.contains(f))return;b.push(1)}if(d=a.objectIds){if(!c){for(var g=d.length,k=this._mode,l=0,f=0;g>f;f++)k._getFeature(d[f])&&l++;if(l!==g)return}b.push(2)}if(this.timeInfo)if(a=a.timeExtent,d=this._mapTimeExtent,c)a&&b.push(3);else if(e){if(a)return}else if(d)if(-1!==h.indexOf(b,2))a&&b.push(3);else{if(-1===h.indexOf(b,1))return;a==d&&b.push(3)}else if(0<b.length)a&&b.push(3);else if(a)return;return 0<b.length?b:null}},_getAbsMid:function(a){return M.toAbsMid?M.toAbsMid(a):S.id.replace(/\/[^\/]*$/gi,
"/")+a},_doQuery:function(a,c,b){var d=[],e=this.objectIdField,f=this,g=new w,k=new w,l=this.graphics;if(-1!==h.indexOf(c,1)){var n,m=this.spatialIndex||this._map&&this._map.spatialIndex,t=a.geometry._normalize(null,!0);null==m&&ua.autoSpatialIndexing?n=(this._map||this).addPlugin(this._getAbsMid("../plugins/spatialIndex")).then(p.hitch(this,p.partial(this._getFromIndex,t,m)),function(){k.resolve(p.hitch(this,p.partial(this._filterByExtent,l,t)))}):m&&(n=this._getFromIndex(t,m));n?n.then(function(a){for(var b=
0;b<a.length;b++)a[b].results&&(d=d.concat(a[b].results));k.resolve(d)}).otherwise(function(a){k.reject(a)}):k.resolve(this._filterByExtent(l,t))}else k.resolve(l);return k.then(function(k){if(d=k,-1!==h.indexOf(c,2)){var l=a.objectIds;d=h.filter(d,function(a){return-1<h.indexOf(l,a.attributes[e])})}-1!==h.indexOf(c,3)&&f.timeInfo&&(k=a.timeExtent,d=f._filterByTime(d,k.startTime,k.endTime).match);b&&(d=h.map(d,function(a){return a.attributes[e]},this));g.resolve(d)}),g},_getFromIndex:function(a,c){c=
c||this.spatialIndex||this._map.spatialIndex;a instanceof Array||(a=[a]);var b=this.id;return X(h.map(a,function(a){return c.intersects(a,b)}))},_filterByExtent:function(a,c){for(var b=[],d=0,e=a.length;e>d;d++){var f=a[d],g=f.geometry;g&&(this.normalization&&c.length?(c[0].intersects(g)||c[1].intersects(g))&&b.push(f):c.intersects(g)&&b.push(f))}return b},_filterByTime:function(a,c,b){var d,e=this._startTimeField,f=this._endTimeField;this._twoTimeFields||(d=e||f);var g,k,l,h=r.isDefined,m=[],p=[],
q=a.length;if(c=c?c.getTime():-1/0,b=b?b.getTime():1/0,d)for(g=0;q>g;g++)k=a[g],l=k.attributes,e=l[d],e>=c&&b>=e?m.push(k):p.push(k);else for(g=0;q>g;g++)k=a[g],l=k.attributes,d=l[e],l=l[f],d=h(d)?d:-1/0,l=h(l)?l:1/0,d>=c&&b>=d||l>=c&&b>=l||c>=d&&l>=b?m.push(k):p.push(k);return{match:m,noMatch:p}},_resolve:function(a,c,b,d,e){c&&this[c].apply(this,a);b&&b.apply(null,a);d&&C._resDfd(d,a,e)},_getShallowClone:function(a){var c,b=new K;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_query:function(a,
c,b,d,e){var f,g,k=this,l=this._map,n=new w(C._dfdCanceller),m=b;if("executeRelationshipQuery"!==a){var m=this._getShallowClone(b),p=this.getOutFields();m.outFields||(m.outFields=p);m.outFields&&m.outFields.length&&(g=-1<h.indexOf(p,"*")?!1:!h.every(m.outFields,function(a){return-1<h.indexOf(p,a)}));m.returnGeometry=b.hasOwnProperty("returnGeometry")?b.returnGeometry:!b.outStatistics;m.returnGeometry&&(m.multipatchOption=this.multipatchOption);var q;l&&(b=l&&l.spatialReference,(l=m.outSpatialReference)?
f=!l.equals(b):m.outSpatialReference=new J(b.toJson()));if(!this._applyQueryFilters(m,"execute"===a&&!m.outStatistics)){switch(a){case "execute":q=new I({features:[]});break;case "executeForIds":q=[];break;case "executeForCount":q=0;break;case "executeForExtent":q={}}return this._resolve([q],c,d,n),n}if(b="executeForExtent"!==a&&!f&&!g&&this._canDoClientSideQuery(m))return n._pendingDfd=N(this._doQuery(m,b,"executeForIds"===a||"executeForCount"===a)),n._pendingDfd.then(function(b){switch(a){case "execute":q=
new I;q.features=b;break;case "executeForIds":q=b;break;case "executeForCount":q=b.length}k._resolve([q],c,d,n)}),n}if(this._collection)return this._resolve([Error("FeatureLayer::_query - "+this.invalidParams)],null,e,n,!0),n;this._ts&&(m._ts=(new Date).getTime());return(n._pendingDfd=this._task[a](m)).addCallbacks(function(b){var e=!!m.outStatistics||f||g;if("execute"===a||"executeRelationshipQuery"===a){var l,h;if("execute"===a)for(l=b.features,h=l.length,--h;0<=h;h--){if(l[h]._layer=k,!e&&!k._isTable){var p=
k._mode._getFeature(l[h].attributes[k.objectIdField]);p&&l.splice(h,1,p)}}else for(p in b)if(b.hasOwnProperty(p))for(l=b[p].features,h=l.length,--h;0<=h;h--)l[h]._layer=k}k._resolve([b],c,d,n)},function(a){k._resolve([a],null,e,n,!0)}),n},_convertFeaturesToJson:function(a,c,b,d){var e,f=[],g=this._selectionSymbol,k=this.visibilityField,l=this.objectIdField;this.loaded&&(b||d)&&(e=h.filter(this.fields,function(a){return!1===a.editable&&(!d||a.name!==l)}));for(b=0;b<a.length;b++){var n=a[b],m={},t=
n.geometry,q=n.attributes,u=n.symbol;!t||d&&this.loaded&&!this.allowGeometryUpdates||(m.geometry=t.toJson());k?(m.attributes=q=p.mixin({},q),q[k]=n.visible?1:0):q&&(m.attributes=p.mixin({},q));m.attributes&&e&&e.length&&h.forEach(e,function(a){delete m.attributes[a.name]});u&&u!==g&&(m.symbol=u.toJson());f.push(m)}return c?f:F.toJson(f)},_selectHandler:function(a,c,b,d,e){var f;d=v;switch(c){case d.SELECTION_NEW:this.clearSelection(!0);f=!0;break;case d.SELECTION_ADD:f=!0;break;case d.SELECTION_SUBTRACT:f=
!1}var g,k;d=a.features;var h=this._mode,n=[],m=this.objectIdField;if(f)for(f=0;f<d.length;f++)g=d[f],k=g.attributes[m],g=h._addFeatureIIf(k,g),n.push(g),this._selectFeatureIIf(k,g,h);else for(f=0;f<d.length;f++)g=d[f],k=g.attributes[m],this._unSelectFeatureIIf(k,h),k=h._removeFeatureIIf(k),n.push(k||g);this._isSelOnly&&h._applyTimeFilter(!0);this._resolve([n,c,a.exceededTransferLimit?{queryLimitExceeded:!0}:null],"onSelectionComplete",b,e);a.exceededTransferLimit&&this.onQueryLimitExceeded()},_selectFeatureIIf:function(a,
c,b){var d=this._selectedFeatures,e=d[a];return e||(b._incRefCount(a),d[a]=c,this._isTable||(this._setSelectSymbol(c),c.attr("data-selected",""))),e||c},_unSelectFeatureIIf:function(a,c){var b=this._selectedFeatures[a];return b&&(c._decRefCount(a),delete this._selectedFeatures[a],this._isTable||(this._setUnSelectSymbol(b),b.attr("data-selected"))),b},_isSelected:function(){},_setSelectSymbol:function(a){var c=this._selectionSymbol;c&&!this._isSelOnly&&a.setSymbol(c)},_setUnSelectSymbol:function(a){var c=
this._selectionSymbol;c&&!this._isSelOnly&&c===a.symbol&&a.setSymbol(null,!0)},_getOutFields:function(){var a=[this.objectIdField,this.typeIdField,this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._rendererFields).concat(this.dataAttributes),a=h.filter(a,function(a,c,e){return!!a&&h.indexOf(e,a)===c}),c=p.clone(this._outFields);return c?-1!==h.indexOf(c,"*")?c:(h.forEach(a,function(a){-1===h.indexOf(c,a)&&c.push(a)}),c):a},_checkFields:function(a){var c=a||
this._getOutFields();(h.forEach(c,function(a){"*"!==a&&(this._getField(a)||console.debug("esri.layers.FeatureLayer: "+r.substitute({url:this.url,field:a},"unable to find '${field}' field in the layer 'fields' information [url: ${url}]")))},this),a||this._isTable||this._fserver||this._collection||this._isStream)||h.some(this.fields,function(a){return a&&"esriFieldTypeGeometry"===a.type?!0:!1})||console.debug("esri.layers.FeatureLayer: "+r.substitute({url:this.url},"unable to find a field of type 'esriFieldTypeGeometry' in the layer 'fields' information. If you are using a map service layer, features will not have geometry [url: ${url}]"))},
_fixFieldCase:function(a,c,b){var d,e=a&&a[c];return e&&!p.isFunction(e)&&(d=!this._getField(e)&&this._getField(e,!0),d&&(e=a[c]=d.name),b&&b.push(e)),e},_fixRendererFields:function(){var a=this.renderer;if(this._orderBy=null,a&&0<this.fields.length){var c,b=[],a=h.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],r.isDefined),d=[].concat(a);h.forEach(a,function(a){h.forEach(a.rendererInfos,function(a){a.renderer&&d.push(a.renderer)})});h.forEach(d,function(a){this._fixFieldCase(a,
"attributeField",b);this._fixFieldCase(a,"attributeField2",b);this._fixFieldCase(a,"attributeField3",b);this._fixFieldCase(a.rotationInfo,"field",b);(c=this._fixFieldCase(a.sizeInfo,"field",b))&&(this._orderBy||(this._orderBy=[c+" DESC"]));this._fixFieldCase(a.sizeInfo,"normalizationField",b);this._fixFieldCase(a.colorInfo,"field",b);this._fixFieldCase(a.colorInfo,"normalizationField",b);this._fixFieldCase(a.field,"field",b);this._fixFieldCase(a.opacityInfo,"field",b);this._fixFieldCase(a.opacityInfo,
"normalizationField",b);h.forEach(a.visualVariables,function(a){c=this._fixFieldCase(a,"field",b);"sizeInfo"===a.type&&c&&!this._orderBy&&(this._orderBy=[c+" DESC"]);this._fixFieldCase(a,"normalizationField",b)},this);this._orderBy||!a.addBreak||p.isFunction(a.attributeField)||!a.backgroundFillSymbol&&!this._hasSizeDiff(a)||(this._orderBy=[a.attributeField+" DESC"])},this);this._rendererFields=h.filter(b,r.isDefined)}},_hasSizeDiff:function(a){var c,b,d=Number.MAX_VALUE,e=-Number.MAX_VALUE;return h.forEach(a.infos,
function(a){if(b=a.symbol){switch(c=0,b.type){case "simplemarkersymbol":c=b.size;break;case "picturemarkersymbol":c=(b.width+b.height)/2;break;case "simplelinesymbol":case "cartographiclinesymbol":c=b.width;break;case "simplefillsymbol":case "picturefillsymbol":c=b.outline&&b.outline.width}c&&(d=Math.min(d,c),e=Math.max(e,c))}}),d!==Number.MAX_VALUE&&e!==-Number.MAX_VALUE&&1<Math.abs(e-d)},getOrderByFields:function(){var a=this.orderByFields||this._orderBy;return this.supportsAdvancedQueries&&a?h.filter(a,
function(a){return a=a.split(" ")[0],!!this._getField(a,!0)},this):null},_getField:function(a,c){var b=this.fields;if(!b||0===b.length)return null;var d;return c&&(a=a.toLowerCase()),h.some(b,function(b){var f=!1;return f=c?b&&b.name.toLowerCase()===a?!0:!1:b&&b.name===a?!0:!1,f&&(d=b),f}),d},_getDateOpts:function(){this._dtOpts||(this._dtOpts={properties:h.map(h.filter(this.fields,function(a){return!(!a||"esriFieldTypeDate"!==a.type)}),function(a){return a.name})});return this._dtOpts},_applyNormalized:function(a,
c){a&&c&&h.forEach(a,function(a,d){a&&c[d]&&a.setGeometry(c[d])})},_editHandler:function(a,c,b,d,e,f){var g,k,l,n,m;e=a.addResults;var t=a.updateResults;a=a.deleteResults;var q=this.objectIdField,u=this._mode,r=this._isTable;g=this.editFieldsInfo;var y=this.getOutFields()||[],z=g&&g.creatorField,w=g&&g.creationDateField,A=g&&g.editorField,B=g&&g.editDateField;g=g&&g.realm;-1===h.indexOf(y,"*")&&(z&&-1===h.indexOf(y,z)&&(z=null),w&&-1===h.indexOf(y,w)&&(w=null),A&&-1===h.indexOf(y,A)&&(A=null),B&&
-1===h.indexOf(y,B)&&(B=null));var y=w||B?(new Date).getTime():null,x=z||A?this.getUserId():void 0;if(x&&g&&(x=x+"@"+g),e)for(g=0;g<e.length;g++)if(e[g]=new E(e[g]),!r&&(k=e[g],k.success))l=k.objectId,n=c[g],(m=n._graphicsLayer)&&m!==this&&m.remove(n),m=n.attributes||{},m[q]=l,z&&(m[z]=x),A&&(m[A]=x),w&&(m[w]=y),B&&(m[B]=y),n.setAttributes(m),u._init&&u.drawFeature(n);if(t)for(g=0;g<t.length;g++)if(t[g]=new E(t[g]),!r&&(k=t[g],k.success))l=k.objectId,n=b[l],(c=u._getFeature(l))&&(c.geometry!==n.geometry&&
n.geometry&&c.setGeometry(ga.fromJson(n.geometry.toJson())),c.attributes!==n.attributes&&n.attributes&&c.setAttributes(p.mixin(c.attributes,n.attributes)),this._repaint(c,l)),n=c||n,m=n.attributes||{},A&&(m[A]=x),B&&(m[B]=y),n.setAttributes(m);if(a){b=[];for(g=0;g<a.length;g++)a[g]=new E(a[g]),r||(k=a[g],k.success&&(l=k.objectId,n=u._getFeature(l),n&&(this._unSelectFeatureIIf(l,u)&&b.push(n),n._count=0,u._removeFeatureIIf(l))));0<b.length&&this.onSelectionComplete(b,v.SELECTION_SUBTRACT)}this._resolve([e,
t,a],"onEditsComplete",d,f)},_sendAttachment:function(a,c,b,d,e){var f=this;return x({url:this._url.path+"/"+c+"/"+("add"===a?"addAttachment":"updateAttachment"),form:b,content:p.mixin(this._url.query,{f:"json",token:this._getToken()||void 0}),callbackParamName:"callback.html",handleAs:"json"}).addCallback(function(b){var e="add"===a?"onAddAttachmentComplete":"onUpdateAttachmentComplete";b=new E(b["add"===a?"addAttachmentResult":"updateAttachmentResult"]);return b.attachmentId=b.objectId,b.objectId=
c,f._resolve([b],e,d),b}).addErrback(function(a){f._resolve([a],null,e,null,!0)})},_repaint:function(a,c,b){c=r.isDefined(c)?c:a.attributes[this.objectIdField];c in this._selectedFeatures&&this._selectionSymbol||a.setSymbol(a.symbol,b)},_getKind:function(a){var c=this._trackManager;return c&&c.isLatestObservation(a)?1:0}});return p.mixin(v,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,MODE_AUTO:6,MODE_STREAM:7,POPUP_NONE:"esriServerHTMLPopupTypeNone",
POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"}),ha._createWrappers(v),G("extend-esri")&&p.setObject("layers.FeatureLayer",v,H),v});