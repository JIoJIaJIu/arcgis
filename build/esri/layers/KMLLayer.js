//>>built
define("esri/layers/KMLLayer","dojo/_base/kernel dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/sniff dojo/io-query dojo/dom-construct dojo/dom-style ../kernel ../config ../lang ../request ../SpatialReference ../geometry/webMercatorUtils ../dijit/PopupTemplate ./layer ./KMLFolder ./KMLGroundOverlay ./MapImageLayer ./FeatureLayer".split(" "),function(w,x,l,h,f,y,z,t,u,A,n,v,B,C,D,p,E,F,G,H,I,J){var r=x([F],{declaredClass:"esri.layers.KMLLayer",serviceUrl:location.protocol+
"//utility.arcgis.com/sharing/kml",constructor:function(a,b){a||console.log("KMLLayer:constructor - please provide url for the KML file");this._outSR=b&&b.outSR||new D({wkid:4326});this._options=h.mixin({},b);v.defaults.kmlService&&(this.serviceUrl=v.defaults.kmlService);var c=this.linkInfo=b&&b.linkInfo;c&&(this.visible=!!c.visibility,this._waitingForMap=!!c.viewFormat);(!c||c&&c.visibility&&!this._waitingForMap)&&this._parseKml();this.refresh=h.hitch(this,this.refresh);this.registerConnectEvents("esri.layers.KMLLayer",
!0)},getFeature:function(a){if(a){var b,c;c=a.type;var e=a.id;switch(c){case "esriGeometryPoint":case "esriGeometryPolyline":case "esriGeometryPolygon":(a=this["_"+c])&&(b=h.getObject("_mode._featureMap."+e,!1,a));break;case "GroundOverlay":if(a=this._groundLyr){var d=a.getImages();c=d.length;for(a=0;c>a;a++)if(d[a].id===e){b=d[a];break}}break;case "ScreenOverlay":break;case "NetworkLink":f.some(this._links,function(a){return a.linkInfo&&a.linkInfo.id===e?(b=a,!0):!1});break;case "Folder":c=(d=this.folders)?
d.length:0;for(a=0;c>a;a++)if(d[a].id===e){b=d[a];break}break;default:console.log("KMLLayer:getFeature - unknown feature type")}return b}},getLayers:function(){var a=[];return this._groundLyr&&a.push(this._groundLyr),this._fLayers&&(a=a.concat(this._fLayers)),this._links&&f.forEach(this._links,function(b){b.declaredClass&&a.push(b)}),a},setFolderVisibility:function(a,b){a&&(this._fireUpdateStart(),a.visible=b,b&&(b=this._areLocalAncestorsVisible(a)),this._setState(a,b),this._fireUpdateEnd())},onRefresh:function(){},
onOpacityChange:function(){},_parseKml:function(a){var b=this;this._fireUpdateStart();this._io=C({url:this.serviceUrl,content:{url:this._url.path+this._getQueryParameters(a),model:"simple",folders:"",refresh:this.loaded?!0:void 0,outSR:y.toJson(this._outSR.toJson())},callbackParamName:"callback",load:function(a){b._io=null;b._initLayer(a)},error:function(a){b._io=null;a=h.mixin(Error(),a);a.message="Unable to load KML: "+b.url+" "+(a.message||"");b._fireUpdateEnd(a);b.onError(a)}})},_initLayer:function(a){var b;
this.loaded&&(b=[],f.forEach(this.folders,function(a){a.visible&&b.push(a.id)}),this._options.minScale=this.minScale,this._options.maxScale=this.maxScale,this._options.opacity=this.opacity,this._removeInternalLayers());this.name=a.name;this.description=a.description;this.snippet=a.snippet;this.visibility=a.visibility;this.featureInfos=a.featureInfos;var c,e,d,m=this.folders=a.folders,k=[];if(m)for(e=m.length,c=0;e>c;c++)d=m[c]=new G(m[c]),-1===d.parentFolderId&&k.push(d);var g;e=(d=this._links=a.networkLinks)?
d.length:0;for(c=0;e>c;c++)d[c].viewRefreshMode&&-1!==d[c].viewRefreshMode.toLowerCase().indexOf("onregion")||(g=h.mixin({},this._options),g.linkInfo=d[c],g.id&&(g.id=g.id+"_"+c),d[c]=new r(d[c].href,g),d[c]._parentLayer=this,d[c]._parentFolderId=this._getLinkParentId(d[c].linkInfo.id));if((d=a.groundOverlays)&&0<d.length)for(g=h.mixin({},this._options),g.id&&(g.id+="_mapImage"),m=this._groundLyr=new I(g),e=d.length,c=0;e>c;c++)m.addImage(new H(d[c]));a=h.getObject("featureCollection.layers",!1,a);
if(a&&0<a.length&&(this._fLayers=[],f.forEach(a,function(a,b){var c,d=h.getObject("featureSet.features",!1,a);d&&0<d.length&&(g=h.mixin({outFields:["*"],infoTemplate:a.popupInfo?new E(a.popupInfo):null,editable:!1},this._options),g.id&&(g.id=g.id+"_"+b),a.layerDefinition.capabilities="Query,Data",c=new J(a,g),c.geometryType&&(this["_"+c.geometryType]=c),this._fLayers.push(c))},this),0===this._fLayers.length&&delete this._fLayers),!this.loaded)for(e=k.length,c=0;e>c;c++)d=k[c],this._setState(d,d.visible);
this._fireUpdateEnd();this.loaded?(this._addInternalLayers(),f.forEach(this.folders,function(a){-1<f.indexOf(b,a.id)?this.setFolderVisibility(a,!0):this.setFolderVisibility(a,!1)},this),this.onRefresh()):(this.loaded=!0,this.onLoad(this))},_addInternalLayers:function(){var a=this._map;this._fireUpdateStart();this._links&&f.forEach(this._links,function(b){b.declaredClass&&(a.addLayer(b),b._waitingForMap&&(b._waitingForMap=null,b.visible?b._parseKml(a):b._wMap=a))});var b,c=a.spatialReference,e=this._outSR;
if(!c.equals(e))if(c.isWebMercator()&&4326===e.wkid)b=p.geographicToWebMercator;else{if(!e.isWebMercator()||4326!==c.wkid)return void console.log("KMLLayer:_setMap - unsupported workflow. Spatial reference of the map and kml layer do not match, and the conversion cannot be done on the client.");b=p.webMercatorToGeographic}this._groundLyr&&(b&&f.forEach(this._groundLyr.getImages(),function(a){a.extent=b(a.extent)}),a.addLayer(this._groundLyr));(c=this._fLayers)&&0<c.length&&f.forEach(c,function(c){if(b){var e,
f,g=c.graphics,h=g?g.length:0;for(e=0;h>e;e++)(f=g[e].geometry)&&g[e].setGeometry(b(f))}a.addLayer(c)});this.onVisibilityChange(this.visible)},_removeInternalLayers:function(){var a=this._map;this._links&&f.forEach(this._links,function(a){a.declaredClass&&a._io&&a._io.cancel()});a&&f.forEach(this.getLayers(),a.removeLayer,a)},_setState:function(a,b){var c,e,d,f=a.featureInfos,k=f?f.length:0,g=b?"show":"hide";for(d=0;k>d;d++)c=f[d],(e=this.getFeature(c))&&("Folder"===c.type?this._setState(e,b&&e.visible):
"NetworkLink"===c.type?this._setInternalVisibility(e,b):e[g]())},_areLocalAncestorsVisible:function(a){var b=a.parentFolderId;for(a=a.visible;a&&-1!==b;)b=this.getFeature({type:"Folder",id:b}),a=a&&b.visible,b=b.parentFolderId;return a},_setInternalVisibility:function(a,b){var c=a._parentLayer,e=a._parentFolderId;for(b=b&&a.visible;b&&c;)b=b&&c.visible,-1<e&&(b=b&&c._areLocalAncestorsVisible(c.getFeature({type:"Folder",id:e}))),e=c._parentFolderId,c=c._parentLayer;this._setIntState(a,b)},_setIntState:function(a,
b){a&&f.forEach(a.getLayers(),function(c){c.linkInfo?a._setIntState(c,b&&c.visible&&a._areLocalAncestorsVisible(a.getFeature({type:"Folder",id:c._parentFolderId}))):c.setVisibility(b)})},_getLinkParentId:function(a){var b=-1;return this.folders&&f.some(this.folders,function(c){return c.networkLinkIds&&-1!==f.indexOf(c.networkLinkIds,a)?(b=c.id,!0):!1}),b},_checkAutoRefresh:function(){var a=this.linkInfo;if(a)if(this.visible){if(this.loaded&&this._map){var b=a.refreshMode,c=a.refreshInterval,e=a.viewRefreshMode,
a=a.viewRefreshTime;b&&-1!==b.toLowerCase().indexOf("oninterval")&&0<c&&(this._stopAutoRefresh(),this._timeoutHandle=setTimeout(this.refresh,1E3*c));e&&-1!==e.toLowerCase().indexOf("onstop")&&0<a&&(this._extChgHandle||(this._extChgHandle=l.connect(this._map,"onExtentChange",this,this._extentChanged)))}}else this._stopAutoRefresh(),l.disconnect(this._extChgHandle),delete this._extChgHandle},_stopAutoRefresh:function(){clearTimeout(this._timeoutHandle);this._timeoutHandle=null},_getQueryParameters:function(a){a=
a||this._map;var b,c={},e=this.linkInfo,d=a&&a.extent;(this._url.query&&(h.mixin(c,this._url.query),b=!!this._url.query.token),n.id&&!b)&&(b=n.id.findCredential(this._url.path))&&(c.token=b.token);if(e){b=e.viewFormat;var f=e.httpQuery,e=e.viewBoundScale;if(d&&b){var k=d,g=d,l=d.spatialReference;l&&(l.isWebMercator()?k=p.webMercatorToGeographic(d):4326===l.wkid&&(g=p.geographicToWebMercator(d)));d=k.getCenter();g=Math.max(g.getWidth(),g.getHeight());e&&(k=k.expand(e));b=b.replace(/\[bboxWest\]/gi,
k.xmin).replace(/\[bboxEast\]/gi,k.xmax).replace(/\[bboxSouth\]/gi,k.ymin).replace(/\[bboxNorth\]/gi,k.ymax).replace(/\[lookatLon\]/gi,d.x).replace(/\[lookatLat\]/gi,d.y).replace(/\[lookatRange\]/gi,g).replace(/\[lookatTilt\]/gi,0).replace(/\[lookatHeading\]/gi,0).replace(/\[lookatTerrainLon\]/gi,d.x).replace(/\[lookatTerrainLat\]/gi,d.y).replace(/\[lookatTerrainAlt\]/gi,0).replace(/\[cameraLon\]/gi,d.x).replace(/\[cameraLat\]/gi,d.y).replace(/\[cameraAlt\]/gi,g).replace(/\[horizFov\]/gi,60).replace(/\[vertFov\]/gi,
60).replace(/\[horizPixels\]/gi,a.width).replace(/\[vertPixels\]/gi,a.height).replace(/\[terrainEnabled\]/gi,0);h.mixin(c,t.queryToObject(b))}f&&(f=f.replace(/\[clientVersion\]/gi,n.version).replace(/\[kmlVersion\]/gi,2.2).replace(/\[clientName\]/gi,"ArcGIS API for JavaScript").replace(/\[language\]/gi,w.locale),h.mixin(c,t.queryToObject(f)))}var q;a=[];for(q in c)B.isDefined(c[q])&&a.push(q+"\x3d"+c[q]);return a=a.join("\x26"),a?"?"+a:""},setScaleRange:function(a,b){this.inherited(arguments);f.forEach(this.getLayers(),
function(c){c.setScaleRange(a,b)})},setOpacity:function(a){this.opacity!=a&&(f.forEach(this.getLayers(),function(b){b.setOpacity(a)}),this.opacity=a,this.onOpacityChange(a))},_setMap:function(a,b){this.inherited(arguments);this._map=a;var c=this._div=u.create("div",null,b);return A.set(c,"position","absolute"),this._addInternalLayers(),this.evaluateSuspension(),c},_unsetMap:function(a,b){this._io&&this._io.cancel();this._stopAutoRefresh();l.disconnect(this._extChgHandle);delete this._extChgHandle;
this._removeInternalLayers();var c=this._div;c&&(b.removeChild(c),u.destroy(c));this._wMap=this._div=null;this.inherited(arguments)},onVisibilityChange:function(a){return this.loaded?(this._fireUpdateStart(),this._setInternalVisibility(this,a),this._checkAutoRefresh(),void this._fireUpdateEnd()):void(this.linkInfo&&a&&(this._waitingForMap||this._parseKml(this._wMap)))},refresh:function(){this.loaded&&this._map&&!this._io&&this.visible&&this._parseKml()},getFeatureCollection:function(a){var b,c=[];
a=this.getFeature({type:"Folder",id:a});return a&&(b=f.map(a.featureInfos,function(a){return"esriGeometryPoint"===a.type||"esriGeometryPolyline"===a.type||"esriGeometryPolygon"===a.type?a.id:void 0},this),b&&0<b.length&&f.forEach(this._fLayers,function(a){var d,h;d=a.toJson();d.featureSet.features&&0<d.featureSet.features.length&&(h=f.filter(d.featureSet.features,function(c){return-1!==f.indexOf(b,c.attributes[a.objectIdField])?c:void 0},this));h&&0<h.length&&(d.featureSet.features=h,c.push(d))},
this)),c},getFeatureCount:function(a){a=this.getFeature({type:"Folder",id:a});var b={points:0,polylines:0,polygons:0};return a&&f.forEach(a.featureInfos,function(a){"esriGeometryPoint"===a.type&&(b.points+=1);"esriGeometryPolyline"===a.type&&(b.polylines+=1);"esriGeometryPolygon"===a.type&&(b.polygons+=1)}),b},_extentChanged:function(){this._stopAutoRefresh();this._timeoutHandle=setTimeout(this.refresh,1E3*this.linkInfo.viewRefreshTime)}});return z("extend-esri")&&h.setObject("layers.KMLLayer",r,
n),r});