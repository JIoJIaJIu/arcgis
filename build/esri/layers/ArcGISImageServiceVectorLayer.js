//>>built
define("esri/layers/ArcGISImageServiceVectorLayer","dojo/_base/declare dojo/_base/lang dojo/_base/connect dojo/_base/json dojo/sniff ../kernel ../lang ./GraphicsLayer ./ImageServiceLayerMixin ../renderers/VectorFieldRenderer ../geometry/Point ../geometry/Extent ../graphic dojox/gfx".split(" "),function(h,m,A,t,q,u,k,v,w,r,x,y,z,p){h=h([v,w],{declaredClass:"esri.layers.ArcGISImageServiceVectorLayer",constructor:function(a,c){this.symbolTileSize=c&&c.symbolTileSize?c.symbolTileSize:50;this._maxMag=
this._minMag=null;this.setVectorRendererStyle(c&&c.rendererStyle?c.rendererStyle:r.STYLE_SINGLE_ARROW);var b=m.clone(this._params);delete b.imageServiceParameters;delete b.pixelFilter;delete b.rendererStyle;delete b.symbolTileSize;this._initialize(a,c);this.geometryType="esriGeometryPoint";this.symbolTileSizeUnits="Pixels";m.mixin(this._params,b)},getField:function(a){return this._getField(a,!0)},setVectorRendererStyle:function(a){this.rendererStyle=a;this._updateVectorFieldRenderer();this.useDefaultRenderer=
!0},setRenderer:function(){this.useDefaultRenderer=!1;this.inherited(arguments)},getFlowRepresentation:function(){return this._vectorFlowRepresentation},onRendererChange:function(){},onResume:function(){this.inherited(arguments);this._toggleTime()},onSuspend:function(){this.inherited(arguments);this._toggleTime()},_refresh:function(){if(10>q("ie"))return void this.onError(Error("Unable to refresh. This layer is not supported in the current browser."));if(!1===this.hasMultidimensions)return void this.onError(Error("Unable to refresh. This layer does not have multi-dimensional info."));
this.setImageFormat("LERC",!0);var a=this.fullExtent.xmin,c=this.fullExtent.ymax,b=m.clone(this._map.extent),f=1/this.symbolTileSize*this._map.width,f=f?Math.ceil(f):50,d=1/this.symbolTileSize*this._map.height,d=Math.ceil(d?d:(b.ymax-b.ymin)/(b.xmax-b.xmin)*f),e=(b.xmax-b.xmin)/f,g=(b.ymax-b.ymin)/d;b.xmin=a+Math.floor((b.xmin-a)/e)*e;b.xmax=a+Math.ceil((b.xmax-a)/e)*e;b.ymin=c+Math.floor((b.ymin-c)/g)*g;b.ymax=c+Math.ceil((b.ymax-c)/g)*g;this._requestData(b,f,d)},_drawPixelData:function(){if(this.clear(),
this.pixelData){var a=this.pixelData.pixelBlock,c=this.pixelData.extent,b=this.pixelData.locations,f=k.isDefined(a.mask)&&0<a.mask.length;if(a&&c&&b){if(this.useDefaultRenderer&&this.renderer&&(!k.isDefined(this._minMag)||!k.isDefined(this._maxMag))){var d=this._getServiceMinMaxStats();d?(this._minMag=d.min,this._maxMag=d.max):(this._minMag=a.statistics[0].minValue,this._maxMag=a.statistics[0].maxValue);var d={type:"sizeInfo",minSize:p.px2pt(.2*this.symbolTileSize),maxSize:p.px2pt(.8*this.symbolTileSize),
minDataValue:this._minMag,maxDataValue:this._maxMag},e=[];e.push(d);e.push({type:"colorInfo"});this.renderer.setVisualVariables(e)}for(var g,l,n=e=d=0,h=c.spatialReference?c.spatialReference._getInfo():null,d=0;d<a.height;d++)for(e=0;e<a.width;e++,n++)if(g=b[n],(!f||a.mask[n])&&g&&2===g.length){l=new x(g[0],g[1],c.spatialReference);h&&(l.x=y.prototype._normalizeX(l.x,h).x);var m={Magnitude:a.pixels[0][n],Direction:a.pixels[1][n],Location:t.toJson(l.toJson())};l=new z(l,null,m);this.add(l)}}}},_getServiceMinMaxStats:function(){if(!k.isDefined(this.minValues)||
!k.isDefined(this.maxValues)||2>this.minValues.length||2>this.maxValues.length)return null;var a=this.minValues[0],c=this.maxValues[0],b=this.minValues[1],f=this.maxValues[1];if(this.pixelFilter&&a&&c&&b&&f){var d=[];d.push([a,c]);d.push([b,f]);b=this._createPixelData(d);this.pixelFilter(b);b&&b.pixelBlock&&b.pixelBlock.pixels&&0<b.pixelBlock.pixels.length&&(a=b.pixelBlock.pixels[0][0],c=b.pixelBlock.pixels[0][1])}return a&&c?{min:a,max:c}:null},_updateVectorFieldRenderer:function(){var a={type:"sizeInfo",
minSize:p.px2pt(.2*this.symbolTileSize),maxSize:p.px2pt(.8*this.symbolTileSize),minDataValue:this._minMag,maxDataValue:this._maxMag},c=[];c.push(a);a=new r({style:this.rendererStyle,visualVariables:c,flowRepresentation:this._vectorFlowRepresentation});this.setRenderer(a)},_getField:function(a,c){if(k.isDefined(a))return(c&&(a=a.toLowerCase()),"magnitude"!==a&&"direction"!==a)?null:{name:a,alias:a,domain:null,editable:!1,length:50,type:"esriFieldTypeDouble"}},_requestDataErrorHandler:function(a){"CancelError"!==
a.name&&(this.clear(),this.onError(a))},_setFlowRepresentation:function(a){a&&this.renderer&&k.isDefined(a.FlowDirection)&&(this._vectorFlowRepresentation="oceanographic"===a.FlowDirection.toLowerCase()?this.renderer.FLOW_TO:this.renderer.FLOW_FROM);this.renderer&&(this.renderer.flowRepresentation=this._vectorFlowRepresentation)}});return q("extend-esri")&&m.setObject("layers.ArcGISImageServiceVectorLayer",h,u),h});