//>>built
define("esri/layers/ImageServiceLayerMixin","dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/json dojo/_base/config dojo/_base/connect dojo/has dojo/io-query ../kernel ../config ../lang ../request ../deferredUtils ../urlUtils ../geometry/Extent ../geometry/Point ../geometry/Polygon ./MosaicRule ./RasterFunction ./DimensionalDefinition ./Raster ./PixelBlock ./pixelFilters/VectorFieldPixelFilter ./rasterFormats/ImageCanvasDecoder ./TimeInfo ./Field ../graphic ../tasks/ImageServiceIdentifyTask ../tasks/ImageServiceIdentifyParameters".split(" "),
function(y,f,n,p,A,K,N,Q,R,S,T,B,E,t,L,J,U,V,r,O,P,W,M,X,Y,Z,aa,ba,ca,da){y=y(null,{declaredClass:"esri.layers.ImageServiceLayerMixin",_rasterFieldPrefix:"Raster.",_renderingRuleFieldSubPrefix:"ServicePixelValue.",_eventMap:{"rendering-change":!0,"mosaic-rule-change":!0},constructor:function(a,b){this.useMapTime=b&&b.hasOwnProperty("useMapTime")?!!b.useMapTime:!0},_initialize:function(a,b){this._url=L.urlToObject(a);this.raster=new W(a);this.infoTemplate=b&&b.infoTemplate;var c=b&&b.imageServiceParameters;
this.format=c&&c.format;this.compressionTolerance=c&&c.compressionTolerance?c.compressionTolerance:.01;this.interpolation=c?c.interpolation:null;this.compressionQuality=c?c.compressionQuality:null;this.bandIds=c?c.bandIds:null;this.mosaicRule=c?c.mosaicRule:null;this.renderingRule=c?c.renderingRule:null;this.useMapDimensionValue=b&&b.hasOwnProperty("useMapDimensionValue")?!!b.useMapDimensionValue:!0;this.activeMapDimensions=b&&b.activeMapDimensions;this._params=f.mixin({},this._url.query,{f:"image",
interpolation:this.interpolation,format:this.format,compressionQuality:this.compressionQuality,bandIds:this.bandIds?this.bandIds.join(","):null},c?c.toJson():{});this.pixelFilter=b&&b.pixelFilter;this.originalPixelData=this.pixelData=null;this.hasDataChanged=!0;this._requestDataHandler=f.hitch(this,this._requestDataHandler);this._requestDataErrorHandler=f.hitch(this,this._requestDataErrorHandler);this._rasterReadPromise=null;this._initLayer=f.hitch(this,this._initLayer);this._queryVisibleRastersHandler=
f.hitch(this,this._queryVisibleRastersHandler);this._visibleRasters=[];this._rasterAttributeTableFields=[];this._rasterAttributeTableFeatures=[];this._renderingRuleAttributeTable={};this._useRenderingRuleAttributeTable=!1;this._loadCallback=b&&b.loadCallback;(c=b&&b.resourceInfo)?this._initLayer(c):E({url:this._url.path,content:f.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler});this.registerConnectEvents()},disableClientCaching:!1,_initLayer:function(a){if(null!==
a&&void 0!==a){this._findCredential();(this.credential&&this.credential.ssl||a&&a._ssl)&&this._useSSL();var b=this.minScale,c=this.maxScale;f.mixin(this,a);this.minScale=b;this.maxScale=c;this.initialExtent=this.fullExtent=this.extent=new J(a.extent);this.spatialReference=this.initialExtent.spatialReference;this.pixelSizeX=parseFloat(this.pixelSizeX);this.pixelSizeY=parseFloat(this.pixelSizeY);for(var d=this.minValues,e=this.maxValues,h=this.meanValues,k=this.stdvValues,g=this.bands=[],b=0,c=this.bandCount;c>
b;b++)g[b]={min:d[b],max:e[b],mean:h[b],stddev:k[b]};this.timeInfo=(b=this.timeInfo)&&b.timeExtent?new Z(b):null;c=this.fields=[];if(d=a.fields)for(b=0;b<d.length;b++)c.push(new aa(d[b]));(this.version=a.currentVersion,this.version)||(this.version="fields"in a||"objectIdField"in a||"timeInfo"in a?10:9.3);B.isDefined(a.minScale)&&!this._hasMin&&this.setMinScale(a.minScale);B.isDefined(a.maxScale)&&!this._hasMax&&this.setMaxScale(a.maxScale);b={};(a.defaultMosaicMethod?(b.method=a.defaultMosaicMethod,
b.operation=a.mosaicOperator,b.sortField=a.sortField,b.sortValue=a.sortValue):b.method=r.METHOD_NONE,this.defaultMosaicRule=new r(b),this.defaultMosaicRule.ascending=!0,this._useRenderingRuleAttributeTable=10<this.version&&"esriImageServiceDataTypeThematic"===this.serviceDataType&&!this.hasRasterAttributeTable,this._setDefaultRenderingRule(!0),this._isScientificData()&&(!this.mosaicRule||this.mosaicRule&&!this.mosaicRule.multidimensionalDefinition)&&this._setDefaultMultidimensionalDefinition(!0),
10<this.version&&this.hasRasterAttributeTable)&&this.getRasterAttributeTable().then(f.hitch(this,function(a){a&&a.features&&0<a.features.length&&(this._rasterAttributeTableFeatures=f.clone(a.features));a&&a.fields&&0<a.fields.length&&(this._rasterAttributeTableFields=f.clone(a.fields))}));this._isVectorData()&&!B.isDefined(this.pixelFilter)&&(this.vectorFieldPixelFilter=new X,this.vectorFieldPixelFilter.isDataUV="esriImageServiceDataTypeVector-UV"===this.serviceDataType,this.pixelFilter=this.vectorFieldPixelFilter.computeMagnitudeAndDirection,
this.getKeyProperties().then(f.hitch(this,this._setFlowRepresentation)));this.loaded=!0;this.onLoad(this);(a=this._loadCallback)&&(delete this._loadCallback,a(this))}},getKeyProperties:function(){var a=this._url.path+"/keyProperties",b=new n(t._dfdCanceller);10<this.version?(b._pendingDfd=E({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),b._pendingDfd.then(function(a){b.callback(a)},function(a){b.errback(a)})):(a=Error("Layer does not have key properties"),a.log=K.isDebug,
b.errback(a));return b},getRasterAttributeTable:function(a){var b=this._url.path+"/rasterAttributeTable",c=new n(t._dfdCanceller),d={f:"json"},e=this.hasRasterAttributeTable;(a&&a.renderingRule&&(d.renderingRule=A.toJson(a.renderingRule.toJson()),e=!0),10<this.version&&e)?(c._pendingDfd=E({url:b,content:d,handleAs:"json",callbackParamName:"callback"}),c._pendingDfd.then(function(a){c.callback(a)},function(a){c.errback(a)})):(a=Error("Layer does not support raster attribute table"),a.log=K.isDebug,
c.errback(a));return c},_getRenderingRuleAttributeTable:function(a){var b=new n(t._dfdCanceller);if(!a||!a.renderingRule)return b.errback(Error("Rendering rule is not specified")),b;a=a.renderingRule;var c=a.functionName;return this._renderingRuleAttributeTable&&c&&this._renderingRuleAttributeTable.hasOwnProperty(c)?b.resolve(this._renderingRuleAttributeTable[c]):b=this.getRasterAttributeTable({renderingRule:a}).then(f.hitch(this,function(a){var b;return a&&a.features&&a.features.length&&a.fields&&
a.fields.length&&(b={features:f.clone(a.features),fields:f.clone(a.fields)},c&&(this._renderingRuleAttributeTable[c]=b)),b})),b},_getRasterAttributeTableFeatures:function(){var a=new n;return this._rasterAttributeTableFeatures&&0<this._rasterAttributeTableFeatures.length?(a.resolve(this._rasterAttributeTableFeatures),a):10<this.version&&this.hasRasterAttributeTable?(a=this.getRasterAttributeTable(),a.then(f.hitch(this,function(a){a&&a.features&&0<a.features.length&&(this._rasterAttributeTableFeatures=
f.clone(a.features))})),a):(a.resolve(this._rasterAttributeTableFeatures),a)},_getRenderingRuleAttributeTableFeatures:function(a){a=a&&a.renderingRule;return a?this._getRenderingRuleAttributeTable({renderingRule:a}).then(function(a){return a&&a.features}):(a=new n,a.errback(Error("Rendering rule is not specified")),a)},getCustomRasterFields:function(a){var b=a?a.rasterAttributeTableFieldPrefix:this._rasterFieldPrefix;a=10.3<=this.version?"esriFieldTypeDouble":"esriFieldTypeString";var c={name:this._rasterFieldPrefix+
"ItemPixelValue",alias:"Item Pixel Value",domain:null,editable:!1,length:50,type:a},d={name:this._rasterFieldPrefix+"ServicePixelValue",alias:"Service Pixel Value",domain:null,editable:!1,length:50,type:a},e={name:this._rasterFieldPrefix+"ServicePixelValue.Raw",alias:"Raw Service Pixel Value",domain:null,editable:!1,length:50,type:"esriFieldTypeDouble"},h=this.fields?f.clone(this.fields):[];a=h.length;(h[a]=d,10.4<=this.version&&"esri.layers.ArcGISImageServiceLayer"===this.declaredClass&&(!this.rasterFunctionInfos||
!this.rasterFunctionInfos.length||this._isRasterFunctionInfoAvailable("none"))&&(a++,h[a]=e),(this.capabilities&&-1<this.capabilities.toLowerCase().indexOf("catalog")||this.fields&&0<this.fields.length)&&(a++,h[a]=c),!B.isDefined(this.pixelFilter)||"esriImageServiceDataTypeVector-UV"!==this.serviceDataType&&"esriImageServiceDataTypeVector-MagDir"!==this.serviceDataType)||(c={name:this._rasterFieldPrefix+"Magnitude",alias:"Magnitude",domain:null,editable:!1,type:"esriFieldTypeDouble"},d={name:this._rasterFieldPrefix+
"Direction",alias:"Direction",domain:null,editable:!1,type:"esriFieldTypeDouble"},a++,h[a]=c,a++,h[a]=d);a=this._rasterAttributeTableFields;c=this.renderingRule&&this.renderingRule.functionName;if(c&&this._renderingRuleAttributeTable&&this._renderingRuleAttributeTable.hasOwnProperty(c)&&(a=this._renderingRuleAttributeTable[c].fields),a&&0<a.length)a=p.filter(a,function(a){return"esriFieldTypeOID"!==a.type&&"value"!==a.name.toLowerCase()}),a=p.map(a,function(a){var c=f.clone(a);return c.name=b+a.name,
c}),h=h.concat(a);var k=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;return 10.4<=this.version&&this.rasterFunctionInfos&&p.forEach(this.rasterFunctionInfos,function(a){a&&a.name&&"none"!==a.name.toLowerCase()&&(a={name:k+a.name.replace(/ /gi,"_"),alias:a.name,domain:null,editable:!1,type:"esriFieldTypeDouble"},h.push(a))}),h},_prepareGetImageParameters:function(a,b,c,d){d=B.isDefined(d)?d:this._params;var e=a.spatialReference.wkid||A.toJson(a.spatialReference.toJson(!1));delete d._ts;
f.mixin(d,{bbox:a.xmin+","+a.ymin+","+a.xmax+","+a.ymax,imageSR:e,bboxSR:e,size:b+","+c},this.disableClientCaching?{_ts:(new Date).getTime()}:{});delete d.compressionTolerance;d.format&&"LERC"===d.format.toUpperCase()&&(d.compressionTolerance=this.compressionTolerance);d.token=this._getToken()},getImageUrl:function(a,b,c,d,e){e=B.isDefined(e)?e:this._params;this._prepareGetImageParameters(a,b,c,e);a=f.clone(e);this._cleanupRequestParams(a);b=this._url.path+"/exportImage?";c=L.addProxy(b+R.objectToQuery(f.mixin(a,
{f:"image"})));var h=a.token;c.length>T.defaults.io.postLength||this.useMapImage?this._jsonRequest=E({url:b,content:f.mixin(a,{f:"json"}),callbackParamName:"callback",load:function(a){a=a.href;h&&(a+=-1===a.indexOf("?")?"?token\x3d"+h:"\x26token\x3d"+h);d(L.addProxy(a))},error:this._errorHandler}):d(c)},onRenderingChange:function(){},onMosaicRuleChange:function(){},setInterpolation:function(a,b){this.interpolation=this._params.interpolation=a;b||this.refresh(!0)},setCompressionQuality:function(a,
b){this.compressionQuality=this._params.compressionQuality=a;b||this.refresh(!0)},setCompressionTolerance:function(a,b){this.compressionTolerance=a;b||this.refresh(!0)},setBandIds:function(a,b){var c=!1;this.bandIds!==a&&(c=!0);this.bandIds=a;this._params.bandIds=a.join(",");c&&!b&&this.onRenderingChange();b||this.refresh(!0)},setDefaultBandIds:function(a){this.bandIds=this._params.bandIds=null;a||this.refresh(!0)},setDisableClientCaching:function(a){this.disableClientCaching=a},setMosaicRule:function(a,
b){var c=!1;this.mosaicRule!==a&&(c=!0);this.mosaicRule=a;this._params.mosaicRule=A.toJson(a.toJson());c&&!b&&this.onMosaicRuleChange();b||this.refresh(!0)},setRenderingRule:function(a,b){var c=!1;this.renderingRule!==a&&(c=!0);this.renderingRule=a;this._params.renderingRule=a?A.toJson(a.toJson()):null;this._useRenderingRuleAttributeTable&&this._getRenderingRuleAttributeTable({renderingRule:a});c&&!b&&this.onRenderingChange();b||this.refresh(!0)},setImageFormat:function(a,b){this.format=this._params.format=
a;b||this.refresh(!0)},setInfoTemplate:function(a){this.infoTemplate=a},setDefinitionExpression:function(a,b){var c=this.mosaicRule?this.mosaicRule.toJson():{};this.mosaicRule||(this.defaultMosaicRule?c=this.defaultMosaicRule.toJson():c.method=r.METHOD_NONE);c.where=a;c=new r(c);return this.setMosaicRule(c,b),this},getDefinitionExpression:function(){return this.mosaicRule?this.mosaicRule.where:null},setPixelFilter:function(a){this.pixelFilter=a},getPixelData:function(a){return a?(this._useBrowserDecoding()&&
(this.originalPixelData={pixelBlock:this._getPixelBlockFromCanvas(this._context,this._map.width,this._map.height),extent:this._map.extent}),this.originalPixelData):this.pixelData},redraw:function(){this.hasDataChanged=!1;this._setPixelData(this.originalPixelData)},queryVisibleRasters:function(a,b,c,d){var e=this._map,h=t._fixDfd(new n(t._dfdCanceller));this._visibleRasters=[];var k,g,m=!0,z=this.infoTemplate?this.infoTemplate.info:null,u=z?f.clone(this.infoTemplate.info.fieldInfos):null;if(this.infoTemplate.info.mediaInfos&&
this.infoTemplate.info.mediaInfos.length){var D=[];p.forEach(this.infoTemplate.info.mediaInfos,function(a){D=D.concat(a&&a.value&&a.value.fields||[])});D.length&&p.forEach(u,function(a){a&&-1<D.indexOf(a.fieldName)&&(a.visible=!0)})}if(u&&0<u.length)for(m=!1,k=0;k<u.length;k++)if(g=u[k],g&&g.fieldName.toLowerCase()!==this._rasterFieldPrefix.toLowerCase()+"servicepixelvalue"&&(g.visible||z.title&&-1<z.title.toLowerCase().indexOf(g.fieldName.toLowerCase()))){m=!0;break}var l=(g=this._removeVisualizationStretchFunction(this.renderingRule))&&
g.functionName,q=[];if(10.4<=this.version){var v=!1;if(this.rasterFunctionInfos&&u){var x=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;p.forEach(this.rasterFunctionInfos,function(a){var b=x+a.name.replace(/ /gi,"_");p.some(u,function(a){return a.visible&&a.fieldName===b})&&(v=v||l&&l===a.name,q.push(new O({rasterFunction:a.name})))})}g&&!v&&q.push(g)}k=new da;if(k.geometry=a.geometry,k.returnGeometry=this._map.spatialReference.equals(this.spatialReference),k.returnCatalogItems=m,k.timeExtent=
a.timeExtent,k.mosaicRule=this.mosaicRule||null,k.renderingRule=10.4>this.version&&g||null,k.renderingRules=q||null,e)a=new U((e.extent.xmax-e.extent.xmin)/(2*e.width),(e.extent.ymax-e.extent.ymin)/(2*e.height),e.extent.spatialReference),k.pixelSize=a;b.requestParams=k;var H=this;a=new ca(this.url);return(h._pendingDfd=a.execute(k)).addCallbacks(function(a){H._queryVisibleRastersHandler(a,b,c,d,h)},function(a){H._resolve([a],null,d,h,!0)}),h},_queryVisibleRastersHandler:function(a,b,c,d,e){function h(){var a,
d,h,l,m,q,v,z,x,n,t,r=this.getCustomRasterFields(b),C=this._getDomainFields(r),A=b?b.returnDomainValues:!1,y=b&&b.rasterAttributeTableFieldPrefix;this._useRenderingRuleAttributeTable&&this.renderingRule?(n=this._getRenderingRuleAttributeTableFeatures({renderingRule:this.renderingRule}),t=u):n=this._getRasterAttributeTableFeatures();n.then(f.hitch(this,function(b){for(a=0;a<g.length;a++){if(w=g[a],w.setInfoTemplate(this.infoTemplate),w._layer=this,u){if(x=u.replace(/ /gi,"").split(","),d=u,h=x,k&&
k.length>=a&&(d=k[a].replace(/ /gi,", "),h=k[a].split(" ")),w.attributes[this._rasterFieldPrefix+"ItemPixelValue"]=h,w.attributes[this._rasterFieldPrefix+"ServicePixelValue"]=x,D&&(w.attributes[this._rasterFieldPrefix+"ServicePixelValue.Raw"]=D.replace(/ /gi,"").split(",")),this.pixelFilter){var n=new M({height:1,width:1,pixelType:"F32",pixels:[],statistics:[]});p.forEach(h,function(a){n.addData({pixels:[a],statistics:{minValue:a,maxValue:a,noDataValue:null}})});this.pixelFilter({pixelBlock:n,extent:new J(0,
0,0,0,this._map.spatialReference)});("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)&&(w.attributes[this._rasterFieldPrefix+"Magnitude"]=n.pixels[0][0],w.attributes[this._rasterFieldPrefix+"Direction"]=n.pixels[1][0])}p.forEach(H,function(a){w.attributes[a.name]=a.value});var r=t||d;if(b&&0<b.length&&(l=p.filter(b,function(a){return a&&a.attributes?a.attributes.hasOwnProperty("Value")?a.attributes.Value==r:a.attributes.VALUE==
r:void 0}),0<l.length&&(m=f.clone(l[0]),y&&m))){z={};for(q in m.attributes)m.attributes.hasOwnProperty(q)&&(v=y+q,z[v]=m.attributes[q]);m.attributes=z;w.attributes=f.mixin(w.attributes,m.attributes)}}A&&C&&0<C.length&&p.forEach(C,function(a){if(a){var b=w.attributes[a.name];B.isDefined(b)&&(b=this._getDomainValue(a.domain,b),B.isDefined(b)&&(w.attributes[a.name]=b))}},this);I.push(w);this._visibleRasters.push(w)}this._resolve([I,null,!0],null,c,e)}))}var k,g,m,z,u=a.value,D=a.value,l=0,q=0,v=this,
x=this.objectIdField,H=[];d=b.requestParams.renderingRules;var C=a.processedValues,n=this.renderingRule&&dojo.toJson(this._removeVisualizationStretchFunction(this.renderingRule).toJson());if(d&&C&&d.length===C.length){var t=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;p.forEach(d,function(a,b){if(a.functionName){var c={name:t+a.functionName.replace(/ /gi,"_"),value:C[b].replace(/ /gi,"").split(",")};H.push(c);n&&n===dojo.toJson(a.toJson())&&(u=C[b])}})}if(d=this.infoTemplate&&this.infoTemplate.info&&
this.infoTemplate.info.layerOptions&&this.infoTemplate.info.layerOptions.hasOwnProperty("showNoDataRecords")?this.infoTemplate.info.layerOptions.showNoDataRecords:!0,a.catalogItems){var r,F,y=0,G=a.catalogItems.features.length;z=0;g=Array(G);k=Array(G);m=Array(G);for(l=0;G>l;l++)-1<a.properties.Values[l].toLowerCase().indexOf("nodata")&&z++;r=G-z;for(l=0;G>l;l++)z=!0,-1<a.properties.Values[l].toLowerCase().indexOf("nodata")?(F=r++,d||(z=!1,g.length--,k.length--,m.length--)):F=y++,z&&(g[F]=a.catalogItems.features[l],
k[F]=a.properties.Values[l],m[F]=g[F].attributes[x])}this._visibleRasters=[];var w;a=-1<u.toLowerCase().indexOf("nodata");(a&&!d&&(g=[],k=[],m=[]),!u||g||a)||(x="ObjectId",g=[],w=new ba(new J(this.fullExtent),null,{ObjectId:0}),g.push(w));var I=[];return g?void(!this._map.spatialReference.equals(this.spatialReference)&&m&&0<m.length?E({url:this._url.path+"/query",content:{f:"json",objectIds:m.join(","),returnGeometry:!0,outSR:A.toJson(v._map.spatialReference.toJson()),outFields:x},handleAs:"json",
callbackParamName:"callback",load:function(a){if(0===a.features.length)return void v._resolve([I,null,null],null,c,e);for(l=0;l<a.features.length;l++)for(q=0;q<g.length;q++)g[q].attributes[x]==a.features[l].attributes[x]&&(g[q].geometry=new V(a.features[l].geometry),g[q].geometry.setSpatialReference(v._map.spatialReference));h.call(v)},error:function(){v._resolve([I,null,null],null,c,e)}}):h.call(this)):void this._resolve([I,null,null],null,c,e)},getVisibleRasters:function(){var a,b=this._visibleRasters,
c=[];for(a in b)b.hasOwnProperty(a)&&c.push(b[a]);return c},_getDomainFields:function(a){if(a){var b=[];return p.forEach(a,function(a){if(a.domain){var d={};d.name=a.name;d.domain=a.domain;b.push(d)}}),b}},_getDomainValue:function(a,b){if(a&&a.codedValues){var c;return p.some(a.codedValues,function(a){return a.code===b?(c=a.name,!0):!1}),c}},_requestData:function(a,b,c){this._rasterReadPromise&&this._rasterReadPromise.cancel();a=f.clone(a);var d=a._normalize(!0);this._prepareGetImageParameters(d,
b,c);b=f.clone(this._params);this._cleanupRequestParams(b);b.extent=a;c=null;this._useBrowserDecoding()&&(c=new Y({ctx:this._context}));b={imageServiceParameters:b,nBands:Math.min(this.bandCount,3),pixelType:this.pixelType,decodeFunc:c?f.hitch(c,"decode"):null};this._rasterReadPromise=this.raster.read(b,this._requestDataHandler,this._requestDataErrorHandler)},_requestDataHandler:function(a){this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this.originalPixelData=a,this.hasDataChanged=
!0,this._setPixelData(a))},_setPixelData:function(a){a=this._clonePixelData(a);this.pixelFilter&&this.pixelFilter(a);this.pixelData=a;this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this._drawPixelData(),this._rasterReadPromise=null)},_drawPixelData:function(){},_requestDataErrorHandler:function(){},_clonePixelData:function(a){if(null===a||void 0===a)return a;var b={};a.extent&&(b.extent=f.clone(a.extent));a=a.pixelBlock;return null===a||void 0===a?b:(b.pixelBlock=a.clone(),b)},_getPixelBlockFromCanvas:function(a,
b,c){for(var d,e,h=a.getImageData(0,0,b,c).data,f=b*c,g=0,m=0,n=new Uint8Array(f),u=new Uint8Array(f),p=new Uint8Array(f),l=new Uint8Array(f),q=1/0,v=1/0,x=1/0,r=-1/0,t=-1/0,y=-1/0,g=0;f>g;g++)a=h[m++],d=h[m++],e=h[m++],q=a>q?q:a,r=r>a?r:a,v=d>v?v:d,t=t>d?t:d,x=e>x?x:e,y=y>e?y:e,n[g]=a,u[g]=d,p[g]=e,l[g]=1&h[m++];return new M({width:b,height:c,pixels:[n,u,p],pixelType:"U8",mask:l,statistics:[{minValue:q,maxValue:r},{minValue:v,maxValue:t},{minValue:x,maxValue:y}]})},_useBrowserDecoding:function(){return(void 0===
this.pixelFilter||null===this.pixelFilter)&&("jpeg"==this.format.toLowerCase()||-1<this.format.toLowerCase().indexOf("png"))},getMultidimensionalInfo:function(){var a=this._url.path+"/multiDimensionalInfo",b=new n(t._dfdCanceller);if(this._multidimensionalInfo)return b.resolve(this._multidimensionalInfo),b;10.3<=this.version&&this.hasMultidimensions?(b._pendingDfd=E({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),b._pendingDfd.then(f.hitch(this,function(a){this._multidimensionalInfo=
a.multidimensionalInfo;b.callback(a.multidimensionalInfo)}),function(a){b.errback(a)})):(a=Error("Layer does not support multidimensional info"),a.log=K.isDebug,b.errback(a));return b},getDefaultMultidimensionalDefinition:function(){var a,b,c,d=[],e=new n(t._dfdCanceller);return this._defaultMultidimensionalDefinition?(e.resolve(this._defaultMultidimensionalDefinition),e):(e._pendingDfd=this.getMultidimensionalInfo(),e._pendingDfd.then(f.hitch(this,function(f){a=f;b=a.variables[0].dimensions;for(c in b)b.hasOwnProperty(c)&&
d.push(b[c].hasRanges&&1==b[c].hasRanges?new P({variableName:"",dimensionName:b[c].name,isSlice:!1,values:[b[c].values[0]]}):new P({variableName:"",dimensionName:b[c].name,isSlice:!0,values:[b[c].extent[0]]}));this._defaultMultidimensionalDefinition=d;e.callback(d)}),function(a){e.errback(a)}),e)},_setDefaultMultidimensionalDefinition:function(a){var b,c={};this.getDefaultMultidimensionalDefinition().then(f.hitch(this,function(d){b=d;0<b.length&&(this.mosaicRule?(c=f.clone(this.mosaicRule),c.multidimensionalDefinition=
b):this.defaultMosaicRule?(c=f.clone(this.defaultMosaicRule),c.multidimensionalDefinition=b):c=new r({multidimensionalDefinition:b}),this.setMosaicRule(c,a))}))},_setDefaultRenderingRule:function(a){var b={};if(!this.renderingRule&&"esri.layers.ArcGISImageServiceVectorLayer"!==this.declaredClass&&this.rasterFunctionInfos&&this.rasterFunctionInfos.length&&"none"!==this.rasterFunctionInfos[0].name.toLowerCase())b.rasterFunction=this.rasterFunctionInfos[0].name;else if(!this.renderingRule&&"esri.layers.ArcGISImageServiceVectorLayer"==
this.declaredClass&&10.3<this.version){var c="esriImageServiceDataTypeVector-UV"===this.serviceDataType?7:10;b.rasterFunction="Resample";b.rasterFunctionArguments={ResamplingType:c,InputCellSize:{x:this.pixelSizeX,y:this.pixelSizeY}}}b.hasOwnProperty("rasterFunction")&&(this.defaultRenderingRule=new O(b),this.setRenderingRule(this.defaultRenderingRule,a))},_cleanupRequestParams:function(a){if(!a)return a;if(a.time&&a.mosaicRule){var b=new r(A.fromJson(a.mosaicRule));if(b&&b.multidimensionalDefinition&&
0<b.multidimensionalDefinition.length){var c=p.filter(b.multidimensionalDefinition,function(a){return"StdTime"!==a.dimensionName});b.multidimensionalDefinition=c;a.mosaicRule=A.toJson(b.toJson())}}var d,b="displayOnPan drawMode styling id opacity visible resourceInfo useMapDimensionValue extent".split(" ");for(d in b)a.hasOwnProperty(b[d])&&delete a[b[d]];return a},_removeVisualizationStretchFunction:function(a){var b=a&&a.functionName;if(!b||"stretch"!==b.toLowerCase())return a;var c=a.functionArguments.Raster;
return c&&c.functionName&&p.some(this.rasterFunctionInfos,function(a){return c.functionName===a.name})?c:a},_isScientificData:function(){return"esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType||"esriImageServiceDataTypeScientific"===this.serviceDataType},_isVectorData:function(){return"esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType},_isRasterFunctionInfoAvailable:function(a){return p.some(a&&
(this.rasterFunctionInfos||[]),function(b){return b&&b.name&&b.name.toLowerCase()===a.toLowerCase()})},_createPixelData:function(a){a=new M({width:2,height:2,pixels:a,pixelType:this.pixelType,statistics:a});var b=this.fullExtent.getCenter(),b=new J(b.x,b.y,b.x+this.pixelSizeX,b.y+this.pixelSizeY,this.spatialReference);return{pixelBlock:a,extent:b}},_resolve:function(a,b,c,d,e){b&&this[b].apply(this,a);c&&c.apply(null,a);d&&t._resDfd(d,a,e)},_toggleTime:function(){var a=this._map;this.timeInfo&&this.useMapTime&&
a&&!this.suspended?(this._timeConnect||(this._timeConnect=N.connect(a,"onTimeExtentChange",this,this._onTimeExtentChangeHandler)),this._setTime(a.timeExtent)):(N.disconnect(this._timeConnect),this._timeConnect=null,this._setTime(null))},setUseMapTime:function(a,b){this.useMapTime=a;this._toggleTime();!b&&this._map&&this.refresh(!0)},_setTime:function(a){this._params&&(this._params.time=a?a.toJson().join(","):null)},_onTimeExtentChangeHandler:function(a){this.suspended||(this._setTime(a),this.refresh(!0))}});
return Q("extend-esri")&&f.setObject("layers.ImageServiceLayerMixin",y,S),y});