//>>built
define("esri/layers/DynamicMapServiceLayer","dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/dom-construct dojo/dom-style dojox/xml/parser dojox/gfx/matrix ../kernel ../config ../sniff ../request ../domUtils ./layer ./MapImage".split(" "),function(m,f,q,n,g,y,u,h,v,r,z,w,A,B){var x=v.defaults.map.zoomDuration;m=m(A,{declaredClass:"esri.layers.DynamicMapServiceLayer",_eventMap:{"map-image-export":["mapImage"]},constructor:function(a,b){this.useMapTime=b&&b.hasOwnProperty("useMapTime")?!!b.useMapTime:
!0;var c=q.hitch;this._exportMapImageHandler=c(this,this._exportMapImageHandler);this._imgSrcFunc=c(this,this._imgSrcFunc);this._divAlphaImageFunc=c(this,this._divAlphaImageFunc);this._tileLoadHandler=c(this,this._tileLoadHandler);this._tileErrorHandler=c(this,this._tileErrorHandler);this.registerConnectEvents()},opacity:1,isPNG32:!1,_setMap:function(a,b){this.inherited(arguments);this._map=a;var c=this._div=n.create("div",null,b),e=h._css.names,d={position:"absolute",width:a.width+"px",height:a.height+
"px",overflow:"visible",opacity:this.opacity},l=r("ie"),k=f.connect,t=a.__visibleDelta;if(8===l&&delete d.opacity,"css-transforms"===a.navigationMode?(d[e.transform]=h._css.translate(t.x,t.y),g.set(c,d),this._left=t.x,this._top=t.y):(d.left="0px",d.top="0px",g.set(c,d),this._left=this._top=0),g.set(c,d),this._onResizeHandler_connect=k(a,"onResize",this,"_onResizeHandler"),this._opacityChangeHandler_connect=k(this,"onOpacityChange",this,"_opacityChangeHandler"),this._img_loading=null,this._dragOrigin=
{x:0,y:0},this.evaluateSuspension(),this.suspended&&!a.loaded)var m=f.connect(a,"onLoad",this,function(){f.disconnect(m);m=null;this.evaluateSuspension()});return c},_unsetMap:function(){n.destroy(this._div);this._map=this._div=null;var a=f.disconnect;a(this._onResizeHandler_connect);a(this._opacityChangeHandler_connect);this._onResizeHandler_connect=this._opacityChangeHandler_connect=null;this._fireUpdateEnd();this._toggleTime();clearTimeout(this._wakeTimer);this._wakeTimer=null;this._disableDrawConnectors();
this.inherited(arguments)},_onResizeHandler:function(a,b,c){g.set(this._div,{width:b+"px",height:c+"px"});this._onExtentChangeHandler(a)},onSuspend:function(){this.inherited(arguments);this._fireUpdateEnd();this._toggleTime();w.hide(this._div);clearTimeout(this._wakeTimer);this._wakeTimer=null;this._disableDrawConnectors()},onResume:function(){this.inherited(arguments);var a=this._map;if(this._toggleTime(),"css-transforms"===a.navigationMode)a=a.__visibleDelta,this._left=a.x,this._top=a.y,g.set(this._div,
h._css.names.transform,h._css.translate(this._left,this._top));this._enableDrawConnectors();this._wakeTimer=this._wakeTimer||setTimeout(q.hitch(this,function(){this.suspended||this._onExtentChangeHandler(this._map.extent,null,!0)}),0)},_enableDrawConnectors:function(){var a=f.connect,b=this._map;b&&(this._onPanHandler_connect=a(b,"onPan",this,"_onPanHandler"),this._onExtentChangeHandler_connect=a(b,"onExtentChange",this,"_onExtentChangeHandler"),"css-transforms"===b.navigationMode?this._onScaleHandler_connect=
a(b,"onScale",this,this._onScaleHandler):this._onZoomHandler_connect=a(b,"onZoom",this,"_onZoomHandler"))},_disableDrawConnectors:function(){var a=f.disconnect;a(this._onPanHandler_connect);a(this._onExtentChangeHandler_connect);a(this._onZoomHandler_connect);a(this._onScaleHandler_connect);this._onPanHandler_connect=this._onExtentChangeHandler_connect=this._onZoomHandler_connect=this._onScaleHandler_connect=null},_toggleTime:function(){var a=this._map;this.timeInfo&&this.useMapTime&&a&&!this.suspended?
(this._timeConnect||(this._timeConnect=f.connect(a,"onTimeExtentChange",this,this._onTimeExtentChangeHandler)),this._setTime(a.timeExtent)):(f.disconnect(this._timeConnect),this._timeConnect=null,this._setTime(null))},_setTime:function(a){this._params&&(this._params.time=a?a.toJson().join(","):null)},_onPanHandler:function(a,b){this._panDx=b.x;this._panDy=b.y;var c=this._dragOrigin,e=this._map.__visibleDelta,d=this._img;d&&("css-transforms"===this._map.navigationMode?(this._left=e.x+b.x,this._top=
e.y+b.y,g.set(this._div,h._css.names.transform,h._css.translate(this._left,this._top))):g.set(d,{left:c.x+b.x+"px",top:c.y+b.y+"px"}))},_onExtentChangeHandler:function(a,b,c){if(!this.suspended){clearTimeout(this._wakeTimer);this._wakeTimer=null;var e=this._map,d=this._img,l=d&&d.style,k=this._dragOrigin;!b||c||!d||b.x===this._panDx&&b.y===this._panDy||("css-transforms"===e.navigationMode?(b=e.__visibleDelta,this._left=b.x,this._top=b.y,g.set(this._div,h._css.names.transform,h._css.translate(this._left,
this._top))):g.set(d,{left:k.x+b.x+"px",top:k.y+b.y+"px"}));d?(k.x=parseInt(l.left,10),k.y=parseInt(l.top,10)):k.x=k.y=0;"css-transforms"===e.navigationMode&&c&&d&&(g.set(d,h._css.names.transition,"none"),d._multiply=d._multiply?u.multiply(d._matrix,d._multiply):d._matrix);this._fireUpdateStart();if(c=this._img_loading)if(f.disconnect(c._onload_connect),f.disconnect(c._onerror_connect),f.disconnect(c._onabort_connect),n.destroy(c),this._img_loading=null,c=this._jsonRequest){try{c.cancel()}catch(m){}this._jsonRequest=
null}if(10<=this.version&&e.wrapAround180&&(a=a._normalize(!0)),this.isPNG32)d=this._img_loading=n.create("div"),d.id=e.id+"_"+this.id+"_"+(new Date).getTime(),g.set(d,{position:"absolute",left:"0px",top:"0px",width:e.width+"px",height:e.height+"px"}),d=d.appendChild(n.create("div")),g.set(d,{opacity:0,width:e.width+"px",height:e.height+"px"}),this.getImageUrl(a,e.width,e.height,this._divAlphaImageFunc);else{c=this._img_loading=n.create("img");b=h._css.names;var q=r("ie"),p={position:"absolute",width:e.width+
"px",height:e.height+"px"};8===q&&(p.opacity=this.opacity);"css-transforms"===e.navigationMode?(p[b.transform]=h._css.translate(-this._left,-this._top),c._tdx=-this._left,c._tdy=-this._top,p[b.transition]=b.transformName+" "+x+"ms ease"):(p.left="0px",p.top="0px");c.id=e.id+"_"+this.id+"_"+(new Date).getTime();g.set(c,p);c._onload_connect=f.connect(c,"onload",this,"_onLoadHandler");c._onerror_connect=f.connect(c,"onerror",this,"_onErrorHandler");c._onabort_connect=f.connect(c,"onabort",this,"_onErrorHandler");
this._startRect={left:k.x,top:k.y,width:d?parseInt(l.width,10):e.width,height:d?parseInt(l.height,10):e.height,zoom:l&&l.zoom?parseFloat(l.zoom):1};this.getImageUrl(a,e.width,e.height,this._imgSrcFunc)}}},_onTimeExtentChangeHandler:function(a){this.suspended||(this._setTime(a),this.refresh(!0))},getImageUrl:function(){},_imgSrcFunc:function(a){this._img_loading.src=a},_divAlphaImageFunc:function(a){g.set(this._img_loading,"filter","progid:DXImageTransform.Microsoft.AlphaImageLoader(src\x3d'"+a+"', sizingMethod\x3d'scale')");
this._onLoadHandler({currentTarget:this._img_loading})},_onLoadHandler:function(a){a=a.currentTarget;var b=f.disconnect,c=this._map;if(b(a._onload_connect),b(a._onerror_connect),b(a._onabort_connect),!c||c.__panning||c.__zooming)return n.destroy(a),void this._fireUpdateEnd();y.removeChildren(this._div);this._img=a;this._startRect={left:0,top:0,width:c.width,height:c.height,zoom:1};this._div.appendChild(a);this.suspended||w.show(this._div);a._onload_connect=a._onerror_connect=a._onabort_connect=this._img_loading=
null;a=this._dragOrigin;a.x=a.y=0;this.onUpdate();this._fireUpdateEnd()},_onErrorHandler:function(a){a=a.currentTarget;var b=f.disconnect;g.set(a,"visibility","hidden");b(a._onload_connect);b(a._onerror_connect);b(a._onabort_connect);a._onload_connect=a._onerror_connect=a._onabort_connect=null;a=Error("Unable to load image: "+a.src);this.onError(a);this._fireUpdateEnd(a)},setUseMapTime:function(a,b){this.useMapTime=a;this._toggleTime();b||this.refresh(!0)},refresh:function(){this._map&&this._onExtentChangeHandler(this._map.extent)},
_onScaleHandler:function(a,b){var c={},e=h._css.names,d=this._img;d&&(g.set(d,e.transition,b?"none":e.transformName+" "+x+"ms ease"),d._matrix=a,a=d._multiply?u.multiply(a,d._multiply):a,(d._tdx||d._tdy)&&(a=u.multiply(a,{xx:1,xy:0,yx:0,yy:1,dx:d._tdx,dy:d._tdy})),c[e.transform]=h._css.matrix(a),g.set(d,c))},_onZoomHandler:function(a,b,c){a=this._startRect;var e=a.width*b,d=a.height*b,f=this._img,h=r("ie");f&&(h&&8>h?g.set(f,{left:a.left-(e-a.width)*(c.x-a.left)/a.width+"px",top:a.top-(d-a.height)*
(c.y-a.top)/a.height+"px",zoom:b*a.zoom}):g.set(f,{left:a.left-(e-a.width)*(c.x-a.left)/a.width+"px",top:a.top-(d-a.height)*(c.y-a.top)/a.height+"px",width:e+"px",height:d+"px"}))},_exportMapImage:function(a,b,c){var e=this._exportMapImageHandler;b.token=this._getToken();z({url:a,content:b,callbackParamName:"callback",load:function(a,b){e(a,b,c)},error:v.defaults.io.errorHandler})},_exportMapImageHandler:function(a,b,c){a=new B(a);this.onMapImageExport(a);c&&c(a)},onMapImageExport:function(){},setOpacity:function(a){this.opacity!=
a&&this.onOpacityChange(this.opacity=a)},onOpacityChange:function(){},_opacityChangeHandler:function(a){var b=8===r("ie")?this._img:this._div;g.set(b,"opacity",a)}});return r("extend-esri")&&q.setObject("layers.DynamicMapServiceLayer",m,h),m});