//>>built
define("esri/layers/Raster","require dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/config dojo/json dojo/sniff ../kernel ../Evented ../request ../geometry/Extent ../SpatialReference ../deferredUtils ./PixelBlock ./rasterFormats/LercCodec".split(" "),function(z,n,k,v,w,x,A,q,B,C,D,E,F,y,m,G){var r,t,p;n=n(C,{declaredClass:"esri.layers.Raster",imageServiceUrl:null,validPixelTypes:"U1 U2 U4 U8 U16 U32 S8 S16 S32 F32".split(" "),validFormats:"lerc jpeg jpg jpgpng png png8 png24 png32 bip bsq".split(" "),
_eventMap:{"raster-read-complete":["pixelData","params"]},constructor:function(a){if(!a)throw"Image Service URL is not defined";this.imageServiceUrl=a;this.registerConnectEvents();this._loadRasterFormatModules()},read:function(a,b,d){var c=this,e=new v(y._dfdCanceller);if(10>q("ie"))throw"This browser is not supported.";if(!a.imageServiceParameters)throw"Insufficient parameters to read data";var f=k.clone(a.imageServiceParameters),g=a.pixelType;w.some(this.validPixelTypes,function(a){return a===g})||
(f.pixelType="F32");w.some(this.validFormats,function(a){return a.toLowerCase()===f.format.toLowerCase()})||(f.format="lerc");var l,h=a.decodeFunc;return this._prepareGetImageParameters(f),e._pendingDfd=D({url:this.imageServiceUrl+"/exportImage",handleAs:"arraybuffer",content:k.mixin(f,{f:"image"}),load:function(a){var k=f.format.toUpperCase();if("BSQ"!==k&&"BIP"!==k&&(k=c._getFormat(a)),"ERROR"===k)return a=Error(String.fromCharCode.apply(null,new Uint8Array(a))),a.log=x.isDebug,void c._resolve([a],
null,d,e,!0);((void 0===h||null===h)&&(h=c._getFormatDecoderDfd(k)),h)?h(a,{width:f.width,height:f.height,planes:null,pixelType:g,noDataValue:f.noData}).then(function(a){l={pixelBlock:a,extent:f.extent};c._resolve([l,f],"onRasterReadComplete",b,e)},function(a){c._resolve([a],null,d,e,!0)}):(a=Error("Format '"+f.format+"' is not supported."),a.log=x.isDebug,c._resolve([a],null,d,e,!0))},error:function(a){c._resolve([a],null,d,e,!0)}}),e.promise},onRasterReadComplete:function(){},_prepareGetImageParameters:function(a){if(a.size&&
a.bbox){var b=a.size.split(",");(a.width=parseFloat(b[0]),a.height=parseFloat(b[1]),a.extent)||(b=a.bbox.split(","),a.extent=new E(parseFloat(b[0]),parseFloat(b[1]),parseFloat(b[2]),parseFloat(b[3]),new F(a.bboxSR)))}else{if(!a.width||Math.floor(a.width)!==a.width||!a.height||Math.floor(a.height)!==a.height)throw"Incorrect Image Dimensions";if(!a.extent||"esri.geometry.Extent"!==a.extent.declaredClass)throw"Incorrect extent";var b=a.extent,d=b.spatialReference.wkid||A.toJson(b.spatialReference.toJson());
delete a._ts;k.mixin(a,{bbox:b.xmin+","+b.ymin+","+b.xmax+","+b.ymax,imageSR:d,bboxSR:d,size:a.width+","+a.height},a.disableClientCaching?{_ts:(new Date).getTime()}:{})}},_adjustExtent:function(a,b,d){var c=a.ymax-a.ymin,e=a.xmax-a.xmin;return d>=b?(c=e*b/d,a.ymax=a.ymin+c):(e=c*d/b,a.xmax=a.xmin+e),a},_resolve:function(a,b,d,c,e){b&&this[b].apply(this,a);d&&d.apply(null,a);c&&y._resDfd(c,a,e)},_getFormatDecoderDfd:function(a){var b=null;switch(a){case "LERC":b=this._decodeLerc;break;case "JPEG":b=
this._decodeJpeg;break;case "PNG":b=this._decodePng;break;case "BSQ":b=this._decodeBsq;break;case "BIP":b=this._decodeBip}b=k.hitch(this,b);return function(a,c){var e=new v;try{var f=b(a,c);e.resolve(f)}catch(g){e.reject(g)}return e}},_getFormat:function(a){a=new Uint8Array(a,0,10);var b="";return 255===a[0]&&216===a[1]?b="JPEG":137===a[0]&&80===a[1]&&78===a[2]&&71===a[3]?b="PNG":67===a[0]&&110===a[1]&&116===a[2]&&90===a[3]&&73===a[4]&&109===a[5]&&97===a[6]&&103===a[7]&&101===a[8]&&32===a[9]?b="LERC":
-1<String.fromCharCode.apply(null,a).toLowerCase().indexOf("error")&&(b="ERROR"),b},_validateDecodeParams:function(a){if(!a.height||Math.floor(a.height)!==a.height)throw"Height not provided.";if(!a.width||Math.floor(a.width)!==a.width)throw"Width not provided.";},_decodeJpeg:function(a,b){if(!r)throw"The jpeg decoder module is not loaded.";this._validateDecodeParams(b);var d=(new r).decode(a);if(d.height!==b.height||d.width!==b.width)throw"The decoded image dimensions are incorrect.";var c,e,f=[];
for(c=0;c<d.pixels.length;c++)e=d.pixels[c],f.push(this._calculateBandStatistics(e));return new m({width:d.width,height:d.height,pixels:d.pixels,pixelType:"U8",mask:d.mask,statistics:f})},_decodePng:function(a,b){if(!t)throw"The png decoder module is not loaded.";this._validateDecodeParams(b);var d=new Uint8Array(a),c=new t(d),d=new Uint8Array(b.width*b.height*4);c.copyToImageData(d,c.decodePixels());var e,f=c=0;e=new Uint8Array(b.width*b.height);for(c=0;c<b.width*b.height;c++)e[c]=d[4*c+3];for(var g=
new m({width:b.width,height:b.height,pixels:[],pixelType:"U8",mask:e,statistics:[]}),c=0;3>c;c++){e=new Uint8Array(b.width*b.height);for(f=0;f<b.width*b.height;f++)e[f]=d[4*f+c];g.addData({pixels:e,statistics:this._calculateBandStatistics(e)})}return g},_decodeBsq:function(a,b){if(!p)throw"The bsq decoder module is not loaded.";this._validateDecodeParams(b);g=b.noDataValue;b.pixelType=u(b.pixelType);var d,c=p.decodeBSQ(a,{bandCount:b.planes,width:b.width,height:b.height,pixelType:h,noDataValue:g}),
e=[],f=null;for(d=0;d<c.pixels.length;d++)f=c.pixels[d],e.push(this._calculateBandStatistics(f));return new m({width:b.width,height:b.height,pixels:c.pixels,pixelType:b.pixelType,mask:c.maskData,statistics:e})},_decodeBip:function(a,b){this._validateDecodeParams(b);g=b.noDataValue;b.pixelType=u(b.pixelType);var d,c=p.decodeBIP(a,{bandCount:b.planes,width:b.width,height:b.height,pixelType:h,noDataValue:g}),e=[],f=null;for(d=0;d<c.pixels.length;d++)f=c.pixels[d],e.push(this._calculateBandStatistics(f));
return new m({width:b.width,height:b.height,pixels:c.pixels,pixelType:b.pixelType,mask:c.maskData,statistics:e})},_decodeLerc:function(a,b){this._validateDecodeParams(b);g=b.noDataValue;b.pixelType=u(b.pixelType);for(var d,c,e=0,f=0,k=a.byteLength-10;k>f;){var l=G.decode(a,{inputOffset:f,encodedMaskData:d,returnMask:0===e?!0:!1,returnEncodedMask:0===e?!0:!1,returnFileInfo:!0,pixelType:h,noDataValue:g});if(f=l.fileInfo.eofOffset,0===e&&(d=l.encodedMaskData,c=new m({width:b.width,height:b.height,pixels:[],
pixelType:b.pixelType,mask:l.maskData,statistics:[]})),e++,l.height!==b.height||l.width!==b.width)throw"The decoded image dimensions are incorrect";c.addData({pixels:l.pixelData,statistics:{minValue:l.minValue,maxValue:l.maxValue,noDataValue:l.noDataValue}})}return c},_calculateBandStatistics:function(a){var b,d=1/0,c=-1/0,e=a.length,f=0;for(b=0;e>b;b++)f=a[b],d=d>f?f:d,c=f>c?f:c;return{minValue:d,maxValue:c}},_loadRasterFormatModules:function(){10>q("ie")||z(["./rasterFormats/JpgPlus","./rasterFormats/Png",
"./rasterFormats/Raw"],function(a,b,d){r=a;t=b;p=d})}});var h=null,g=null,u=function(a){return"U1"===a||"U2"===a||"U4"===a||"U8"===a?(a="U8",g=Math.pow(2,8)-1,h=Uint8Array,a):"U16"===a?(g=g||Math.pow(2,16)-1,h=Uint16Array,a):"U32"===a?(g=g||Math.pow(2,32)-1,h=Uint32Array,a):"S8"===a?(g=g||0-Math.pow(2,7),h=Int8Array,a):"S16"===a?(g=g||0-Math.pow(2,15),h=Int16Array,a):"S32"===a?(g=g||0-Math.pow(2,31),h=Int32Array,a):(h=Float32Array,a)};return q("extend-esri")&&k.setObject("layers.Raster",n,B),n});