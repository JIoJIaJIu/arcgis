//>>built
define("esri/layers/StreamLayer","dojo/_base/declare dojo/_base/connect dojo/_base/array dojo/_base/Color dojo/_base/lang dojo/has dojo/io-query dojo/on dojo/aspect ../kernel ../request ../graphic ./FeatureLayer ./StreamMode ./StreamTrackManager ../geometry/jsonUtils ../symbols/SimpleFillSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleMarkerSymbol ../renderers/SimpleRenderer ./PurgeOptions".split(" "),function(p,y,h,q,m,z,A,B,H,C,u,D,r,E,F,t,v,n,w,G,x){p=p([r],{declaredClass:"esri.layers.StreamLayer",
_preventInit:!0,constructor:function(a,b){if(b=b||{},b.mode&&b.mode!==r.MODE_STREAM||(this._isStream=!0,this.mode=r.MODE_STREAM,this.currentMode=r.MODE_STREAM,this._mode=new E(this)),this.purgeOptions=new x(this,b.purgeOptions||{}),this.purgeInterval=b.purgeInterval||0,this._reconnectAttempts=0,this.maxReconnectAttempts=10,this._reconnectTimeoutId=null,this.socket=null,this._keepLatestQueried=!1,this._keepLatestUrl=null,this._relatedQueried=!1,this._relatedUrl=null,this._joinField=null,this._refreshing=
!1,this._attemptReconnect=m.hitch(this,this._attemptReconnect),this._purge=m.hitch(this,this._purge),this._processServiceJson=m.hitch(this,this._processServiceJson),m.isObject(a)&&a.layerDefinition)this._initFeatureLayer(a,b);else{var c=this;u({url:a,content:m.mixin({f:"json"}),callbackParamName:"callback"}).then(function(a){c._processServiceJson(a,b)},function(a){c._errorHandler(a)})}},_processServiceJson:function(a,b){var c=this;a.relatedFeatures&&a.relatedFeatures.featuresUrl&&a.relatedFeatures.joinField?
(this._relatedUrl=a.relatedFeatures.featuresUrl,this._joinField=a.relatedFeatures.joinField,this.objectIdField=this._joinField,u({url:this._relatedUrl,content:{f:"json"},callbackParamName:"callback"}).then(function(d){d=d.fields||[];var e=h.map(a.fields,function(a){return a.name});h.forEach(d,function(b){-1===h.indexOf(e,b.name)&&a.fields.push(b)});b.resourceInfo=a;c._initFeatureLayer(c._url,b)},function(a){c.onError({error:a})})):(b.resourceInfo=a,this._initFeatureLayer(this._url,b))},_initLayer:function(a){if(this.inherited(arguments),
a){var b;if(a.layerDefinition)this.purgeOptions=new x(this,this._params.purgeOptions||{}),this.socketUrl=this._params.socketUrl||a.layerDefinition.socketUrl||void 0;else{if(this._params.socketUrl)this.socketUrl=this._params.socketUrl;else{var c,d=this._getWebsocketConnectionInfo(a),e=d.urls;e&&e.length?(this._socketUrls=e,this.socketUrl=e[0],this.socketDirection="broadcast"===this._params.socketDirection?"broadcast":"subscribe",this.socketUrl+="/"+this.socketDirection,this._websocketToken=d.token,
e.length>this.maxReconnectAttempts&&(this.maxReconnectAttempts=e.length)):(this.socketUrl=void 0,c="No web socket urls were retrieved from the Stream Service. Layer will not attempt to connect.","https:"===location.protocol&&(c+=" An insecure web socket connection cannot be made from a secure web page."),this.onError(Error(c)))}if(this._params.filter)try{this._filter=b=this._makeFilter(this._params.filter)}catch(f){this.onError(Error("Error trying to create filter object: "+f+". Layer will not have filter applied")),
this._filter=null}if(this._params.geometryDefinition||this._outFields||this._defnExpr){b=b||{};b.geometry=this._params.geometryDefinition;b.outFields=this._outFields;b.where=this._defnExpr;try{this._filter=b=this._makeFilter(b)}catch(k){this.onError(Error("Error trying to create filter object: "+k+". Layer will not have filter applied")),this._filter=null}}}this.maximumTrackPoints=this._params.maximumTrackPoints||0===this._params.maximumTrackPoints?this._params.maximumTrackPoints:1;(this._params.refreshRate||
0===this._params.refreshRate)&&this._mode&&this._mode._setRefreshRate&&this._mode._setRefreshRate(this._params.refreshRate);this._keepLatestUrl=a.keepLatestArchive?a.keepLatestArchive.featuresUrl:null;a.relatedFeatures&&a.relatedFeatures.featuresUrl&&a.relatedFeatures.joinField&&(this._relatedUrl=a.relatedFeatures.featuresUrl,this._joinField=a.relatedFeatures.joinField,this.objectIdField=this._joinField);this.objectIdField||this._makeObjectIdField();this._map&&this.socketUrl&&!this._connected&&this.connect()}},
_setMap:function(a){var b=this.inherited(arguments),c=this._getRenderer();return this.timeInfo&&(this._trackIdField||c&&(c.latestObservationRenderer||c.trackRenderer))&&(this._trackManager=new F(this),this._trackManager.initialize(a)),this.socketUrl&&!this._connected&&this._map&&this.connect(),b},_unsetMap:function(){h.forEach(this._connects,y.disconnect);(this._connected||this._reconnecting||this.socket)&&this.disconnect();this._togglePurgeT();this.inherited(arguments);this._map=null},_suspend:function(){this._togglePurgeT();
this.inherited(arguments)},_resume:function(){this.inherited(arguments);this._togglePurgeT(!0)},clear:function(){try{this._mode&&this._mode._clearDrawBuffer&&this._mode._clearDrawBuffer(),this._mode&&this._mode._clearTimeBin&&this._mode._clearTimeBin(),this._mode&&this._mode._clearFeatureMap&&this._mode._clearFeatureMap(),this._trackManager&&this._trackManager.clearTracks()}catch(a){}this.inherited(arguments)},redraw:function(){this._mode&&this._mode._flushDrawBuffer&&this._mode._flushDrawBuffer();
this.inherited(arguments)},setDefinitionExpression:function(a){this.setFilter({where:a})},getDefinitionExpression:function(){var a;return this._filter&&(a=this._filter.where),a},destroy:function(){this.disconnect();this.inherited(arguments)},onResume:function(){this.inherited(arguments)},setGeometryDefinition:function(a){this.setFilter({geometry:a})},getGeometryDefinition:function(){var a;return this._filter&&(a=this._filter.geometry),a},connect:function(a){var b,c,d=this,e={},f=this._filter,k=this.socketUrl;
try{if(!this._connected){if(this._map){var g;if(this._relatedUrl&&!this._relatedQueried&&this._mode._fetchArchive)return g=this.on("update-end",function(a){return d._relatedQueried=!0,g.remove(),g=null,a&&a.error?void console.log("Not connecting. Error fetching related features"):void d.connect()}),this._mode._fetchArchive(this._relatedUrl),!1;if(this._keepLatestUrl&&!this._keepLatestQueried&&this._mode._fetchArchive)return g=this.on("update-end",function(a){return d._keepLatestQueried=!0,g.remove(),
g=null,a&&a.error?void console.log("Not connecting. Error fetching archived features"):void d.connect()}),this._mode._fetchArchive(this._keepLatestUrl),!1}if(this._websocketToken&&(e.token=this._websocketToken),this._map&&this._map.spatialReference&&this.spatialReference&&this._map.spatialReference.wkid!==this.spatialReference.wkid&&(e.outSR=this._map.spatialReference.wkid),f)for(c in f)null!==f[c]&&(b="geometry"===c?JSON.stringify(f[c]):f[c],e[c]=b);return k+="?"+A.objectToQuery(e),this._createConnection(k,
a)}}catch(l){console.log("Error connecting to data stream: ",l),a&&a(l,!1),this.onConnectionError({error:l})}},disconnect:function(a){var b=this._refreshing?"Disconnecting as part of layer refresh cycle":"Connection closed from client",c=this._refreshing?!0:!1;this._reconnectTimeoutId&&clearTimeout(this._reconnectTimeoutId);this._refreshing=this._reconnecting=this._connected=!1;this.socket&&this.socket.close();this.onDisconnect({willReconnect:c,message:b});a&&a(null,!0)},setFilter:function(a){var b,
c,d;if(this._collection)return this.onError("Filter can only be set when the source of the layer is a Stream Service"),!1;try{if(void 0!==a.outFields)return d=Error("Outfields property cannot be changed after layer is created"),this.onFilterChange({filter:this.getFilter(),error:d}),!1;b=this._makeFilter(a)}catch(e){return d=Error(e),this.onFilterChange({filter:this.getFilter(),error:d}),!1}return this.socket?(c={filter:b},this.socket.send(JSON.stringify(c))):B.once(this,"connect",function(){this.setFilter(b)}),
!0},getFilter:function(){var a=this._filter,b={},c=["geometry","outFields","where"];return a&&h.forEach(c,function(c){var e=a[c];e&&("geometry"===c?e=t.fromJson(e):"outFields"===c&&(e=e.split(",")),b[c]=e)}),b},setMaximumTrackPoints:function(a){return a||0===a?(this.maximumTrackPoints=a,void this._mode.propertyChangeHandler(3)):!1},getUniqueValues:function(a){var b,c,d={},e=[];return(b=this._getField(a,!0))?(a=b.name,c=this.graphics||[],h.forEach(c,function(b){b=(b.attributes||{})[a];void 0!==b&&
(d[b]||(d[b]=1,e.push(b)))}),e.sort(function(a,b){return b>a?-1:a>b?1:0}),e):e},getLatestObservations:function(){return this._trackManager?this._trackManager.getLatestObservations():this.graphics},setPurgeInterval:function(a){var b=this.purgeInterval;return this.purgeInterval=a,this._togglePurgeT(),a&&this._togglePurgeT(!0),b!==a&&this.onPurgeIntervalChange(),this},_togglePurgeT:function(a){if(a&&this.purgeInterval){var b=this;clearTimeout(this._purgeT);this._mode&&this._mode._flushDrawBuffer&&(this._purgeT=
setTimeout(function(){b.updating||b.suspended||(b._mode._flushDrawBuffer(),b._togglePurgeT(!0))},6E4*this.purgeInterval))}else this._purgeT&&(clearTimeout(this._purgeT),this._refreshT=null)},onMessage:function(){},onConnect:function(){},onDisconnect:function(){},onFilterChange:function(){},onAttemptReconnect:function(){},onConnectionError:function(){},onPurgeIntervalChange:function(){},_createConnection:function(a,b){var c=this,d=new WebSocket(a);return d.onopen=function(){c.socket=d;c._connected=
!0;c._reconnecting=!1;c._reconnectAttempts=0;c._bind();c.onConnect();b&&b(null,!0)},d.onclose=function(a){var b,d=!0,g=c._connected,l=null;c._connected||c._reconnecting?(a.code&&(b="Connection failed: ",1001===a.code?(b+=a.reason||"Service is going away.",d=!1):4400===a.code?(b+=a.reason||"Invalid url parameters. Check filter properties.",d=!1):4404===a.code?(b+="Service not found",d=!1):(4401===a.code||4403===a.code)&&(b+="Not authorized",d=!1)),d&&(c._reconnectAttempts+=1,c._reconnectAttempts>c.maxReconnectAttempts&&
(b="Maximum reconnect attempts exceeded",d=!1,g=!0)),c._connected=!1,g&&(b&&(l=Error(b)),c.onDisconnect({error:l,willReconnect:d})),d?c._attemptReconnect():c.socket=null):(c.socket||(l=Error("Could not make connection to service"),c.onConnectionError({error:l})),c.socket=null,c._connected=!1)},d.onerror=function(){console.log("Socket error")},d},_purge:function(){var a,b,c=[];if(this.purgeOptions.displayCount&&this.graphics.length>this.purgeOptions.displayCount)for(a=0;a<this.graphics.length-this.purgeOptions.displayCount;a++)b=
this.graphics[a],c.push(b);0<c.length&&(this._mode._removeFeatures(c),this._trackManager&&this._trackManager.removeFeatures(c))},_bind:function(){var a=this;this.socket.onmessage=function(b){a._onMessage(JSON.parse(b.data))}},_onMessage:function(a){var b=this;this.onMessage(a);var c={create:function(a){b._create(a)},update:function(a){b._update(a)},"delete":function(a){b._delete(a)}};a.type?c[a.type](a.feature):a.hasOwnProperty("filter")?b._handleFilterMessage(a):this._create(a)},_create:function(a){function b(a){if(!c._featureHasOID(a,
d)){if(!a.geometry)return!1;a.attributes=a.attributes||{};a.attributes[d]=c._nextId++}a=a.declaredClass?a:new D(a);c._mode.drawFeature(a)}var c=this,d=c.objectIdField;a.length?a.forEach(function(a){a&&b(a)}):a&&b(a)},_delete:function(a){var b=this,c=a[b.objectIdField]||a.attributes[b.objectIdField],d=!1;this.graphics.forEach(function(a){a.attributes[b.objectIdField]==c&&(d=a)});d&&this.remove(d)},_update:function(a){var b=this,c=!1;this.graphics.forEach(function(d){d.attributes[b.objectIdField]==
a.attributes[b.objectIdField]&&(c=d)});c&&(a.attributes&&c.setAttributes(a.attributes),a.geometry&&c.setGeometry(t.fromJson(a.geometry)))},_makeFilter:function(a){var b,c,d,e=null;if(a=a||{},void 0!==a.geometry)if(e=e||{},null===a.geometry)e.geometry=null;else{if(b="string"==typeof a.geometry?t.fromJson(JSON.parse(a.geometry)):a.geometry.declaredClass?a.geometry:t.fromJson(a.geometry),!b||"point"===b.type)throw"Query object contains invalid geometry";if("extent"!==b.type&&(b=b.getExtent()),!b||0===
b.getHeight()&&0===b.getWidth())throw"Invalid filter geometry: Extent cannot have a height and width of 0";e.spatialRel="esriSpatialRelIntersects";e.geometryType="esriGeometryEnvelope";e.geometry=b.toJson()}if(void 0!==a.where&&(e=e||{},e.where=a.where),void 0!==a.outFields&&(e=e||{},c="string"==typeof a.outFields?"*"===a.outFields?null:a.outFields.replace(/,\s+/g,",").split(","):null===a.outFields?null:a.outFields,d=this._makeOutFields(c))){if(d.errors&&0<d.errors.length)throw"Invalid filter outFields. "+
d.errors.join(",");e.outFields=d.fields?d.fields.join(","):null}return e},_makeOutFields:function(a){var b,c=this,d=[],e=[],f={fields:null};return a&&0!==a.length?(h.forEach(a,function(a){if("*"===a)return f;var b=c._getField(a,!0);b?d.push(b.name):e.push("Field named "+a+" not found in schema.")}),b=c._getOutFields(),h.forEach(b,function(a){c._getField(a)&&-1===h.indexOf(d,a)&&d.push(a)}),f.fields=d,f.errors=e,f):f},_handleFilterMessage:function(a){var b,c;a.error?(c=Error(a.error.join(",")),this.onFilterChange({filter:this.getFilter(),
error:c})):(b=a.filter,b.geometry&&"string"==typeof b.geometry&&(b.geometry=JSON.parse(b.geometry)),this._filter=b,this.onFilterChange({filter:this.getFilter()}))},_getWebsocketConnectionInfo:function(a){var b,c,d,e,f={urls:[]},k=[],g=[];if(a.streamUrls&&h.forEach(a.streamUrls,function(a){"ws"===a.transport&&(b=a.urls,f.token=a.token)}),!b)return f;if(h.forEach(b,function(a){0===a.lastIndexOf("wss",0)?g.push(a):k.push(a)}),c="https:"===location.protocol||0===this.url.lastIndexOf("https:",0)?g:0===
k.length?g:k,1<c.length)for(a=0;a<c.length-1;a++)d=a+Math.floor(Math.random()*(c.length-a)),e=c[d],c[d]=c[a],c[a]=e;return f.urls=c,f},_attemptReconnect:function(){var a,b,c,d=this;return this._reconnectTimeoutId=null,d._connected=!1,d._socketUrls?!d._collection&&!d._reconnecting&&d.socket&&d.credential?(d._reconnecting=!0,d._getServiceConnectionMetadata(d._attemptReconnect),!1):(d._reconnecting=!0,d.socket=null,d._reconnectAttempts>d.maxReconnectAttempts?(d._reconnecting=!1,!1):(a=d._reconnectAttempts>
d._socketUrls.length-1?d._reconnectAttempts%d._socketUrls.length:d._reconnectAttempts,d.socketUrl=d._socketUrls[a],d.socketUrl+="/"+d.socketDirection,c=d._randomIntFromInterval(0,1E3),b=1E3*d._reconnectAttempts+c,void(this._reconnectTimeoutId=setTimeout(function(){d.onAttemptReconnect({count:d._reconnectAttempts,url:d.socketUrl});d.connect()},b)))):!1},_getServiceConnectionMetadata:function(a){var b=this,c=b._url.path;a="function"==typeof a?a:null;u({url:c,content:m.mixin({f:"json"},this._url.query),
callbackParamName:"callback"}).then(function(c){c=b._getWebsocketConnectionInfo(c);b._websocketToken=c.token;a&&a()},function(a){b.onError(Error(a))})},_setDefaultRenderer:function(){var a,b=this.geometryType,c=new q([5,112,176,.8]),d=new q([255,255,255]),e=new n(n.STYLE_SOLID,d,1);"esriGeometryPoint"===b||"esriGeometryMultipoint"===b?a=new w(w.STYLE_CIRCLE,10,e,c):"esriGeometryPolyline"===b?a=new n(n.STYLE_SOLID,c,2):("esriGeometryPolygon"===b||"esriGeometryEnvelope"===b)&&(c=new q([5,112,176,.2]),
d=new q([5,112,176,.8]),e=new n(n.STYLE_SOLID,d,1),a=new v(v.STYLE_SOLID,e,c));a&&this.setRenderer(new G(a))},_makeObjectIdField:function(){var a,b,c=1,d=[];if(!this.objectIdField){a=this.fields.length;for(b=0;a>b;b++)d.push(this.fields[b].name.toLowerCase());for(;-1!==h.indexOf(d,"objectid_"+c);)c+=1;this.objectIdField="objectid_"+c;this.fields.push({name:"objectid_"+c,type:"esriFieldTypeOID",alias:"objectid_"+c,nullable:!1})}},_featureHasOID:function(a,b){return a.attributes&&(a.attributes[b]||
0===a.attributes[b])},_randomIntFromInterval:function(a,b){return Math.floor(Math.random()*(b-a+1)+a)}});return z("extend-esri")&&m.setObject("layers.StreamLayer",p,C),p});