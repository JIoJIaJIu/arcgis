//>>built
define("esri/layers/StreamMode","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../SpatialReference ../tasks/query ../tasks/QueryTask ../geometry/jsonUtils ./RenderMode".split(" "),function(l,p,m,r,t,u,v,w,x,y){l=l([y],{declaredClass:"esri.layers._StreamMode",constructor:function(a){this.featureLayer=a;this._featureMap={};this._setRefreshRate();this._drawBuffer={adds:[],updates:[]};this._timeoutId=null;this._flushDrawBuffer=p.hitch(this,this._flushDrawBuffer);this._featuresByTime=
{};this._lastEndTimeCheck=null;this._maxFeatureAge=0;a.purgeOptions&&a.purgeOptions.age&&"number"==typeof a.purgeOptions.age&&(this._maxFeatureAge=1E3*Math.ceil(60*a.purgeOptions.age));this._drawFeatures=p.hitch(this,this._drawFeatures);this._queryErrorHandler=p.hitch(this,this._queryErrorHandler)},startup:function(){this.featureLayer._collection},propertyChangeHandler:function(a){this._init&&(0===a?this._applyTimeFilter():3===a?this._redrawAllTracks():console.debug("StreamLayer: Stream Layer only supports changing map time or maximumTrackPoints. Layer id \x3d "+
this.featureLayer.id))},drawFeature:function(a){var b=this.featureLayer,d=b.objectIdField;this._timeoutId||(this._timeoutId=setTimeout(this._flushDrawBuffer,this._refreshRate));b._joinField&&this._getFeature(a.attributes[d])?this._drawBuffer.updates.push({oid:a.attributes[d],updates:a}):this._drawBuffer.adds.push(a)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var a=this.featureLayer;a&&(a._relatedUrl||a._keepLatestUrl?(a._fireUpdateStart(),a._refreshing=!0,a.disconnect(),
a.clear(),a._relatedQueried=!1,a._keepLatestQueried=!1,a.connect()):(a._fireUpdateStart(),a.clear(),a._fireUpdateEnd()))},_drawFeatures:function(a,b){this._purgeRequests();var d=this.featureLayer;d._create(a.features||[]);d._fireUpdateEnd(null,b)},_applyTimeFilter:function(){this.inherited(arguments);this._redrawAllTracks()},_removeFeatures:function(a){var b=this.featureLayer,d=b.objectIdField;a&&m.forEach(a,function(a){a=a.attributes[d];b._unSelectFeatureIIf(a,this);this._decRefCount(a);this._removeFeatureIIf(a)},
this)},_addFeatures:function(a){var b,d,c,e=this.featureLayer,g=e._endTimeField,f=e._startTimeField,h=[],n=[],k=[];if(b=e._trackManager,d=e.objectIdField,b)for(c in a=b.addFeatures(a),a)a.hasOwnProperty(c)&&(h.push(c),a[c].adds&&(n=n.concat(a[c].adds)),a[c].deletes&&(k=k.concat(a[c].deletes)));else n=a;m.forEach(n,function(a){var b,c,e=a.attributes[d];b=g&&a.attributes[g];!b&&this._maxFeatureAge&&(b=f&&a.attributes[f]?a.attributes[f]+this._maxFeatureAge:Date.now()+this._maxFeatureAge);b&&(c=1E3*Math.ceil(b/
1E3),this._featuresByTime[c]?this._featuresByTime[c].push(e):this._featuresByTime[c]=[e]);this._addFeatureIIf(e,a);this._incRefCount(e)},this);k.length&&this._removeFeatures(k);b&&b.refreshTracks(h)},_updateFeatures:function(a){var b,d,c=this.featureLayer,e=[];b=c._trackManager;d=c._trackIdField;m.forEach(a,function(a){var f,h;f=a.updates;if(a=this._getFeature(a.oid)){f.geometry&&a.setGeometry(f.geometry);f=f.attributes||{};for(h in f)f.hasOwnProperty(h)&&(a.attributes[h]=f[h]);a.visible=this._checkFeatureTimeIntersects(a);
b&&a.attributes[d]?e.push(a.attributes[d]):c._repaint(a,null,!0)}},this);e.length&&b.refreshTracks(e)},_redrawAllTracks:function(){var a,b=this.featureLayer._trackManager;b&&(a=b.trimTracks(),a&&0<a.length&&(this._removeFeatures(a),b.refreshTracks()))},_flushDrawBuffer:function(){clearTimeout(this._timeoutId);var a,b=this._drawBuffer,d=b.adds.splice(0,b.adds.length),b=b.updates.splice(0,b.updates.length),c=this.featureLayer;return c?(c.updating||c._fireUpdateStart(),this._addFeatures(d),this._updateFeatures(b),
a=this._getExpiredFeatures(),a&&a.length&&(this._removeFeatures(a),c._trackManager&&c._trackManager.removeFeatures(a)),c._purge(),c._fireUpdateEnd(),void(this._timeoutId=null)):!1},_clearDrawBuffer:function(){var a=this._timeoutId,b=this._drawBuffer,d=b.adds,b=b.updates;a&&clearTimeout(a);d.splice(0,d.length);b.splice(0,b.length);this._timeoutId=null},_clearTimeBin:function(){this._featuresByTime={};this._lastEndTimeCheck=1E3*Math.ceil(Date.now()/1E3)},_clearFeatureMap:function(){this._featureMap=
{}},_setRefreshRate:function(a){a=a||0===a?a:200;0>a&&(a=200);this._refreshRate=a},_checkFeatureTimeIntersects:function(a){var b,d=this.featureLayer,c=d.getMap();return(c=c?c.timeExtent:null)&&d.timeInfo&&(d.timeInfo.startTimeField||d.timeInfo.endTimeField)?(b=d._filterByTime([a],c.startTime,c.endTime),0<b.match.length):!0},_getRequestId:function(a){return("_"+a.name+a.layerId+a._ulid).replace(/[^a-zA-Z0-9\_]+/g,"_")},_fetchArchive:function(a){function b(a){l++;c.execute(e).then(function(b){a(null,
b)},function(b){a(b)})}function d(a,c){return a?l>=p||!k._relatedUrl?void m._queryErrorHandler(Error("Could not get features from related feature service")):(q={relatedFeatureWarning:"Querying related feature service using the current filter failed. All related features are displayed, and the filter is applied to the stream service only"},e.where="1\x3d1",void b(d)):void m._drawFeatures(c,q)}var c,e,g,f,h,n,k=this.featureLayer;if(k._fireUpdateStart(),!a||!this.map)return this._fireUpdateEnd({error:"Archive data cannot be fetched if no feature service url is provided or if the layer is not added to a map"}),
!1;c=new w(a);e=new v;a=this.map;g=k.getFilter()||{};f=g.where||"1\x3d1";h=g.geometry?x.fromJson(g.geometry):null;g=g.outFields?g.outFields.split(","):["*"];e.geometry=h;e.where=f;e.outFields=g;e.returnGeometry=!0;e.outSpatialReference=new u(a.spatialReference.toJson());k._usePatch&&(n=this._getRequestId(k),this._cancelPendingRequest(null,n));var l=0,p=2,m=this,q=null;b(d)},_queryErrorHandler:function(a){this._purgeRequests();var b=this.featureLayer;b._errorHandler(a);b._fireUpdateEnd(a)},_getExpiredFeatures:function(){var a,
b,d,c=[],e=[];if(!this.featureLayer._endTimeField&&!this._maxFeatureAge)return e;if(a=1E3*Math.floor(this._lastEndTimeCheck/1E3),b=1E3*Math.ceil(Date.now()/1E3),this._lastEndTimeCheck=b,a&&a!==b)for(d=this._featuresByTime;b>=a;a+=1E3)d[a]&&(c=c.concat(d[a]),delete d[a]);return m.forEach(c,function(a){(a=this._getFeature(a))&&e.push(a)},this),e}});return r("extend-esri")&&p.setObject("layers._StreamMode",l,t),l});