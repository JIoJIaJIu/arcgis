//>>built
define("esri/layers/WMTSLayer","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/sniff dojox/xml/parser ../kernel ../lang ../request ../WKIDUnitConversion ../SpatialReference ../geometry/Point ../geometry/Extent ../geometry/webMercatorUtils ./TiledMapServiceLayer ./TileInfo ./WMTSLayerInfo dojo/query".split(" "),function(h,x,y,k,z,F,G,A,H,B,C,D,E,I,J,K,L){x=x([J],{declaredClass:"esri.layers.WMTSLayer",copyright:null,extent:null,tileUrl:null,spatialReference:null,tileInfo:null,
constructor:function(b,a){if(this.version="1.0.0",this.tileUr=this._url=b,this.serviceMode="RESTful",this._parseCapabilities=y.hitch(this,this._parseCapabilities),this._getCapabilitiesError=y.hitch(this,this._getCapabilitiesError),a||(a={}),a.serviceMode){if("KVP"!==a.serviceMode&&"RESTful"!==a.serviceMode)return void console.error("WMTS mode could only be 'KVP' or 'RESTful'");this.serviceMode=a.serviceMode}this.layerInfo=new L;a.layerInfo&&(this.layerInfo=a.layerInfo,this._identifier=a.layerInfo.identifier,
this._tileMatrixSetId=a.layerInfo.tileMatrixSet,a.layerInfo.format&&(this.format="image/"+a.layerInfo.format),this._style=a.layerInfo.style,this.title=a.layerInfo.title,this._dimension=a.layerInfo.dimension);a.resourceInfo?(this.version=a.resourceInfo.version,a.resourceInfo.getTileUrl&&(this._url=this.tileUrl=a.resourceInfo.getTileUrl),this.copyright=a.resourceInfo.copyright,this.layerInfos=a.resourceInfo.layerInfos,this._parseResourceInfo(),this.loaded=!0,this.onLoad(this)):this._getCapabilities();
this._formatDictionary={"image/png":".png","image/png8":".png","image/png24":".png","image/png32":".png","image/jpg":".jpg","image/jpeg":".jpeg","image/gif":".gif","image/bmp":".bmp","image/tiff":".tif","image/jpgpng":"","image/jpegpng":"","image/unknown":""}},setActiveLayer:function(b){this.setVisibleLayer(b)},setVisibleLayer:function(b){this._setActiveLayer(b);this.refresh(!0)},getTileUrl:function(b,a,c){b=this._levelToLevelValue[b];var d;return d=this.resourceUrls&&0<this.resourceUrls.length?this.resourceUrls[a%
this.resourceUrls.length].template.replace(/\{Style\}/gi,this._style).replace(/\{TileMatrixSet\}/gi,this._tileMatrixSetId).replace(/\{TileMatrix\}/gi,b).replace(/\{TileRow\}/gi,a).replace(/\{TileCol\}/gi,c).replace(/\{dimensionValue\}/gi,this._dimension):this.UrlTemplate.replace(/\{level\}/gi,b).replace(/\{row\}/gi,a).replace(/\{col\}/gi,c),this.addTimestampToURL(d)},getTileUrlTemplate:function(b){var a,c=b.identifier,d=b.tileMatrixSet,e=b.format,f=b.style;b=b.dimension;if(c?a=k.filter(this.layers,
function(a){return a.identifier===c})[0]:(a=this.layers[0],c=this.layers[0].identifier),!a)return console.error("couldn't find the layer "+c),void this.onError(Error("couldn't find the layer "+c));if(e){if(-1===e.indexOf("image/")&&(e="image/"+e),-1===k.indexOf(a.formats,e))return console.error("The layer doesn't support the format of "+e),void this.onError(Error("The layer doesn't support the format of "+e))}else e=a.formats[0],-1===e.indexOf("image/")&&(e="image/"+e);if(f){if(-1===k.indexOf(a.styles,
f))return console.error("The layer doesn't support the style of "+f),void this.onError(Error("The layer doesn't support the style of "+f))}else f=a.styles[0];if(!b&&a.dimensions)b=a.dimensions[0];else if(-1===k.indexOf(a.dimensions,b))return console.error("The layer doesn't support the dimension of "+b),void this.onError(Error("The layer doesn't support the dimension of "+b));var g;if(d){if(g=k.filter(a.tileMatrixSetInfos,function(a){return a.tileMatrixSet===d})[0],!g)return console.error("The tileMatrixSetId "+
d+" is not supported by the layer of "+c),void this.onError(Error("The tileMatrixSetId "+d+" is not supported by the layer of "+c))}else(g=k.filter(a.tileMatrixSetInfos,function(a){return"GoogleMapsCompatible"===a.tileMatrixSet})[0])||(g=a.tileMatrixSetInfos[0]),d=g.tileMatrixSet;return this._getTileUrlTemplate(c,d,e,f,b)},_getTileUrlTemplate:function(b,a,c,d,e){var f;if(b||(b=this._identifier),a||(a=this._tileMatrixSetId),c||(c=this.format),d||""===d||(d=this._style),this.resourceUrls&&0<this.resourceUrls.length)return f=
this.resourceUrls[0].template,f.indexOf(".xxx")===f.length-4&&(f=f.slice(0,f.length-4)),f=f.replace(/\{Style\}/gi,d),f=f.replace(/\{TileMatrixSet\}/gi,a),f=f.replace(/\{TileMatrix\}/gi,"{level}"),f=f.replace(/\{TileRow\}/gi,"{row}"),f=f.replace(/\{TileCol\}/gi,"{col}"),f.replace(/\{dimensionValue\}/gi,e);"KVP"===this.serviceMode?f=this._url+"SERVICE\x3dWMTS\x26VERSION\x3d"+this.version+"\x26REQUEST\x3dGetTile\x26LAYER\x3d"+b+"\x26STYLE\x3d"+d+"\x26FORMAT\x3d"+c+"\x26TILEMATRIXSET\x3d"+a+"\x26TILEMATRIX\x3d{level}\x26TILEROW\x3d{row}\x26TILECOL\x3d{col}":
"RESTful"===this.serviceMode&&(e="",this._formatDictionary[c.toLowerCase()]&&(e=this._formatDictionary[c.toLowerCase()]),f=this._url+b+"/"+d+"/"+a+"/{level}/{row}/{col}"+e);return f},_parseResourceInfo:function(){var b,a=this.layerInfos;"KVP"===this.serviceMode&&(this._url+=-1<this._url.indexOf("?")?"":"?");for(b=0;b<a.length;b++)if(!(this._identifier&&a[b].identifier!==this._identifier||this.title&&a[b].title!==this.title||this._tileMatrixSetId&&a[b].tileMatrixSet!==this._tileMatrixSetId||this.format&&
"image/"+a[b].format!==this.format||this._style&&a[b].style!==this._style)){y.mixin(this,{description:a[b].description,tileInfo:a[b].tileInfo,spatialReference:a[b].tileInfo.spatialReference,fullExtent:a[b].fullExtent,initialExtent:a[b].initialExtent,_identifier:a[b].identifier,_tileMatrixSetId:a[b].tileMatrixSet,format:"image/"+a[b].format,_style:a[b].style});break}this._setActiveLayer();this.UrlTemplate=this._getTileUrlTemplate();this._levelToLevelValue=[];k.forEach(this.tileInfo.lods,function(a){this._levelToLevelValue[a.level]=
a.levelValue?a.levelValue:a.level},this)},_getCapabilities:function(){var b;"KVP"===this.serviceMode?b=-1<this._url.indexOf("?")?this._url+"\x26request\x3dGetCapabilities\x26service\x3dWMTS\x26version\x3d"+this.version:this._url+"?request\x3dGetCapabilities\x26service\x3dWMTS\x26version\x3d"+this.version:"RESTful"===this.serviceMode&&(b=this._url+"/"+this.version+"/WMTSCapabilities.xml");H({url:b,handleAs:"text",load:this._parseCapabilities,error:this._getCapabilitiesError})},_parseCapabilities:function(b){b=
b.replace(/ows:/gi,"");b=F.parse(b);var a=h.query("Contents",b)[0];if(!a)return console.error("The WMTS capabilities XML is not valid"),void this.onError(Error("The WMTS capabilities XML is not valid"));var c,d,e,f=h.query("OperationsMetadata",b)[0];c=h.query("[name\x3d'GetTile']",f)[0];var f=this._url,g=h.query("Get",c),u=!1;for(c=0;c<g.length;c++){var l=h.query("Constraint",g[c])[0];if(!l||this._getTagWithChildTagValue("AllowedValues","Value",this.serviceMode,l)){f=g[c].attributes[0].nodeValue;
u=!0;break}!l||this._getTagWithChildTagValue("AllowedValues","Value","RESTful",l)?d=g[c].attributes[0].nodeValue:(!l||this._getTagWithChildTagValue("AllowedValues","Value","KVP",l))&&(e=g[c].attributes[0].nodeValue)}u||("KVP"===this.serviceMode&&d?(f=d,this.serviceMode="RESTful"):"RESTful"===this.serviceMode&&e&&(f=e,this.serviceMode="KVP"));-1===f.indexOf("/1.0.0/")&&"RESTful"===this.serviceMode&&(f+="/");"KVP"===this.serviceMode&&(f+=-1<f.indexOf("?")?"":"?");this._url=f;this.copyright=this._getTagValues("Capabilities\x3eServiceIdentification\x3eAccessConstraints",
b)[0];var q;d=h.query("Layer",a);var m=[];this.layers=[];k.forEach(d,function(b){q=this._getTagValues("Identifier",b)[0];m.push(q);this.layers.push(this._getWMTSLayerInfo(q,b,a))},this);this._setActiveLayer();this.loaded=!0;this.onLoad(this)},_setActiveLayer:function(b){if(b||(b={}),b.identifier&&(this._identifier=b.identifier),b.tileMatrixSet&&(this._tileMatrixSetId=b.tileMatrixSet),b.format&&(this.format=b.format),b.style&&(this._style=b.style),b.dimension&&(this._dimension=b.dimension),this.layers){var a;
if(this._identifier?a=k.filter(this.layers,function(a){return a.identifier===this._identifier},this)[0]:(a=this.layers[0],this._identifier=this.layers[0].identifier),!a)return console.error("couldn't find the layer "+this._identifier),void this.onError(Error("couldn't find the layer "+this._identifier));if(this.format){if(-1===this.format.indexOf("image/")&&(this.format="image/"+this.format),-1===k.indexOf(a.formats,this.format))return console.error("The layer doesn't support the format of "+this.format),
void this.onError(Error("The layer doesn't support the format of "+this.format))}else this.format=a.formats[0],-1===this.format.indexOf("image/")&&(this.format="image/"+this.format);if(this._style){if(-1===k.indexOf(a.styles,this._style))return console.error("The layer doesn't support the style of "+this._style),void this.onError(Error("The layer doesn't support the style of "+this._style))}else this._style=a.styles[0];if(!this._dimension&&a.dimensions)this._dimension=a.dimensions[0];else if(-1===
k.indexOf(a.dimensions,this._dimension))return console.error("The layer doesn't support the dimension of "+this._dimension),void this.onError(Error("The layer doesn't support the dimension of "+this._dimension));var c;if(this._tileMatrixSetId){if(c=k.filter(a.tileMatrixSetInfos,function(a){return a.tileMatrixSet===this._tileMatrixSetId},this)[0],!c)return console.error("The tileMatrixSetId "+this._tileMatrixSetId+" is not supported by the layer of "+this._identifier),void this.onError(Error("The tileMatrixSetId "+
this._tileMatrixSetId+" is not supported by the layer of "+this._identifier))}else(c=k.filter(a.tileMatrixSetInfos,function(a){return"GoogleMapsCompatible"===a.tileMatrixSet})[0])||(c=a.tileMatrixSetInfos[0]),this._tileMatrixSetId=c.tileMatrixSet;this.description=a.description;this.title=a.title;this.spatialReference=c.tileInfo.spatialReference;this.tileInfo=c.tileInfo;this._levelToLevelValue=[];k.forEach(this.tileInfo.lods,function(a){this._levelToLevelValue[a.level]=a.levelValue?a.levelValue:a.level},
this);102100===this.spatialReference.wkid||102113===this.spatialReference.wkid?this.fullExtent=this.initialExtent=I.geographicToWebMercator(a.gcsExtent):4326===this.spatialReference.wkid?this.fullExtent=this.initialExtent=a.gcsExtent:(this.fullExtent=c.fullExtent,this.initialExtent=c.initialExtent);this.resourceUrls=a.resourceUrls;this.UrlTemplate=this._getTileUrlTemplate();this.layerInfo={identifier:this._identifier,tileMatrixSet:this._tileMatrixSetId,format:this.format,style:this._style,fullExtent:this.fullExtent,
initialExtent:this.initialExtent,tileInfo:this.tileInfo,title:this.title,description:this.description}}},_getWMTSLayerInfo:function(b,a,c){var d,e=this._getTagValues("Abstract",a)[0],f=this._getTagValues("Title",a)[0],g=h.query("WGS84BoundingBox",a)[0],u=g?this._getTagValues("LowerCorner",g)[0].split(" "):["-180","-90"],l=g?this._getTagValues("UpperCorner",g)[0].split(" "):["180","90"],g=parseFloat(u[0]),u=parseFloat(u[1]),q=parseFloat(l[0]),l=parseFloat(l[1]),g=new E(g,u,q,l,new C({wkid:4326})),
l=this._getTagValues("Identifier",h.query("Style",a)[0]),m=this._getTagValues("Identifier",h.query("Dimension",a)[0]),w=this._getTagValues("Value",h.query("Dimension",a)[0])||this._getTagValues("Default",h.query("Dimension",a)[0]),u=this._getTagValues("Format",a);c=this._getLayerMatrixInfos(a,c);b={identifier:b,tileMatrixSetInfos:c,formats:u,styles:l,title:f,description:e,gcsExtent:g,dimensions:w};a=h.query("ResourceURL",a);var n=[];return k.forEach(a,function(a){d=a.getAttribute("template");m&&w&&
(d=d.replace("{"+m+"}","{dimensionValue}"));n.push({template:d,format:a.getAttribute("format"),resourceType:a.getAttribute("resourceType")})}),n&&0<n.length&&(b.resourceUrls=n),b},_getLayerMatrixInfos:function(b,a){var c,d=[];this._allMatrixInfos||(this._allMatrixInfos=[]);var e=this._getTagValues("TileMatrixSet",b);if(e&&0!==e.length)return k.forEach(e,function(f){var e;if(0<this._allMatrixInfos.length)for(c=0;c<this._allMatrixInfos.length;c++)if(this._allMatrixInfos[c].tileMatrixSet==f){e=this._allMatrixInfos[c];
break}e||(e=this._getLayerMatrixInfo(f,b,a),this._allMatrixInfos.push(e));d.push(e)},this),d},_getLayerMatrixInfo:function(b,a,c){var d,e,f,g,k=[];a=this._getTagWithChildTagValue("TileMatrixSetLink","TileMatrixSet",b,a);var l=this._getTagValues("TileMatrix",a),q=this._getTagWithChildTagValue("TileMatrixSet","Identifier",b,c),m=this._getTagValues("SupportedCRS",q)[0];d=parseInt(m.split(":").pop(),10);900913!=d&&3857!=d||(d=102100);-1<m.toLowerCase().indexOf("crs84")||-1<m.toLowerCase().indexOf("crs:84")?
(d=4326,g=!0):-1<m.toLowerCase().indexOf("crs83")||-1<m.toLowerCase().indexOf("crs:83")?(d=4269,g=!0):(-1<m.toLowerCase().indexOf("crs27")||-1<m.toLowerCase().indexOf("crs:27"))&&(d=4267,g=!0);var w=new C({wkid:d}),n=h.query("TileMatrix",q)[0];c=parseInt(this._getTagValues("TileWidth",n)[0],10);a=parseInt(this._getTagValues("TileHeight",n)[0],10);e=this._getTagValues("TopLeftCorner",n)[0].split(" ");var r=e[0],v=e[1];1<r.split("E").length&&(e=r.split("E"),r=e[0]*Math.pow(10,e[1]));1<v.split("E").length&&
(e=v.split("E"),v=e[0]*Math.pow(10,e[1]));var r=parseFloat(r),v=parseFloat(v),x=g&&4326===d&&90===r&&-180===v;for(e=0;e<this._flippingAxisForWkids.length;e++)if(m.split(":").pop()>=this._flippingAxisForWkids[e][0]&&m.split(":").pop()<=this._flippingAxisForWkids[e][1]||4326===d&&(!g||x)){4326===d&&90<r&&(r="90");f=new D(v,r,w);break}if(e===this._flippingAxisForWkids.length&&(f=new D(r,v,w)),0===l.length)for(l=h.query("TileMatrix",q),e=0;e<l.length;e++)g=this._getLodFromTileMatrix(l[e],d,e,b),k.push(g);
else for(e=0;e<l.length;e++)g=this._getTagWithChildTagValue("TileMatrix","Identifier",l[e],q),g=this._getLodFromTileMatrix(g,d,e,b),k.push(g);var t,p;d=h.query("BoundingBox",q)[0];(d&&(t=this._getTagValues("LowerCorner",d)[0].split(" "),p=this._getTagValues("UpperCorner",d)[0].split(" ")),t&&1<t.length&&p&&1<p.length)?(n=parseFloat(t[0]),d=parseFloat(t[1]),t=parseFloat(p[0]),p=parseFloat(p[1])):(t=this._getTagValues("MatrixWidth",n)[0],d=this._getTagValues("MatrixHeight",n)[0],n=f.x,p=f.y,t=n+t*a*
k[0].resolution,d=p-d*c*k[0].resolution);p=new E(n,d,t,p,w);f=new K({dpi:96,spatialReference:w,format:this.format,rows:c,cols:a,origin:f,lods:k});return{tileMatrixSet:b,fullExtent:p,initialExtent:p,tileInfo:f}},_getCapabilitiesError:function(b){console.error("Failed to get capabilities xml");this.onError(b)},_getLodFromTileMatrix:function(b,a,c,d){var e=this._getTagValues("Identifier",b)[0];b=this._getTagValues("ScaleDenominator",b)[0];1<b.split("E").length?(b=b.split("E"),b=b[0]*Math.pow(10,b[1])):
b=parseFloat(b);a=A.isDefined(B[a])?B.values[B[a]]:"default028mm"===d?6370997*Math.PI/180:6378137*Math.PI/180;a=7*b/25E3/a;return{level:c,levelValue:e,scale:1.058267716535433*b,resolution:a}},_getTag:function(b,a){var c=h.query(b,a);return c&&0<c.length?c[0]:null},_getTagValues:function(b,a){var c,d,e=[],f=b.split("\x3e");if(c=h.query(f[0],a)[0],1<f.length){for(d=1;d<f.length-1;d++)c=h.query(f[d],c)[0];c=h.query(f[f.length-1],c)}else c=h.query(f[0],a);return c&&0<c.length&&k.forEach(c,function(a){e.push(9>
z("ie")?a.childNodes.length?a.childNodes[0].nodeValue:"":a.textContent)}),e},_getAttributeValues:function(b,a,c){b=h.query(b,c);var d=[];return b&&0<b.length&&k.forEach(b,function(b){d.push(b.getAttribute(a))}),d},_getTagWithChildTagValue:function(b,a,c,d){var e,f=d.childNodes;for(d=0;d<f.length;d++)if(-1<f[d].nodeName.indexOf(b)&&(9>z("ie")?A.isDefined(h.query(a,f[d])[0])&&(e=h.query(a,f[d])[0].childNodes[0].nodeValue):A.isDefined(h.query(a,f[d])[0])&&(e=h.query(a,f[d])[0].textContent),e===c||c.split(":")&&
e===c.split(":")[1]))return f[d]},_flippingAxisForWkids:[[3819,3819],[3821,3824],[3889,3889],[3906,3906],[4001,4025],[4027,4036],[4039,4047],[4052,4055],[4074,4075],[4080,4081],[4120,4176],[4178,4185],[4188,4216],[4218,4289],[4291,4304],[4306,4319],[4322,4326],[4463,4463],[4470,4470],[4475,4475],[4483,4483],[4490,4490],[4555,4558],[4600,4646],[4657,4765],[4801,4811],[4813,4821],[4823,4824],[4901,4904],[5013,5013],[5132,5132],[5228,5229],[5233,5233],[5246,5246],[5252,5252],[5264,5264],[5324,5340],
[5354,5354],[5360,5360],[5365,5365],[5370,5373],[5381,5381],[5393,5393],[5451,5451],[5464,5464],[5467,5467],[5489,5489],[5524,5524],[5527,5527],[5546,5546],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3038,3051],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3150,3151],[3300,3301],[3328,3335],[3346,3346],
[3350,3352],[3366,3366],[3389,3390],[3416,3417],[3833,3841],[3844,3850],[3854,3854],[3873,3885],[3907,3910],[4026,4026],[4037,4038],[4417,4417],[4434,4434],[4491,4554],[4839,4839],[5048,5048],[5105,5130],[5253,5259],[5269,5275],[5343,5349],[5479,5482],[5518,5519],[5520,5520],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,
31259],[31275,31279],[31281,31290],[31466,31700],[900913,900913]]});return z("extend-esri")&&y.setObject("layers.WMTSLayer",x,G),x});