//>>built
define("esri/layers/GraphicsLayer","dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/dom-attr dojo/dom-construct dojo/dom-style dojo/dom dojox/gfx dojox/gfx/matrix ./gfxSniff!esri-svg?dojox/gfx/filters ./layer ../kernel ../lang ../sniff ../Color ../domUtils ../symbols/MarkerSymbol ../symbols/SimpleMarkerSymbol ../geometry/Point ../geometry/ScreenPoint ../geometry/Extent ../geometry/mathUtils ../geometry/screenUtils ../PluginTarget ./gfxSniff!esri-svg?dojox/gfx/svgext".split(" "),
function(G,t,A,u,R,W,O,ca,J,K,B,da,S,Y,H,ea,M,X,C,Z,T,L,aa,U,fa){var P,Q=-1!==J.renderer.toLowerCase().indexOf("svg"),N=-1!==J.renderer.toLowerCase().indexOf("canvas"),y=9>H("ie"),ba=H("esri-touch");X=G(null,{declaredClass:"esri.layers._GraphicsContainer",_setMap:function(a,c){var b,e=this._connects=[];(this._map=a,N)?(b=W.create("div",{style:"overflow: visible; position: absolute;"},c),this._surface={getEventSource:function(){return b}},e.push(t.connect(b,"onmousedown",this,this._canvasDownHandler)),
e.push(t.connect(b,"onmouseup",this,this._canvasUpHandler)),e.push(t.connect(b,"onclick",this,this._canvasClickHandler)),P.prototype._canvas=!0):(b=(this._surface=J.createSurface(c,a.width,a.height)).getEventSource(),O.set(b=y?b.parentNode:b,{overflow:"visible",position:"absolute"}));return e.push(t.connect(a,"onResize",this,"_onResizeHandler")),b},_onResizeHandler:function(a,c,b){var e;a=this._surface.getEventSource();var d=this._map;y&&O.set(a=a.parentNode,{width:c+"px",height:b+"px",clip:"rect(0px "+
c+"px "+b+"px 0px)"});R.set(a,"width",c);R.set(a,"height",b);this._surface.declaredClass||u.forEach(a.childNodes,function(a){R.set(a,"width",c);R.set(a,"height",b)});d.loaded&&(d.graphics.suspended||(d.graphics._resized=!0),u.forEach(d.graphicsLayerIds,function(a){e=d.getLayer(a);e.suspended||(e._resized=!0);e._updateSVGFilters(null,null,c,b)}))},_cleanUp:function(){u.forEach(this._connects,t.disconnect,t);this._map=this._surface=null},_processEvent:function(a){var c=this._map;a.screenPoint=new T(a.pageX-
c.position.x,a.pageY-c.position.y);a.mapPoint=c.toMap(a.screenPoint)},_canvasDownHandler:function(a){this._processEvent(a);this._downPt=a.screenPoint.x+","+a.screenPoint.y},_canvasUpHandler:function(a){this._processEvent(a);this._upPt=a.screenPoint.x+","+a.screenPoint.y},_tolerance:15,_isPrimaryMatch:function(a,c,b,e){if(!a.visible||!c)return!1;var d,f=c.getTransformedBoundingBox();return f?(d=new L(f[0].x,f[0].y,f[2].x,f[2].y),delete d.spatialReference,ba?d.intersects(b):d.contains(e)):u.some(c.children||
[],function(a){return f=a.getTransformedBoundingBox(),d=new L(f[0].x,f[0].y,f[2].x,f[2].y),delete d.spatialReference,ba?d.intersects(b):d.contains(e)})},_canvasClickHandler:function(a){if(this._downPt&&this._upPt&&this._downPt===this._upPt){this._processEvent(a);var c=this._map,b=u.map(c.graphicsLayerIds,function(a){return c.getLayer(a)});b.push(c.graphics);b.reverse();var b=u.filter(b,function(a){return a.loaded&&a._mouseEvents&&!a.suspended&&(!Y.isDefined(a.opacity)||0<a.opacity)}),e,d=a.screenPoint,
f=this._tolerance,g=d.x-f,h=d.y+f,k=d.x+f,f=d.y-f,l=new L(g,f,k,h),g=c.toMap(new T(g,h)),k=c.toMap(new T(k,f)),h=g.spatialReference._getInfo(),m=new L(L.prototype._normalizeX(g.x,h).x,g.y,L.prototype._normalizeX(k.x,h).x,k.y,g.spatialReference);(delete l.spatialReference,u.some(b,function(a){a=u.filter(a.graphics,function(a){return this._isPrimaryMatch(a,a.getDojoShape(),l,d)||!(!a._bgShape||!this._isPrimaryMatch(a,a._bgShape,l,d))},this);if(a.reverse(),0<a.length){var b;if(u.some(a,function(a){return a.geometry&&
m.intersects(a.geometry)?(b=a,!0):!1}),b)return e=b,!0}return!1},this),e)&&(b=e.getLayer())&&(a.graphic=e,b.onClick(a))}}});P=G(da,{declaredClass:"esri.layers._GraphicsLayer",managedSuspension:!0,surfaceType:N?"canvas-2d":J.renderer,_eventMap:{"graphic-add":["graphic"],"graphic-remove":["graphic"],"renderer-change":["renderer"]},constructor:function(a,c){a&&(A.isString(a)||A.isObject(a)&&(a.layerDefinition||a.query))&&(a=c);this._params=A.mixin({displayOnPan:!0,drawMode:!0,styling:!0},a||{});var b=
this._params.dataAttributes;"string"==typeof b&&(b=[b]);this.styling=Q?this._params.styling:!0;this.dataAttributes=b;this.infoTemplate=a&&a.infoTemplate;this.graphics=[];this._draw=A.hitch(this,this._draw);this._refresh=A.hitch(this,this._refresh);this.registerConnectEvents()},getNode:function(){return this._div&&this._div.getEventSource()},setDrawMode:function(a){this._params.drawMode=a},renderer:null,_setMap:function(a,c){this.inherited(arguments);this._map=a;this._wrap=a.wrapAround180;this._srInfo=
a.spatialReference._getInfo();this._svgFilters={};this._canvas?(c=J.createSurface(c.getEventSource(),a.width,a.height),O.set(c.rawNode,"position","absolute"),this._div=c.createGroup(),this._renderProto=this._div.constructor.prototype._render,this._div._render=A.hitch(this,this._canvasRender)):this._div=c.createGroup();this._bgGroup=this._div.createGroup();this._div.getEventSource().id=this.id+"_layer";var b=this.opacity;return Y.isDefined(b)&&1>b&&this.setOpacity(b,!0),this._div},_unsetMap:function(a,
c){u.forEach(this.graphics,function(a){a._shape=null});this._canvas?(c=this._div.getParent(),c._parent={},W.destroy(c.rawNode),c.destroy()):(this._div.clear(),c.remove(this._div),W.destroy(this._div.getEventSource()));this._map=this._div=this._svgFilters=null;clearTimeout(this._wakeTimer);this._wakeTimer=null;this._disableDrawConnectors();this.inherited(arguments)},_onZoomStartHandler:function(){M.hide(this._div.getEventSource())},_onExtentChangeHandler:function(a,c,b){(clearTimeout(this._wakeTimer),
this._wakeTimer=null,b)?(a=this._map.__visibleRect,c=this._div,this._evalSDRenderer(),this._refresh(!0),this._updateTransform(c,a.x,a.y,!0),this._renderProto&&c.surface.pendingRender?this._dirty=!0:this.suspended||M.show(c.getEventSource())):this._resized&&(this._refresh(!1),this._resized=!1);0<this.graphics.length&&this.onUpdate()},_canvasRender:function(){var a=this._div;return this._dirty&&(delete this._dirty,this.suspended||M.show(a.getEventSource())),this._renderProto.apply(a,arguments)},_refresh:function(a){var c,
b=this.graphics,e=b.length,d=this._draw;for(c=0;e>c;c++)d(b[c],a)},refresh:function(){this._refresh(!0)},redraw:function(){this._refresh(!0)},_onPanHandler:function(a,c){this._panDx=c.x;this._panDy=c.y;var b=this._map.__visibleRect;this._updateTransform(this._div,b.x+c.x,b.y+c.y)},_onPanEndUpdateHandler:function(a,c){var b=this._map.__visibleRect;this._params._child||c.x===this._panDx&&c.y===this._panDy?this._updateSVGFilters(-b.x,-b.y):this._updateTransform(this._div,b.x,b.y,!0);this._refresh(!1);
this.graphics.length&&this.onUpdate()},_onPanStartHandler:function(){M.hide(this._div.getEventSource())},_onPanEndHandler:function(){var a=this._map.__visibleRect,c=this._div;this._updateTransform(c,a.x,a.y,!0);this._refresh(!1);this._renderProto&&c.surface.pendingRender?this._dirty=!0:M.show(c.getEventSource());this.graphics.length&&this.onUpdate()},_updateTransform:function(a,c,b,e){a.setTransform(K.translate({x:c,y:b}));e&&this._updateSVGFilters(-c,-b)},onSuspend:function(){this.inherited(arguments);
M.hide(this._div.getEventSource());clearTimeout(this._wakeTimer);this._wakeTimer=null;this._disableDrawConnectors()},onResume:function(a){this.inherited(arguments);a.firstOccurrence&&this._evalSDRenderer();this._enableDrawConnectors();this._wakeTimer=this._wakeTimer||setTimeout(A.hitch(this,function(){this.suspended||this._onExtentChangeHandler(null,null,!0)}),0)},_enableDrawConnectors:function(){var a=this._map,c=t.connect;this._disableDrawConnectors();this._params.displayOnPan?(this._params._child||
(this._onPanHandler_connect=c(a,"onPan",this,"_onPanHandler")),this._onPanEndHandler_connect=c(a,"onPanEnd",this,"_onPanEndUpdateHandler")):(this._onPanStartHandler_connect=c(a,"onPanStart",this,"_onPanStartHandler"),this._onPanEndHandler_connect=c(a,"onPanEnd",this,"_onPanEndHandler"));this._onZoomStartHandler_connect=c(a,"onZoomStart",this,"_onZoomStartHandler");this._onExtentChangeHandler_connect=c(a,"onExtentChange",this,"_onExtentChangeHandler")},_disableDrawConnectors:function(){var a=t.disconnect;
a(this._onExtentChangeHandler_connect);a(this._onZoomStartHandler_connect);a(this._onPanHandler_connect);a(this._onPanStartHandler_connect);a(this._onPanEndHandler_connect);this._onExtentChangeHandler_connect=this._onZoomStartHandler_connect=this._onPanHandler_connect=this._onPanStartHandler_connect=this._onPanEndHandler_connect=null},_updateExtent:function(a){var c=a.geometry;if(!c)return void(a._extent=null);if(!(a._extent=c.getExtent())){var b,e;if("esri.geometry.Point"===c.declaredClass)b=c.x,
e=c.y;else{if("esri.geometry.Multipoint"!==c.declaredClass)return void(a._extent=null);b=c.points[0][0];e=c.points[0][1]}a._extent=new L(b,e,b,e,c.spatialReference)}},_intersects:function(a,c,b){var e=a.spatialReference,d=c.spatialReference,f=e&&d&&!e.equals(d)&&e._canProject(d)&&4326===d.wkid;if(this._wrap&&!b){var g,h,k,l,m,p;b=[];e=a._getFrameWidth();g=this._srInfo;k=a._clip?a._getAvailExtent():a.extent;var n=[];h=c._partwise;if(f&&(k=a.geographicExtent,g=d._getInfo()),a=k._getParts(g),h&&h.length)for(c=
[],d=0,f=h.length;f>d;d++)c=c.concat(h[d]._getParts(g));else c=c._getParts(g);d=0;for(f=c.length;f>d;d++)for(m=c[d],g=0,k=a.length;k>g;g++)if(p=a[g],p.extent.intersects(m.extent))for(h=0,l=m.frameIds.length;l>h;h++)b.push((p.frameIds[0]-m.frameIds[h])*e);d=0;for(f=b.length;f>d;d++)h=b[d],u.indexOf(b,h)===d&&n.push(h);return n.length?n:null}return(f?a.geographicExtent:a.extent).intersects(c)?[0]:null},_defaultMarker:{type:"simplemarkersymbol",style:"square",size:1,xoffset:0,yoffset:0,angle:0},_draw:function(a,
c){if(this._params.drawMode&&this._map&&!this.suspended)try{var b,e,d,f=a._extent,g=!Q||this.styling,h=Q&&this.dataAttributes,k=a.getDojoShape();if(a.visible&&f&&(b=this._intersects(this._map,f,a.geometry._originOnly))&&(e=g?this._getSymbol(a):this._defaultMarker)){if(a._offsets&&a._offsets.join(",")===b.join(",")?d=!0:a._offsets=b,!k||c||!d){var l=a.geometry.type;d={graphic:a};var m=a._bgShape,p=g&&!a.symbol?this._getRenderer(a):null,n=p&&p.backgroundFillSymbol;if("point"===l)this._isInvalidShape(e,
k)&&this._removeShape(a),a._shape=this._drawPoint(this._div,a.geometry,e,a.getDojoShape(),b,p,a),g&&this._symbolizePoint(a.getDojoShape(),e,p,a);else if("multipoint"===l)this._drawMarkers(a,e,b,p),g&&this._symbolizeMarkers(a,e,p);else{var r,D,w,l=e;if(g&&(r="simplemarkersymbol"===e.type||"picturemarkersymbol"===e.type||"textsymbol"===e.type?e:null,l=r?n:e),l&&l===n&&(D=this._bgGroup),m&&!D&&this._removeBgShape(a),l&&(!D&&this._isInvalidShape(l,a._shape)&&this._removeShape(a,!1),w=this._drawShape(a,
b,D||this._div,D?m:a.getDojoShape()),g&&this._symbolizeShape(w,l,p,!!n,a),a[D?"_bgShape":"_shape"]=w),r){this._isInvalidShape(r,a._shape)&&this._removeShape(a,!1);var I=a.geometry.getCentroid();(w=I&&this._drawPoint(this._div,I,r,a._shape,b,p,a))&&this._symbolizePoint(w,r,p,a);a._shape=w}}N||(a._bgShape&&this._initNode(a,a._bgShape,a._bgShape!==m,d,h),a._shape&&this._initNode(a,a._shape,a._shape!==k,d,h));d.node=a.getNode();this.onGraphicDraw(d)}}else k&&this._removeShape(a)}catch(V){this._errorHandler(V,
a)}},_initNode:function(a,c,b,e,d){(c=c&&c.getNode())&&(c.e_graphic=a,this._addDataAttrs(a,d,c),b&&(e.node=c,this.onGraphicNodeAdd(e)))},_removeShape:function(a,c){var b=a.getDojoShape(),e=b&&b.getNode();b&&(b.removeShape(),b.destroy());a._shape=a._offsets=null;!1!==c&&this._removeBgShape(a);e&&(e.e_graphic=null,N||this.onGraphicNodeRemove({graphic:a,node:e}))},_removeBgShape:function(a){var c=a._bgShape,b=c&&c.getNode();c&&(c.removeShape(),c.destroy(),a._bgShape=null);b&&(b.e_graphic=null,N||this.onGraphicNodeRemove({graphic:a,
node:b}))},_addDataAttrs:function(a,c,b){var e,d,f=a.attributes,g=c?c.length:0,h=this._getRenderer(a);if(b&&f){for(e=0;g>e;e++)(b=c[e])&&a.attr("data-"+b,f[b]);!this.styling&&h&&(h.getBreakIndex?(d=h.getBreakIndex(a),a.attr("data-class-break",-1!==d?d:null)):h.getUniqueValueInfo&&(d=h.getUniqueValueInfo(a),a.attr("data-unique-value",d?d.value:null)))}},_drawShape:function(a,c,b,e){var d,f,g,h;a=a.geometry;h=a.type;var k=this._map,l=k.extent,m=k.width,p=k.height,k=k.__visibleRect;g=[];d="extent"===
h;if("rect"===h||d)g={x:0,y:0,spatialReference:a.spatialReference},g.x=d?a.xmin:a.x,g.y=d?a.ymax:a.y,h=U.toScreenPoint(l,m,p,g),g.x=d?a.xmax:a.x+a.width,g.y=d?a.ymin:a.y+a.height,a=U.toScreenPoint(l,m,p,g),c={x:h.x-k.x+c[0],y:h.y-k.y,width:Math.abs(a.x-h.x),height:Math.abs(a.y-h.y)},0===c.width&&(c.width=1),0===c.height&&(c.height=1),e=this._drawRect(b,e,c);else if("polyline"===h||"polygon"===h){d=0;for(f=c.length;f>d;d++)g=g.concat(U._toScreenPath(l,m,p,a,-k.x+c[d],-k.y));e=this._drawPath(b,e,g);
this._rendererLimits&&("polyline"===h?this._clipPolyline(e,a):this._clipPolygon(e,a))}return e},_drawRect:function(a,c,b){return c?c.setShape(b):a.createRect(b)},_drawImage:function(a,c,b){return c?c.setShape(b):a.createImage(b)},_drawCircle:function(a,c,b){return c?c.setShape(b):a.createCircle(b)},_drawPath:function(){return y?function(a,c,b,e){if(b=e?b:b.join(" "),c)return c.setShape(b);c=a.createObject(e?J.Path:J.EsriPath,b);return a._overrideSize(c.getEventSource()),c}:function(a,c,b,e){return b=
e?b:b.join(" "),c?c.setShape(b):a.createPath(b)}}(),_drawText:function(a,c,b){return c?c.setShape(b):a.createText(b)},_evalSDRenderer:function(a){var c,b=this._map,e=this.renderer,d=this._rndForScale;b&&b.loaded&&e&&e.getRendererInfo&&(c="zoom"===e.rangeType?e.getRendererInfoByZoom(b.getZoom()):e.getRendererInfoByScale(b.getScale()));this._rndForScale=c&&c.renderer;a||this._rndForScale==d||this.emit("renderer-change",{renderer:this._rndForScale})},_getRenderer:function(a){var c=this._rndForScale||
this.renderer;return a&&c&&c.getObservationRenderer&&(c=c.getObservationRenderer(a)),c},_getSymbol:function(a){var c=this._getRenderer();return a.symbol||c&&c.getSymbol(a)},_getVariable:function(a,c,b){var e,d;return a&&(e=a.getVisualVariablesForType(c,b),d=e&&e[0]),d},_applyOpacity:function(a,c,b,e){c=c.getOpacity(e,{opacityInfo:b});return null!=c&&(a=new ea(a),a.a=c),a},_symbolizeShape:function(a,c,b,e,d){var f,g,h=c.getStroke(),k=c.getFill(),l=c.type,m=this._getVariable(b,"sizeInfo",!1),p=this._getVariable(b,
"colorInfo",!1),n=this._getVariable(b,"opacityInfo",!1),r=-1!==l.indexOf("linesymbol");c=r?"none"!==c.style:c.outline&&"none"!==c.outline.style;var D=r?null:this._getVariable(b,"sizeInfo","outline"),m=(m=e?D:D||m)?b.getSize(d,{sizeInfo:m,resolution:this._map.getResolutionInMeters(),scale:this._map.getScale()}):null;e&&(p=n=null);(p||n)&&"picturefillsymbol"!==l&&(r?(f=h&&h.color,p&&(f=b.getColor(d,{colorInfo:p})||f),f&&n&&(f=this._applyOpacity(f,b,n,d))):k&&k.toCss&&(g=k,p&&(g=b.getColor(d,{colorInfo:p})||
g),g&&n&&(g=this._applyOpacity(g,b,n,d))));a.setStroke(!c||null==m&&!f?h:A.mixin({},h,null!=m?{width:m}:null,f&&{color:f})).setFill(g||k)},_smsToPath:function(){return y?function(a,c,b,e,d,f,g,h,k){switch(c){case a.STYLE_SQUARE:return["M",d+","+g,"L",f+","+g,f+","+h,d+","+h,"X","E"];case a.STYLE_CROSS:return["M",b+","+g,"L",b+","+h,"M",d+","+e,"L",f+","+e,"E"];case a.STYLE_X:return["M",d+","+g,"L",f+","+h,"M",d+","+h,"L",f+","+g,"E"];case a.STYLE_DIAMOND:return["M",b+","+g,"L",f+","+e,b+","+h,d+","+
e,"X","E"];case a.STYLE_TARGET:return["M",d+","+g,"L",f+","+g,f+","+h,d+","+h,d+","+g,"M",d-k+","+e,"L",d+","+e,"M",b+","+(g-k),"L",b+","+g,"M",f+k+","+e,"L",f+","+e,"M",b+","+(h+k),"L",b+","+h,"E"]}}:function(a,c,b,e,d,f,g,h,k){switch(c){case a.STYLE_SQUARE:return["M",d+","+g,f+","+g,f+","+h,d+","+h,"Z"];case a.STYLE_CROSS:return["M",b+","+g,b+","+h,"M",d+","+e,f+","+e];case a.STYLE_X:return["M",d+","+g,f+","+h,"M",d+","+h,f+","+g];case a.STYLE_DIAMOND:return["M",b+","+g,f+","+e,b+","+h,d+","+e,
"Z"];case a.STYLE_TARGET:return["M",d+","+g,f+","+g,f+","+h,d+","+h,d+","+g,"M",d-k+","+e,d+","+e,"M",b+","+(g-k),b+","+g,"M",f+k+","+e,f+","+e,"M",b+","+(h+k),b+","+h]}}}(),_pathStyles:{square:1,cross:1,x:1,diamond:1,target:1},_typeMaps:{picturemarkersymbol:"image",picturefillsymbol:"path",simplefillsymbol:"path",simplelinesymbol:"path",cartographiclinesymbol:"path",textsymbol:"text"},_isInvalidShape:function(a,c){var b=c&&c.shape&&c.shape.type,e=a&&a.type,d=a&&a.style;return"rect"===b&&(b="path"),
e&&(d=this._typeMaps[e]||d),this._pathStyles[d]&&(d="path"),"shieldlabelsymbol"===e?!0:!(!b||!d||b===d)},_drawPoint:function(a,c,b,e,d,f,g){var h,k,l,m,p=b.type,n=this._map,r=n.__visibleRect,D=U.toScreenPoint(n.extent,n.width,n.height,c).offset(-r.x+d[0],-r.y),r=D.x,w=D.y;c=[];var I=this._getVariable(f,"rotationInfo",!1),I=I?f.getRotationAngle(g,{rotationInfo:I}):null,V=this._getVariable(f,"sizeInfo",!1),n=V?f.getSize(g,{sizeInfo:V,shape:b.style,resolution:n.getResolutionInMeters(),scale:n.getScale()}):
null;if(I&&c.push(K.rotategAt(I,D)),(0!==b.xoffset||0!==b.yoffset)&&(m=K.translate(b.xoffset,-b.yoffset),c.push(m)),0!==b.angle&&c.push(K.rotategAt(b.angle,D)),"simplemarkersymbol"===p)switch(h=b.style,f=Math.round,n=null!=n?n:b.size,h){case C.STYLE_SQUARE:case C.STYLE_CROSS:case C.STYLE_X:case C.STYLE_DIAMOND:b=isNaN(n)?16:n/2;h=this._drawPath(a,e,this._smsToPath(C,h,r,w,f(r-b),f(r+b),f(w-b),f(w+b)));break;case C.STYLE_TARGET:g=b._targetWidth/2;D=b._targetHeight/2;h=this._drawPath(a,e,this._smsToPath(C,
h,r,w,f(r-g),f(r+g),f(w-D),f(w+D),b._spikeSize));break;case C.STYLE_PATH:h=this._drawPath(a,e,b.path,!0);b=h.getBoundingBox();a=this._getScaleMatrix(b,n);1===a.xx&&1===a.yy||c.push(K.scaleAt(a.xx,a.yy,D));c.push(K.translate(-(b.x+b.width/2)+r,-(b.y+b.height/2)+w));break;default:b=isNaN(n)?16:n/2,h=this._drawCircle(a,e,{cx:r,cy:w,r:b})}else if("shieldlabelsymbol"===p){if(k=b.width,l=b.height,h=a.createGroup(),e=a.createImage({x:r-k/2,y:w-l/2,width:k,height:l,src:b.url}),h.add(e),null!=b.font)w+=.2*
b.getHeight(),a=a.createText({type:"text",text:b.text,x:r,y:w,align:"middle",decoration:b.decoration,rotated:b.rotated,kerning:b.kerning}),a.setFont(b.font),a.setFill(b.color),h.add(a)}else if("picturemarkersymbol"===p){if(null==n?(k=b.width,l=b.height):(l=n,k=b.width/b.height*l,m&&(null!=m.dx&&(m.dx=m.dx/b.width*k),null!=m.dy&&(m.dy=m.dy/b.height*l))),h=this._drawImage(a,e,{x:r-k/2,y:w-l/2,width:k,height:l,src:b.url}),Q)if(a=h.getNode())b=(b=this._getVariable(f,"opacityInfo",!1))?f.getOpacity(g,
{opacityInfo:b}):null,null!=b?a.setAttribute("opacity",b):a.setAttribute("opacity",1)}else"textsymbol"===p&&(f=b.font,null!=n&&f&&(f=new f.constructor(f.toJson()),f.setSize(n)),h=this._drawText(a,e,{type:"text",text:b.text,x:r,y:w,align:b.getSVGAlign(),decoration:b.decoration||f&&f.decoration,rotated:b.rotated,kerning:b.kerning}),f&&h.setFont(f),Q)&&(a=h.getNode(),r=b.getSVGBaseline(),w=b.getSVGBaselineShift(),a&&(a.setAttribute("dominant-baseline",r),w&&a.setAttribute("baseline-shift",w),this._applyHalo(h,
b.haloColor,b.haloSize)));return h.setTransform(K.multiply(c)),h._wrapOffsets=d,h},_applyHalo:function(a,c,b){var e=c&&b?this._getHaloId(c,b):null;a.setFilter(c&&b?H("webkit")||H("ff")?this._getDilateFilter(c,b,e):this._getOffsetFilter(c,b,e):null)},_getDilateFilter:function(a,c,b){var e=this._getSVGFilter(b);return e||(e=this._createSVGFilter({id:b},[B.feMorphology({operator:"dilate",radius:c,result:"dilated"}),B.feFlood({"flood-color":a.toCss(!0)}),B.feComposite({in2:"dilated",operator:"in",result:"composite"}),
B.feMerge("composite","SourceGraphic")])),e},_getOffsetFilter:function(a,c,b){var e=this._getSVGFilter(b);if(!e){var e=a.toCss(!0),d=this._offsetPrimitives,f=d.length,g=[],h=[];for(a=0;f>a;a++){var k=d[a],l="offset"+k.dir,m="composite"+k.dir;h.push(m);g.push(B.feOffset({dx:k.dx*c,dy:k.dy*c,"in":"SourceAlpha",result:l}),B.feFlood({"flood-color":e}),B.feComposite({in2:l,operator:"in",result:m}))}h.push("SourceGraphic");g.push(B.feMerge.apply(B.feMerge,h));e=this._createSVGFilter({id:b},g)}return e},
_offsetPrimitives:[{dir:"L",dx:-1,dy:0},{dir:"TL",dx:-1,dy:-1},{dir:"T",dx:0,dy:-1},{dir:"TR",dx:1,dy:-1},{dir:"R",dx:1,dy:0},{dir:"BR",dx:1,dy:1},{dir:"B",dx:0,dy:1},{dir:"BL",dx:-1,dy:1}],_getHaloId:function(a,c){return"halo_"+this._map.id+"_"+this.id+"_"+a.r+"_"+a.g+"_"+a.b+"_"+a.a+"_"+c},_getSVGFilter:function(a){return this._svgFilters[a]},_createSVGFilter:function(a,c){var b=B.createFilter(a,c),e=this._map,d=e.__visibleRect;return b.x=-d.x,b.y=-d.y,b.width=e.width,b.height=e.height,this._svgFilters[a.id]=
b,b},_updateSVGFilters:function(a,c,b,e){var d,f,g,h=this._svgFilters;for(f in h)(d=h[f])&&(g=ca.byId(f),g&&(null!=a&&g.setAttribute("x",a),null!=c&&g.setAttribute("y",c),null!=b&&g.setAttribute("width",b),null!=e&&g.setAttribute("height",e)),null!=a&&(d.x=a),null!=c&&(d.y=c),null!=b&&(d.width=b),null!=e&&(d.height=e))},_getScaleMatrix:function(a,c){var b=a.width/a.height,e=1,d=1;return isNaN(c)||(1<b?(e=c/a.width,d=c/b/a.height):(d=c/a.height,e=c*b/a.width)),{xx:e,yy:d}},_symbolizePoint:function(a,
c,b,e){var d=c.type,f=c.style;if("shieldlabelsymbol"!==d&&"picturemarkersymbol"!==d){var g=c.getStroke();c=c.getFill();var f=f===C.STYLE_X||f===C.STYLE_CROSS,h=g&&g.color,k=f?h:c;if(b){var l=this._getVariable(b,"colorInfo",!1),m=this._getVariable(b,"opacityInfo",!1);l&&(k=b.getColor(e,{colorInfo:l})||k);k&&m&&(k=this._applyOpacity(k,b,m,e));k&&(f?k!==h&&(g=g?A.mixin({},g):{},g.color=k):k!==c&&(c=k))}"textsymbol"===d?a.setFill(c):"simplemarkersymbol"===d&&a.setFill(c).setStroke(g)}},_drawMarkers:function(a,
c,b,e){var d,f,g,h=a.geometry,k=h.points,l=a.getDojoShape()||this._div.createGroup(),m=k.length,p=[],n=0,r=b?b.length:0;l.children[0]&&this._isInvalidShape(c,l.children[0])&&l.clear();for(f=0;m>f;f++)for(d=k[f],g=0;r>g;g++)p[0]=b[g],this._drawPoint(l,{x:d[0],y:d[1],spatialReference:h.spatialReference},c,l.children[n++],p,e,a);c=l.children.length;if(m*b.length<c)for(f=c-1;f>=m*b.length;f--)l.children[f].removeShape();a._shape=l},_symbolizeMarkers:function(a,c,b){var e,d=a.getDojoShape().children,f=
d.length;for(e=0;f>e;e++)this._symbolizePoint(d[e],c,b,a)},_errorHandler:function(a,c){a.message=c?"Unable to draw graphic (geometry:"+(c.geometry?c.geometry.declaredClass:null)+", symbol:"+(c.symbol?c.symbol.declaredClass:null)+"): "+a.message:"Unable to draw graphic (null): "+a.message;this.inherited(arguments)},_rendererLimits:function(){var a,c,b;if(H("ff")?(a=16125,c=-32250,b=32250):y?(a=1E5,c=-1E5,b=1E5):H("chrome")&&6>H("chrome")&&(a=8150,c=-1E4,b=1E4),a){var e,d;return e=[-a,-a,a,a],d=[[[-a,
-a],[a,-a]],[[a,-a],[a,a]],[[a,a],[-a,a]],[[-a,a],[-a,-a]]],{clipLimit:a,rangeMin:c,rangeMax:b,clipBBox:e,clipSegments:d}}}(),_clipPolyline:function(a,c){var b=this._getCorners(a,c),e=b.br,d=this._rendererLimits,f=d.rangeMin,g=d.rangeMax,h=d.clipBBox,k=d.clipSegments,d=this._isPointWithinRange,l=this._isPointWithinBBox,m=this._getClipperIntersection,p=this._getPlaneIndex;if(!d(b.tl,f,g)||!d(e,f,g)){y&&this._createSegments(a);var n=[];u.forEach(a.segments,function(a){var b=a.args,c=b.length,e=[];for(a=
0;c>a;a+=2){var d=[b[a],b[a+1]],f=[b[a+2],b[a+3]],g=l(d,h),F=l(f,h);g^F?(F=m([d,f],k))&&(g?(a?e.push(F[1]):e.push(d,F[1]),n.push(e),e=[]):e.push(F[1],f)):g?a?e.push(f):e.push(d,f):(F=p(d,h),g=p(f,h),-1!==F&&-1!==g&&F!==g&&(d=m([d,f],k,!0),0<d.length&&(d[F]||(F=d[F[0]]?F[0]:F[1]),d[g]||(g=d[g[0]]?g[0]:g[1]),f=d[F],d=d[g],f&&e.push(f),d&&(e.push(d),n.push(e),e=[]))))}n.push(e)});a.setShape(this._getPathStringFromPaths(n))}},_clipPolygon:function(a,c){var b=this._getCorners(a,c),e=b.br,d=this._rendererLimits,
f=d.clipLimit,g=d.rangeMin,h=d.rangeMax,k=d.clipBBox,l=d.clipSegments,d=this._isPointWithinRange,m=this._isPointWithinBBox,p=this._getClipperIntersection,n=this._getPlaneIndex,r=aa._pointLineDistance;d(b.tl,g,h)&&d(e,g,h)||(y&&this._createSegments(a),b=u.map(a.segments,function(a){var b,c=a.args,e=c.length,d=[];a=[];for(b=0;e>b;b+=2){var g=[c[b],c[b+1]],h=[c[b+2],c[b+3]];if(b===e-2){d.push(g);break}var q,x=m(g,k),v=m(h,k);if(d.push(g),x^v){if(q=p([g,h],l))g=q[1],g[x?"inOut":"outIn"]=!0,d.push(g),
a.push([x?"INOUT":"OUTIN",d.length-1,q[0]])}else x||(x=n(g,k),v=n(h,k),-1===x||-1===v||x===v)||((q=p([g,h],l,!0),0<q.length)?(q[x]||(x=q[x[0]]?x[0]:x[1]),q[v]||(v=q[v[0]]?v[0]:v[1]),g=q[x],h=q[v],g&&(g.outIn=!0,d.push(g),a.push(["OUTIN",d.length-1,x])),h&&(h.inOut=!0,d.push(h),a.push(["INOUT",d.length-1,v]))):A.isArray(x)&&A.isArray(v)&&(v=x.concat(v),v.sort(),"0123"===v.join(""))&&(v=[],3===x[0]+x[1]?v.push([f,-f],[-f,f]):v.push([-f,-f],[f,f]),x=r(v[0],[g,h]),g=r(v[1],[g,h]),d.push(g>x?v[0]:v[1])))}var t=
k[0],y=k[1],B=k[2],C=k[3];u.forEach(d,function(a){a[0]<t&&(a[1]>=y&&a[1]<=C?a[0]=t:(a[0]=t,a[1]=a[1]<y?y:C))});u.forEach(d,function(a){a[1]<y&&(a[0]>=t&&a[0]<=B?a[1]=y:(a[1]=y,a[0]=a[0]<t?t:B))});u.forEach(d,function(a){a[0]>B&&(a[1]>=y&&a[1]<=C?a[0]=B:(a[0]=B,a[1]=a[1]<y?y:C))});u.forEach(d,function(a){a[1]>C&&(a[0]>=t&&a[0]<=B?a[1]=C:(a[1]=C,a[0]=a[0]<t?t:B))});var E,z;q=0;if(e=a.length,0<e){do{if(E=a[q],z=a[(q+1)%e],E[2]===z[2]&&"INOUT"===E[0]&&"OUTIN"===z[0])if(c=E[1],b=z[1],b>c)for(c+=1;b>c;c++)d[c][2]=
!0;else if(c>b){for(c+=1;c<d.length;c++)d[c][2]=!0;for(c=0;b>c;c++)d[c][2]=!0}q=(q+1)%e}while(0!==q)}e=d[0];b=d[d.length-1];e[2]&&(b[2]=!0,u.some(a,function(a){return 1===a[1]?(d.splice(d.length-1,0,A.clone(d[1])),!0):!1}));d=u.filter(d,function(a){return a[2]?!1:!0});for(q=0;q<d.length-1;q++)E=d[q],(z=d[q+1])&&E[0]===z[0]&&E[1]===z[1]&&(z.outIn?E.outIn=!0:z.inOut&&(E.inOut=!0),d.splice(q+1,1));c=Math.abs;a=[];for(q=0;q<d.length-1;q++){E=d[q];g=E[0];E=E[1];h=c(g)===f;x=c(E)===f;z=d[q+1];v=z[0];z=
z[1];var G=c(v)===f,H=c(z)===f;h&&H?a.push([q+1,[g,z]]):x&&G&&a.push([q+1,[v,E]])}for(q=a.length-1;0<=q;q--)z=a[q],c=d[z[0]-1],E=d[z[0]],c.outIn||c.inOut||E.outIn||E.inOut||d.splice(z[0],0,z[1]);return e=d[0],b=d[d.length-1],(e[0]!==b[0]||e[1]!==b[1])&&d.push(e),d}),a.setShape(this._getPathStringFromPaths(b)))},_getCorners:function(a,c){if(y){var b=this._map,e=c.getExtent(),d=e.spatialReference,f=b.toScreen(new Z(e.xmin,e.ymax,d)),b=b.toScreen(new Z(e.xmax,e.ymin,d));return{tl:f,br:b}}f=a.getTransformedBoundingBox();
return{tl:f[0],br:f[2]}},_createSegments:function(a){a.shape.path=a.vmlPath;a.segmented=!1;a._confirmSegmented();var c=a.segments;1<c.length&&(a.segments=u.filter(c,function(a,c,d){c=d[c+1];return"M"===a.action&&c&&"L"===c.action?(a.args=a.args.concat(c.args),!0):!1}))},_getPathStringFromPaths:function(a){return y?(a=u.map(a,function(a){return"m "+u.map(a,function(a,c){return(1===c?"l ":"")+a.join(",")}).join(" ")}),a.push("e")):a=u.map(a,function(a){return"M "+u.map(a,function(a){return a.join(",")}).join(" ")}),
a.join(" ")},_isPointWithinBBox:function(a,c){var b=c[1],e=c[2],d=c[3],f=a[0],g=a[1];return f>c[0]&&e>f&&g>b&&d>g?!0:!1},_isPointWithinRange:function(a,c,b){var e=a.x;a=a.y;return c>e||c>a||e>b||a>b?!1:!0},_getClipperIntersection:function(a,c,b){var e,d=aa._getLineIntersection2,f=Math.round,g={length:0};for(e=0;4>e;e++){var h=d(a,c[e]);if(h){if(h[0]=f(h[0]),h[1]=f(h[1]),!b)return[e,h];g[e]=h;g.length++}}return b?g:null},_getPlaneIndex:function(a,c){var b=a[0],e=a[1],d=c[0],f=c[1],g=c[2],h=c[3];return d>=
b?e>=f&&h>=e?3:f>e?[0,3]:[2,3]:f>=e?b>=d&&g>=b?0:d>b?[3,0]:[1,0]:b>=g?e>=f&&h>=e?1:f>e?[0,1]:[2,1]:e>=h?b>=d&&g>=b?2:d>b?[3,2]:[1,2]:-1},onGraphicAdd:function(){},onGraphicRemove:function(){},onGraphicNodeAdd:function(){},onGraphicNodeRemove:function(){},onGraphicDraw:function(){},onGraphicsClear:function(){},onRendererChange:function(){},onOpacityChange:function(){},setInfoTemplate:function(a){this.infoTemplate=a},add:function(a,c){return a._graphicsLayer===this?a:(c||this.graphics.push(a),a._graphicsLayer=
this,a._layer=this,this._updateExtent(a),this._draw(a),c||this.onGraphicAdd(a),a)},remove:function(a,c){if(!c){var b;if(-1===(b=u.indexOf(this.graphics,a)))return null;a=this.graphics.splice(b,1)[0]}return a.getDojoShape()&&this._removeShape(a),a._shape=a._graphicsLayer=null,this.onGraphicRemove(a),a},clear:function(a,c){for(var b=this.graphics;0<b.length;)this.remove(b[0]);c||this.onGraphicsClear()},_setIEOpacity:function(a,c){var b=a&&a.getNode();if(b){var e=a.strokeStyle,d=b.stroke;e&&d&&(d.opacity=
e.color.a*c);e=a.fillStyle;d=b.fill;e&&d&&("tile"===d.type?O.set(b,"opacity",c):d.opacity=e.a*c)}},setOpacity:function(a,c){if(c||this.opacity!=a){var b=this._div;b&&(y?(u.forEach(this.graphics,function(b){this._setIEOpacity(b._shape,a);this._setIEOpacity(b._bgShape,a)},this),b._esriIeOpacity=a,this._bgGroup._esriIeOpacity=a):this._canvas?O.set(b.getEventSource(),"opacity",a):b.getEventSource().setAttribute("opacity",a));this.opacity=a;c||this.onOpacityChange(a)}},setRenderer:function(a){this.renderer=
a;this._evalSDRenderer(!0);this.emit("renderer-change",{renderer:this._rndForScale||a})}});G=G([P,fa],{declaredClass:"esri.layers.GraphicsLayer",constructor:function(){this.enableMouseEvents=A.hitch(this,this.enableMouseEvents);this.disableMouseEvents=A.hitch(this,this.disableMouseEvents);this._processEvent=A.hitch(this,this._processEvent);this._initLayer()},_initLayer:function(){this.loaded=!0;this.onLoad(this)},_setMap:function(){var a=this.inherited("_setMap",arguments);return this.enableMouseEvents(),
a},_unsetMap:function(){this.disableMouseEvents();this.inherited("_unsetMap",arguments)},_processEvent:function(a){var c,b=this._map,e=a.target;a.screenPoint=new T(a.pageX-b.position.x,a.pageY-b.position.y);for(a.mapPoint=b.toMap(a.screenPoint);e&&!(c=e.e_graphic);)e=e.parentNode;return c?(a.graphic=c,a):void 0},_onMouseOverHandler:function(a){this._processEvent(a)&&this.onMouseOver(a)},_onMouseMoveHandler:function(a){this._processEvent(a)&&this.onMouseMove(a)},_onMouseDragHandler:function(a){this._processEvent(a)&&
this.onMouseDrag(a)},_onMouseOutHandler:function(a){this._processEvent(a)&&this.onMouseOut(a)},_onMouseDownHandler:function(a){this._downGr=this._downPt=null;this._processEvent(a)&&(t.disconnect(this._onmousemove_connect),t.disconnect(this._onmousedrag_connect),this._onmousedrag_connect=t.connect(this._div.getEventSource(),"onmousemove",this,"_onMouseDragHandler"),this._downGr=a.graphic,this._downPt=a.screenPoint.x+","+a.screenPoint.y,this.onMouseDown(a))},_onMouseUpHandler:function(a){this._upGr=
this._upPt=null;this._processEvent(a)&&(t.disconnect(this._onmousedrag_connect),t.disconnect(this._onmousemove_connect),this._onmousemove_connect=t.connect(this._div.getEventSource(),"onmousemove",this,"_onMouseMoveHandler"),this._upGr=a.graphic,this._upPt=a.screenPoint.x+","+a.screenPoint.y,this.onMouseUp(a))},_onClickHandler:function(a){if(this._processEvent(a)){var c=this._downGr,b=this._upGr;c&&b&&c===b&&this._downPt===this._upPt&&(y&&(S._ieGraphic=a.graphic),this.onClick(a))}},_onDblClickHandler:function(a){this._processEvent(a)&&
this.onDblClick(a)},onMouseOver:function(){},onMouseMove:function(){},onMouseDrag:function(){},onMouseOut:function(){},onMouseDown:function(){},onMouseUp:function(){},onClick:function(){},onDblClick:function(){},enableMouseEvents:function(){if(!this._mouseEvents){var a=t.connect,c=this._div.getEventSource();N||(this._onmouseover_connect=a(c,"onmouseover",this,"_onMouseOverHandler"),this._onmousemove_connect=a(c,"onmousemove",this,"_onMouseMoveHandler"),this._onmouseout_connect=a(c,"onmouseout",this,
"_onMouseOutHandler"),this._onmousedown_connect=a(c,"onmousedown",this,"_onMouseDownHandler"),this._onmouseup_connect=a(c,"onmouseup",this,"_onMouseUpHandler"),this._onclick_connect=a(c,"onclick",this,"_onClickHandler"),this._ondblclick_connect=a(c,"ondblclick",this,"_onDblClickHandler"));this._mouseEvents=!0}},disableMouseEvents:function(){if(this._mouseEvents){var a=t.disconnect;a(this._onmouseover_connect);a(this._onmousemove_connect);a(this._onmousedrag_connect);a(this._onmouseout_connect);a(this._onmousedown_connect);
a(this._onmouseup_connect);a(this._onclick_connect);a(this._ondblclick_connect);this._mouseEvents=!1}}});return G._GraphicsContainer=X,G._GraphicsLayer=P,H("extend-esri")&&(A.setObject("layers.GraphicsLayer",G,S),A.setObject("layers._GraphicsContainer",X,S),A.setObject("layers._GraphicsLayer",P,S)),G});