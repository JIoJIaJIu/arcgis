//>>built
define("esri/layers/OnDemandMode","dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/has ../kernel ../geometry/Point ../tasks/query ./RenderMode ./GridLayout".split(" "),function(p,l,q,r,t,u,w,v,x,y){p=p([x],{declaredClass:"esri.layers._OnDemandMode",constructor:function(c){this.featureLayer=c;this._featureMap={};this._queryErrorHandler=q.hitch(this,this._queryErrorHandler)},initialize:function(c){this.inherited(arguments);var a=this.featureLayer,b=a._srInfo;this._gridLayer=
new y(new w(b?b.valid[0]:c.extent.xmin,b?b.valid[1]:c.extent.ymax,c.spatialReference),{width:a._tileWidth,height:a._tileHeight},{width:c.width,height:c.height},b);this._cellMap={};this._gridLayer.setResolution(c.extent)},startup:function(){this._ioQueue=[];this.featureLayer.suspended||(this._zoomHandler(),this._enableConnectors())},propertyChangeHandler:function(c){this._init&&(2>c?this._zoomHandler():console.log("FeatureLayer: layer in on-demand mode does not support time definitions. Layer id \x3d "+
this.featureLayer.id+", Layer URL \x3d "+this.featureLayer.url))},destroy:function(){this._disableConnectors();this.inherited(arguments)},drawFeature:function(c){var a=this._gridLayer,b=c.geometry,h=[];if(b)for(var h=a.getCellsInExtent("point"===b.type?{xmin:b.x,ymin:b.y,xmax:b.x,ymax:b.y}:b.getExtent(),!1).cells,f,e,d,g=this._cellMap,k=c.attributes[this.featureLayer.objectIdField],a=0;a<h.length;a++)b=h[a],f=b.latticeID,e=b.row,d=b.col,f?b=g[f]=g[f]||b:(g[e]=g[e]||{},b=g[e][d]=g[e][d]||b),b.features=
b.features||[],b.features.push(c),this._addFeatureIIf(k,c),this._incRefCount(k)},suspend:function(){this._init&&this._disableConnectors()},resume:function(){this._init&&(this._enableConnectors(),this._zoomHandler())},refresh:function(){this._zoomHandler()},_enableConnectors:function(){var c=this.map;this._zoomConnect=l.connect(c,"onZoomEnd",this,this._zoomHandler);this._panConnect=l.connect(c,"onPanEnd",this,this._panHandler);this._resizeConnect=l.connect(c,"onResize",this,this._panHandler)},_disableConnectors:function(){l.disconnect(this._zoomConnect);
l.disconnect(this._panConnect);l.disconnect(this._resizeConnect)},_zoomHandler:function(){this._processIOQueue(!0);var c=this.featureLayer,a=this.map;c.suspended||(c._fireUpdateStart(),this._clearIIf(),(c=c._trackManager)&&c.clearTracks(),this._cellMap={},this._gridLayer.setResolution(a.extent),this._sendRequest())},_panHandler:function(c){this.featureLayer._fireUpdateStart();this._sendRequest(this.featureLayer._resized&&c)},_getRequestId:function(c,a){return("_"+c.name+c.layerId+c._ulid+"_"+a.resolution+
"_"+(a.latticeID||a.row+"_"+a.col)).replace(/[^a-zA-Z0-9\_]+/g,"_")},_sendRequest:function(c){this._exceeds=!1;var a=this.featureLayer,b=this.map;c=c||b.extent;b=this._gridLayer.getCellsInExtent(c,a.latticeTiling).cells;if(!a.isEditable())var h=this._cellMap,b=r.filter(b,function(a){if(a.lattice){if(h[a.latticeID])return!1}else if(h[a.row]&&h[a.row][a.col])return!1;return!0});var f,e,d,g,k=a.getOutFields(),m=a.getDefinitionExpression(),n=a._getOffsettedTE(a._mapTimeExtent),l=a.supportsAdvancedQueries?
a.getOrderByFields():null,p=a._usePatch,q=this._ioQueue,t=this,u=this._drawFeatures;this._pending=this._pending||0;for(f=0;f<b.length;f++)e=b[f],d=new v,d.geometry=e.extent||e.lattice,d.outFields=k,d.where=m,a.latticeTiling&&e.extent&&(d.spatialRelationship=v.SPATIAL_REL_CONTAINS),d.returnGeometry=!0,d.timeExtent=n,a._ts&&(d._ts=(new Date).getTime()),d.orderByFields=l,d.multipatchOption=a.multipatchOption,d.maxAllowableOffset=a._maxOffset,d.quantizationParameters=a._quantizationParameters,(g=a.advancedQueryCapabilities)&&
g.supportsQueryWithResultType&&(d.resultType="tile"),g=null,p&&(g=this._getRequestId(a,e),this._isPending(g))||(this._pending++,q.push(a._task.execute(d,function(){var a=e;return function(b){u.apply(t,[b,a])}}.call(this),this._queryErrorHandler,g)));this._removeOldCells(c);this._endCheck()},_drawFeatures:function(c,a){this._exceeds=this._exceeds||c.exceededTransferLimit;this._finalizeIO();var b,h;b=this.map.extent;h=a.extent;var f=a.row,e=a.col,d=this.featureLayer.objectIdField,g=c.features,k=this._gridLayer,
m=this._cellMap,n=a.latticeID,l=n?m[n]:m[f]&&m[f][e];if(a.resolution==k._resolution&&(n?n===k.getLatticeID(b):k.intersects(h,b)))if(l)this._updateCell(l,g);else for(a.features=g,n?m[n]=a:(m[f]=m[f]||{},m[f][e]=a),h=g.length,b=0;h>b;b++)f=g[b],e=f.attributes[d],this._addFeatureIIf(e,f),this._incRefCount(e);else l&&this._removeCell(f,e,n);this._endCheck()},_queryErrorHandler:function(c){this._finalizeIO();this.featureLayer._errorHandler(c);this._endCheck(!0)},_finalizeIO:function(){this._purgeRequests();
this._pending--},_endCheck:function(c){if(0===this._pending){this._processIOQueue();var a=this.featureLayer,b=a._trackManager;b&&(b.clearTracks(),b.addFeatures(a.graphics),a._ager&&r.forEach(a.graphics,function(b){b._shape&&a._repaint(b)}),b.moveLatestToFront(),b.drawTracks());this.featureLayer._fireUpdateEnd(c&&Error("FeatureLayer: an error occurred while updating the layer"),this._exceeds?{queryLimitExceeded:!0}:null);this._exceeds&&a.onQueryLimitExceeded()}},_processIOQueue:function(c){this._ioQueue=
r.filter(this._ioQueue,function(a){return-1<a.fired?!1:!0});c&&r.forEach(this._ioQueue,this._cancelPendingRequest)},_removeOldCells:function(c){var a,b,h=this._cellMap,f=this._gridLayer;for(a in h)if(h[a]){var e=h[a],d=e.latticeID,g=0,k=0;if(d)g++,d!==f.getLatticeID(c)&&(this._removeCell(null,null,d),k++);else for(b in e)e[b]&&(g++,f.intersects(e[b].extent,c)||(this._removeCell(a,b),k++));k===g&&delete h[a]}},_updateCell:function(c,a){var b;b=this.featureLayer;var h=b.objectIdField,f=b._selectedFeatures,
e=a.length;c.features=c.features||[];for(b=0;e>b;b++){var d=a[b],g=d.attributes[h],k=this._addFeatureIIf(g,d);k===d?(this._incRefCount(g),c.features.push(k)):g in f||(k.setGeometry(d.geometry),k.setAttributes(d.attributes))}},_removeCell:function(c,a,b){var h=this._cellMap,f=this.featureLayer,e=f.objectIdField,d=b?h[b]:h[c]&&h[c][a];if(d)for(b?delete h[b]:delete h[c][a],a=d.features,c=0;c<a.length;c++)b=a[c].attributes[e],this._decRefCount(b),b in f._selectedFeatures||this._removeFeatureIIf(b)}});
return t("extend-esri")&&q.setObject("layers._OnDemandMode",p,u),p});