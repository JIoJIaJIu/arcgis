//>>built
define("esri/layers/TileMap","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/Deferred dojo/io-query ../request ../urlUtils ../sniff".split(" "),function(l,k,m,n,p,q,u,r){var t=r("esri-iphone");return l(null,{declaredClass:"esri.layers.TileMap",constructor:function(a){this.layer=a;this._tileMaps={}},getTile:function(a,b,e,c,d){a={id:c,level:a,row:b,col:e};b=this._getResamplingBudget();0<b?this._process({tile:a,requestedTile:a,callback:d,resamplingBudget:b}):(d||this.callback).call(this,a,
a)},statusOf:function(a,b,e){var c,d=this._getResamplingBudget();a={level:a,row:b,col:e};if(0===d)return 1;for(;0<=d;){if((c=this._tileToTileMap(a),!this._tileMaps[c.uid])||(c=this._tileMaps[c.uid],!c.promise.isFulfilled()))return-1;if(this._isTileAvailable(a,c))return 1;if(a=this._parentTile(a),!a)break;d--}return 0},style:function(a,b){if(a.level!==b.level||a.row!==b.row||a.col!==b.col){for(var e,c,d=this.layer.tileInfo,f=d.lods,g=d.cols,d=d.rows,h=f.length-1;!e||!c;)e||f[h].level!==a.level||(e=
f[h]),c||f[h].level!==b.level||(c=f[h]),h--;c=Math.round(e.resolution/c.resolution);f=b.col%c*-1*g;e=b.row%c*-1*d;c={width:g*c+"px",height:d*c+"px",margin:e+"px 0 0 "+f+"px","will-change":"transform"};t&&(f=0===f?0:-1*f,e=0===e?0:-1*e,c.clip="rect("+e+"px,"+(f+g)+"px,"+(e+d)+"px,"+f+"px)");return c}},_process:function(a){var b=a.tile,e=this._tileToTileMap(b),c=this._parentTile(b);this._getTileMap(e).then(k.hitch(this,function(d){e=d;this._isTileAvailable(b,e)?(a.callback||this.callback).call(this,
b,a.requestedTile):0<a.resamplingBudget&&c?(a.resamplingBudget--,a.tile=c,this._process(a)):(a.callback||this.callback).call(this,a.requestedTile,a.requestedTile)}),k.hitch(this,function(){(a.callback||this.callback).call(this,a.requestedTile,a.requestedTile)}))},_getTileMap:function(a){var b,e,c,d,f=null;return this._tileMaps[a.uid]?(a=this._tileMaps[a.uid],b=a.promise):(this._tileMaps[a.uid]=a,e=new n,q({url:this._getTileMapUrl(a.level,a.row,a.col),handleAs:"json",callbackParamName:"callback",timeout:3E3,
load:function(b){if(k.mixin(a,b),a.data&&0<a.data.length){if(d=a.data.length,1===d)f=a.data[0];else for(f=a.data[0],c=1;d>c;c++)if(a.data[c]!==f){f=null;break}null!==f&&(delete a.data,a.value=f)}e.resolve(a)},error:function(){e.reject()}}),b=a.promise=e.promise),b},_parentTile:function(a){var b,e,c,d=this.layer.tileInfo.lods,f=null;return m.some(d,function(c,d){return a.level===c.level?(b=c,e=d,!0):!1}),0<e&&(c=d[e-1],f={id:a.id,level:c.level,row:Math.floor(a.row*b.resolution/c.resolution+.01),col:Math.floor(a.col*
b.resolution/c.resolution+.01)}),f},_tileToTileMap:function(a){var b=8*Math.floor(a.row/8),e=8*Math.floor(a.col/8);return{uid:a.level+"_"+b+"_"+e,level:a.level,row:b,col:e}},_isTileAvailable:function(a,b){var e,c,d;return b.valid?void 0!==b.value?d=b.value:(e=b.location.left,c=b.location.top,d=(a.row-c)*b.location.width+(a.col-e),d=d<b.data.length?b.data[d]:0):d=0,d},_getTileMapUrl:function(a,b,e){var c=this.layer,d=c.tileServers,f=c._getToken(),g=c._url.query;a=(d?d[b%d.length]:c._url.path)+"/tilemap/"+
a+"/"+b+"/"+e+"/8/8";return g&&(a+="?"+p.objectToQuery(g)),!f||g&&g.token||(a+=(-1===a.indexOf("?")?"?":"\x26")+"token\x3d"+f),c.addTimestampToURL(a)},_getResamplingBudget:function(){var a=this.layer,b=0;return a.resampling&&(b=a._resamplingTolerance,(null===b||void 0===b)&&(b=a.tileInfo.lods.length)),b}})});