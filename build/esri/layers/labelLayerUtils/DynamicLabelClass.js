//>>built
define("esri/layers/labelLayerUtils/DynamicLabelClass","dojo/_base/declare dojo/_base/lang dojo/has ../../kernel ../GraphicsLayer ../../geometry/Extent ../../geometry/Polygon".split(" "),function(y,I,J,K,L,M,H){y=y(L,{declaredClass:"esri.layers.labelLayerUtils.DynamicLabelClass",constructor:function(){this._preparedLabels=[];this._placedLabels=[];this._extent=null;this._y1=this._x1=this._y0=this._x0=this._ymax=this._ymin=this._xmax=this._xmin=0;this._scale=1},setMap:function(e,c){this._labelLayer=
c;this._xmin=e.extent.xmin;this._xmax=e.extent.xmax;this._ymin=e.extent.ymin;this._ymax=e.extent.ymax;this._scale=(this._xmax-this._xmin)/e.width},_process:function(e){this._preparedLabels=e;this._placedLabels=[];var c;for(e=this._preparedLabels.length-1;0<=e;e--){var a=this._preparedLabels[e],f=Math.min(a.labelWidth,a.labelHeight),g=a.labelWidth+0*f,f=a.labelHeight+0*f,h=(c=a.options)&&void 0!==c.lineLabelPlacement?c.lineLabelPlacement:"PlaceAtCenter",d=c&&void 0!==c.lineLabelPosition?c.lineLabelPosition:
"Above",b=c&&void 0!==c.pointPriorities?c.pointPriorities:"AboveRight",k=[2,2,1,3,0,2,3,3,2];"AboveLeft"==b?k=[1,2,2,2,0,3,2,3,3]:"AboveCenter"==b?k=[2,1,2,2,0,2,3,3,3]:"AboveRight"==b?k=[2,2,1,3,0,2,3,3,2]:"CenterLeft"==b?k=[2,2,3,1,0,3,2,2,3]:"CenterCenter"==b?k=[0,0,0,0,1,0,0,0,0]:"CenterRight"==b?k=[3,2,2,3,0,1,3,2,2]:"BelowLeft"==b?k=[2,3,3,2,0,3,1,2,2]:"BelowCenter"==b?k=[3,3,3,2,0,2,2,1,2]:"BelowRight"==b&&(k=[3,3,2,3,0,2,2,2,1]);var l=c&&void 0!==c.labelRotation?c.labelRotation:!0,b=Math.PI/
180*a.angle;if(c=c&&void 0!==c.howManyLabels?c.howManyLabels:"OneLabel","point"==a.geometry.type)this._generatePointPositions(a,a.geometry.x,a.geometry.y,a.text,b,g,f,a.symbolWidth,a.symbolHeight,k);else if("multipoint"==a.geometry.type)for(d=a.geometry,h=0;h<d.points.length;h++)this._generatePointPositions(a,d.points[h][0],d.points[h][1],a.text,b,g,f,a.symbolWidth,a.symbolHeight,k);else"polyline"==a.geometry.type?this._generateLinePositions(a,a.geometry,a.text,g,f,2*a.symbolHeight+f,h,d,l):"polygon"==
a.geometry.type&&this._generatePolygonPositions(a,c,a.geometry,a.text,b,g,f)}return this._placedLabels},_generatePointPositions:function(e,c,a,f,g,h,d,b,k,l){var m;b=(b+h)*this._scale;var n=(k+d)*this._scale;for(k=1;3>=k;k++)for(m=1;9>=m;m++)if(l[m-1]==k)switch(m){case 1:if(this._findPlace(e,f,c-b,a+n,g,h,d))return;break;case 2:if(this._findPlace(e,f,c,a+n,g,h,d))return;break;case 3:if(this._findPlace(e,f,c+b,a+n,g,h,d))return;break;case 4:if(this._findPlace(e,f,c-b,a,g,h,d))return;break;case 5:if(this._findPlace(e,
f,c,a,g,h,d))return;break;case 6:if(this._findPlace(e,f,c+b,a,g,h,d))return;break;case 7:if(this._findPlace(e,f,c-b,a-n,g,h,d))return;break;case 8:if(this._findPlace(e,f,c,a-n,g,h,d))return;break;case 9:if(this._findPlace(e,f,c+b,a-n,g,h,d))return}},_generateLinePositions:function(e,c,a,f,g,h,d,b,k){var l,m,n,r=f*this._scale*f*this._scale;for(l=0;l<c.paths.length;l++){var t=c.paths[l],q=t.length,p=Math.floor((q-1)/2),u=0!==(q-1)%2?1:-1;"PlaceAtStart"==d&&(p=0,u=1);for("PlaceAtEnd"==d&&(p=q-2,u=-1);0<=
p&&q-1>p;){for(m=p;q>m;m++){var v=t[p][0],w=t[p][1],x=t[m][0]-v,y=t[m][1]-w;if(x*x+y*y>r){for(var z=Math.atan2(y,x);z>Math.PI/2;)z-=Math.PI;for(;z<-(Math.PI/2);)z+=Math.PI;var E=Math.sin(z),F=Math.cos(z),A=0,B=0;if("Above"==b&&(A=h*E*this._scale,B=h*F*this._scale),"Below"==b&&(A=-h*E*this._scale,B=-h*F*this._scale),1==m-p){if(this._clipLine(v,w,t[m][0],t[m][1])&&(m=this._x1-this._x0,n=this._y1-this._y0,m*m+n*n>r)){var C,D,v=Math.atan2(n,m),x=f/2+2*g,w=x*this._scale*Math.cos(v),x=x*this._scale*Math.sin(v);
if("PlaceAtStart"==d?(C=this._x0+w,D=this._y0+x):"PlaceAtEnd"==d?(C=this._x1-w,D=this._y1-x):(C=this._x0+m/2,D=this._y0+n/2),this._findPlace(e,a,C-A,D+B,k?-v:0,f,g))return}}else{var G=0;for(n=p;m>=n;n++)G=Math.max(G,Math.abs((t[n][1]-w)*F-(t[n][0]-v)*E));if(g>G&&this._findPlace(e,a,v+x/2-A,w+y/2+B,k?-z:0,f,g))return}break}}p+=u}}},_generatePolygonPositions:function(e,c,a,f,g,h,d){var b;if("ManyLabels"==c)for(c=0;c<a.rings.length;c++){var k=a.rings[c];H.prototype.isClockwise(k)&&(b=this._findCentroid(k,
this._xmin,this._ymin,this._xmax,this._ymax),this._findPlace(e,f,b[0],b[1],g,h,d))}else{b=this._findCentroidForFeature(a,this._xmin,this._ymin,this._xmax,this._ymax);var k=b[1],l=0;for(c=0;10>c&&(l+=d/4,b=this._findCentroidForFeature(a,this._xmin,k+(l-d/4),this._xmax,k+(l+d/4)),!this._findPlace(e,f,b[0],b[1],g,h,d))&&(b=this._findCentroidForFeature(a,this._xmin,k-(l+d/4),this._xmax,k-(l-d/4)),!this._findPlace(e,f,b[0],b[1],g,h,d));c++);}},_findCentroid:function(e,c,a,f,g){var h=e.length,d=[0,0],b=
0,k=e[0][0],l=e[0][1];k>f&&(k=f);c>k&&(k=c);l>g&&(l=g);a>l&&(l=a);for(var m=1;h-1>m;m++){var n=e[m][0],r=e[m][1],t=e[m+1][0],q=e[m+1][1];n>f&&(n=f);c>n&&(n=c);r>g&&(r=g);a>r&&(r=a);t>f&&(t=f);c>t&&(t=c);q>g&&(q=g);a>q&&(q=a);var p=(n-k)*(q-l)-(t-k)*(r-l);d[0]+=p*(k+n+t);d[1]+=p*(l+r+q);b+=p}if(d[0]/=3*b,d[1]/=3*b,isNaN(d[0])||isNaN(d[1]))return d;a=[];return this._fillBuffer(e,a,d),d[0]=this._sortBuffer(a,d[0],c,f),d},_findCentroidForFeature:function(e,c,a,f,g){for(var h,d=0,b=[0,0],k=0;k<e.rings.length;k++){var l=
e.rings[k],m=l.length,n=l[0][0],r=l[0][1];n>f&&(n=f);c>n&&(n=c);r>g&&(r=g);a>r&&(r=a);for(h=1;m-1>h;h++){var t=l[h][0],q=l[h][1],p=l[h+1][0],u=l[h+1][1];t>f&&(t=f);c>t&&(t=c);q>g&&(q=g);a>q&&(q=a);p>f&&(p=f);c>p&&(p=c);u>g&&(u=g);a>u&&(u=a);var v=(t-n)*(u-r)-(p-n)*(q-r);b[0]+=v*(n+t+p);b[1]+=v*(r+q+u);d+=v}}if(b[0]/=3*d,b[1]/=3*d,isNaN(b[0])||isNaN(b[1]))return b;a=[];for(h=0;h<e.rings.length;h++)this._fillBuffer(e.rings[h],a,b);return b[0]=this._sortBuffer(a,b[0],c,f),b},_fillBuffer:function(e,c,
a){for(var f=e.length-1,g=e[0][1]>=e[f][1]?1:-1,h=0;f>=h;h++){var d=h,b=h+1;h==f&&(b=0);var k=e[d][0],d=e[d][1],l=e[b][0],b=e[b][1],m=b>=d?1:-1;if(d<=a[1]&&a[1]<=b||b<=a[1]&&a[1]<=d)a[1]!=d&&a[1]!=b?(c.push((a[1]-d)*(l-k)/(b-d)+k),g=m):a[1]==d&&a[1]!=b?(g!=m&&c.push(k),g=m):a[1]!=d&&a[1]==b?(c.push(l),g=m):a[1]==d&&a[1]==b&&(1==g&&c.push(k),c.push(l),g=m)}},_sortBuffer:function(e,c,a,f){var g=e.length;if(e.sort(),0<g){for(var h=0,d=c=0;g-1>d;d+=2){var b=Math.abs(e[d+1]-e[d]);e[d]<=a&&e[d+1]<=a||e[d]>=
f&&e[d+1]>=f||b>h&&(h=b,c=d)}g=e[c];e=e[c+1];g>f&&(g=f);a>g&&(g=a);e>f&&(e=f);a>e&&(e=a);c=(g+e)/2}return c},_findPlace:function(e,c,a,f,g,h,d){if(isNaN(a)||isNaN(f))return!1;for(var b=0;b<this._placedLabels.length;b++){var k=this._placedLabels[b].angle,l=this._placedLabels[b].width*this._scale,m=this._placedLabels[b].height*this._scale,n=this._placedLabels[b].x-a,r=this._placedLabels[b].y-f;if(0===g&&0===k){if(this._findPlace2(-h*this._scale,-d*this._scale,h*this._scale,d*this._scale,n-l,r-m,n+l,
r+m))return!1}else{var t=new M(-h*this._scale,-d*this._scale,h*this._scale,d*this._scale,null),q=0,p=1;0!==g&&(q=Math.sin(g),p=Math.cos(g));var u=n*p-r*q,n=n*q+r*p,k=k-g,q=Math.sin(k),p=Math.cos(k),v=-l*p- -m*q,r=-l*q+-m*p,k=+l*p- -m*q,w=+l*q+-m*p,l=u+v,m=n-r,q=u+k,p=n-w,v=u-v,r=n+r,u=u-k,n=n+w,k=new H;if(k.addRing([[l,m],[q,p],[v,r],[u,n],[l,m]]),t.intersects(k))return!1}}for(;g>Math.PI/2;)g-=Math.PI;for(;g<-(Math.PI/2);)g+=Math.PI;b={};return b.layer=e,b.text=c,b.angle=g,b.x=a,b.y=f,b.width=h,b.height=
d,this._placedLabels.push(b),!0},_findPlace2:function(e,c,a,f,g,h,d,b){return(e>=g&&d>=e||a>=g&&d>=a||g>=e&&a>=d)&&(c>=h&&b>=c||f>=h&&b>=f||h>=c&&f>=b)?!0:!1},_clipLine:function(e,c,a,f){for(var g=this._code(e,c),h=this._code(a,f);0!==g||0!==h;){if(0!==(g&h))return!1;var d=a-e,b=f-c;0!==g?(e<this._xmin?(c+=b*(this._xmin-e)/d,e=this._xmin):e>this._xmax?(c+=b*(this._xmax-e)/d,e=this._xmax):c<this._ymin?(e+=d*(this._ymin-c)/b,c=this._ymin):c>this._ymax&&(e+=d*(this._ymax-c)/b,c=this._ymax),g=this._code(e,
c)):(a<this._xmin?(f+=b*(this._xmin-a)/d,a=this._xmin):a>this._xmax?(f+=b*(this._xmax-a)/d,a=this._xmax):f<this._ymin?(a+=d*(this._ymin-f)/b,f=this._ymin):f>this._ymax&&(a+=d*(this._ymax-f)/b,f=this._ymax),h=this._code(a,f))}return this._x0=e,this._y0=c,this._x1=a,this._y1=f,!0},_code:function(e,c){var a=0;return e<this._xmin&&(a+=8),e>this._xmax&&(a+=4),c<this._ymin&&(a+=2),c>this._ymax&&(a+=1),a}});return J("extend-esri")&&I.setObject("layers.labelLayerUtils.DynamicLabelClass",y,K),y});