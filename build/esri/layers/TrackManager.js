//>>built
define("esri/layers/TrackManager","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../graphic ../geometry/Polyline ./GraphicsLayer".split(" "),function(h,n,g,p,q,r,t,u){h=h(null,{declaredClass:"esri.layers._TrackManager",constructor:function(b){this.layer=b;this.trackMap={};this.trackLineMap={}},initialize:function(b){this.map=b;var a=this.layer,c=a._getRenderer(),c=c&&c.trackRenderer;if("esriGeometryPoint"===a.geometryType){var d=this.container=new u._GraphicsLayer({id:a.id+
"_tracks",_child:!0,visible:a.visible,minScale:a.minScale,maxScale:a.maxScale});d.loaded=!0;d.onLoad(d);d._setMap(b,a._div);d.setRenderer(c);a.on("visibility-change",n.hitch(this,function(a){this.container.setVisibility(a.visible);this.container.evaluateSuspension()}));a.on("scale-range-change",n.hitch(this,function(){this.container.setScaleRange(this.layer.minScale,this.layer.maxScale)}))}},addFeatures:function(b){var a=this.trackMap,c=this.layer,d=c._trackIdField,f=[];g.forEach(b,function(b){var c=
b.attributes[d];(a[c]=a[c]||[]).push(b);-1===g.indexOf(f,c)&&f.push(c)});var e=c._startTimeField,k=c.objectIdField,m=function(a,c){var b=a.attributes[e],d=c.attributes[e];return b===d?a.attributes[k]<c.attributes[k]?-1:1:d>b?-1:1};g.forEach(f,function(c){a[c].sort(m)})},trimTracks:function(b){function a(a){for(a=d[a]||[];a.length>f;)e.push(a.shift())}var c,d=this.trackMap,f=this.layer.maximumTrackPoints||0,e=[];if(!f)return e;if(b)g.forEach(b,function(c){a(c)});else for(c in d)d.hasOwnProperty(c)&&
a(c);return e},drawTracks:function(b){function a(a){var b,e,g,l,h=c[a];if(l=k.trackLineMap[a],m.remove(l),delete k.trackLineMap[a],l=null,!h||2>h.length)return!1;e=[];for(b=h.length-1;0<=b;b--)(g=h[b].geometry)&&e.push([g.x,g.y]);b={};b[f]=a;1<e.length&&(l=new r(new t({paths:[e],spatialReference:d}),null,b),m.add(l),k.trackLineMap[a]=l)}var c,d,f,e,k=this,m=this.container;if(m)if(c=this.trackMap,d=this.map.spatialReference,f=this.layer._trackIdField,b)g.forEach(b,function(b){a(b)});else for(e in c)c.hasOwnProperty(e)&&
a(e)},refreshTracks:function(b){function a(a){var b,c;if(d.drawTracks([a]),k&&k.latestObservationRenderer)for(a=f[a]||[],b=a.length,c=0;b>c;c++)e._repaint(a[c],null,!0)}var c,d=this,f=this.trackMap,e=this.layer,k=e._getRenderer();if(b)g.forEach(b,function(b){a(b)});else for(c in f)f.hasOwnProperty(c)&&a(c);this.moveLatestToFront()},moveLatestToFront:function(b){g.forEach(this.getLatestObservations(b),function(a){var b=a._shape;b&&b._moveToFront();this._repaint(a,null,!0)},this.layer)},getLatestObservations:function(b){function a(a){a=
e[a];return a[a.length-1]}var c,d=[],f=this.layer._getRenderer(),e=this.trackMap;if(!f.latestObservationRenderer)return d;if(b)g.forEach(b,function(b){d.push(a(b))});else for(c in e)e.hasOwnProperty(c)&&d.push(a(c));return d},clearTracks:function(b){var a,c=this.getLatestObservations(b),d=this.container;b?g.forEach(b,function(b){delete this.trackMap[b];d&&(a=this.trackLineMap[b],d.remove(a),delete this.trackLineMap[b])},this):(this.trackMap={},this.trackLineMap={},d&&d.clear());g.forEach(c,function(a){this._repaint(a,
null,!0)},this.layer)},isLatestObservation:function(b){var a=this.trackMap[b.attributes[this.layer._trackIdField]];return a?a[a.length-1]===b:!1},destroy:function(){var b=this.container;b&&(b.clear(),b._unsetMap(this.map,this.layer._div));this.map=this.layer=this.trackMap=this.container=null}});return p("extend-esri")&&n.setObject("layers._TrackManager",h,q),h});