//>>built
define("esri/layers/HeatmapManager","dojo/_base/declare dojo/_base/lang dojo/aspect dojo/_base/array require ../kernel ../sniff ../geometry/Point ../geometry/webMercatorUtils ./MapImage ../renderers/HeatmapRenderer ../tasks/query dojo/_base/fx".split(" "),function(g,m,u,r,v,w,x,y,z,A,l,B,t){function C(){}function D(a){var b=a.layer;return{geometry:a.geometry,attributes:a.attributes,getLayer:function(){return b}}}g=g(null,{declaredClass:"esri.layers.HeatmapManager",heatmapRenderer:null,sourceLayer:null,
imageLayer:null,useTiles:!0,useWorker:!1,map:null,constructor:function(a){this.sourceLayer=a;this._hndls=[]},initialize:function(a){this.map=a;var b=this.sourceLayer,d=b.renderer;b.setDrawMode(!1);this.imageLayer=a._getMapImageLyr();var c=this;this.heatmapRenderer=d instanceof l?d:(d.getRendererInfoByZoom(a.getZoom())||d.getRendererInfoByScale(a.getScale())).renderer;this._setupDraw=this._setupDraw.bind(this);this.recalculateHeatmap=this.recalculateHeatmap.bind(this);this._removeRenderer=this._removeRenderer.bind(this);
this._handleRendererChange=this._handleRendererChange.bind(this);this._rendererChangeHandle=this.sourceLayer.on("renderer-change",this._handleRendererChange);this._handleOpacityChange=this._handleOpacityChange.bind(this);this._reprojectFeature=this._reprojectFeature.bind(this);v(["../workers/heatmapCalculator"],function(a){c._calculator=new a(m.mixin({width:c.map.width,height:c.map.height},c._getOptions()));c._setupRenderer();c.heatmapRenderer.getStats=a.calculateStats;c.heatmapRenderer.getHistogramData=
a.getHistogramData})},destroy:function(){this._removeHandlers();this._rendererChangeHandle&&this._rendererChangeHandle.remove();this._rendererChangeHandle=this.sourceLayer=this.imageLayer=this.map=this.heatmapRenderer=this._hndls=null},_handleRendererChange:function(a){var b=a.renderer,d=b instanceof l;this.heatmapRenderer?d?this.heatmapRenderer=b:this._removeRenderer(a):d&&(this.heatmapRenderer=b,this.sourceLayer&&this.map&&this._setupRenderer())},_handleOpacityChange:function(a){a=a.opacity;var b=
this._getImageBySourceId(this.sourceLayer.id);b&&b.setOpacity(a)},_setupRenderer:function(){var a=this._hndls,b=this.sourceLayer,d=this.map,c=this;b._originalDraw=b._draw;b._draw=C;b._div.clear();clearTimeout(this._resetTimer);this._resetTimer=setTimeout(this._resetGraphics.bind(this),250);a.push(b.on("update-end",this._setupDraw));a.push(b.on("suspend",function(){var a=c._getImageBySourceId(c.sourceLayer.id);a&&a.hide()}));a.push(b.on("resume",function(){var a=c._getImageBySourceId(c.sourceLayer.id);
a&&a.show()}));a.push(u.after(b,"redraw",this._setupDraw));a.push(d.on("layer-remove",function(a){a.layer==b&&((a=c._getImageBySourceId(c.sourceLayer.id))&&c.imageLayer.removeImage(a),c._removeRenderer({target:b}))}));b._collection&&a.push(b.on("graphic-add",function(a){c._reprojectFeature(a.graphic);c._setupDraw()}));1!==b.mode&&(a.push(d.on("resize, pan-end",this._setupDraw)),a.push(d.on("zoom-end",this._setupDraw)));a.push(b.on("opacity-change",this._handleOpacityChange));this.imageLayer.suspended&&
this.imageLayer.resume();b.graphics&&b.graphics.length&&(b.graphics[0].geometry&&!d.spatialReference.equals(b.graphics[0].geometry.spatialReference)&&r.forEach(b.graphics,function(a){this._reprojectFeature(a)}.bind(this)),this._setupDraw())},_setupDraw:function(){if(!this._drawTimer){var a=(this.sourceLayer,this);this._drawTimer=setTimeout(function(){clearTimeout(a._drawTimer);a._drawTimer=null;a.sourceLayer._getRenderer().isInstanceOf(l)&&a.recalculateHeatmap()},16)}},_removeRenderer:function(a){var b=
a.target;b._draw=b._originalDraw;delete b._originalDraw;b.setDrawMode(!0);this._removeHandlers();this._hndls=[];var d=this._getImageBySourceId(this.sourceLayer.id);d&&this.imageLayer.removeImage(d);clearTimeout(this._drawTimer);clearTimeout(this._resetTimer);this._drawTimer=this._resetTimer=null;b.renderer!=a.renderer&&b.renderer.getRendererInfo?this.heatmapRenderer=null:(b.redraw(),this.destroy())},recalculateHeatmap:function(){this._calculator?this._doMainCalculation():this._calculatorClient&&this._doWorkerCalculation()},
_reprojectFeature:function(a){if(a&&a.geometry){var b=a.geometry,d=this.map.spatialReference;d.equals(b.spatialReference)||(b=z.project(b,d),null==b?console.log("Unable to reproject features to map's spatial reference. Please convert feature geometry before adding to layer"):a.geometry=b)}},_doWorkerCalculation:function(){},_doMainCalculation:function(){var a=this.sourceLayer,b=this.map,d=this.heatmapRenderer,c=this.map.extent,f=this.map.width,h=this.map.height,g=this._calculator,k=this,p=function(e){e=
k._getScreenPoints(e.features,b,a);e=g.calculateImageData(m.mixin({screenPoints:e,mapinfo:{extent:[c.xmin,c.ymin,c.xmax,c.ymax],resolution:b.getResolution()},width:f,height:h},k._getOptions()));e=d.getSymbol(D({geometry:b.extent,attributes:{size:[f,h],imageData:e},layer:a}));e=new A({extent:b.extent,href:e.url,opacity:0,sourceId:a.id});k._swapMapImages(e,k._getImageBySourceId(a.id));a.suspended&&e.hide()},n={geometry:b.extent,timeExtent:a.useMapTime?b.timeExtent:void 0,spatialRelationship:B.SPATIAL_REL_INTERSECTS};
null!=a._canDoClientSideQuery(n)?a.queryFeatures(n,p):p({features:a.graphics})},_getScreenPoints:function(a,b,d){var c,f,h,g=[],k=a.length,p=0,n=0,e=new y(b.extent.xmin,b.extent.ymax,b.spatialReference),q=b.toScreen(e),m=q.x,q=q.y,l=b.getResolution();for((c=b.extent.getCacheValue("_parts"))&&(h=r.map(c,function(a){return d._intersects(b,a.extent)[0]}));k--;)c=a[k],c.geometry&&(f={x:Math.ceil((c.geometry.x-e.x)/l+m),y:Math.floor((e.y-c.geometry.y)/l-q),attributes:c.attributes},h&&(n=1<h.length&&f.x<
-h[0]?h[1]:h[0],f.x+=n),g[p++]=f);return g},_getImageBySourceId:function(a){var b=this.imageLayer.getImages();return b=r.filter(b,function(b){return b.sourceId==a}),b.length?b[b.length-1]:void 0},_swapMapImages:function(a,b){function d(){c.removeImage(b)}var c=this.imageLayer,f=this.sourceLayer.opacity||1;c.addImage(a);t.anim(a._node,{opacity:f},null,null,function(){a.opacity=f});null!=b&&t.anim(b._node,{opacity:0},null,null,d)},_removeHandlers:function(){if(null!=this._hndls)for(var a=this._hndls.length;a--;)this._hndls[a].remove()},
_getOptions:function(){var a=this.heatmapRenderer;return{blurRadius:a.blurRadius,gradient:a.gradient,maxPixelIntensity:a.maxPixelIntensity,minPixelIntensity:a.minPixelIntensity,field:a.field,fieldOffset:a.fieldOffset}},_resetGraphics:function(){clearTimeout(this._resetTimer);this._resetTimer=null;for(var a,b=this.sourceLayer.graphics,d=b.length;d--;)a=b[d],a._shape=a._offsets=void 0}});return x("extend-esri")&&m.setObject("layers.HeatmapManager",g,w),g});