//>>built
define("esri/plugins/FeatureLayerStatistics","dojo/_base/lang dojo/_base/array dojo/_base/declare dojo/has dojo/Deferred dojo/on dojo/promise/all dojo/when ../kernel ../config ../SpatialReference ../tasks/query ../tasks/StatisticDefinition ../tasks/GenerateRendererTask ../tasks/UniqueValueDefinition ../tasks/ClassBreaksDefinition ../tasks/GenerateRendererParameters ../tasks/generateRenderer ../tasks/GeometryService ../tasks/ProjectParameters ../layers/TileInfo ../layers/HeatmapManager ../workers/heatmapCalculator ../geometry/mathUtils ../geometry/webMercatorUtils ../geometry/scaleUtils ../geometry/Point ../geometry/Extent".split(" "),
function(r,l,J,K,p,G,L,z,M,C,B,u,D,N,O,P,E,Q,R,S,T,U,H,F,I,V,W,X){C=C.defaults;var Y=H.prototype._calculateIntensityMatrix,Z=H.calculateStats,aa=U.prototype._getScreenPoints,y=J(null,{declaredClass:"esri.plugins.FeatureLayerStatistics",sampleSize:500,worldScale:1E8,generalizeForScale:4E5,generalizeForResolution:105,mapWidth:1280,mapHeight:800,mapPaddingRatioForFE:.25,minDistance:12,minLength:30,minSize:15,minScaleRelaxationRatio:.25,samplingThreshold:2E4,numBins:10,numClasses:5,classificationMethod:"equal-interval",
standardDeviationInterval:1,geometryServiceUrl:window.location.protocol+"//utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",tileInfo:new T({rows:256,cols:256,dpi:96,format:"JPEG",compressionQuality:90,origin:{x:-2.0037508342787E7,y:2.0037508342787E7},spatialReference:{wkid:102100,latestWkid:3857},lods:[{level:0,resolution:156543.03392800014,scale:5.91657527591555E8},{level:1,resolution:78271.51696399994,scale:2.95828763795777E8},{level:2,resolution:39135.75848200009,scale:1.47914381897889E8},
{level:3,resolution:19567.87924099992,scale:7.3957190948944E7},{level:4,resolution:9783.93962049996,scale:3.6978595474472E7},{level:5,resolution:4891.96981024998,scale:1.8489297737236E7},{level:6,resolution:2445.98490512499,scale:9244648.868618},{level:7,resolution:1222.992452562495,scale:4622324.434309},{level:8,resolution:611.4962262813797,scale:2311162.217155},{level:9,resolution:305.74811314055756,scale:1155581.108577},{level:10,resolution:152.87405657041106,scale:577790.554289},{level:11,resolution:76.43702828507324,
scale:288895.277144},{level:12,resolution:38.21851414253662,scale:144447.638572},{level:13,resolution:19.10925707126831,scale:72223.819286},{level:14,resolution:9.554628535634155,scale:36111.909643},{level:15,resolution:4.77731426794937,scale:18055.954822},{level:16,resolution:2.388657133974685,scale:9027.977411},{level:17,resolution:1.1943285668550503,scale:4513.988705},{level:18,resolution:.5971642835598172,scale:2256.994353},{level:19,resolution:.29858214164761665,scale:1128.497176}]}),_outlineInfo:[{size:10,
width:0},{size:20,width:.5},{size:80,width:1},{size:250,width:2}],constructor:function(a){r.mixin(this,a);this._scaleCache=this._sampleCache=null;this._gsTask=C.geometryService||new R(this.geometryServiceUrl);this.layer.loaded?this._createGRTask():G.once(this.layer,"load",r.hitch(this,this._createGRTask))},destroy:function(){this.layer=this._grTask=this._scaleCache=this._sampleCache=null},getUniqueValues:function(a){var b=new p;return a&&(a.field||a.sqlExpression)?this._callAfterLoad(this._findUniqueValues,
{dfd:b,params:a}):this._rejectDfd(b,"FeatureLayerStatistics.getUniqueValues: 'field' or 'sqlExpression' parameter is required."),b.promise},getPredominantCategories:function(a){var b=new p;return a&&a.fields?2>a.fields.length?this._rejectDfd(b,"FeatureLayerStatistics.getPredominantCategories: invalid fields. Minimum required is 2."):this._callAfterLoad(this._predominantCategories,{dfd:b,params:a}):this._rejectDfd(b,"FeatureLayerStatistics.getPredominantCategories: 'fields' parameter is missing."),
b.promise},getPredominanceExpressions:function(a){var b=new p;return a&&a.fields?2>a.fields.length?this._rejectDfd(b,"FeatureLayerStatistics.getPredominanceExpressions: invalid fields. Minimum required is 2."):this._callAfterLoad(this._predominanceExpressions,{dfd:b,params:a}):this._rejectDfd(b,"FeatureLayerStatistics.getPredominanceExpressions: 'fields' parameter is missing."),b.promise},getFieldStatistics:function(a){var b=new p;return a&&(a.field||a.valueExpression||a.sqlExpression)?this._callAfterLoad(this._getFieldStats,
{dfd:b,params:a}):this._rejectDfd(b,"FeatureLayerStatistics.getFieldStatistics: 'field', 'valueExpression' or 'sqlExpression' parameter is required."),b.promise},getSpatialStatistics:function(a){var b=new p;return a&&a.features&&a.features.length?this._callAfterLoad(this._spatialStats,{dfd:b,params:a}):this._rejectDfd(b,"FeatureLayerStatistics.getSpatialStatistics: 'features' parameter is missing or it has no features."),b.promise},getSuggestedSizeRange:function(a){var b=new p;return this._callAfterLoad(this._getSizeRange,
{dfd:b,params:a}),b.promise},getSuggestedOutline:function(a){var b=new p;return this._callAfterLoad(this._getOutline,{dfd:b,params:a}),b.promise},getHeatmapStatistics:function(a){var b=new p;return this._callAfterLoad(this._getHeatmapStats,{dfd:b,params:a}),b.promise},getHistogram:function(a){var b=new p;return a&&(a.field||a.valueExpression||a.sqlExpression)?this._callAfterLoad(this._getHistogram,{dfd:b,params:a}):this._rejectDfd(b,"FeatureLayerStatistics.getHistogram: 'field', 'valueExpression' or 'sqlExpression' parameter is required."),
b.promise},getSampleFeatures:function(a){var b=new p;return this._callAfterLoad(this._sampleFeatures,{dfd:b,params:a}),b.promise},getSuggestedScaleRange:function(a){var b=new p;return this._callAfterLoad(this._scaleRange,{dfd:b,params:a}),b.promise},getClassBreaks:function(a){var b=new p;return a&&a.field?this._callAfterLoad(this._findClassBreaks,{dfd:b,params:a}):this._rejectDfd(b,"FeatureLayerStatistics.getClassBreaks: 'field' parameter is missing."),b.promise},_srcQuery:"service-query",_srcGenRend:"service-generate-renderer",
_srcMemory:"features-in-memory",_srcFeatures:"features",_log10e:Math.LOG10E,_reNumber:/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,_isCollection:function(){return!this.layer.url},_getFieldStats:function(a){var b=this,c=a.params,d=r.isFunction(c.field),e=c.field&&!d?this.layer.getField(c.field):null;if(!e||!this._rejectNonNumeric(a.dfd,e,"getFieldStatistics")){if((c.valueExpression||c.sqlExpression)&&c.normalizationType)return void this._rejectDfd(a.dfd,"FeatureLayerStatistics.getFieldStatistics: normalization is not supported when valueExpression or sqlExpression is specified.");
this._isCollection()||c.features||d?this._statsFromMemory(c).then(function(b){a.dfd.resolve(b)}).otherwise(function(){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getFieldStatistics: unable to calculate field statistics.")}):(c.normalizationType?this._statsFromGenRend(c):this._statsFromQuery(c)).then(function(b){a.dfd.resolve(b)}).otherwise(function(){b._statsFromMemory(c).then(function(b){a.dfd.resolve(b)}).otherwise(function(){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getFieldStatistics: unable to calculate field statistics.")})})}},
_statsFromQuery:function(a){var b=this.layer,c=new p;if(b.url&&b.supportsStatistics){var d=new u,e=this,f=this._getRangeExpr(a.field,a.minValue,a.maxValue);f?d.where=f:a.sqlExpression&&(d.where=a.sqlWhere);d.outStatistics=l.map("min max avg stddev count sum var".split(" "),function(b){var c=new D;return c.statisticType=b,c.onStatisticField=a.sqlExpression||a.field,c.outStatisticFieldName="var"===b?"variance":b,c});b.queryFeatures(d).then(function(a){var b;a=(a=a&&a.features)&&a[0]&&a[0].attributes;
var d={source:e._srcQuery};for(b in a)d[b.toLowerCase()]=a[b];d.min===d.max&&null!=d.min&&null==d.stddev&&(d.stddev=d.variance=0);c.resolve(d)}).otherwise(function(){e._rejectDfd(c,"FeatureLayerStatistics: Statistics query operation failed.")})}else this._rejectDfd(c,"FeatureLayerStatistics: Statistics query requires a layer that supports statistics.");return c.promise},_statsFromMemory:function(a){var b,c=new p;if("percent-of-total"===a.normalizationType){if(b=this._calcStatsFromMemory({field:a.field}).sum,
null==b)return void this._rejectDfd(c,"getFieldStatistics: invalid normalizationTotal.");a=r.mixin({normalizationTotal:b},a)}return c.resolve(this._calcStatsFromMemory(a)),c.promise},_calcStatsFromMemory:function(a){var b=!(!a.features||!a.features.length),c=this._getDataValues(b?a.features:this.layer.graphics,a);a=this._calcStatistics(c,!a.normalizationType);return a.source=b?this._srcFeatures:this._srcMemory,a},_getDataValues:function(a,b){var c,d,e,f=b.field,g=r.isFunction(f),h=b.normalizationType,
k=b.normalizationField,m=b.normalizationTotal,n=null==b.minValue?-1/0:b.minValue,q=null==b.maxValue?1/0:b.maxValue,x=[];return l.forEach(a,function(a){c=a.attributes;g?e=f.call(null,a):c&&(e=c[f]);h&&null!=e&&(d=c&&parseFloat(c[k]),"log"===h&&0!=e?e=Math.log(e)*this._log10e:"percent-of-total"!==h||isNaN(m)||0==m?"field"!==h||isNaN(d)||0==d||(e/=d):e=e/m*100);null!=e&&!isNaN(e)&&e>=n&&q>=e&&x.push(e)},this),x},_calcStatistics:function(a,b){var c=1/0,d=-1/0,e=0,f=null,g=null,h=null,k=null;if(l.forEach(a,
function(a){e++;f+=a;c>a&&(c=a);a>d&&(d=a)}),e){var g=f/e,m=0;l.forEach(a,function(a){m+=Math.pow(a-g,2)});k=b?1<e?m/(e-1):0:0<e?m/e:0;h=Math.sqrt(k)}return{min:e?c:null,max:e?d:null,count:e,sum:f,avg:g,stddev:h,variance:k}},_statsFromGenRend:function(a){var b=new p,c=this,d=a.normalizationType,e=a.normalizationField;return this.getClassBreaks({field:a.field,classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:d,normalizationField:"field"===d?e:void 0,minValue:a.minValue,
maxValue:a.maxValue}).then(function(a){var d,e,k,m;l.some(a.classBreakInfos,function(a){return a.hasAvg&&(d=a),!!d});d&&(m=d.maxValue-d.minValue,e=d.minValue+m/2,k=4*m);b.resolve({min:a.minValue,max:a.maxValue,avg:e,stddev:k,source:c._srcGenRend})}).otherwise(function(){c._rejectDfd(b,"FeatureLayerStatistics.getFieldStatistics: unable to calculate class breaks.")}),b.promise},_spatialStats:function(a){var b=a.params.features,c=this.layer.geometryType,d={},c={point:"esriGeometryPoint"===c,mPoint:"esriGeometryMultipoint"===
c,line:"esriGeometryPolyline"===c,polygon:"esriGeometryPolygon"===c};c.point?d=this._getPointStats(b):c.mPoint?d=this._getPointStats(b,!0):c.line?d=this._getLineStats(b):c.polygon&&(d=this._getPolygonStats(b));d.avgXY=this._getAvgXY(b,c);a.dfd.resolve(d)},_getPointStats:function(a,b){var c,d,e,f,g,h,k,m=a.length,n={},q={},x=0,l=0,A=1/0,v=-1/0,w=0,p=0,r=[];if(b)for(c=0;m>c;c++)a[c].geometry&&r.push.apply(r,a[c].geometry.points);else r=a;m=r.length;for(c=0;m>c;c++)if(b?(n.x=r[c][0],n.y=r[c][1],e=n):
e=r[c].geometry,e){h=1/0;k=-1/0;for(d=0;m>d;d++)d!==c&&(b?(q.x=r[d][0],q.y=r[d][1],f=q):f=r[d].geometry,f&&(g=F.getLength(e,f),0<g&&(h>g&&(h=g),A>g&&(A=g),g>k&&(k=g),g>v&&(v=g))));1/0!==h&&(++w,x+=h);k!==-1/0&&(++p,l+=k)}return{minDistance:1/0!==A?A:null,maxDistance:v!==-1/0?v:null,avgMinDistance:w?x/w:null,avgMaxDistance:p?l/p:null}},_getLineStats:function(a){var b,c,d,e=a.length,f={},g={},h=1/0,k=-1/0,m=0,n=0;for(b=0;e>b;b++)(c=a[b].geometry)&&(d=this._getLineLength(c,f,g),0<d&&(++n,m+=d,h>d&&(h=
d),d>k&&(k=d)));return{minLength:1/0!==h?h:null,maxLength:k!==-1/0?k:null,avgLength:n?m/n:null}},_getLineLength:function(a,b,c){var d,e=a.paths,f=e.length,g=0;for(a=0;f>a;a++)d=e[a],d=this._getActualLineLength(d,b,c),0<d&&(g+=d);return g},_getApproxLineLength:function(a,b,c){var d=a[0],e=a[a.length-1],f=0;return d&&e&&d[0]===e[0]&&d[1]===e[1]&&(e=a[a.length-2]),d&&e&&d!==e&&(b.x=d[0],b.y=d[1],c.x=e[0],c.y=e[1],f=F.getLength(b,c)),f},_getActualLineLength:function(a,b,c){var d,e,f,g=a.length,h=0;for(d=
0;g-1>d;d++)e=a[d],f=a[d+1],e&&f&&(b.x=e[0],b.y=e[1],c.x=f[0],c.y=f[1],h+=F.getLength(b,c));return h},_getPolygonStats:function(a){var b,c,d,e=a.length,f=1/0,g=-1/0,h=0,k=0;for(b=0;e>b;b++)a[b].geometry&&(d=a[b].geometry.getExtent(),d&&(c=(d.getWidth()+d.getHeight())/2,0<c&&(++k,h+=c,f>c&&(f=c),c>g&&(g=c))));return{minSize:1/0!==f?f:null,maxSize:g!==-1/0?g:null,avgSize:k?h/k:null}},_getAvgXY:function(a,b){var c,d,e,f,g,h,k,m,n=a.length,q=null,l=null,t=0;for(c=0;n>c;c++)if(d=a[c].geometry)if(b.point)++t,
q+=d.x,l+=d.y;else if(b.mPoint)for(h=d.points,g=h.length,d=0;g>d;d++)++t,q+=h[d][0],l+=h[d][1];else if(b.line)for(k=d.paths,f=k.length,d=0;f>d;d++)for(h=k[d],g=h.length,e=0;g>e;e++)++t,q+=h[e][0],l+=h[e][1];else if(b.polygon)for(k=d.rings,f=k.length,d=0;f>d;d++)for(h=k[d],g=h.length,e=0;g>e;e++)++t,q+=h[e][0],l+=h[e][1];return null!=q&&null!=l&&(m={x:q/t,y:l/t}),m},_getSizeRange:function(a){var b=this,c=a.params,d=this.layer,e=d.getMap();if("esriGeometryPolygon"!==d.geometryType)return void this._rejectDfd(a.dfd,
"FeatureLayerStatistics.getSuggestedSizeRange: not supported for points and lines.");if(!e)return void this._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: layer has to be added to the map.");if(c&&"visible-scale-range"===c.optimizeForScale){var f=this._projectExtent(d.fullExtent,this.tileInfo.spatialReference);this.getSuggestedScaleRange({map:!1}).then(function(c){b._processSizeRange(c.spatialStatistics,e,a.dfd,f,c)}).otherwise(function(){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: unable to calculate suggested scale range.")})}else this._getFeatures(e,
c).then(function(c){b.getSpatialStatistics({features:c}).then(function(c){b._processSizeRange(c,e,a.dfd)}).otherwise(function(){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedSizeRange: unable to calculate spatial statistics.")})}).otherwise(function(c){b._rejectDfd(a.dfd,c.message)})},_processSizeRange:function(a,b,c,d,e){var f=this;z(d).always(function(d){d=d&&d.hasOwnProperty("xmin")?d:null;f._calcSizeRange(a,b,c,d,e)})},_getFeatures:function(a,b){var c,d=new p,e=this;b&&b.useMapExtent?
(c=new u,c.geometry=a.extent,c=this.layer.queryFeatures(c)):c={features:this.layer.graphics.slice(0)};return z(c).then(function(a){(a=a&&a.features)&&a.length?d.resolve(a):e._rejectDfd(d,"FeatureLayerStatistics: layer has 0 features.")}).otherwise(function(){e._rejectDfd(d,"FeatureLayerStatistics: unable to query features.")}),d.promise},_calcSizeRange:function(a,b,c,d,e){var f=a&&a.avgSize,g=b.getResolution();b=b.getScale();if(null==f||isNaN(f))this._rejectDfd(c,"FeatureLayerStatistics.getSuggestedSizeRange: invalid average feature size.");
else if(g&&b){var h;if(e){var k=g/b;d=this._getScaleValues(d,e);var m=d.feScaleIndex,n=[],q=[];h=d.scales[m];l.forEach(d.scales,function(a,b){var c=this._calcSizeValues(f,k*a),d=-1<m&&b>m?2:1;n.push({value:a,size:c.min/d});q.push({value:a,size:c.max/d})},this);d={type:"sizeInfo",expression:"view.scale",stops:n};g={type:"sizeInfo",expression:"view.scale",stops:q}}else g=this._calcSizeValues(f,g),d=g.min,g=g.max;c.resolve({minSize:d,maxSize:g,spatialStatistics:a,avgFeatureSize:f,scaleAtFullExtent:h,
suggestedScaleRange:e})}else this._rejectDfd(c,"FeatureLayerStatistics.getSuggestedSizeRange: invalid map scale/resolution.")},_getScaleValues:function(a,b){var c=this.tileInfo.lods,d=this.layer.minScale||c[0].scale,c=this.layer.maxScale||c[c.length-1].scale,e=b&&b.minScale||0,f=b&&b.maxScale||0,g=a&&this._findLODForFE(this.tileInfo.lods,a,this.mapWidth,this.mapHeight),g=g&&g.scale<d&&g.scale>c?Math.round(g.scale):0,h=l.map([d,c,e,f,g],Math.round);return h.sort(this._numberSorter),h=l.filter(h,function(a,
b){return!!a&&l.indexOf(h,a)===b}),h=l.filter(h,function(a,b,c){return b?5<Math.abs(a-c[b-1]):!0}),{scales:h,feScaleIndex:l.indexOf(h,g)}},_numberSorter:function(a,b){return a-b},_findLODForFE:function(a,b,c,d){var e,f,g=a.length,h=b.getWidth(),k=b.getHeight();for(b=0;g>b;b++){if(e=a[b],c*e.resolution<h||d*e.resolution<k){f=0===b?a[b]:a[b-1];break}if(b===g-1){f=a[b];break}}return f},_calcSizeValues:function(a,b){a=Math.ceil(a/b);var c=Math.ceil(a/4);4>c?c=4:16<c&&(c=16);var d=5*c;return{min:c,max:50>
d?50:d}},_getOutline:function(a){var b=this;return"esriGeometryPolygon"!==this.layer.geometryType?void this._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedOutline: not supported for points and lines."):void this._getFeatures().then(function(c){b.getSpatialStatistics({features:c}).then(function(d){if(d.avgSize){var e;l.some(c,function(a){return a.geometry&&(e=a.geometry.spatialReference),!!e});b._calcOutline(d,e,a.params,a.dfd)}else b._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedOutline: average feature size is 0 or null.")}).otherwise(function(){b._rejectDfd(a.dfd,
"FeatureLayerStatistics.getSuggestedOutline: unable to calculate spatial statistics.")})}).otherwise(function(c){b._rejectDfd(a.dfd,c.message)})},_calcOutline:function(a,b,c,d){var e=a.avgSize,f=c&&null!=c.allowZeroWidth?c.allowZeroWidth:!0,g=39.37*96*V.getUnitValueForSR(b);b=l.map(l.filter(this._outlineInfo,function(a,b){return f||0<b}),function(a){return{size:a.width,value:Math.round(e/a.size*g)}});b.sort(function(a,b){return a.value-b.value});d.resolve({widthInfo:{type:"sizeInfo",target:"outline",
expression:"view.scale",stops:b},spatialStatistics:a})},_getHeatmapStats:function(a){var b=this,c=this.layer,d=a.params,e=a.dfd,f=d.fieldOffset;a=d.field&&this.layer.getField(d.field);d.field&&this._rejectNonNumeric(e,a,"getHeatmapStatistics")||(d.field&&null==f?c.statisticsPlugin.getFieldStatistics({field:d.field}).then(function(a){b._calcHeatmapStats(a,f,d,e)}).otherwise(function(){b._rejectDfd(e,"FeatureLayerStatistics.getHeatmapStatistics: unable to calculate field statistics.")}):this._calcHeatmapStats(null,
f,d,e))},_calcHeatmapStats:function(a,b,c,d){var e=this;if(a){var f=a.min,g=a.max;a.count?f===g&&0===f?b=1:0>=g?b="abs":0>f&&(b=-1.01*f):b=1}this._heatStatsFromMemory(c,b).then(function(c){c.fieldStatistics=a;c.fieldOffset=b;d.resolve(c)}).otherwise(function(){e._rejectDfd(d,"FeatureLayerStatistics.getHeatmapStatistics: unable to calculate heatmap statistics.")})},_heatStatsFromMemory:function(a,b){var c,d=new p,e=this.layer,f=e.graphics,g=f.length,h=e.getMap();if(!g)return d.resolve({count:0,min:null,
max:null,avg:null,stddev:null,source:this._srcMemory}),d.promise;e=h&&Y(aa(f,h,e),h.width,h.height,a.blurRadius||10,a.field,b);return c=e&&e.matrix&&Z(e.matrix),c?d.resolve({count:g,min:c.min,max:c.max,avg:c.mean,stddev:c.stdDev,source:this._srcMemory}):this._rejectDfd(d,"FeatureLayerStatistics.getHeatmapStatistics: unable to calculate heatmap statistics."),d.promise},_getHistogram:function(a){var b=this,c=a.params,d=c.minValue,e=c.maxValue,f=c.valueExpression||c.sqlExpression,g=null!=d&&null!=e,
h=c.field?this.layer.getField(c.field):null,k=!c.classificationMethod||"equal-interval"===c.classificationMethod;if(!h||!this._rejectNonNumeric(a.dfd,h,"getHistogram")){if(f){if(c.normalizationType)return void this._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: normalization is not supported when valueExpression or sqlExpression is specified.");if(!k)return void this._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: classification methods other than 'equal-interval' are not supported when valueExpression or sqlExpression is specified.")}c.normalizationType||
!k?this._binParamsFromGenRend(c).then(function(f){if(g)if(d>f.max||e<f.min)b._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: custom value range is beyond field value range.");else{var h=b._getFieldExpr(c,f.normTotal),h=b._getRangeExpr(h,d,e);k?b._getBins(a,f.sqlExpr,d,e,null,"parameters",null,f.excludeZerosExpr):b._binParamsFromGenRend(c,h).then(function(c){b._getBins(a,c.sqlExpr,c.min,c.max,c.intervals,c.source,c.normTotal,c.excludeZerosExpr)}).otherwise(function(){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: unable to calculate histogram parameters using custom min/max values.")})}else b._getBins(a,
f.sqlExpr,f.min,f.max,f.intervals,f.source,f.normTotal,f.excludeZerosExpr)}).otherwise(function(){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: unable to calculate min/max from generate renderer operation.")}):f?(f=g?{min:d,max:e}:this.getFieldStatistics(c),z(f).then(function(d){b._getBinsFromStatsQuery(c,d.min,d.max,g?"parameters":d.source).then(function(b){a.dfd.resolve(b)}).otherwise(function(){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: query to calculate count failed.")})}).otherwise(function(){b._rejectDfd(a.dfd,
"FeatureLayerStatistics.getHistogram: unable to calculate min/max.")})):g?this._getBins(a,null,d,e,null,"parameters"):this.getFieldStatistics(c).then(function(c){c.count?b._getBins(a,null,c.min,c.max,null,c.source):b._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: cannot calculate histogram for 0 features (statistics.count \x3d 0).")}).otherwise(function(){b._rejectDfd(a.dfd,"FeatureLayerStatistics.getHistogram: unable to calculate min/max.")})}},_getBins:function(a,b,c,d,e,f,g,h){var k=this,
m=a.params.field,n=a.params.numBins||this.numBins;e=e||this._getEqualIntervalBins(c,d,n);b=b||m;this._isCollection()?this._countBinsInMemory(a,c,d,e,g,f):this._queryBins(b,e,h).then(function(b){b=l.map(b,function(a,b){return{minValue:e[b][0],maxValue:e[b][1],count:a}});a.dfd.resolve({bins:b,minValue:c,maxValue:d,normalizationTotal:g,source:k._srcQuery,statisticsSource:f})}).otherwise(function(){k._countBinsInMemory(a,c,d,e,g,f)})},_getEqualIntervalBins:function(a,b,c){var d;b=(b-a)/c;var e=a,f=[];
for(a=1;c>=a;a++)d=e+b,f.push([e,d]),e=d;return f},_countBinsInMemory:function(a,b,c,d,e,f){var g=this;this._binsFromMemory(a.params,b,c,d,e).then(function(d){a.dfd.resolve({bins:d,minValue:b,maxValue:c,normalizationTotal:e,source:g._srcMemory,statisticsSource:f})}).otherwise(function(){g._rejectDfd(a.dfd,"FeatureLayerStatistics: unable to calculate histogram.")})},_queryBins:function(a,b,c){var d,e,f=this.layer,g=[],h=b.length;for(d=0;h>d;d++)e=new u,e.where=(c?c+" AND ":"")+a+" \x3e\x3d "+b[d][0]+
(null!==b[d][1]?" AND "+a+(d===h-1?" \x3c\x3d ":" \x3c ")+b[d][1]:""),g.push(e);return L(l.map(g,function(a){return f.queryCount(a)}))},_binsFromMemory:function(a,b,c,d,e){var f,g,h,k,m,n,l=new p,x=a.field,t=a.normalizationType,A=a.normalizationField,v=this.layer.graphics,w=[];if(!v.length)return this._rejectDfd(l,"Layer has 0 features in memory."),l.promise;h=d.length;for(a=0;h>a;a++)w.push({minValue:d[a][0],maxValue:d[a][1],count:0});h=v.length;for(a=0;h>a;a++)g=(f=(f=v[a])&&f.attributes)&&f[x],
null!=g&&(t?(m=null,n=f&&parseFloat(f[A]),"log"===t&&0!=g?m=Math.log(g)*this._log10e:"percent-of-total"!==t||isNaN(e)||0==e?"field"!==t||isNaN(n)||0==n||(m=g/n):m=g/e*100):m=g,null!=m&&!isNaN(m)&&m>=b&&c>=m&&(k=this._binIndex(d,m),-1<k&&w[k].count++));return l.resolve(w),l.promise},_binIndex:function(a,b){var c,d,e=-1;for(c=a.length-1;0<=c;c--)if(d=a[c][0],b>=d){e=c;break}return e},_binParamsFromGenRend:function(a,b){var c=this.layer,d=new p,e=this,f=this._getGRWhereInfo(c,a),g=f.where,h=a.numBins||
this.numBins,k=this._createCBDefn(a,h),m=new E;return m.classificationDefinition=k,m.where=g?g+(b?" AND "+b:""):b,!this._isCollection()&&10.1<=c.version?this._grTask.execute(m).then(function(b){e._resolveBinParams(b,f,e._srcGenRend,a,d)}).otherwise(function(){e._binParamsFromMemory(h,f,e._srcMemory,a,d)}):e._binParamsFromMemory(h,f,e._srcMemory,a,d),d.promise},_binParamsFromMemory:function(a,b,c,d,e){var f=this;this._cbFromMemory(d,a).then(function(a){f._resolveBinParams(a,b,c,d,e)}).otherwise(function(){f._rejectDfd(e,
"FeatureLayerStatistics.getHistogram: unable to calculate class breaks.")})},_resolveBinParams:function(a,b,c,d,e){var f,g,h=[],k=a.infos;g=k.length;f=k[0].minValue;g=k[g-1].maxValue;l.forEach(k,function(a){h.push([a.minValue,a.maxValue])});e.resolve({min:f,max:g,intervals:h,sqlExpr:this._getFieldExpr(d,a.normalizationTotal),excludeZerosExpr:b.excludeZerosExpr,normTotal:a.normalizationTotal,source:c})},_getGRWhereInfo:function(a,b){var c,d=b.field,e=b.normalizationType,f=b.normalizationField,g=a.getDefinitionExpression();
return"log"===e?c="(NOT "+d+" \x3d 0)":"field"===e&&(c="(NOT "+f+" \x3d 0)"),{where:c?c+(g?" AND "+g:""):g,excludeZerosExpr:c}},_getFieldExpr:function(a,b){var c=a.field,d=a.normalizationType,e=a.normalizationField,f=c;return"percent-of-total"===d?f="(("+c+" / "+b+") * 100)":"log"===d?f="(log("+c+") * "+this._log10e+")":"field"===d&&(f="("+c+" / "+e+")"),f},_getRangeExpr:function(a,b,c){b=null!=b?a+" \x3e\x3d "+b:"";a=null!=c?a+" \x3c\x3d "+c:"";c="";return c=b&&a?b+" AND "+a:b||a,c?"("+c+")":""},
_getBinsFromStatsQuery:function(a,b,c,d){var e=this.layer,f=e.advancedQueryCapabilities,f=f&&f.supportsSqlExpression,g=new p;if(this._isCollection())this._rejectDfd(g,"FeatureLayerStatistics.getHistogram: feature collection is not supported.");else if(f&&(e.useStandardizedQueries||this._reHostedFS.test(e.url))){var h=this._getEqualIntervalBins(b,c,a.numBins||this.numBins),f=this._calcBinsSQL(a.sqlExpression,h),k=this,m=new D;m.statisticType="count";m.outStatisticFieldName="countOFExpr";m.onStatisticField=
"*";var n=new u;n.outStatistics=[m];n.groupByFieldsForStatistics=[f];n.orderByFields=[f];n.where=a.sqlWhere;e.queryFeatures(n).then(function(a){var e={};l.forEach(a.features,function(a){var b=a.attributes;a=this._getCustomExprVal(b,"countOFExpr");b=this._getAttributeVal(b,"countOFExpr");0!==a&&(e[a]=b)},k);var f=[];l.forEach(h,function(a,b){var c=b+1;f.push({minValue:a[0],maxValue:a[1],count:e.hasOwnProperty(c)?e[c]:0})});g.resolve({bins:f,minValue:b,maxValue:c,source:k._srcQuery,statisticsSource:d})}).otherwise(function(){k._rejectDfd(g,
"FeatureLayerStatistics.getHistogram: Statistics query operation failed.")})}else this._rejectDfd(g,"FeatureLayerStatistics.getHistogram: make sure the layer supports advanced SQL expressions and standardized queries.");return g.promise},_sampleFeatures:function(a){var b=this,c=a.params,d=a.dfd,e=this.layer,f=e.graphics;a=this._sampleCache;var g=c&&c.resample,h=c&&c.sampleSize||this.sampleSize;if(a&&!g)return void d.resolve(this._cloneSample(a));(d._time={start:this._getTime()},f.length&&h<=f.length)?
this._resolveSample(d,this._pickItems(f,h),this._srcMemory):(a=new u,a.where="1\x3d1",d._time.countStart=this._getTime(),e.queryCount(a).then(function(a){d._time.countEnd=b._getTime();d._totalFeatures=a;h>e.maxRecordCount&&(h=e.maxRecordCount);var g;a?a<=f.length?b._resolveSample(d,b._pickItems(f,f.length),b._srcMemory):h>=a?(g=new u,g.where="1\x3d1",b._queryFeatures(g,c,e,f,d)):a<=b.samplingThreshold?(a=new u,a.where="1\x3d1",d._time.idStart=b._getTime(),e.queryIds(a).then(function(a){d._time.idEnd=
b._getTime();var g=new u;g.objectIds=b._pickItems(a,h);b._queryFeatures(g,c,e,f,d)}).otherwise(function(){g=new u;g.where="1\x3d1";b._queryFeatures(g,c,e,f,d)})):(g=new u,g.where="1\x3d1",(a=e.advancedQueryCapabilities)&&a.supportsPagination&&(g.num=h),b._queryFeatures(g,c,e,f,d)):b._resolveSample(d,[],b._srcQuery)}).otherwise(function(){b._resolveSample(d,b._pickItems(f,f.length),b._srcMemory)}))},_queryFeatures:function(a,b,c,d,e){var f=this;a.outSpatialReference=b&&b.spatialReference;a.maxAllowableOffset=
b&&b.maxAllowableOffset;a.outFields=b&&b.outFields;b&&null!=b.returnGeometry&&(a.returnGeometry=b.returnGeometry);e._time.featStart=this._getTime();c.queryFeatures(a).then(function(a){e._time.featEnd=f._getTime();f._resolveSample(e,a&&a.features||[],f._srcQuery)}).otherwise(function(){f._resolveSample(e,f._pickItems(d,d.length),f._srcMemory)})},_pickItems:function(a,b){var c,d=a.length,e=[],f=[];if(b>=d)f=a.slice(0);else for(;f.length<b;)c=this._getRandomInt(0,d),-1===l.indexOf(e,c)&&(e.push(c),f.push(a[c]));
return f},_getRandomInt:function(a,b){return Math.floor(Math.random()*(b-a))+a},_resolveSample:function(a,b,c){b=b||[];var d,e,f,g=b.length;for(d=0;g>d&&(e=b[d].geometry,!(f=e&&e.spatialReference));d++);a._time.end=(new Date).getTime();d=a._time;a._time=null;this._sampleCache={features:b,spatialReference:f&&new B(f.toJson()),source:c,time:this._getTimeStats(d),totalFeatures:a._totalFeatures};a.resolve(this._cloneSample(this._sampleCache))},_cloneSample:function(a){return{features:l.map(a.features,
function(a){return new a.constructor(a.toJson())}),spatialReference:a.spatialReference&&new B(a.spatialReference.toJson()),source:a.source,time:r.clone(a.time),totalFeatures:a.totalFeatures}},_getTimeStats:function(a){var b=this._getTimeDiff;return{total:b(a.start,a.end),features:b(a.featStart,a.featEnd),featureIds:b(a.idStart,a.idEnd),featureCount:b(a.countStart,a.countEnd)}},_getTimeDiff:function(a,b){var c,d,e;return null!=a&&null!=b&&(d=b-a,e="millisecond",1E3<=d&&(d/=1E3,e="second",60<=d&&(d/=
60,e="minute")),c={value:Number(d.toFixed(2)),unit:e}),c},_getTime:function(){return(new Date).getTime()},_scaleRange:function(a){var b,c,d,e=this,f=a.params,g=this.layer,h=f&&f.sampleSize||this.sampleSize,k=f&&f.map||g.getMap(),m=f&&f.mapWidth||this.mapWidth,n=f&&f.mapHeight||this.mapHeight,l=f&&f.generalizeForScale||this.generalizeForScale;f&&!1===f.map&&(k=null);k&&k.__tileInfo?(b=k.__tileInfo,c=k.spatialReference,d=k.extent.getWidth()/k.width/k.getScale()*l):(b=this.tileInfo,c=b.spatialReference,
d=this.generalizeForResolution/this.generalizeForScale*l);this.getSampleFeatures({sampleSize:h,spatialReference:c,maxAllowableOffset:d,outFields:[]}).then(function(d){var h=e._projectExtent(g.fullExtent,c),k=d.features;k&&k.length?e.getSpatialStatistics({features:k}).then(function(c){z(h).always(function(g){g=g&&g.hasOwnProperty("xmin")?g:null;e._processScaleRange(a.dfd,f,b,m,n,g,d,c)})}).otherwise(function(){e._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedScaleRange: unable to calculate spatial statistics.")}):
e._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedScaleRange: sampling returned 0 features.")}).otherwise(function(){e._rejectDfd(a.dfd,"FeatureLayerStatistics.getSuggestedScaleRange: unable to sample features.")})},_processScaleRange:function(a,b,c,d,e,f,g,h){var k,m,l=this.layer.geometryType,q={point:"esriGeometryPoint"===l,mPoint:"esriGeometryMultipoint"===l,line:"esriGeometryPolyline"===l,polygon:"esriGeometryPolygon"===l},l=c.lods,p=this._getLODForMinScale(b,h,q,c),t=q.polygon?this._getLODForMaxScale(b,
h,q,c):null,r=1-this.mapPaddingRatioForFE,v=(r=f&&this._findLODForFE(l,f,d*r,e*r))?r.scale:null,w=(b=this._getLODForMinScale(b,h,q,c,this.minScaleRelaxationRatio))?b.scale:null,u=(b=h.avgXY)&&new W(b.x,b.y,g.spatialReference&&new B(g.spatialReference.toJson())),z=this,y=q.polygon?t?Math.floor(t.scale):null:0;p&&f&&u&&(m=this._findClosestLOD(l,p,f,u,d,e));k=(p=m||p)?Math.ceil(p.scale):null;w=w&&v?Math.max(w,2*v):w||2*v;v=v&&Math.ceil(v);w=w&&Math.ceil(w);p||t?p&&u?this._countAtView(u,p,d,e).then(function(b){var c;
if(!b){var d;b=g.features[0];q.point?c=b.geometry:(d=b.geometry&&b.geometry.getExtent(),c=d&&d.getCenter())}z._resolveScaleRange(a,k,y,v,w,c||u,g,h)}).otherwise(function(){z._resolveScaleRange(a,k,y,v,w,u,g,h)}):this._resolveScaleRange(a,k,y,v,w,u,g,h):this._rejectDfd(a,"FeatureLayerStatistics.getSuggestedScaleRange: unable to find optimal scale range.")},_resolveScaleRange:function(a,b,c,d,e,f,g,h){c>b?this._rejectDfd(a,"FeatureLayerStatistics.getSuggestedScaleRange: invalid scale range - calculated minScale is less than maxScale."):
a.resolve({minScale:b&&(b>this.worldScale?0:b),maxScale:c,scaleAtFullExtent:d,relaxedMinScale:e&&(e>this.worldScale?0:e),center:f,sampleInfo:g,spatialStatistics:h})},_countAtView:function(a,b,c,d){a=this._getExtentFromCenter(a,b,c,d);b=new u;return b.geometry=a,this.layer.queryCount(b).promise},_projectExtent:function(a,b){if(a.spatialReference.equals(b))return new a.constructor(a.toJson());if(I.canProject(a.spatialReference,b))return I.project(a,b);var c=new S;return c.geometries=[a],c.outSR=b,this._gsTask.project(c).then(function(a){return a&&
a[0]})},_getLODForMinScale:function(a,b,c,d,e){var f,g,h,k=a&&a.minDistance||this.minDistance,m=a&&a.minLength||this.minLength;a=a&&a.minSize||this.minSize;return c.point?(f=b.avgMinDistance,h=k):c.mPoint?(f=b.avgMinDistance,h=k):c.line?(f=b.avgLength,h=m):c.polygon&&(f=b.avgSize,h=a),0<f&&(g=this._findLOD(d,f,h*(e||1))),g},_getLODForMaxScale:function(a,b,c,d){var e,f,g,h=this.mapWidth,k=a&&a.maxDistance||h/4,m=a&&a.maxLength||h/4;a=a&&a.maxSize||h/2;return c.point?(e=b.minDistance,g=k):c.mPoint?
(e=b.minDistance,g=k):c.line?(e=b.minLength,g=m):c.polygon&&(e=b.minSize,g=a),0<e&&(f=this._findLOD(d,e,null,g)),f},_findLOD:function(a,b,c,d){var e,f,g,h=a&&a.lods;if(h&&h.length){var k=null!=d,m=k?0:h.length-1,l=k?-1:1;for(a=k?h.length-1:0;k?a>=m:m>=a;a+=l)if(f=h[a],g=Math.round(b/f.resolution),k){if(d>=g){e=f;break}}else if(g>=c){e=f;break}}return e},_getExtentFromCenter:function(a,b,c,d){c=c/2*b.resolution;b=d/2*b.resolution;return new X(a.x-c,a.y-b,a.x+c,a.y+b,new B(a.spatialReference.toJson()))},
_findClosestLOD:function(a,b,c,d,e,f){var g,h,k,m=a.length;for(g=0;m>g;g++)if(!(a[g].level<b.level)){if(h=this._getExtentFromCenter(d,a[g],e,f),!h.contains(c)){k=a[g-1];break}if(g===m-1){k=a[g];break}}return k&&k.level>b.level?k:null},_findUniqueValues:function(a){var b=this,c=a.params,d=c.field,e=d?this.layer.getField(d):null;return d&&!e?void this._rejectDfd(a.dfd,"FeatureLayerStatistics.getUniqueValues: unknown 'field'."):void(this._isCollection()?this._uvFromMemory(c).then(function(c){b._resolveUVDfd(c,
a,e,b._srcMemory)}).otherwise(function(){b._rejectDfd(a.dfd,"FeatureLayerStatistics: unable to calculate unique values.")}):this._uvFromStatisticsQuery(c).then(function(c){b._resolveUVDfd(c,a,e,b._srcQuery)}).otherwise(function(){b._uvFromGenRenderer(c,e).then(function(c){b._resolveUVDfd(c,a,e,b._srcGenRend)}).otherwise(function(){b._uvFromMemory(c).then(function(c){b._resolveUVDfd(c,a,e,b._srcMemory)}).otherwise(function(){b._rejectDfd(a.dfd,"FeatureLayerStatistics: unable to calculate unique values.")})})}))},
_uvFromStatisticsQuery:function(a){var b=this.layer,c=new p;if(b.supportsStatistics){var d=a.field;a=a.sqlExpression;var e="countOF"+(d||"Expr"),f=this,g=new D;g.statisticType="count";g.onStatisticField=a?"*":d;g.outStatisticFieldName=e;var h=new u;h.outStatistics=[g];h.groupByFieldsForStatistics=[d||a];b.queryFeatures(h).then(function(a){var g,n,q,p,t={};l.forEach(a.features,function(a){g=a.attributes;n=d?this._getAttributeVal(g,d):this._getCustomExprVal(g,e);q=this._getAttributeVal(g,e);null===
n&&0===q&&(p=!0);(null==n||""===n||"string"==typeof n&&""===r.trim(n))&&(n=null);null==t[n]?t[n]={count:q,data:n}:t[n].count+=q},f);d&&p?(h=new u,h.where=d+" is NULL",b.queryCount(h).then(function(a){t["null"].count+=a||0;c.resolve({count:t})}).otherwise(function(){c.resolve({count:t})})):c.resolve({count:t})}).otherwise(function(){f._rejectDfd(c,"FeatureLayerStatistics: Statistics query operation failed.")})}else this._rejectDfd(c,"FeatureLayerStatistics: Statistics query requires a layer that supports statistics.");
return c.promise},_uvFromGenRenderer:function(a,b){var c=this.layer,d=new p,e=this;if(10.1<=c.version){var f=new O;f.attributeField=a.field;var g=new E;g.classificationDefinition=f;g.where=c.getDefinitionExpression();this._grTask.execute(g).then(function(a){var c,f={},g=-1<l.indexOf(e._numericTypes,b.type);l.forEach(a.infos,function(a){c=a.value;null!=c&&""!==c&&("string"!=typeof c||""!==r.trim(c)&&"\x3cnull\x3e"!==c.toLowerCase())||(c=null);null==f[c]?f[c]={count:a.count,data:g&&c?Number(c):c}:f[c].count+=
a.count});d.resolve({count:f})}).otherwise(function(){e._rejectDfd(d,"FeatureLayerStatistics: Generate renderer operation failed.")})}else this._rejectDfd(d,"FeatureLayerStatistics: Generate renderer operation requires server version 10.1 or later.");return d.promise},_uvFromMemory:function(a){var b,c,d=this.layer,e=new p,f=a.field,g={};return l.forEach(d.graphics,function(a){c=(b=a.attributes)&&b[f];(null==c||""===c||"string"==typeof c&&""===r.trim(c))&&(c=null);null==g[c]?g[c]={count:1,data:c}:
g[c].count++}),e.resolve({count:g}),e.promise},_resolveUVDfd:function(a,b,c,d){var e,f=a.count;c=c&&this.layer.getDomain(c.name);a=[];b.params.includeAllCodedValues&&c&&"codedValue"===c.type&&l.forEach(c.codedValues,function(a){a=a.code;f.hasOwnProperty(a)||(f[a]={data:a,count:0})});for(e in f)c=f[e],a.push({value:c.data,count:c.count});b.dfd.resolve({source:d,uniqueValueInfos:a})},_findClassBreaks:function(a){var b=this,c=a.params,d=c.minValue,e=c.maxValue,f=null!=d||null!=e,g=c.classificationMethod,
h="percent-of-total"===c.normalizationType,k=c.numClasses||this.numClasses,l=!1!==c.analyzeData,n=this.layer.getField(c.field);if(!this._rejectNonNumeric(a.dfd,n,"getClassBreaks")){if(f)if(l){if(h&&null==c.normalizationTotal)return void this._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: normalizationTotal is required when minValue/maxValue are specified.")}else{if(null==d||null==e)return void this._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: both minValue AND maxValue are required when data analysis is disabled.");
if(g&&"equal-interval"!==g)return void this._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: data analysis can be disabled only for equal-interval classification.");if(h&&null==c.normalizationTotal)return void this._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: normalizationTotal is required when data analysis is disabled.")}else if(!l)return void this._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: both minValue AND maxValue are required when data analysis is disabled.");
l?this._cbFromGenRend(c,k).then(function(d){b._resolveCBDfd(a.dfd,c,d,b._srcGenRend)}).otherwise(function(){f?b._rejectDfd(a.dfd,"FeatureLayerStatistics.getClassBreaks: cannot calculate class breaks in-memory when minValue/maxValue are specified."):b._cbFromMemory(c,k).then(function(d){b._resolveCBDfd(a.dfd,c,d,b._srcMemory)}).otherwise(function(){b._rejectDfd(a.dfd,"FeatureLayerStatistics: unable to calculate class breaks.")})}):this._cbFromInterpolation(c,k).then(function(d){b._resolveCBDfd(a.dfd,
c,d,b._srcMemory)}).otherwise(function(){b._rejectDfd(a.dfd,"FeatureLayerStatistics: unable to calculate class breaks.")})}},_cbFromGenRend:function(a,b){var c=this.layer,d=new p,e=this;if(c.url&&10.1<=c.version){var f=this._createCBDefn(a,b),c=this._getGRWhereInfo(c,a).where,g=this._getFieldExpr(a,a.normalizationTotal),g=this._getRangeExpr(g,a.minValue,a.maxValue),h=new E;h.classificationDefinition=f;h.where=c?c+(g?" AND "+g:""):g;this._grTask.execute(h).then(function(a){d.resolve(a)}).otherwise(function(){e._rejectDfd(d,
"FeatureLayerStatistics: Generate renderer operation failed.")})}else this._rejectDfd(d,"FeatureLayerStatistics: Generate renderer operation requires server version 10.1 or later.");return d.promise},_cbFromMemory:function(a,b){var c=new p,d=this.layer.graphics;if(d.length){var e,f=this._createCBDefn(a,b);if("percent-of-total"===a.normalizationType){if(e=this._calcStatsFromMemory({field:a.field}).sum,null==e)return this._rejectDfd(c,"FeatureLayerStatistics: Invalid normalizationTotal."),c.promise;
a=r.mixin({normalizationTotal:e},a)}c.resolve(Q.createClassBreaksRenderer({features:d,definition:f,values:this._getDataValues(d,a)}))}else this._rejectDfd(c,"Layer has 0 features in memory.");return c.promise},_cbFromInterpolation:function(a,b){var c=new p,d=a.minValue,e=a.maxValue;if(d>=e||!b||1>b)this._rejectDfd(c,"FeatureLayerStatistics.getClassBreaks: invalid input parameters: minValue, maxValue or numClasses.");else{var f,g,h=[],k=(e-d)/b;for(f=0;b>f;f++)g=d+f*k,h.push({minValue:g,maxValue:g+
k});h[b-1].maxValue=e;c.resolve({infos:h,normalizationTotal:a.normalizationTotal})}return c.promise},_createCBDefn:function(a,b){var c=a.field,d=a.classificationMethod||this.classificationMethod,e=a.normalizationType,f=a.normalizationField,g=new P;return g.classificationField=c,g.breakCount=b,g.classificationMethod=d,g.standardDeviationInterval="standard-deviation"===d?a.standardDeviationInterval||this.standardDeviationInterval:void 0,g.normalizationType=e,g.normalizationField="field"===e?f:void 0,
g},_resolveCBDfd:function(a,b,c,d){var e,f,g,h=c.infos,k=h[0].minValue,m=h[h.length-1].maxValue,n="standard-deviation"===b.classificationMethod,p=this._reNumber,h=l.map(h,function(a){return g=a.label,f={minValue:a.minValue,maxValue:a.maxValue,label:g},n&&g&&(e=g.match(p),e=l.map(e,function(a){return+r.trim(a)}),2===e.length?(f.minStdDev=e[0],f.maxStdDev=e[1],0>e[0]&&0<e[1]&&(f.hasAvg=!0)):1===e.length&&(-1<g.indexOf("\x3c")?(f.minStdDev=null,f.maxStdDev=e[0]):-1<g.indexOf("\x3e")&&(f.minStdDev=e[0],
f.maxStdDev=null))),f});a.resolve({minValue:k,maxValue:m,classBreakInfos:h,normalizationTotal:c.normalizationTotal,source:d})},_reHostedFS:/https?:\/\/services.*\.arcgis\.com/i,_noDominantCategoryField:"no_dominant_category",_predominantCategories:function(a){var b=a.dfd,c=a.params.fields;a=this.layer;var d=a.advancedQueryCapabilities&&a.advancedQueryCapabilities.supportsSqlExpression;if(this._isCollection())this._rejectDfd(b,"FeatureLayerStatistics.getPredominantCategories: feature collection is not supported.");
else if(d&&(a.useStandardizedQueries||this._reHostedFS.test(a.url))){a=this._predominantCategoryNameSQL(c);var e=this;this._uvFromStatisticsQuery({sqlExpression:a.expression}).then(function(a){var d,h=[],k=a.count;for(d in k)a=k[d],h.push({value:a.data,count:a.count});var m=l.map(h,function(a){return a.value});d=l.filter(c,function(a){return-1===l.indexOf(m,a)});l.forEach(d,function(a){h.push({value:a,count:0})});h.sort(e._predominantFieldSorter(c));l.forEach(h,function(a){a.value===e._noDominantCategoryField&&
(a.value=null)});b.resolve({predominantCategoryInfos:h,source:e._srcQuery})}).otherwise(function(){e._rejectDfd(b,"FeatureLayerStatistics.getPredominantCategories: error when counting features in each predominant category.")})}else this._rejectDfd(b,"FeatureLayerStatistics.getPredominantCategories: make sure the layer supports advanced SQL expressions and standardized queries.")},_predominantCategoryNameSQL:function(a){return{expression:this._calcMaxFieldSQL(a,{returnFieldName:!0,defaultValue:"'"+
this._noDominantCategoryField+"'"})}},_calcMaxFieldSQL:function(a,b){var c,d,e,f,g=[];if(b&&(c=b.resultValue,d=b.returnFieldName,e=b.defaultValue,f=b.integerFields),d&&e){var h=l.map(a,function(a){return a+" \x3c\x3d 0"});g.push("WHEN "+h.join(" AND ")+" THEN "+e)}return l.forEach(a,function(b){var e=[];l.forEach(a,function(a){b!==a&&e.push(b+" \x3e "+a)});g.push("WHEN "+e.join(" AND ")+" THEN "+(c||d&&"'"+b+"'"||(-1<l.indexOf(f,b)?"cast("+b+" as float)":b)))}),["CASE",g.join(" "),"ELSE "+(e||"0"),
"END"].join(" ")},_predominantFieldSorter:function(a){return function(b,c){var d=l.indexOf(a,b.value),e=l.indexOf(a,c.value);return d-e}},_predominanceExpressions:function(a){var b=a.params.fields,c=l.map(l.filter(this.layer.fields,function(a){return-1<l.indexOf(this._integerTypes,a.type)},this),function(a){return a.name}),d=this._sumOfFieldsSQL(b),c=this._strengthOfPredominanceSQL(b,c);a.dfd.resolve({predominantCategory:{valueExpression:this._predominantCategoryArcade(b)},size:{valueExpression:this._sumOfFieldsArcade(b),
statisticsQuery:d,histogramQuery:d},opacity:{valueExpression:this._strengthOfPredominanceArcade(b),statisticsQuery:c,histogramQuery:c}})},_calcMaxFieldInfo:function(a,b){a=l.map(a,function(a){return'"'+a+'"'});var c=["var fieldNames \x3d [ "+a.join(", ")+" ];","var numFields \x3d "+a.length+";","var maxValueField \x3d null;","var maxValue \x3d -Infinity;","var value, i, totalValue \x3d null;","for(i \x3d 0; i \x3c numFields; i++) {","value \x3d $feature[fieldNames[i]];","if(value \x3e 0) {","if(value \x3e maxValue) {",
"maxValue \x3d value;","maxValueField \x3d fieldNames[i];","}","else if (value \x3d\x3d maxValue) {","maxValueField \x3d null;","}","}"];return b&&c.push("if(value !\x3d null \x26\x26 value \x3e\x3d 0) {","if (totalValue \x3d\x3d null) { totalValue \x3d 0; }","totalValue \x3d totalValue + value;","}"),c.push("}"),c},_predominantCategoryArcade:function(a){a=this._calcMaxFieldInfo(a);return a.push("return maxValueField;"),a.join("\n")},_sumOfFieldsArcade:function(a){a=l.map(a,function(a){return'"'+
a+'"'});return["var fieldNames \x3d [ "+a.join(", ")+" ];","var numFields \x3d "+a.length+";","var value, i, totalValue \x3d null;\nfor(i \x3d 0; i \x3c numFields; i++) {\nvalue \x3d $feature[fieldNames[i]];\nif(value !\x3d null \x26\x26 value \x3e\x3d 0) {\nif (totalValue \x3d\x3d null) { totalValue \x3d 0; }\ntotalValue \x3d totalValue + value;\n}\n}\nreturn totalValue;"].join("\n")},_strengthOfPredominanceArcade:function(a){a=this._calcMaxFieldInfo(a,!0);return a.push("var strength \x3d null;",
"if (maxValueField !\x3d null \x26\x26 totalValue \x3e 0) {","strength \x3d (maxValue / totalValue) * 100;","}","return strength;"),a.join("\n")},_calcSumOfFieldsSQL:function(a){return a.join(" + ")},_ensurePositiveFields:function(a){return"("+l.map(a,function(a){return a+" \x3e\x3d 0"}).join(" OR ")+")"},_sumOfFieldsSQL:function(a){return{sqlExpression:"("+this._calcSumOfFieldsSQL(a)+")",sqlWhere:this._ensurePositiveFields(a)}},_strengthOfPredominanceSQL:function(a,b){return{sqlExpression:"((("+
this._calcMaxFieldSQL(a,{integerFields:b})+") / ("+this._calcSumOfFieldsSQL(a)+")) * 100)",sqlWhere:this._ensurePositiveFields(a)+" AND (("+this._calcSumOfFieldsSQL(a)+") \x3e 0)"}},_calcBinsSQL:function(a,b){var c=[],d=b.length;return l.forEach(b,function(b,f){c.push("WHEN ("+[a+" \x3e\x3d "+b[0],a+(f===d-1?" \x3c\x3d ":" \x3c ")+b[1]].join(" AND ")+") THEN "+(f+1))}),["CASE",c.join(" "),"ELSE 0 END"].join(" ")},_rejectDfd:function(a,b){a.reject(Error(b))},_rejectNonNumeric:function(a,b,c){var d;
return b?(b.name===this.layer.objectIdField||-1===l.indexOf(this._numericTypes,b.type))&&(this._rejectDfd(a,"FeatureLayerStatistics."+c+": 'field' should be numeric."),d=!0):(this._rejectDfd(a,"FeatureLayerStatistics."+c+": unknown 'field'."),d=!0),d},_getAttributeVal:function(a,b){var c,d;if(b=b.toLowerCase(),a)for(d in a)if(d.toLowerCase()===b){c=a[d];break}return c},_getCustomExprVal:function(a,b){var c,d;if(b=b.toLowerCase(),a)for(d in a)if(d.toLowerCase()!==b){c=a[d];break}return c},_callAfterLoad:function(a,
b){this.layer.loaded?a.call(this,b):G.once(this.layer,"load",r.hitch(this,a,b))},_numericTypes:["esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"],_integerTypes:["esriFieldTypeInteger","esriFieldTypeSmallInteger"],_createGRTask:function(){this._grTask=new N(this.layer,{source:this.layer.source,gdbVersion:this.layer.gdbVersion})}});return r.mixin(y,{add:function(a,b){if(!a.statisticsPlugin){var c=b||{};c.layer=a;a.statisticsPlugin=new y(c)}},remove:function(a){a.statisticsPlugin&&
(a.statisticsPlugin.destroy(),delete a.statisticsPlugin)}}),K("extend-esri")&&r.setObject("plugins.FeatureLayerStatistics",y,M),y});