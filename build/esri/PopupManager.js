//>>built
define("esri/PopupManager","./geometry/Extent ./geometry/ScreenPoint ./kernel ./layerUtils ./tasks/query dijit/registry dojo/_base/array dojo/_base/declare dojo/_base/Deferred dojo/_base/lang dojo/has dojo/on dojo/promise/all dojo/Stateful require".split(" "),function(F,y,G,E,H,I,f,u,w,x,J,K,L,M,N){var z;u=u(M,{declaredClass:"esri.PopupManager",enabled:!1,map:null,_mapClickHandle:null,_featureLayersCache:{},constructor:function(){this._mapClickHandler=x.hitch(this,this._mapClickHandler)},setMap:function(a){if(this.map){if(a===
this.map)return;this.unsetMap()}this.map=a;this._setupClickHandler()},unsetMap:function(){this.map&&(this.map=null);this._mapClickHandle&&(this._mapClickHandle.remove(),this._mapClickHandle=null)},getMapLayer:function(a){var c;if(a&&(c=a.getLayer())&&(a=c.id,this._featureLayersCache[a])){var b=a.lastIndexOf("_");-1<b&&(a=a.substring(0,b),c=this.map.getLayer(a))}return c},_enabledSetter:function(a){this.enabled=a;this._setupClickHandler()},_setupClickHandler:function(){this._mapClickHandle&&(this._mapClickHandle.remove(),
this._mapClickHandle=null);this.enabled&&this.map&&(this._mapClickHandle=this.map.on("click",this._mapClickHandler))},_mapClickHandler:function(a){var c=this.map.infoWindow,b=a.graphic;c&&this.map.loaded&&(c.clearFeatures&&c.setFeatures?this._showPopup(a):b&&b.getInfoTemplate()&&this._showInfoWindow(b,a.mapPoint))},_showPopup:function(a){var c=this.map,b=c.infoWindow,d=this,n=[],g=[c.graphics].concat(f.map(c.graphicsLayerIds,c.getLayer,c));f.forEach(g,function(a){a&&a.loaded&&a.infoTemplate&&!a.suspended&&
n.push(a)});var p=[];f.forEach(c.layerIds,function(a){(a=c.getLayer(a))&&a.loaded&&!a.suspended&&(d._isImageServiceLayer(a)&&a.infoTemplate?n.push(a):"esri.layers.ArcGISDynamicMapServiceLayer"!==a.declaredClass&&"esri.layers.ArcGISTiledMapServiceLayer"!==a.declaredClass||!a.infoTemplates||p.push(a))});this._getSubLayerFeatureLayers(p).then(function(g){n=n.concat(g);g=null;if(a.graphic&&a.graphic.getInfoTemplate()&&!d._isImageServiceLayer(a.graphic._layer)&&(g=a.graphic),n.length||g){var k=d._calculateClickTolerance(n),
t=a.screenPoint,e=c.toMap(new y(t.x-k,t.y+k)),k=c.toMap(new y(t.x+k,t.y-k)),l=new F(e.x,e.y,k.x,k.y,c.spatialReference);if(l=l.intersects(c.extent)){var m=new H,q=!!g,p=!0,e=f.map(n,function(b){var e;if(m.timeExtent=b.useMapTime?c.timeExtent:null,d._isImageServiceLayer(b))m.geometry=a.mapPoint,p=!1,e=b.queryVisibleRasters(m,{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),e.addCallback(function(){var a=b.getVisibleRasters();return q=q||0<a.length,a});else if(d._featureLayersCache[b.id]||
"function"==typeof b.queryFeatures&&(0===b.currentMode||1===b.currentMode))m.geometry=l,e=b.queryFeatures(m),e.addCallback(function(a){a=a.features;return q=q||0<a.length,a});else{e=new w;var g=f.filter(b.graphics,function(a){return a&&a.visible&&l.intersects(a.geometry)});q=q||0<g.length;e.resolve(g)}return e});g&&(k=new w,k.resolve([g]),e.unshift(k));if(!f.some(e,function(a){return!a.isFulfilled()})&&!q)return b.hide(),void b.clearFeatures();b.setFeatures(e);b.show(a.mapPoint,{closestFirst:p})}}})},
_getSubLayerFeatureLayers:function(a,c){var b=c||new w,d=[],n=a.length,g=Math.floor(this.map.extent.getWidth()/this.map.width),p=this.map.getScale(),u=!1,k=this,t=0;a:for(;n>t;t++){var e=a[t],l=e.dynamicLayerInfos||e.layerInfos;if(l){var m=null;e._params&&(e._params.layers||e._params.dynamicLayers)&&(m=e.visibleLayers);for(var m=E._getVisibleLayers(l,m),q=E._getLayersForScale(p,l),y=l.length,B=0;y>B;B++){var A=l[B],r=A.id,v=e.infoTemplates[r];if(!A.subLayerIds&&v&&v.infoTemplate&&-1<f.indexOf(m,r)&&
-1<f.indexOf(q,r)){if(!z){u=!0;break a}var C=e.id+"_"+r,h=this._featureLayersCache[C];h&&h.loadError||(h||((h=v.layerUrl)||(h=A.source?this._getLayerUrl(e.url,"/dynamicLayer"):this._getLayerUrl(e.url,r)),h=new z(h,{id:C,drawMode:!1,mode:z.MODE_SELECTION,outFields:this._getOutFields(v.infoTemplate),resourceInfo:v.resourceInfo,source:A.source}),this._featureLayersCache[C]=h),h.setDefinitionExpression(e.layerDefinitions&&e.layerDefinitions[r]),h.setGDBVersion(e.gdbVersion),h.setInfoTemplate(v.infoTemplate),
h.setMaxAllowableOffset(g),h.setUseMapTime(!!e.useMapTime),e.layerDrawingOptions&&e.layerDrawingOptions[r]&&e.layerDrawingOptions[r].renderer&&h.setRenderer(e.layerDrawingOptions[r].renderer),d.push(h))}}}}if(u){var x=new w;N(["./layers/FeatureLayer"],function(a){z=a;x.resolve()});x.then(function(){k._getSubLayerFeatureLayers(a,b)})}else{var D=[];f.forEach(d,function(a){if(!a.loaded){var b=new w;K.once(a,"load, error",function(){b.resolve()});D.push(b.promise)}});D.length?L(D).then(function(){d=f.filter(d,
function(a){return!a.loadError&&a.isVisibleAtScale(p)});b.resolve(d)}):(d=f.filter(d,function(a){return a.isVisibleAtScale(p)}),b.resolve(d))}return b.promise},_getLayerUrl:function(a,c){var b=a.indexOf("?");return-1===b?a+"/"+c:a.substring(0,b)+"/"+c+a.substring(b)},_getOutFields:function(a){var c;return a.info&&"esri.dijit.PopupTemplate"===a.declaredClass?(c=[],f.forEach(a.info.fieldInfos,function(a){var d=a.fieldName&&a.fieldName.toLowerCase();d&&"shape"!==d&&0!==d.indexOf("relationships/")&&c.push(a.fieldName)})):
c=["*"],c},_calculateClickTolerance:function(a){var c,b,d=6;return f.forEach(a,function(a){(c=a.renderer)&&("esri.renderer.SimpleRenderer"===c.declaredClass?(b=c.symbol,b&&b.xoffset&&(d=Math.max(d,Math.abs(b.xoffset))),b&&b.yoffset&&(d=Math.max(d,Math.abs(b.yoffset)))):("esri.renderer.UniqueValueRenderer"===c.declaredClass||"esri.renderer.ClassBreaksRenderer"===c.declaredClass)&&f.forEach(c.infos,function(a){(b=a.symbol)&&b.xoffset&&(d=Math.max(d,Math.abs(b.xoffset)));b&&b.yoffset&&(d=Math.max(d,
Math.abs(b.yoffset)))}))}),d},_showInfoWindow:function(a,c){var b=this.map.infoWindow,d=a.geometry,d=d&&"point"===d.type?d:c,f=a.getContent();if(b.setTitle(a.getTitle()),f&&x.isString(f.id)){var g=I.byId(f.id);g&&g.set&&/_PopupRenderer/.test(g.declaredClass)&&g.set("showTitle",!1)}b.setContent(f);b.show(d)},_isImageServiceLayer:function(a){return"esri.layers.ArcGISImageServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass}});return J("extend-esri")&&(G.PopupManager=
u),u});