//>>built
define("esri/arcgis/utils","require dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/Deferred dojo/_base/json dojo/_base/url dojo/on dojo/DeferredList dojo/dom-construct dojo/sniff ../kernel ../config ../lang ../request ../SpatialReference ../map ../urlUtils ../geometry/ScreenPoint ../geometry/Extent ../geometry/webMercatorUtils ../symbols/jsonUtils ../renderers/jsonUtils ../dijit/PopupTemplate ../dijit/Popup ../tasks/query ../tasks/GeometryService ../layers/ArcGISTiledMapServiceLayer ../layers/FeatureLayer dojo/i18n!../nls/jsapi".split(" "),
function(J,n,h,u,r,K,xb,Ga,E,yb,Ha,I,L,k,A,C,zb,Ia,Ja,F,Ab,G,M,Ka,Bb,Cb,Db,Eb,v,ka){function H(a){return A({url:t.arcgisUrl+"/"+a.itemId+"/data",content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:!0,_preLookup:!0})}function la(a,e){var d={f:"json"};e&&(d.token=e);return A({url:a,content:d,callbackParamName:"callback"},{disableIdentityLookup:!0})}function ma(a){a.itemProperties.layerDefinition&&(a.layerDefinition?(a.layerDefinition.drawingInfo||(a.layerDefinition.drawingInfo=a.itemProperties.layerDefinition.drawingInfo),
k.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition.definitionExpression=a.itemProperties.layerDefinition.definitionExpression),k.isDefined(a.layerDefinition.minScale)||(a.layerDefinition.minScale=a.itemProperties.layerDefinition.minScale),k.isDefined(a.layerDefinition.maxScale)||(a.layerDefinition.maxScale=a.itemProperties.layerDefinition.maxScale)):a.layerDefinition=a.itemProperties.layerDefinition);!a.itemProperties.popupInfo||a.popupInfo||a.disablePopup||(a.popupInfo=a.itemProperties.popupInfo);
k.isDefined(a.itemProperties.showLabels)&&!k.isDefined(a.showLabels)&&(a.showLabels=a.itemProperties.showLabels);k.isDefined(a.itemProperties.showLegend)&&!k.isDefined(a.showLegend)&&(a.showLegend=a.itemProperties.showLegend);k.isDefined(a.itemProperties.refreshInterval)&&!k.isDefined(a.refreshInterval)&&(a.refreshInterval=a.itemProperties.refreshInterval)}function La(a){ma(a);a.itemProperties.layerDefinition&&a.layerDefinition&&(!k.isDefined(a.layerDefinition.maximumTrackPoints)&&k.isDefined(a.itemProperties.layerDefinition.maximumTrackPoints)&&
(a.layerDefinition.maximumTrackPoints=a.itemProperties.layerDefinition.maximumTrackPoints),!a.layerDefinition.definitionGeometry&&a.itemProperties.layerDefinition.definitionGeometry&&(a.layerDefinition.definitionGeometry=a.itemProperties.layerDefinition.definitionGeometry));a.itemProperties.purgeOptions&&!a.purgeOptions&&(a.purgeOptions=a.itemProperties.purgeOptions)}function N(a){var e=new r,d=a.itemData,c=[],b=[];if(h.forEach(d.operationalLayers,function(a){if(a.itemId&&!a.type){var d=a.url.toLowerCase();
-1<d.indexOf("/featureserver")||-1<d.indexOf("/mapserver/")?(b.push(a),c.push(H(a))):-1<d.indexOf("/mapserver")&&-1===d.indexOf("/mapserver/")&&(!a.layers||!k.isDefined(a.minScale)&&!k.isDefined(a.maxScale))?(b.push(a),c.push(H(a))):-1<d.indexOf("/imageserver")&&!k.isDefined(a.minScale)&&!k.isDefined(a.maxScale)?(b.push(a),c.push(H(a))):-1<d.indexOf("/streamserver")&&(b.push(a),c.push(H(a)))}}),d.baseMap&&d.baseMap.baseMapLayers&&h.forEach(d.baseMap.baseMapLayers,function(a){a.itemId&&"VectorTileLayer"!==
a.layerType&&(b.push(a),c.push(H(a)))}),0<c.length){var f={};(new E(c)).addCallback(function(d){h.forEach(b,function(a,c){var b=d[c][1];if(b&&!(b instanceof Error)&&(f[a.itemId]=b,!a.type)){var e=a.url.toLowerCase();(-1<e.indexOf("/featureserver")||-1<e.indexOf("/mapserver/"))&&b.layers?h.forEach(b.layers,function(b){var d="/featureserver/"+b.id;(d=e.match(d+"$")==d)||(d="/mapserver/"+b.id,d=e.match(d+"$")==d);d&&(a.itemProperties=b,ma(a))}):-1<e.indexOf("/streamserver")?(a.itemProperties=b,La(a)):
-1<e.indexOf("/mapserver")?(b.layers&&!a.layers&&(a.layers=b.layers),k.isDefined(b.minScale)&&!k.isDefined(a.minScale)&&(a.minScale=b.minScale),k.isDefined(b.maxScale)&&!k.isDefined(a.maxScale)&&(a.maxScale=b.maxScale),k.isDefined(b.refreshInterval)&&!k.isDefined(a.refreshInterval)&&(a.refreshInterval=b.refreshInterval),b.visibleLayers&&!a.visibleLayers&&(a.visibleLayers=b.visibleLayers)):-1<e.indexOf("/imageserver")&&(k.isDefined(b.minScale)&&!k.isDefined(a.minScale)&&(a.minScale=b.minScale),k.isDefined(b.maxScale)&&
!k.isDefined(a.maxScale)&&(a.maxScale=b.maxScale),k.isDefined(b.refreshInterval)&&!k.isDefined(a.refreshInterval)&&(a.refreshInterval=b.refreshInterval),!b.popupInfo||a.popupInfo||a.disablePopup||(a.popupInfo=b.popupInfo),b.renderingRule&&!a.renderingRule&&(a.renderingRule=b.renderingRule,b.renderingRule.functionName&&(a.renderingRule.rasterFunction=b.renderingRule.functionName)),b.bandIds&&!a.bandIds&&(a.bandIds=b.bandIds),b.mosaicRule&&!a.mosaicRule&&(a.mosaicRule=b.mosaicRule),b.format&&!a.format&&
(a.format=b.format),k.isDefined(b.compressionQuality)&&!k.isDefined(a.compressionQuality)&&(a.compressionQuality=b.compressionQuality),!b.layerDefinition||!b.layerDefinition.definitionExpression||k.isDefined(a.layerDefinition)&&k.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition=a.layerDefinition||{},a.layerDefinition.definitionExpression=b.layerDefinition.definitionExpression))}});a.relatedItemsData=f;e.callback(a)})}else e.callback(a);return e}function Fb(a,e){var d=new r,c=
a.itemData,b=c.baseMap.baseMapLayers[0];if("BingMapsAerial"===b.type||"BingMapsRoad"===b.type||"BingMapsHybrid"===b.type)if(b.portalUrl&&I.id)delete e.bingMapsKey,I.id.checkSignInStatus(Ia.urlToObject(t.arcgisUrl).path).then(n.hitch(null,function(a,d,c,e,f){la(b.portalUrl,f.token).then(n.hitch(null,na,a,d,c,e),n.hitch(null,O,a,d,c,e))},a,e,c,d),n.hitch(null,function(a,d,c,e){la(b.portalUrl).then(n.hitch(null,na,a,d,c,e),n.hitch(null,O,a,d,c,e))},a,e,c,d));else if(e.bingMapsKey){var f=new x({bingMapsKey:e.bingMapsKey,
mapStyle:x.MAP_STYLE_AERIAL});u.connect(f,"onLoad",n.hitch(this,function(){d.callback([a,e])}));u.connect(f,"onError",function(){delete e.bingMapsKey;a.itemData=P(c);b=a.itemData.baseMap.baseMapLayers[0];b.errors=[];b.errors.push({message:"The owner of the application has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});d.callback([a,e])})}else a.itemData=P(c),b=a.itemData.baseMap.baseMapLayers[0],b.errors=[],b.errors.push({message:"The owner of the application has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."}),
d.callback([a,e]);else d.callback([a,e]);return d}function Gb(a){var e,d,c=new r;a=a.itemData;var b=a.baseMap&&a.baseMap.baseMapLayers;if(Ha("ie")||oa&&!oa.supported())for(a=0;a<b.length;a++){var f=b[a];if(!f.isReference){"VectorTileLayer"===f.layerType&&(e=f.itemId,d=a);break}}return e?pa(e,!1).addBoth(function(a){var e=/^https?:\/\/basemaps(dev)?\.arcgis\.com\/arcgis\/rest\/services\/World_Basemap\/VectorTileServer/i;a&&a.item&&e.test(a.item.url)&&(b[d]={id:"FB_"+f.id,layerType:"ArcGISTiledMapServiceLayer",
opacity:"opacity"in f?f.opacity:1,visibility:"visibility"in f?f.visibility:!0,url:"http://services.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer"});c.resolve()}):c.resolve(),c}function na(a,e,d,c,b){b.bingKey?(e.bingMapsKey=b.bingKey,b=new x({bingMapsKey:e.bingMapsKey,mapStyle:x.MAP_STYLE_AERIAL}),u.connect(b,"onLoad",n.hitch(this,function(){c.callback([a,e])})),u.connect(b,"onError",function(){delete e.bingMapsKey;a.itemData=P(d);var b=a.itemData.baseMap.baseMapLayers[0];b.errors=
[];b.errors.push({message:"The owner of the map has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});c.callback([a,e])})):O(a,e,d,c)}function O(a,e,d,c){delete e.bingMapsKey;a.itemData=P(d);d=a.itemData.baseMap.baseMapLayers[0];d.errors=[];d.errors.push({message:"The owner of the map has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."});c.callback([a,e])}function P(a){return a.baseMap="BingMapsAerial"===a.baseMap.baseMapLayers[0].type?
{title:"Imagery",baseMapLayers:[{id:"World_Imagery_2017",visibility:!0,opacity:1,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}]}:"BingMapsRoad"===a.baseMap.baseMapLayers[0].type?{title:"Streets",baseMapLayers:[{id:"World_Street_Map_8421",opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"}]}:{title:"Imagery with Labels",baseMapLayers:[{id:"World_Imagery_6611",opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"},
{id:"World_Boundaries_and_Places_1145",isReference:!0,opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer"}]},a}function qa(a,e,d,c){var b=a.dynamicLayerInfos||a.layerInfos,f=e.layers;if(f&&b)if(c.usePopupManager){var g;h.forEach(b,function(a){var b=a.id;if(!a.subLayerIds)for(a=0;a<f.length;a++){var c=f[a];if(c.id===b&&c.popupInfo){g||(g={});g[b]={infoTemplate:new d(c.popupInfo),layerUrl:c.layerUrl};break}}});g&&a.setInfoTemplates(g)}else{var l=
[],m=[],w=[],p=[],q=[],D=[];h.forEach(b,function(b){var d=b.id;if(!b.subLayerIds&&-1!==h.indexOf(a.visibleLayers,d))for(b=0;b<f.length;b++){var c=f[b];if(c.id===d){m.push(d);l.push(c.popupInfo);w.push(c.layerUrl||"");p.push(c.layerDefinition&&c.layerDefinition.definitionExpression?c.layerDefinition.definitionExpression:"");q.push(k.isDefined(c.minScale)?c.minScale:null);D.push(k.isDefined(c.maxScale)?c.maxScale:null);break}}});l.length&&(a.__popups=l,a.__popupIds=m,a.__popupUrls=w,a.__popupWhereClauses=
p,a.__popupMinScales=q,a.__popupMaxScales=D,a.__resourceInfo=e.resourceInfo)}}function ra(a){if(!a)return!1;var e=(new xb(t.arcgisUrl)).authority;return-1!==a.indexOf(".arcgis.com/")||-1!==a.indexOf(e)}function Ma(a){return a?-1!==a.indexOf("/services.arcgisonline.com/")||-1!==a.indexOf("/server.arcgisonline.com/"):!1}function B(a){return"https:"===location.protocol&&(ra(a)||Ma(a))&&(a=a.replace("http:","https:")),a}function sa(a,e,d){var c,b=[];a.displayLevels||(b=h.map(a.resourceInfo.tileInfo.lods,
function(a){return a.level}));a.exclusionAreas&&(c=n.clone(a.exclusionAreas),c=h.map(c,function(a){return a.geometry=new F(a.geometry),a}));c=new Eb(B(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,displayLevels:a.displayLevels||b,id:a.id,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval,exclusionAreas:c});return d.ignorePopups||qa(c,a,e,d),c}function ta(a,e){if(!a||!e||0===e.length)return[];var d,c=","+e+",",b=[],f=",";for(d=0;d<a.length;d++)null!==
a[d].subLayerIds?(-1===c.indexOf(","+a[d].id+",")||-1<f.indexOf(","+a[d].id+","))&&(f+=a[d].subLayerIds.toString()+","):-1<c.indexOf(","+a[d].id+",")&&-1===f.indexOf(","+a[d].id+",")&&b.push(a[d].id);return b}function Na(a,e,d){var c=new Oa;c.format="png24";a.resourceInfo&&a.resourceInfo.supportedImageFormatTypes&&-1<a.resourceInfo.supportedImageFormatTypes.indexOf("PNG32")&&(c.format="png32");var c=new Pa(B(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageParameters:c,
minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval}),b=a.visibleLayers;if(!a.visibleLayers){var f="";h.forEach(c.layerInfos,function(a){a.defaultVisibility&&(f+=(0<f.length?",":"")+a.id)});b=f}if(a.layers&&0<a.layers.length){var g,l,m,w=[],p=[],q=[];h.forEach(a.layers,function(b){if(b.layerDefinition&&b.layerDefinition.definitionExpression&&(w[b.id]=b.layerDefinition.definitionExpression),b.layerDefinition&&b.layerDefinition.source){if(g=null,m=b.layerDefinition.source,"mapLayer"===
m.type){var d=h.filter(a.resourceInfo.layers,function(a){return a.id===m.mapLayerId});d.length&&(g=n.mixin(d[0],b))}else g=n.mixin({},b);if(g){if(g.source=m,delete g.popupInfo,g=new Qa(g),a.visibleLayers)d="string"==typeof a.visibleLayers?a.visibleLayers.split(","):a.visibleLayers,g.defaultVisibility=-1<h.indexOf(d,b.id)?!0:!1;p.push(g)}}b.layerDefinition&&b.layerDefinition.source&&b.layerDefinition.drawingInfo&&(l=new Ra(b.layerDefinition.drawingInfo),q[b.id]=l)},this);0<w.length&&c.setLayerDefinitions(w);
0<p.length?(c.setDynamicLayerInfos(p,!0),0<q.length&&c.setLayerDrawingOptions(q,!0)):(b=ta(c.layerInfos,b),c.setVisibleLayers(b))}else b=ta(c.layerInfos,b),c.setVisibleLayers(b);return d.ignorePopups||qa(c,a,e,d),c}function Hb(a,e,d){var c=new Sa;if(c.bandIds=a.bandIds,null!=a.format&&(c.format=a.format,null!=a.compressionQuality&&(c.compressionQuality=a.compressionQuality)),a.renderingRule&&a.renderingRule.rasterFunction){var b=new Ta(a.renderingRule);c.renderingRule=b}a.mosaicRule&&(b=new Ua(a.mosaicRule),
c.mosaicRule=b);k.isDefined(a.noData)&&(c.noData=a.noData);k.isDefined(a.noDataInterpretation)&&(c.noDataInterpretation=a.noDataInterpretation);k.isDefined(a.interpolation)&&(c.interpolation=a.interpolation);b=a.layerType?"ArcGISImageServiceVectorLayer"===a.layerType:!1;k.isDefined(a.layerType)||(b=a.resourceInfo.hasMultidimensions&&("esriImageServiceDataTypeVector-UV"===a.resourceInfo.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===a.resourceInfo.serviceDataType));c={resourceInfo:a.resourceInfo,
opacity:a.opacity,visible:a.visibility,id:a.id,imageServiceParameters:c,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval};if(c=b?new Va(B(a.url),c):new Wa(B(a.url),c),a.layerDefinition)a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(b=M.fromJson(a.layerDefinition.drawingInfo.renderer),c.setRenderer(b)),a.layerDefinition.definitionExpression&&c.setDefinitionExpression(a.layerDefinition.definitionExpression,!0);return!d.ignorePopups&&a.popupInfo&&c.setInfoTemplate(new e(a.popupInfo)),
c}function ua(a,e,d){var c=[102113,102100,3857],b=d||new C(e[0].layerObject.fullExtent.spatialReference),f=new C(a.resourceInfo.fullExtent.spatialReference);return b.wkt==f.wkt&&(b.wkid==f.wkid||k.isDefined(b.latestWkid)&&b.latestWkid==f.wkid||k.isDefined(f.latestWkid)&&b.wkid==f.latestWkid||k.isDefined(b.latestWkid)&&b.latestWkid==f.latestWkid)?!0:b.wkid&&f.wkid&&h.some(c,function(a){return a===f.wkid})&&h.some(c,function(a){return a===b.wkid})?!0:!1}function va(a,e,d){if(!e[0].layerObject.tileInfo)return!1;
a=a.resourceInfo.tileInfo;e=e[0].layerObject.tileInfo;d=d.width>d.height?d.width:d.height;for(var c=!1,b=!1,f=0;f<a.lods.length;f++){for(var g=a.lods[f].scale/a.dpi,l=0;l<e.lods.length;l++){var m=e.lods[l].scale/e.dpi;if(Math.abs(m-g)/m<1/d){if(c){b=!0;break}c=!0}}if(b)break}return b?!0:!c||1!==a.lods.length&&1!==e.lods.length?!1:!0}function Xa(a,e,d,c,b,f){var g,l=d._clazz;if("OpenStreetMap"===a.type)g=new Ya({id:a.id,opacity:a.opacity,visible:null!==a.visibility&&void 0!==a.visibility?a.visibility:
!0});else if("WMS"===a.type){var m=[],w=[];h.forEach(a.layers,function(a){w.push(new Za({name:a.name,title:a.title,legendURL:a.legendURL}));m.push(a.name)},this);a.visibleLayers&&(m=a.visibleLayers);c={extent:new F(a.extent[0][0],a.extent[0][1],a.extent[1][0],a.extent[1][1],new C({wkid:4326})),layerInfos:w,version:a.version,maxWidth:a.maxWidth,maxHeight:a.maxHeight,getMapURL:a.mapUrl,spatialReferences:a.spatialReferences,title:a.title,copyright:a.copyright,minScale:a.minScale||0,maxScale:a.maxScale||
0,format:a.format};g=new $a(a.url,{id:a.id,visibleLayers:m,format:"png",transparent:a.firstLayer?!1:!0,opacity:a.opacity,visible:null!==a.visibility?a.visibility:!0,resourceInfo:c,refreshInterval:a.refreshInterval});g.spatialReference.wkid=c.spatialReferences[0]}else if("KML"===a.type){if(d=a.url,I.id)if(l=I.id.findCredential(Ia.urlToObject(t.arcgisUrl).path)){var p=t.arcgisUrl.substring(t.arcgisUrl.indexOf("//")+2,t.arcgisUrl.indexOf("/",t.arcgisUrl.indexOf("//")+3)),q=p.split("."),q=q[q.length-
2]+"."+q[q.length-1],D=d.indexOf(q);-1<D&&(d="https://"+p+d.substring(D+q.length),d+="?token\x3d"+l.token)}g=new ab(d,{id:a.id,visible:null!==a.visibility?a.visibility:!0,outSR:c,refreshInterval:a.refreshInterval});u.connect(g,"onLoad",function(){(a.opacity||0===a.opacity)&&g.setOpacity(a.opacity);k.isDefined(a.minScale)&&k.isDefined(a.maxScale)&&g.setScaleRange(a.minScale,a.maxScale);a.visibleFolders&&h.forEach(g.folders,function(b){-1<h.indexOf(a.visibleFolders,b.id)?g.setFolderVisibility(b,!0):
g.setFolderVisibility(b,!1)},this)})}else if("WebTiledLayer"===a.type)g=new bb(a.templateUrl,{id:a.id,visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,copyright:a.copyright,fullExtent:a.fullExtent&&new F(a.fullExtent),initialExtent:a.fullExtent&&new F(a.fullExtent),subDomains:a.subDomains,tileInfo:a.tileInfo?new cb(a.tileInfo):null,refreshInterval:a.refreshInterval}),u.connect(g,"onLoad",function(){(k.isDefined(a.minScale)||k.isDefined(a.maxScale))&&g.setScaleRange(a.minScale,a.maxScale)});
else if("GeoRSS"===a.type)g=new db(a.url,{id:a.id,opacity:a.opacity,outSpatialReference:c,refreshInterval:a.refreshInterval}),u.connect(g,"onLoad",function(){!1===a.visibility&&g.hide();k.isDefined(a.minScale)&&k.isDefined(a.maxScale)&&g.setScaleRange(a.minScale,a.maxScale);var b=g.getFeatureLayers();h.forEach(b,function(d){a.pointSymbol&&"esriGeometryPoint"===d.geometryType?(d.renderer.symbol=G.fromJson(a.pointSymbol),1===b.length&&(g.pointSymbol=G.fromJson(a.pointSymbol))):a.lineSymbol&&"esriGeometryPolyline"===
d.geometryType?(d.renderer.symbol=G.fromJson(a.lineSymbol),1===b.length&&(g.polylineSymbol=G.fromJson(a.lineSymbol))):a.polygonSymbol&&"esriGeometryPolygon"===d.geometryType&&(d.renderer.symbol=G.fromJson(a.polygonSymbol),1===b.length&&(g.polygonSymbol=G.fromJson(a.polygonSymbol)))})});else if("CSV"==a.type&&a.url)c={layerDefinition:a.layerDefinition,columnDelimiter:a.columnDelimiter,id:a.id?a.id:null,visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,refreshInterval:a.refreshInterval},
a.locationInfo&&(c.latitudeFieldName=a.locationInfo.latitudeFieldName,c.longitudeFieldName=a.locationInfo.longitudeFieldName),d.ignorePopups||(c.infoTemplate=new Ka(a.popupInfo?a.popupInfo:eb.generateDefaultPopupInfo(a))),g=new fb(a.url,c);else if("VectorTileLayer"===a.layerType&&a.styleUrl)g=new gb(a.styleUrl,{id:a.id,minScale:a.minScale,maxScale:a.maxScale,opacity:a.opacity,visible:a.visibility});else if(a.layerDefinition&&!a.url)c=K.fromJson(K.toJson(a)),delete c.id,delete c.opacity,delete c.visibility,
g=new v(c,{id:a.id,opacity:a.opacity,visible:a.visibility,outFields:["*"],autoGeneralize:!0}),!d.ignorePopups&&c.popupInfo&&g.setInfoTemplate(new l(c.popupInfo)),hb(g);else if("BingMapsAerial"===a.type||"BingMapsRoad"===a.type||"BingMapsHybrid"===a.type)d.bingMapsKey?(c=x.MAP_STYLE_AERIAL_WITH_LABELS,"BingMapsAerial"===a.type?c=x.MAP_STYLE_AERIAL:"BingMapsRoad"===a.type&&(c=x.MAP_STYLE_ROAD),g=new x({bingMapsKey:d.bingMapsKey,mapStyle:c,opacity:a.opacity,id:a.id}),u.connect(g,"onError",n.hitch(this,
function(a){a.errors=a.errors||[];a.errors.push({message:"This application does not have a valid Bing Key for the Bing layer that is included in this map. [type:"+a.type+"]"})},a))):(a.errors=a.errors||[],a.errors.push({message:"This application does not provide a Bing Key for the Bing layer that is included in this map. [type:"+a.type+"]"}));else if(a.resourceInfo&&a.resourceInfo.mapName)g=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||ua(a,e,c)&&va(a,b,f))?sa(a,l,d):Na(a,l,d);else if(a.resourceInfo&&
a.resourceInfo.pixelSizeX)g=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||ua(a,e,c)&&va(a,b,f))?sa(a,l,d):Hb(a,l,d);else if(a.resourceInfo&&"Feature Layer"===a.resourceInfo.type){if(a.capabilities&&(a.resourceInfo.capabilities=a.capabilities),g=new v(B(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,mode:ra(a.url)?v.MODE_AUTO:k.isDefined(a.mode)?a.mode:v.MODE_ONDEMAND,editable:!1===d.editable?!1:void 0,outFields:["*"],autoGeneralize:!0,refreshInterval:a.refreshInterval}),
!d.ignorePopups&&a.popupInfo&&g.setInfoTemplate(new l(a.popupInfo)),a.layerDefinition)a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(c=M.fromJson(a.layerDefinition.drawingInfo.renderer),c.isMaxInclusive=!0,g.setRenderer(c)),a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.labelingInfo&&(c=h.map(a.layerDefinition.drawingInfo.labelingInfo,function(a){return new ib(a)}),g.setLabelingInfo(c)),a.layerDefinition.definitionExpression&&g.setDefinitionExpression(a.layerDefinition.definitionExpression),
k.isDefined(a.layerDefinition.minScale)&&g.setMinScale(a.layerDefinition.minScale),k.isDefined(a.layerDefinition.maxScale)&&g.setMaxScale(a.layerDefinition.maxScale);hb(g)}else a.resourceInfo&&a.resourceInfo.streamUrls&&(c={resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id},a.layerDefinition&&(q=a.layerDefinition.drawingInfo,a.layerDefinition.definitionGeometry&&(p=p||{},p.geometry=a.layerDefinition.definitionGeometry),k.isDefined(a.layerDefinition.definitionExpression)&&
(p=p||{},p.where=a.layerDefinition.definitionExpression),k.isDefined(a.layerDefinition.maximumTrackPoints)&&(c.maximumTrackPoints=a.layerDefinition.maximumTrackPoints)),p&&(c.filter=p),a.purgeOptions&&(c.purgeOptions=a.purgeOptions),g=new jb(B(a.url),c),q&&q.renderer&&(D=q.renderer,g.setRenderer(M.fromJson(D))),!d.ignorePopups&&a.popupInfo&&g.setInfoTemplate(new l(a.popupInfo)),a.layerDefinition&&(k.isDefined(a.layerDefinition.minScale)&&g.setMinScale(a.layerDefinition.minScale),k.isDefined(a.layerDefinition.maxScale)&&
g.setMaxScale(a.layerDefinition.maxScale)),Ga.once(g,"error",function(){a.errors.push({message:"Error loading stream layer. Check websocket url"})}));return g&&(g.arcgisProps={title:a.title},a.baseMapLayer&&(a.isReference?(g.attr("data-reference",!0),g._basemapGalleryLayerType="reference"):g._basemapGalleryLayerType="basemap")),g}function wa(a,e,d,c,b){h.forEach(a,function(f){f.layerObject=Xa(f,a,e,d,c,b)});var f=h.filter(a,function(a){return!a.isReference}),g=h.filter(a,function(a){return!!a.isReference});
return a=f.concat(g)}function xa(a){var e=null;a=a[0];return a.url&&!a.type?a.resourceInfo.spatialReference&&(e=new C,a.resourceInfo.spatialReference.wkid&&(e.wkid=a.resourceInfo.spatialReference.wkid),a.resourceInfo.spatialReference.wkt&&(e.wkt=a.resourceInfo.spatialReference.wkt)):a.type&&(-1<a.type.indexOf("BingMaps")||"OpenStreetMap"==a.type?e=new C({wkid:102100}):"WMS"==a.type&&(e=new C({wkid:a.spatialReferences[0]}))),e}function kb(a,e,d,c,b,f,g,l){return h.forEach(e,function(b){b.url&&!b.type&&
(b.resourceInfo=a[b.deferredsPos][1],delete b.deferredsPos)}),f=f||xa(e),e=wa(e,d,f,g,l),b.callback(e),b}function hb(a){!window.CanvasRenderingContext2D&&a.renderer&&"esri.renderer.HeatmapRenderer"===a.renderer.declaredClass&&a.setRenderer(M.fromJson({type:"simple",symbol:{color:[77,77,77,255],size:6,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,255,255],width:.75,type:"esriSLS",style:"esriSLSSolid"}}}))}function lb(a,e){var d=B(a);return A({url:d,content:{f:"json"},
callbackParamName:"callback",error:function(a,b){a.message?a.message+=" [url:"+d+"]":a.message="[url:"+d+"]";e.push(a);L.defaults.io.errorHandler(a,b)}})}function mb(a){var e=t.arcgisUrl+"/"+a.itemId+"/data";return A({url:e,content:{f:"json"},callbackParamName:"callback",error:function(d,c){d.message?d.message+=" [url:"+e+"]":d.message="[url:"+e+"]";a.errors=a.errors||[];a.errors.push(d);L.defaults.io.errorHandler(d,c)}})}function nb(a,e,d){var c=new r;return d.featureCollection&&d.featureCollection.layers||
d.layers?(d.layers&&(d.featureCollection={layers:d.layers},delete d.layers,k.isDefined(d.showLegend)&&(d.featureCollection.showLegend=d.showLegend,delete d.showLegend)),ob(a,d.featureCollection,e).then(function(b){d.featureCollection=b;a.featureCollection&&a.featureCollection.layers?h.forEach(d.featureCollection.layers,function(b,d){var c=a.featureCollection.layers[d];c.poupInfo||c.layerDefinition?c.layerDefinition?(k.isDefined(c.layerDefinition.minScale)&&k.isDefined(c.layerDefinition.maxScale)&&
(c.layerDefinition.minScale!==b.layerDefinition.minScale||c.layerDefinition.maxScale!==b.layerDefinition.maxScale)&&(delete b.layerDefinition.minscale,delete b.layerDefinition.maxScale),c.layerDefinition.drawingInfo&&K.toJson(c.layerDefinition.drawingInfo)!==K.toJson(b.layerDefinition.drawingInfo)&&delete b.layerDefinition.drawingInfo,c.layerDefinition.showLegend!==b.layerDefinition.showLegend&&delete b.layerDefinition.showLegend,c.layerDefinition=n.mixin(c.layerDefinition,b.layerDefinition)):c.layerDefinition=
b.layerDefinition:(c.popupInfo=b.popupInfo,c.layerDefinition=b.layerDefinition);c.featureSet=b.featureSet;c.nextObjectId=b.nextObjectId}):(a.featureCollection=a.featureCollection||{},a.featureCollection=n.mixin(a.featureCollection,d.featureCollection));c.callback(a)}),c):(console.log("Invalid Feature Collection item data [item id: "+a.itemId+"]: ",d),a.errors=a.errors||[],a.errors.push({message:"Invalid Feature Collection item data. [item id: "+a.itemId+"]"}),c.errback(),c)}function ob(a,e,d){var c=
new r;return J(["./csv"],function(b){var f=[];h.forEach(e.layers,function(a){a.featureSet&&a.featureSet.features&&a.featureSet.features.length&&a.featureSet.features[0].geometry&&a.featureSet.features[0].geometry.spatialReference&&(a.deferredsPos=f.length,f.push(b.projectFeatureCollection(a,d,a.featureSet.features[0].geometry.spatialReference)))});(new E(f)).addCallback(function(){h.forEach(e.layers,function(b){k.isDefined(b.deferredsPos)&&(f[b.deferredsPos].results&&f[b.deferredsPos].results.length?
b=f[b.deferredsPos].results[0]:(console.log("Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+"]"),b.errors=b.errors||[],b.errors.push({message:"Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+"]"})),delete b.deferredsPos)});c.callback(e)})}),c}function Q(a,e,d,c,b){var f,g=new r,l=new r,m=[];return h.forEach(a.operationalLayers,function(a){a.itemId&&"Feature Collection"==a.type&&m.push(mb(a).then(n.hitch(null,nb,a,d)))}),0===m.length?pb(a,
e,d,c,l,b):(f=new E(m),f.addCallback(function(){pb(a,e,d,c,l,b)})),l.then(function(a){if(m=[],h.forEach(a,function(a){if(a=a.layerObject,a instanceof v&&!a.loaded&&!a.loadError){var b=new r;Ga.once(a,"load, error",function(){b.callback(a)});m.push(b)}}),m.length){var b=new r;return f=new E(m),f.addCallback(function(){b.callback(a)}),b.promise}return a}).then(function(a){var b=[];h.forEach(a,function(a){if(a.layerObject instanceof v){var d=a.layerObject;d.loaded&&d.labelingInfo&&(a.showLabels||d._collection)&&
b.push(d)}});b.length?J(["../layers/LabelLayer"],function(d){var c=new d;h.forEach(b,function(a){c.addFeatureLayer(a)});a.push({layerObject:c});g.callback(a)}):g.callback(a)}),g}function pb(a,e,d,c,b,f){var g=[],l=[],m=[];(h.forEach(a.operationalLayers,function(a,b){if(a.featureCollection&&a.featureCollection.layers){var d=a.featureCollection.layers.length;h.forEach(a.featureCollection.layers,function(c,e){var f=!0;a.visibleLayers&&-1==h.indexOf(a.visibleLayers,e)&&(f=!1);c.visibility=a.visibility&&
f;c.opacity=a.opacity;c.id=(a.id||"operational"+b)+"_"+e;a.title&&(c.title=1!==d&&c.layerDefinition.name&&a.title!==c.layerDefinition.name?a.title+" - "+c.layerDefinition.name:a.title);m.push(c)},this)}else m.push(a)}),h.forEach(a.baseMap.baseMapLayers,function(a,b){a.baseMapLayer=!0;a.id=a.id||"base"+b;g.push(a)}),h.forEach(m,function(a,b){a.id=a.id||"operational"+b;g.push(a)}),h.forEach(g,function(a){a.url&&!a.type&&(a.deferredsPos=l.length,a.errors=a.errors||[],l.push(lb(a.url,a.errors)))}),0===
l.length)?(d=d||xa(g),g=wa(g,e,d,c,f),b.callback(g)):(new E(l)).addCallback(function(a){kb(a,g,e,l,b,d,c,f)});return b}function R(a,e,d,c){var b=a.minScale,f=a.maxScale;if(10.1>=d.version&&e)for(a=e.length-1;0<=a;a--){if(e[a].id==c){if(0==b&&0<e[a].minScale?b=e[a].minScale:0<b&&0==e[a].minScale?b=d.minScale:0<b&&0<e[a].minScale&&(b=Math.min(b,e[a].minScale)),f=Math.max(d.maxScale||0,e[a].maxScale||0),d.setScaleRange(b,f),!(-1<e[a].parentLayerId))break;c=e[a].parentLayerId}}else 10.1<d.version&&(h.forEach(a.layerInfos,
function(a){a.id==c&&(0==b&&0<a.minScale?b=a.minScale:0<b&&0==a.minScale||0<b&&0<a.minScale&&(b=Math.min(b,a.minScale)),f=Math.max(f||0,a.maxScale||0))}),d.setScaleRange(b,f))}function S(a,e,d,c){var b=a.url,f=a.__popupIds,g=a.__popupUrls,l=a.__popupWhereClauses,m=a.__popupMinScales,w=a.__popupMaxScales,p=a.__resourceInfo,q=[];if(h.forEach(a.__popups,function(c,n){if(c){var y,t=[];if(h.forEach(c.fieldInfos,function(a){"shape"!==a.fieldName.toLowerCase()&&t.push(a.fieldName)}),a.dynamicLayerInfos&&
0<a.dynamicLayerInfos.length){var r=h.filter(a.dynamicLayerInfos,function(a){return f[n]==a.id})[0].source;y=new v(b+"/dynamicLayer",{id:a.id+"_"+f[n],source:r,outFields:t,mode:v.MODE_SELECTION,infoTemplate:c&&new d(c),drawMode:!1,visible:a.visible,autoGeneralize:!0});var x=function(b,c){if(0<l[b].length&&c.setDefinitionExpression(l[b]),k.isDefined(m[b])||k.isDefined(w[b]))if(k.isDefined(a.minScale)||k.isDefined(a.maxScale)){var d=a.minScale,g=a.maxScale;0==d&&0<m[b]?d=m[b]:0<d&&0==m[b]||0<d&&0<m[b]&&
(d=Math.min(d,m[b]));g=Math.max(g||0,w[b]||0);c.setScaleRange(d,g)}else c.setScaleRange(m[b],w[b]);else R(a,e||p.layers,c,f[b])};y.loaded?x(n,y):u.connect(y,"onLoad",function(){x(n,y)})}else{var z=null,A=b+"/"+f[n];if(g[n].length)A=g[n];else if(e)for(r=0;r<e.length;r++)if(e[r].id===f[n]){z=e[r];break}y=new v(B(A),{id:a.id+"_"+f[n],outFields:t,mode:v.MODE_SELECTION,infoTemplate:c&&new d(c),drawMode:!1,visible:a.visible,resourceInfo:z,autoGeneralize:!0});y.loaded?(0<l[n].length&&y.setDefinitionExpression(l[n]),
R(a,e||p.layers,y,f[n])):u.connect(y,"onLoad",function(b){0<l[n].length&&y.setDefinitionExpression(l[n]);R(a,e||p.layers,b,f[n])})}q.push(y)}}),0<q.length)u.connect(a,"onVisibilityChange",n.hitch(this,function(a,b){h.forEach(a,function(a){b?a.show():a.hide()})},q)),u.connect(c,"onLayerRemove",n.hitch(this,function(a,b,d){a.id===d.id&&h.forEach(b,function(a){c.removeLayer(a)})},a,q));return delete a.__popups,delete a.__popupIds,delete a.__popupUrls,delete a.__popupWhereClauses,delete a.__popupMinScales,
delete a.__popupMaxScales,delete a.__resourceInfo,q}function qb(a){return A({url:B(a.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}})}function rb(a,e,d){var c=[];h.forEach(a,function(a){var b=a.__popups;b&&1<b.length&&10<=a.version&&(a.__deferredsPos=c.length,c.push(qb(a)))});var b=[];0<c.length?(new E(c)).addCallback(function(c){h.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(a.__deferredsPos||0===a.__deferredsPos?(b=b.concat(S(a,c[a.__deferredsPos][1].layers,
d,e)),delete a.__deferredsPos):b=b.concat(S(a,null,d,e)))});e.addLayers(b)}):(h.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(b=b.concat(S(a,null,d,e)))}),e.addLayers(b))}function sb(a){h.forEach(a,function(a){var d=a.layer;d.toJson&&(a=d.toJson(),a.featureSet&&d.name&&-1<d.name.indexOf("Text")&&h.forEach(a.featureSet.features,function(a,b){if(a.attributes.TEXT){var e=d.graphics[b];e.symbol.setText(a.attributes.TEXT);a.symbol.horizontalAlignment&&(e.symbol.align=a.symbol.horizontalAlignment);
e.setSymbol(e.symbol);e.setAttributes(a.attributes)}},this))})}function tb(a){var e=6;return h.forEach(a,function(a){if(a=a.renderer)"esri.renderer.SimpleRenderer"===a.declaredClass?((a=a.symbol)&&a.xoffset&&(e=Math.max(e,Math.abs(a.xoffset))),a&&a.yoffset&&(e=Math.max(e,Math.abs(a.yoffset)))):"esri.renderer.UniqueValueRenderer"!==a.declaredClass&&"esri.renderer.ClassBreaksRenderer"!==a.declaredClass||h.forEach(a.infos,function(a){(a=a.symbol)&&a.xoffset&&(e=Math.max(e,Math.abs(a.xoffset)));a&&a.yoffset&&
(e=Math.max(e,Math.abs(a.yoffset)))})}),e}function ya(a){var e=this,d=e.infoWindow,c=a.graphic;if(e.loaded){d.hide();d.clearFeatures();var b=[];if(h.forEach(e.graphicsLayerIds,function(a){(a=e.getLayer(a))&&a instanceof v&&a.loaded&&a.visible&&(a.clearSelection(),a.infoTemplate&&!a.suspended&&b.push(a))}),h.forEach(e.layerIds,function(a){(a=e.getLayer(a))&&-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")&&a.loaded&&a.visible&&a.infoTemplate&&b.push(a)}),c=c&&c.getInfoTemplate()?c:null,b.length||
c){var f=tb(b),g=a.screenPoint,l=e.toMap(new Ja(g.x-f,g.y+f)),f=e.toMap(new Ja(g.x+f,g.y-f)),l=new F(l.x,l.y,f.x,f.y,e.spatialReference),m=new Cb;m.geometry=l;m.timeExtent=e.timeExtent;var k=!0,l=h.map(b,function(b){var d;-1!==b.declaredClass.indexOf("ArcGISImageServiceLayer")?(m.geometry=a.mapPoint,k=!1,d=b.queryVisibleRasters(m,{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),d.addCallback(function(){return b.getVisibleRasters()})):(d=b.selectFeatures(m),d.addCallback(function(){return b.getSelectedFeatures()}));
return d});c&&(f=new r,f.callback([c]),l.splice(0,0,f));if(!h.some(l,function(a){return-1===a.fired})){var p=c?1:0;if(h.forEach(b,function(a){p+=-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?a.getVisibleRasters().length:a.getSelectedFeatures().length}),!p)return}d.setFeatures(l);d.show(a.mapPoint,{closestFirst:k})}}}function Ib(a,e){var d,c=e.mapOptions||{};c.infoWindow||(d=new Bb({visibleWhenEmpty:!1},yb.create("div")),c.infoWindow=d);k.isDefined(c.showInfoWindowOnClick)||e.usePopupManager||
(c.showInfoWindowOnClick=!1);d=new zb(a,c);return u.connect(d,"onLayersAddResult",sb),d}function z(a,e,d,c,b,f){var g,l,m,k;c.map?(g=c.map,l=c.clickEventHandle,m=c.clickEventListener,k=c.errors):(g=Ib(c,b),b.ignorePopups||b.disableClickBehavior||b.usePopupManager||(l=u.connect(g,"onClick",ya),m=ya));g.addLayers(a);b.ignorePopups||b.usePopupManager||rb(a,g,b._clazz);var p=k||[];h.forEach(e,function(a){a.errors&&(p=p.concat(a.errors))},this);g.loaded?f.callback({map:g,itemInfo:d,errors:p,clickEventHandle:l,
clickEventListener:m}):u.connect(g,"onLoad",function(){f.callback({map:g,itemInfo:d,errors:p,clickEventHandle:l,clickEventListener:m})})}function T(a,e,d,c,b){var f=[];if(h.forEach(b,function(a){n.isArray(a.layerObject)?h.forEach(a.layerObject,function(a){f.push(a)}):f.push(a.layerObject)}),"BingMapsAerial"===b[0].type||"BingMapsRoad"===b[0].type||"BingMapsHybrid"===b[0].type)var g=setInterval(function(){if(b[0].layerObject&&b[0].layerObject.loaded)clearInterval(g),ub(a,e,d,c,b,f);else if(b[0].errors){clearInterval(g);
var m="";b[0].errors&&b[0].errors.length&&(m=" ("+b[0].errors[0].message+")");c.errback(Error(ka.arcgis.utils.baseLayerError+m))}},10);else if(!f[0]&&b[0].baseMapLayer){var l="";b[0].errors&&b[0].errors.length&&(l=" ("+b[0].errors[0].message+")");c.errback(Error(ka.arcgis.utils.baseLayerError+l))}else ub(a,e,d,c,b,f)}function ub(a,e,d,c,b,f){try{var g=d.mapOptions||{};d.mapOptions=g;var l=a.item;if(f=h.filter(f,k.isDefined),l)if(l.extent&&l.extent.length)if(g.extent)z(f,b,a,e,d,c);else{var m=new F(l.extent[0][0],
l.extent[0][1],l.extent[1][0],l.extent[1][1],new C({wkid:4326})),n=f[0].spatialReference;4326===n.wkid?(g.extent=m,z(f,b,a,e,d,c)):102100===n.wkid||102113===n.wkid||3857===n.wkid?(m.xmin=Math.max(m.xmin,-180),m.xmax=Math.min(m.xmax,180),m.ymin=Math.max(m.ymin,-89.99),m.ymax=Math.min(m.ymax,89.99),g.extent=Ab.geographicToWebMercator(m),z(f,b,a,e,d,c)):d.geometryServiceURL||L.defaults.geometryService?(d.geometryServiceURL?new Db(d.geometryServiceURL):L.defaults.geometryService).project([m],n,function(m){m=
m[0];g.extent=g.extent||m;z(f,b,a,e,d,c)},function(){z(f,b,a,e,d,c)}):c.errback(Error(ka.arcgis.utils.geometryServiceError))}else z(f,b,a,e,d,c);else z(f,b,a,e,d,c)}catch(p){c.errback(p)}}function Jb(a){var e=[];return h.forEach(a.operationalLayers,function(a){a.featureCollection?e.push({featureCollection:a.featureCollection,visibility:a.visibility,title:a.title}):a.layerObject&&e.push({layer:a.layerObject,visibility:a.visibility,title:a.title})}),e}function vb(a){var e=[];a=a.baseMap.baseMapLayers.concat(a.operationalLayers);
return h.forEach(a,function(a){var c={};if(a.featureCollection&&"CSV"!==a.type)!0===a.featureCollection.showLegend&&h.forEach(a.featureCollection.layers,function(b){if(!1!==b.showLegend){var f=b.layerObject.renderer;c={layer:b.layerObject,title:a.title,defaultSymbol:f&&f.defaultSymbol&&f.defaultLabel?!0:!1};1<a.featureCollection.layers.length&&(c.title+=" - "+b.layerDefinition.name);e.push(c)}});else if(a.baseMapLayer&&!0===a.showLegend&&a.layerObject||!a.baseMapLayer&&!1!==a.showLegend&&a.layerObject&&
!(a.layerObject instanceof v&&a.layerObject.mode===v.MODE_SELECTION)){var b=a.layerObject.renderer,f=a.layerObject.declaredClass,b=!b||b&&b.defaultSymbol&&b.defaultLabel?!0:!1;if((10.1>a.layerObject.version&&("esri.layers.ArcGISDynamicMapServiceLayer"===f||"esri.layers.ArcGISTiledMapServiceLayer"===f)||"esri.layers.ArcGISImageServiceLayer"===f)&&(b=!0),c={layer:a.layerObject,title:a.title,defaultSymbol:b},a.layers)f=h.map(h.filter(a.layers,function(a){return!1===a.showLegend}),function(a){return a.id}),
f.length&&(c.hideLayers=f);e.push(c)}}),e}function Kb(a){function e(a,b){h.forEach(a,function(a,c){switch(a){case U:Pa=b[c];break;case V:Wa=b[c];break;case W:Va=b[c];break;case za:eb=b[c];break;case X:fb=b[c];break;case Aa:Qa=b[c];break;case Y:db=b[c];break;case Ba:Oa=b[c];break;case Z:Sa=b[c];break;case aa:ab=b[c];break;case ba:ib=b[c];break;case Ca:Ra=b[c];break;case ca:Ua=b[c];break;case da:Ya=b[c];break;case ea:Ta=b[c];break;case fa:jb=b[c];break;case Da:cb=b[c];break;case Ea:oa=b[c];break;case ga:gb=
b[c];break;case ha:x=b[c];break;case ia:bb=b[c];break;case ja:$a=b[c];break;case Fa:Za=b[c]}})}var d=new r;a=a.itemData;var c=[];a.baseMap&&a.baseMap.baseMapLayers&&(c=c.concat(a.baseMap.baseMapLayers));a.operationalLayers&&(c=c.concat(a.operationalLayers));a=h.map(c,function(a){return a&&a.layerType});for(var b=[],f=[],c=!1,g=0;g<a.length;g++){switch(a[g]){case "ArcGISFeatureLayer":-1===h.indexOf(b,ba)&&b.push(ba);break;case "ArcGISImageServiceLayer":case "ArcGISTiledImageServiceLayer":-1===h.indexOf(b,
V)&&(b.push(V),f.push(Z),f.push(ca),f.push(ea));break;case "ArcGISImageServiceVectorLayer":-1===h.indexOf(b,W)&&(b.push(W),f.push(Z),f.push(ca),f.push(ea));break;case "ArcGISMapServiceLayer":case "ArcGISTiledMapServiceLayer":-1===h.indexOf(b,U)&&(b.push(U),f.push(Aa),f.push(Ba),f.push(Ca));break;case "ArcGISStreamLayer":-1===h.indexOf(b,fa)&&b.push(fa);break;case "BingMapsAerial":case "BingMapsHybrid":case "BingMapsRoad":-1===h.indexOf(b,ha)&&b.push(ha);break;case "CSV":-1===h.indexOf(b,X)&&(b.push(X),
f.push(za));break;case "GeoRSS":-1===h.indexOf(b,Y)&&b.push(Y);break;case "KML":-1===h.indexOf(b,aa)&&b.push(aa);break;case "OpenStreetMap":-1===h.indexOf(b,da)&&b.push(da);break;case "VectorTileLayer":-1===h.indexOf(b,ga)&&(b.push(ga),Ha("ie")||f.push(Ea));break;case "WebTiledLayer":-1===h.indexOf(b,ia)&&(b.push(ia),f.push(Da));break;case "WMS":-1===h.indexOf(b,ja)&&(b.push(ja),f.push(Fa));break;default:c=!0}if(c)break}return c&&(b=Lb,f=Mb),b.length?J(b,function(){e(b,arguments);f.length?J(f,function(){e(f,
arguments);d.resolve()}):d.resolve()}):d.resolve(),d}function wb(a,e,d,c){var b=c.itemData;b.baseMap&&b.baseMap.baseMapLayers&&b.baseMap.baseMapLayers.length&&(b.baseMap.baseMapLayers[0].firstLayer=!0);var f=e.layerMixins,g=f&&f.length;if(g){var k=function(a){for(var b=0;g>b;b++){var c=f[b];if(c.mixin)if(c.hasOwnProperty("id")){if(a.id===c.id){n.mixin(a,c.mixin);break}}else if(a.url===c.url){n.mixin(a,c.mixin);break}}};h.forEach(b.baseMap&&b.baseMap.baseMapLayers,k);h.forEach(b.operationalLayers,
k)}Kb(c,e).then(function(){return Gb(c,e)}).then(function(){return Fb(c,e)}).then(function(b){var c=b[0],e=b[1];if(c.itemData.operationalLayers&&0!==c.itemData.operationalLayers.length){var f=new r,g=c.itemData.baseMap.baseMapLayers.slice(),k=h.filter(c.itemData.baseMap.baseMapLayers,function(a){return!a.isReference});b={item:c.item,itemData:{baseMap:{baseMapLayers:k}}};c.itemData.baseMap.baseMapLayers=h.filter(c.itemData.baseMap.baseMapLayers,function(a){return a.isReference});N(b,e).addCallback(function(b){Q(b.itemData,
e).addCallback(n.hitch(null,T,b,a,e,f))});f.then(function(a){N(c,e).addCallback(function(b){Q(b.itemData,e,a.map.spatialReference,k,a.map).addCallback(function(c){b.itemData.baseMap.baseMapLayers=g;T(b,a,e,d,c)})})},n.hitch(d,d.errback))}else N(c,e).addCallback(function(b){Q(b.itemData,e).addCallback(n.hitch(null,T,b,a,e,d))})})}function pa(a,e){"undefined"==typeof e&&(e=!0);t._arcgisUrl&&0<t._arcgisUrl.length&&(t.arcgisUrl=t._arcgisUrl);var d=t.arcgisUrl+"/"+a,c={},b=new r;return A({url:d,content:{f:"json"},
callbackParamName:"callback",load:function(a){return c.item=a,e?void A({url:d+"/data",content:{f:"json"},callbackParamName:"callback",load:function(a){c.itemData=a;b.callback(c)},error:function(a){b.errback(a)}}):void b.callback(c)},error:function(a){b.errback(a)}}),b}var t,Pa,Wa,Va,eb,fb,Qa,db,Oa,Sa,ab,ib,Ra,Ua,Ya,Ta,jb,cb,oa,gb,x,bb,$a,Za,U="../layers/ArcGISDynamicMapServiceLayer",V="../layers/ArcGISImageServiceLayer",W="../layers/ArcGISImageServiceVectorLayer",za="./csv",X="../layers/CSVLayer",
Aa="../layers/DynamicLayerInfo",Y="../layers/GeoRSSLayer",Ba="../layers/ImageParameters",Z="../layers/ImageServiceParameters",aa="../layers/KMLLayer",ba="../layers/LabelClass",Ca="../layers/LayerDrawingOptions",ca="../layers/MosaicRule",da="../layers/OpenStreetMapLayer",ea="../layers/RasterFunction",fa="../layers/StreamLayer",Da="../layers/TileInfo",Ea="../layers/vector-tile",ga="../layers/VectorTileLayer",ha="../virtualearth/VETiledLayer",ia="../layers/WebTiledLayer",ja="../layers/WMSLayer",Fa="../layers/WMSLayerInfo",
Lb=[U,V,W,X,Y,aa,ba,da,fa,ga,ha,ia,ja],Mb=[za,Aa,Ba,Z,Ca,ca,ea,Da,Ea,Fa];return t={arcgisUrl:location.protocol+"//www.arcgis.com/sharing/rest/content/items",getItem:pa,createMap:function(a,e,d){var c=new r;d=d||{};var b=d.infoTemplateClass;return d._clazz=b&&(n.isObject(b)?b:n.getObject(b))||Ka,n.isString(a)?pa(a).addCallback(n.hitch(null,wb,e,d,c)).addErrback(n.hitch(c,c.errback)):wb(e,d,c,a),c},getLayerList:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?Jb(a.itemInfo.itemData):[]},getLegendLayers:function(a){return a&&
a.itemInfo&&a.itemInfo.itemData?vb(a.itemInfo.itemData):[]},_arcgisUrl:null,_getItemProps:N,_getItemData:H,_getBingKey:la,_portalUrlResponse:na,_portalUrlFailure:O,_processFSItemProperties:ma,_processSSItemProperties:La,_getLayers:Q,_preBuildLayerObjects:kb,_buildLayerObjects:wa,_preCreateMap:T,_getMapSR:xa,_createMap:z,_addSelectionLayers:rb,_createSelectionFeatureLayers:S,_getServiceInfo:lb,_getFeatureCollectionItem:mb,_mergeFeatureCollectionItem:nb,_projectFeatureCollection:ob,_getLayersInfo:qb,
_initLayer:Xa,_loadAsCached:sa,_loadAsDynamic:Na,_processPopups:qa,_onLayersAddResult:sb,_sameSpatialReferenceAsBasemap:ua,_sameTilingSchemeAsBasemap:va,_showPopup:ya,_calculateClickTolerance:tb,_getVisibleFeatureLayers:ta,_updateLayerScaleInfo:R,_checkUrl:B,_isHostedService:ra,_isAgolService:Ma,_getLegendLayers:vb},n.setObject("arcgis.utils",t,I),t});