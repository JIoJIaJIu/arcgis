//>>built
define("esri/arcgis/csv","dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/sniff dojo/number dojox/data/CsvStore ../kernel ../config ../request ../SpatialReference ../geometry/jsonUtils ../geometry/webMercatorUtils".split(" "),function(k,c,B,C,O,P,Q,D,R,t,E,F){function G(a){var b=0,d="";return c.forEach([","," ",";","|","\t"],function(c){var g=a.split(c).length;g>b&&(b=g,d=c)}),d}function H(a,b){if(!a||"[object Date]"!==Object.prototype.toString.call(a)||isNaN(a.getTime()))return!1;var d=
!0;if(C("chrome")&&/\d+\W*$/.test(b)){var c=b.match(/[a-zA-Z]{2,}/);if(c){for(var d=!1,g=0,h=c.length,w=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i;!d&&h>=g&&!(d=!w.test(c[g]));)g++;d=!d}}return d}function I(a,b,d){var f=a.indexOf("\n"),f=k.trim(a.substr(0,f)),g=b.columnDelimiter;g||(g=G(f));var h=new P({data:a,separator:g});return h.fetch({onComplete:function(a){var g=0,
e={layerDefinition:b.layerDefinition,featureSet:{features:[],geometryType:"esriGeometryPoint"}},f=e.layerDefinition.objectIdField,u=e.layerDefinition.fields;f||c.some(u,function(a){return"esriFieldTypeOID"===a.type?(f=a.name,!0):!1})||(u.push({name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1}),f="__OBJECTID");var m,n,q=h._attributes,t=[],v=[];if(c.forEach(u,function(a){"esriFieldTypeDate"===a.type?t.push(a.name):("esriFieldTypeDouble"===a.type||"esriFieldTypeInteger"===a.type)&&
v.push(a.name)}),b.locationInfo&&"coordinates"===b.locationInfo.locationType?(m=b.locationInfo.latitudeFieldName,n=b.locationInfo.longitudeFieldName):c.forEach(q,function(a){var e;e=c.indexOf(J,a.toLowerCase());-1!==e&&(m=a);e=c.indexOf(K,a.toLowerCase());-1!==e&&(n=a)}),!m||!n)return setTimeout(function(){console.error("File does not seem to contain fields with point coordinates.")},1),void(d&&d(null,Error("File does not seem to contain fields with point coordinates.")));-1===c.indexOf(v,m)&&v.push(m);
-1===c.indexOf(v,n)&&v.push(n);var r;k.isArray(b.outFields)&&-1===c.indexOf(b.outFields,"*")&&(r=b.outFields);c.forEach(q,function(a){c.some(u,function(e){return a===e.name})||u.push({name:a,alias:a,type:a===m||a===n?"esriFieldTypeDouble":"esriFieldTypeString"})});var q=0,z=a.length;for(q;z>q;q++){var x=a[q],y=h.getAttributes(x),p={};c.forEach(y,function(a){if(a&&(a===m||a===n||!r||-1<c.indexOf(r,a))){var e=a;if(0===a.length&&c.forEach(u,function(e,b){e.name==="attribute_"+(b-1)&&(a="attribute_"+
(b-1))}),-1<c.indexOf(t,a)){var e=h.getValue(x,e),b=new Date(e);p[a]=H(b,e)?b.getTime():null}else-1<c.indexOf(v,a)?(b=O.parse(h.getValue(x,e)),a!==m&&a!==n||!(isNaN(b)||181<Math.abs(b))?p[a]=isNaN(b)?null:b:(b=parseFloat(h.getValue(x,e)),p[a]=isNaN(b)?null:b)):p[a]=h.getValue(x,e)}});p[f]=g;g++;var y=p[m],A=p[n];null==A||null==y||isNaN(y)||isNaN(A)||(r&&-1===c.indexOf(r,m)&&delete p[m],r&&-1===c.indexOf(r,n)&&delete p[n],e.featureSet.features.push({geometry:{x:A,y:y,spatialReference:{wkid:4326}},
attributes:p}))}e.layerDefinition.name="csv";d&&d(e)},onError:function(a){console.error("Error fetching items from CSV store: ",a);d&&d(null,a)}}),!0}function z(a,b,d,f,g,h){0===a.length&&g(null);var w=E.getGeometryType(b),l=[];c.forEach(a,function(a){a=new w(a);a.spatialReference=d;l.push(a)},this);b=[102113,102100,3857];d.wkid&&4326===d.wkid&&f.wkid&&-1<c.indexOf(b,f.wkid)?(c.forEach(l,function(a){a.xmin?(a.xmin=Math.max(a.xmin,-180),a.xmax=Math.min(a.xmax,180),a.ymin=Math.max(a.ymin,-89.99),a.ymax=
Math.min(a.ymax,89.99)):a.rings?c.forEach(a.rings,function(a){c.forEach(a,function(a){a[0]=Math.min(Math.max(a[0],-180),180);a[1]=Math.min(Math.max(a[1],-89.99),89.99)},this)},this):a.paths?c.forEach(a.paths,function(a){c.forEach(a,function(a){a[0]=Math.min(Math.max(a[0],-180),180);a[1]=Math.min(Math.max(a[1],-89.99),89.99)},this)},this):a.x&&(a.x=Math.min(Math.max(a.x,-180),180),a.y=Math.min(Math.max(a.y,-89.99),89.99))},this),a=[],c.forEach(l,function(b){b=F.geographicToWebMercator(b);102100!==
f.wkid&&(b.spatialReference=f);a.push(b.toJson())},this),g(a)):null!==d.wkid&&-1<c.indexOf(b,d.wkid)&&null!==f.wkid&&4326===f.wkid?(a=[],c.forEach(l,function(b){a.push(F.webMercatorToGeographic(b).toJson())},this),g(a)):(b=function(b,d){b&&b.length===a.length?(a=[],c.forEach(b,function(b){a.push(b&&(b.rings&&0<b.rings.length&&0<b.rings[0].length&&0<b.rings[0][0].length&&!isNaN(b.rings[0][0][0])&&!isNaN(b.rings[0][0][1])||b.paths&&0<b.paths.length&&0<b.paths[0].length&&0<b.paths[0][0].length&&!isNaN(b.paths[0][0][0])&&
!isNaN(b.paths[0][0][1])||b.xmin&&!isNaN(b.xmin)&&b.ymin&&!isNaN(b.ymin)||b.x&&!isNaN(b.x)&&b.y&&!isNaN(b.y))?b.toJson():null)},this),g(a)):h(b,d)},D.defaults.geometryService?D.defaults.geometryService.project(l,f,k.hitch(this,b),h):g(null))}function L(a,b){var d=[102113,102100,3857];return a&&b&&a.wkid===b.wkid&&a.wkt===b.wkt?!0:a&&b&&a.wkid&&b.wkid&&-1<c.indexOf(d,a.wkid)&&-1<c.indexOf(d,b.wkid)?!0:!1}function M(a,b,d,f){if(a.featureSet&&0!==a.featureSet.features.length){if(L(d,b))return void f(a);
var g,h=function(b){var d=[];c.forEach(a.featureSet.features,function(a,c){b[c]&&(a.geometry=b[c],d.push(a))},this);f(a)},w=function(){console.error("error projecting featureSet ("+a.layerDefinition.name+"). Final try.");f(a)},l=function(){console.error("error projecting featureSet ("+a.layerDefinition.name+"). Try one more time.");z(g,a.featureSet.geometryType,b,d,k.hitch(this,h),k.hitch(this,w))};a.featureSet.features&&0<a.featureSet.features.length?(g=[],c.forEach(a.featureSet.features,function(b){if(b.geometry.toJson)g.push(b.geometry);
else{var c=E.getGeometryType(a.featureSet.geometryType);g.push(new c(b.geometry))}}),b.toJson||(b=new t(b)),d.toJson||(d=new t(d)),z(g,a.featureSet.geometryType,b,d,k.hitch(this,h),k.hitch(this,l))):f(a)}}var J="lat latitude y ycenter latitude83 latdecdeg point-y lat_dd".split(" "),K="lon lng long longitude x xcenter longitude83 longdecdeg point-x long_dd".split(" "),N={latFieldStrings:J,longFieldStrings:K,buildCSVFeatureCollection:function(a){var b=new B,c=function(a,c){c?b.errback(c):b.callback(a)},
f={url:a.url,handleAs:"text",load:function(b){I(b,a,k.hitch(this,c))},error:function(a){b.errback(a);console.error("error: "+a)}};return-1<a.url.indexOf("arcgis.com")&&-1<a.url.indexOf("/content/items")&&-1<a.url.indexOf("/data")&&(f.headers={"Content-Type":""}),R(f,{usePost:!1}),b},projectFeatureCollection:function(a,b,c){var f=new B;return c||(c=new t({wkid:4326})),M(a,c,b,k.hitch(this,function(a){f.callback(a)})),f},generateDefaultPopupInfo:function(a){var b={esriFieldTypeDouble:1,esriFieldTypeSingle:1},
d={esriFieldTypeInteger:1,esriFieldTypeSmallInteger:1},f={esriFieldTypeDate:1},g=null;a=c.map(a.layerDefinition.fields,k.hitch(this,function(a){"NAME"===a.name.toUpperCase()&&(g=a.name);var c="esriFieldTypeOID"!==a.type&&"esriFieldTypeGlobalID"!==a.type&&"esriFieldTypeGeometry"!==a.type,l=null;if(c){var e=a.name.toLowerCase();(-1<",stretched value,fnode_,tnode_,lpoly_,rpoly_,poly_,subclass,subclass_,rings_ok,rings_nok,".indexOf(","+e+",")||-1<e.indexOf("area")||-1<e.indexOf("length")||-1<e.indexOf("shape")||
-1<e.indexOf("perimeter")||-1<e.indexOf("objectid")||e.indexOf("_")===e.length-1||e.indexOf("_i")===e.length-2&&1<e.length)&&(c=!1);a.type in d?l={places:0,digitSeparator:!0}:a.type in b?l={places:2,digitSeparator:!0}:a.type in f&&(l={dateFormat:"shortDateShortTime"})}return k.mixin({},{fieldName:a.name,label:a.alias,isEditable:!0,tooltip:"",visible:c,format:l,stringFieldOption:"textbox"})}));return{title:g?"{"+g+"}":"",fieldInfos:a,description:null,showAttachments:!1,mediaInfos:[]}},_getSeparator:G,
_isValidDate:H,_processCsvData:I,_projectGeometries:z,_sameSpatialReference:L,_projectFeatureSet:M};return C("extend-esri")&&k.setObject("arcgis.csv",N,Q),N});