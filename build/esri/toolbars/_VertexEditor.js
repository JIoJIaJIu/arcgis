//>>built
define("esri/toolbars/_VertexEditor","dojo/_base/declare dojo/_base/lang dojo/_base/connect dojo/_base/array dojo/has dijit/Menu dijit/MenuItem ../kernel ./_VertexMover ../geometry/Point ../geometry/jsonUtils dojo/i18n!../nls/jsapi".split(" "),function(u,t,l,q,w,x,y,v,n,p,r,z){var k=u(null,{declaredClass:"esri.toolbars._GraphicVertexEditor",constructor:function(a,b,c){this.graphic=a;this.map=b;this.toolbar=c;a=c._options;this._symbol1=a.vertexSymbol;this._symbol2=a.ghostVertexSymbol;b=a.ghostLineSymbol;
this._lineStroke={style:b.style,width:b.width,color:b.color};this._canDel=a.allowDeleteVertices;this._canAdd=a.allowAddVertices;this._addControllers()},destroy:function(){this._removeControllers()},refresh:function(a){a?(this._removeControllers(),this._addControllers()):(this._refresh(this._vertexMovers),this._refresh(this._mpVertexMovers))},suspend:function(){this._suspended||this._removeControllers();this._suspended=!0},resume:function(){this._suspended&&this._addControllers();this._suspended=!1},
_addControllers:function(){this._firstMoveHandle=l.connect(n,"onFirstMove",this,this._firstMoveHandler);this._moveStopHandle=l.connect(n,"onMoveStop",this,this._moveStopHandler);this._vertexMovers=this._add(this._getSegments(this.graphic.geometry),this._symbol1);this._canAdd&&(this._mpVertexMovers=this._add(this._getMidpointSegments(this.graphic.geometry),this._symbol2,!0));var a=this._getGraphicsLayer();if(this._mouseOverHandle=l.connect(a,"onMouseOver",this,this._mouseOverHandler),this._mouseOutHandle=
l.connect(a,"onMouseOut",this,this._mouseOutHandler),this._canDel)this._ctxMenu=new x({style:"font-size: 12px; margin-left: 5px; margin-top: 5px;"}),a=this._ctxDelete=new y({label:z.toolbars.edit.deleteLabel,iconClass:"vertexDeleteIcon",style:"outline: none;"}),this._deleteHandle=l.connect(a,"onClick",this,this._deleteHandler),this._ctxMenu.addChild(a),this._ctxMenu.startup()},_removeControllers:function(){l.disconnect(this._firstMoveHandle);l.disconnect(this._moveStopHandle);l.disconnect(this._mouseOverHandle);
l.disconnect(this._mouseOutHandle);l.disconnect(this._deleteHandle);this._ctxMenu&&(this._ctxDelete=null,this._unbindCtxNode(),this._ctxMenu.destroyRecursive());this._remove(this._vertexMovers);this._remove(this._mpVertexMovers);this._vertexMovers=this._mpVertexMovers=null},_add:function(a,b,c){var d,e,f=this.graphic,g=[];for(d=0;d<a.length;d++){var h=a[d],m=[];for(e=0;e<h.length;e++)m.push(new n(h[e],b,f,d,e,h.length,this,c));g.push(m)}return g},_remove:function(a){a&&q.forEach(a,function(a){q.forEach(a,
function(a){a.destroy()})})},_refresh:function(a){a&&q.forEach(a,function(a){q.forEach(a,function(a){a.refresh()})})},_isNew:function(a){return-1===q.indexOf(this._vertexMovers[a.segIndex],a)?!0:!1},_getGraphicsLayer:function(){return this.toolbar._scratchGL},_deleteHandler:function(){var a=this._selectedMover;a.ptIndex;this._updateRelatedGraphic(a,a.relatedGraphic,a.graphic.geometry,a.segIndex,a.ptIndex,a.segLength,!1,!0);this._canAdd&&this._deleteMidpoints(a);this._deleteVertex(a);this.toolbar._endOperation("VERTICES")},
_mouseOverHandler:function(a){a=a.graphic;var b=this._findMover(a);b&&(this.toolbar.onVertexMouseOver(this.graphic,b._getInfo()),b._placeholder||(this._selectedMover=b,this._canDel&&this._bindCtxNode(a.getDojoShape().getNode())))},_mouseOutHandler:function(a){(a=this._findMover(a.graphic))&&this.toolbar.onVertexMouseOut(this.graphic,a._getInfo())},_bindCtxNode:function(a){this._unbindCtxNode();this._ctxDelete.set("disabled",this._selectedMover.segLength<=this.minLength?!0:!1);this._ctxMenu.bindDomNode(a);
this._bindNode=a},_unbindCtxNode:function(){var a=this._bindNode;a&&this._ctxMenu.unBindDomNode(a)},_findMover:function(a){var b,c=[];b=this._mpVertexMovers;q.forEach(this._vertexMovers,function(a){c=c.concat(a)});b&&q.forEach(b,function(a){c=c.concat(a)});for(b=0;b<c.length;b++){var d=c[b];if(d.graphic===a)return d}},_firstMoveHandler:function(a){!this._isNew(a)&&this._canAdd&&this._hideRelatedMidpoints(a);this.toolbar._beginOperation("VERTICES")},_moveStopHandler:function(a,b){var c=this._isNew(a);
return b&&(b.dx||b.dy)?(this._updateRelatedGraphic(a,a.relatedGraphic,a.graphic.geometry,a.segIndex,a.ptIndex,a.segLength,c),this._canAdd&&(c?this._addMidpoints(a):(this._repositionRelatedMidpoints(a),this._showRelatedMidpoints(a))),void this.toolbar._endOperation("VERTICES")):void(!c&&this._canAdd&&this._showRelatedMidpoints(a))},_showRelatedMidpoints:function(a){var b=this._getAdjacentMidpoints(a.ptIndex,a.segLength),c=this._mpVertexMovers[a.segIndex];for(a=0;a<b.length;a++){var d=c[b[a]];d.graphic.show();
d.refresh()}},_hideRelatedMidpoints:function(a){var b=this._getAdjacentMidpoints(a.ptIndex,a.segLength),c=this._mpVertexMovers[a.segIndex];for(a=0;a<b.length;a++)c[b[a]].graphic.hide()},_repositionRelatedMidpoints:function(a){var b,c=this._getAdjacentMidpoints(a.ptIndex,a.segLength),d=this._mpVertexMovers[a.segIndex];for(b=0;b<c.length;b++){var e=this._getAdjacentVertices(c[b],a.segLength),f=a.relatedGraphic.geometry.getPoint(a.segIndex,e[0]),e=a.relatedGraphic.geometry.getPoint(a.segIndex,e[1]),
f=new p({x:(f.x+e.x)/2,y:(f.y+e.y)/2,spatialReference:f.spatialReference.toJson()});d[c[b]].graphic.setGeometry(f)}},_addMidpoints:function(a){var b,c=a.segIndex,d=a.ptIndex,e=a.segLength,f=d+1,g=e+1;this._mpVertexMovers[c].splice(d,1);var h=this._vertexMovers[c];for(b=0;f>b;b++)h[b].segLength+=1;for(b=f;b<h.length;b++)h[b].ptIndex+=1,h[b].segLength+=1;a.ptIndex=f;a.segLength=h.length+1;h.splice(f,0,a);a.graphic.setSymbol(this._symbol1);h=this._mpVertexMovers[c];for(b=0;d>b;b++)h[b].segLength+=1;
for(b=d;e-1>b;b++)h[b].ptIndex+=1,h[b].segLength+=1;e=this._getAdjacentVertices(d,g);c=this._getAdjacentVertices(d+1,g);b=a.relatedGraphic.geometry.getPoint(a.segIndex,e[0]);f=a.relatedGraphic.geometry.getPoint(a.segIndex,e[1]);e=new p({x:(b.x+f.x)/2,y:(b.y+f.y)/2,spatialReference:b.spatialReference.toJson()});b=a.relatedGraphic.geometry.getPoint(a.segIndex,c[0]);f=a.relatedGraphic.geometry.getPoint(a.segIndex,c[1]);b=new p({x:(b.x+f.x)/2,y:(b.y+f.y)/2,spatialReference:b.spatialReference.toJson()});
c=new n(e,this._symbol2,this.graphic,a.segIndex,d,g,this,!0);a=new n(b,this._symbol2,this.graphic,a.segIndex,d+1,g,this,!0);h.splice(d,0,c,a)},_deleteVertex:function(a){var b,c=a.ptIndex,d=this._vertexMovers[a.segIndex];for(b=0;c>b;b++)--d[b].segLength;for(b=c+1;b<d.length;b++){var e=d[b];--e.ptIndex;--e.segLength}d.splice(c,1);b=a._getInfo();a.destroy();this.toolbar.onVertexDelete(this.graphic,b)}});return t.mixin(k,{create:function(a,b,c){switch(a.geometry.type){case "multipoint":return new k.MultipointVertexEditor(a,
b,c);case "polyline":return new k.PolylineVertexEditor(a,b,c);case "polygon":return new k.PolygonVertexEditor(a,b,c)}}}),k.MultipointVertexEditor=u(k,{declaredClass:"esri.toolbars._MultipointVertexEditor",minLength:1,constructor:function(){this._moveStartHandle=l.connect(n,"onMoveStart",this,this._moveStartHandler);l.disconnect(this._firstMoveHandle)},destroy:function(){this.inherited(arguments);l.disconnect(this._moveStartHandle)},_getSegments:function(a){var b=a.points,c=[],d=a.spatialReference;
for(a=0;a<b.length;a++){var e=b[a];c.push(new p({x:e[0],y:e[1],spatialReference:d.toJson()}))}return[c]},_getMidpointSegments:function(){return[]},_getControlPoints:function(){return[]},_getGraphicsLayer:function(){return this.graphic._graphicsLayer},_mouseOverHandler:function(a){var b=a.graphic;(a=this._findMover(a))&&(this.toolbar.onVertexMouseOver(b,a._getInfo()),this._selectedMover=a,this._canDel&&this._bindCtxNode(a.graphic.getDojoShape().getNode()))},_mouseOutHandler:function(a){var b=a.graphic;
(a=this._findMover(a))&&this.toolbar.onVertexMouseOut(b,a._getInfo())},_findMover:function(a){var b=[].concat(this._vertexMovers[0]),c=a.target;for(a=0;a<b.length;a++){var d=b[a];if(d.graphic.getDojoShape().getNode()===c)return d}},_moveStartHandler:function(a){var b=a.ptIndex,c=a.segLength-1,d=a.relatedGraphic.geometry.points;a=d.splice(b,1);d.push(a[0]);d=this._vertexMovers[0];for(a=c;a>b;a--)--d[a].ptIndex;a=d.splice(b,1);d.push(a[0]);a[0].ptIndex=c},_moveStopHandler:function(a){this._updateRelatedGraphic(a,
a.relatedGraphic,a.graphic.geometry,a.segIndex,a.ptIndex,a.segLength);this.toolbar._endOperation("VERTICES")},_updateRelatedGraphic:function(a,b,c,d,e,f,g,h){a=b.geometry;h?a.removePoint(e):a.setPoint(e,c);b.setGeometry(a)},_deleteMidpoints:function(){}}),k.PolylineVertexEditor=u(k,{declaredClass:"esri.toolbars._PolylineVertexEditor",minLength:2,_getSegments:function(a){var b,c,d=a.paths,e=[];for(b=0;b<d.length;b++){var f=d[b],g=[];for(c=0;c<f.length;c++)g.push(a.getPoint(b,c));e.push(g)}return e},
_getMidpointSegments:function(a){var b,c,d=a.paths,e=[],f=a.spatialReference;for(b=0;b<d.length;b++){var g=d[b],h=[];for(c=0;c<g.length-1;c++){var m=a.getPoint(b,c),k=a.getPoint(b,c+1),m=new p({x:(m.x+k.x)/2,y:(m.y+k.y)/2,spatialReference:f.toJson()});h.push(m)}e.push(h)}return e},_getControlPoints:function(a,b,c,d,e){var f,g,h,m,k=this.map;return this._isNew(a)?(f=d,g=d+1,0<=f&&(h=k.toScreen(b.getPoint(c,f))),e>=g&&(m=k.toScreen(b.getPoint(c,g)))):(f=d-1,g=d+1,0<=f&&(h=k.toScreen(b.getPoint(c,f))),
e>g&&(m=k.toScreen(b.getPoint(c,g)))),[h,m]},_getAdjacentMidpoints:function(a,b){var c=[],d=a-1;0<=d&&c.push(d);return b-1>a&&c.push(a),c},_getAdjacentVertices:function(a){return[a,a+1]},_deleteMidpoints:function(a){var b,c=this._mpVertexMovers[a.segIndex],d=c.length-1,e=this._getAdjacentMidpoints(a.ptIndex,a.segLength).sort(),f=e[0];for(b=0;f>b;b++)--c[b].segLength;for(b=f+1;b<c.length;b++){var g=c[b];--g.ptIndex;--g.segLength}if(1===e.length)c.splice(f,1)[0].destroy();else for(g=this._getAdjacentVertices(f,
d),b=a.relatedGraphic.geometry.getPoint(a.segIndex,g[0]),g=a.relatedGraphic.geometry.getPoint(a.segIndex,g[1]),b=new p({x:(b.x+g.x)/2,y:(b.y+g.y)/2,spatialReference:b.spatialReference.toJson()}),a=new n(b,this._symbol2,this.graphic,a.segIndex,f,d,this,!0),c=c.splice(f,e.length,a),b=0;b<c.length;b++)c[b].destroy()},_updateRelatedGraphic:function(a,b,c,d,e,f,g,h){a=b.geometry;g?a.insertPoint(d,e+1,r.fromJson(c.toJson())):h?a.removePoint(d,e):a.setPoint(d,e,r.fromJson(c.toJson()));b.setGeometry(a)}}),
k.PolygonVertexEditor=u(k,{declaredClass:"esri.toolbars._PolygonVertexEditor",minLength:3,_getSegments:function(a){var b,c,d=a.rings,e=[];for(b=0;b<d.length;b++){var f=d[b],g=[];for(c=0;c<f.length-1;c++)g.push(a.getPoint(b,c));e.push(g)}return e},_getMidpointSegments:function(a){var b,c,d=a.rings,e=[],f=a.spatialReference;for(b=0;b<d.length;b++){var g=d[b],h=[];for(c=0;c<g.length-1;c++){var k=a.getPoint(b,c),l=a.getPoint(b,c+1),k=new p({x:(k.x+l.x)/2,y:(k.y+l.y)/2,spatialReference:f.toJson()});h.push(k)}e.push(h)}return e},
_getControlPoints:function(a,b,c,d,e){var f,g,h,k,l=this.map;return this._isNew(a)?(f=d,g=(d+1)%e):(f=d-1,f=0>f?(e+f)%e:f,g=(d+1)%e),h=l.toScreen(b.getPoint(c,f)),k=l.toScreen(b.getPoint(c,g)),[h,k]},_getAdjacentMidpoints:function(a,b){var c=a-1;return[0>c?(b+c)%b:c,a]},_getAdjacentVertices:function(a,b){return[a,(a+1)%b]},_deleteMidpoints:function(a){var b,c,d,e;c=a.ptIndex;var f=this._mpVertexMovers[a.segIndex],g=f.length-1;d=this._getAdjacentMidpoints(c,a.segLength).sort();e=d[0];var h=d[d.length-
1];if(0===c)for(b=this._getAdjacentVertices(g-1,g),c=a.relatedGraphic.geometry.getPoint(a.segIndex,b[0]),b=a.relatedGraphic.geometry.getPoint(a.segIndex,b[1]),c=new p({x:(c.x+b.x)/2,y:(c.y+b.y)/2,spatialReference:c.spatialReference.toJson()}),a=new n(c,this._symbol2,this.graphic,a.segIndex,g-1,g,this,!0),f.splice(h,1,a)[0].destroy(),f.splice(e,1)[0].destroy(),d=0;d<f.length-1;d++)e=f[d],--e.ptIndex,--e.segLength;else{b=this._getAdjacentVertices(e,g);c=a.relatedGraphic.geometry.getPoint(a.segIndex,
b[0]);b=a.relatedGraphic.geometry.getPoint(a.segIndex,b[1]);c=new p({x:(c.x+b.x)/2,y:(c.y+b.y)/2,spatialReference:c.spatialReference.toJson()});a=new n(c,this._symbol2,this.graphic,a.segIndex,e,g,this,!0);h=f.splice(e,d.length,a);for(d=0;d<h.length;d++)h[d].destroy();for(d=0;e>d;d++)--f[d].segLength;for(d=e+1;d<f.length;d++)e=f[d],--e.ptIndex,--e.segLength}},_updateRelatedGraphic:function(a,b,c,d,e,f,g,h){a=b.geometry;g?a.insertPoint(d,e+1,r.fromJson(c.toJson())):h?(a.removePoint(d,e),0===e&&a.setPoint(d,
f-1,r.fromJson(a.getPoint(d,0).toJson()))):(a.setPoint(d,e,r.fromJson(c.toJson())),0===e&&a.setPoint(d,f,r.fromJson(c.toJson())));b.setGeometry(a)}}),w("extend-esri")&&(t.setObject("toolbars._GraphicVertexEditor",k,v),t.setObject("toolbars._MultipointVertexEditor",k.MultipointVertexEditor,v),t.setObject("toolbars._PolylineVertexEditor",k.PolylineVertexEditor,v),t.setObject("toolbars._PolygonVertexEditor",k.PolygonVertexEditor,v)),k});