//>>built
define("esri/toolbars/_Box","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/Color dojo/has dojo/dom-style dojox/gfx/Moveable dojox/gfx/matrix ../kernel ../lang ../geometry/Point ../geometry/Polyline ../symbols/SimpleMarkerSymbol ../geometry/webMercatorUtils ../geometry/jsonUtils ../graphic".split(" "),function(p,l,h,q,C,v,w,x,m,y,z,r,A,D,t,B,u){p=p(null,{declaredClass:"esri.toolbars._Box",constructor:function(d,a,b,c,e,g,f){this._graphic=d;this._map=a;this._toolbar=
b;this._scale=c;this._rotate=e;this._defaultEventArgs={};this._scaleEvent="Scale";this._rotateEvent="Rotate";this._uniformScaling=g;d=b._options;this._markerSymbol=d.boxHandleSymbol;this._lineSymbol=d.boxLineSymbol;this._moveStartHandler=l.hitch(this,this._moveStartHandler);this._firstMoveHandler=l.hitch(this,this._firstMoveHandler);this._moveStopHandler=l.hitch(this,this._moveStopHandler);this._moveHandler=l.hitch(this,this._moveHandler);this._isTextPoint=f;this._init()},destroy:function(){this._cleanUp();
this._graphic=this._map=this._toolbar=this._markerSymbol=this._lineSymbol=null},refresh:function(){this._draw()},suspend:function(){h.forEach(this._getAllGraphics(),function(d){d.hide()})},resume:function(){h.forEach(this._getAllGraphics(),function(d){d.show()});this._draw()},_init:function(){this._draw()},_cleanUp:function(){this._connects&&h.forEach(this._connects,q.disconnect);var d=this._toolbar._scratchGL;this._anchors&&h.forEach(this._anchors,function(a){d.remove(a.graphic);(a=a.moveable)&&
a.destroy()});this._box&&d.remove(this._box);this._box=this._anchors=this._connects=null},_draw:function(){if(!this._graphic.getDojoShape())return void this._cleanUp();var d=this._map,a=this._toolbar._scratchGL,b=this._getBoxCoords(),c=new A(d.spatialReference),e=l.clone(h.filter(b,function(a,b){return 8!==b&&0===b%2}));e[0]&&e.push([e[0][0],e[0][1]]);c.addPath(e);this._rotate&&c.addPath([b[1],b[8]]);this._box?this._box.setGeometry(c):(this._box=new u(c,this._lineSymbol),a.add(this._box));this._anchors?
h.forEach(this._anchors,function(a,c){this._scale||(c=8);var e=new r(b[c],d.spatialReference);a.graphic.setGeometry(e);var e=a.moveable,h=a.graphic.getDojoShape();h&&(e?h!==e.shape&&(e.destroy(),a.moveable=this._getMoveable(a.graphic,c)):a.moveable=this._getMoveable(a.graphic,c))},this):(this._anchors=[],this._connects=[],h.forEach(b,function(b,c){if(this._scale||!(8>c)){b=new r(b,d.spatialReference);var e=new u(b,this._markerSymbol);this._isTextPoint&&1===c%2&&e.hide();a.add(e);this._anchors.push({graphic:e,
moveable:this._getMoveable(e,c)})}},this))},_getBoxCoords:function(d){var a,b,c,e,g=this._map,f=[];if(this._isTextPoint){a=this._graphic.getNode().getBoundingClientRect();var k=g.__container.getBoundingClientRect();a=[{x:a.left-k.left,y:a.top-k.top},{x:a.right-k.left,y:a.top-k.top},{x:a.right-k.left,y:a.bottom-k.top},{x:a.left-k.left,y:a.bottom-k.top}]}else a=this._getTransformedBoundingBox(this._graphic);if(h.forEach(a,function(a,k,h){b=a;(c=h[k+1])||(c=h[0]);e={x:(b.x+c.x)/2,y:(b.y+c.y)/2};d||(b=
g.toMap(b),e=g.toMap(e));f.push([b.x,b.y]);f.push([e.x,e.y])}),this._rotate)a=l.clone(f[1]),a=d?{x:a[0],y:a[1]}:g.toScreen({x:a[0],y:a[1],spatialReference:g.spatialReference}),a.y-=this._toolbar._options.rotateHandleOffset,d||(a=g.toMap(a)),f.push([a.x,a.y]);return f},_getTransformedBoundingBox:function(d){var a=this._map,b=d.geometry.getExtent(),c=d.geometry.spatialReference;d=new r(b.xmin,b.ymax,c);b=new r(b.xmax,b.ymin,c);return d=a.toScreen(d),b=a.toScreen(b),[{x:d.x,y:d.y},{x:b.x,y:d.y},{x:b.x,
y:b.y},{x:d.x,y:b.y}]},_getAllGraphics:function(){var d=[this._box];return this._anchors&&h.forEach(this._anchors,function(a){d.push(a.graphic)}),d=h.filter(d,z.isDefined)},_getMoveable:function(d,a){var b=d.getDojoShape();if(b){var c=new x(b);c._index=a;this._connects.push(q.connect(c,"onMoveStart",this._moveStartHandler));this._connects.push(q.connect(c,"onFirstMove",this._firstMoveHandler));this._connects.push(q.connect(c,"onMoveStop",this._moveStopHandler));c.onMove=this._moveHandler;b=b.getEventSource();
return b&&w.set(b,"cursor",this._toolbar._cursors["box"+a]),c}},_moveStartHandler:function(d){this._toolbar["on"+(8===d.host._index?this._rotateEvent:this._scaleEvent)+"Start"](this._graphic)},_firstMoveHandler:function(d){this._map.disableScrollWheelZoom();var a,b,c=d.host._index,e=this._wrapOffset=d.host.shape._wrapOffsets[0]||0,g=this._graphic.getLayer()._div.getTransform(),f=h.map(this._getBoxCoords(!0),function(a){return{x:a[0]+e,y:a[1]}});d=this._isTextPoint?this._map.toScreen(this._graphic.geometry):
{x:f[1].x,y:f[3].y};this._centerCoord=m.multiplyPoint(m.invert(g),d);8===c?(a=m.multiplyPoint(m.invert(g),f[1]),this._isTextPoint&&(this._centerCoord=this._deNormalizePoint(this._centerCoord,a)),this._startLine=[this._centerCoord,a],this._moveLine=l.clone(this._startLine)):(a=m.multiplyPoint(m.invert(g),f[c]),b=m.multiplyPoint(m.invert(g),f[(c+4)%8]),this._isTextPoint&&(this._centerCoord=this._deNormalizePoint(this._centerCoord,a)),this._firstMoverToAnchor=Math.sqrt((a.x-this._centerCoord.x)*(a.x-
this._centerCoord.x)+(a.y-this._centerCoord.y)*(a.y-this._centerCoord.y)),this._startBox=b,this._startBox.width=f[4].x-f[0].x,this._startBox.height=f[4].y-f[0].y,this._moveBox=l.clone(this._startBox),this._xfactor=a.x>b.x?1:-1,this._yfactor=a.y>b.y?1:-1,1===c||5===c?this._xfactor=0:(3===c||7===c)&&(this._yfactor=0));this._toolbar._beginOperation("BOX");this._toolbar["on"+(8===c?this._rotateEvent:this._scaleEvent)+"FirstMove"](this._graphic)},_moveHandler:function(d,a){var b,c,e,g,f,k,h,l,p,q=d.host._index,
n=this._defaultEventArgs;(n.angle=0,n.scaleX=1,n.scaleY=1,8===q)?(b=this._startLine,c=this._moveLine,e=c[1],e.x+=a.dx,e.y+=a.dy,c=this._getAngle(b,c),this._isTextPoint&&(c+=this._graphic.symbol.angle),e=m.rotategAt(c,b[0]),this._graphic.getDojoShape().setTransform(e),n.transform=e,n.angle=c,n.around=b[0]):((b=this._startBox,c=this._moveBox,c.width+=a.dx*this._xfactor,c.height+=a.dy*this._yfactor,this._uniformScaling||this._isTextPoint?(h=c.x+this._xfactor*c.width,l=c.y+this._yfactor*c.height,p=Math.sqrt((h-
this._centerCoord.x)*(h-this._centerCoord.x)+(l-this._centerCoord.y)*(l-this._centerCoord.y)),this._scaleRatio=g=f=p/this._firstMoverToAnchor,k=this._centerCoord):(g=c.width/b.width,f=c.height/b.height,k={x:b.x,y:b.y}),(isNaN(g)||1/0===g||g===-1/0)&&(g=1),(isNaN(f)||1/0===f||f===-1/0)&&(f=1),e=m.scaleAt(g,f,k),this._isTextPoint)?(b=m.rotategAt(this._graphic.symbol.angle,k),this._graphic.getDojoShape().setTransform([b,e])):this._graphic.getDojoShape().setTransform(e),n.transform=e,n.scaleX=g,n.scaleY=
f,n.around=k);this._toolbar["on"+(8===q?this._rotateEvent:this._scaleEvent)](this._graphic,n)},_moveStopHandler:function(d){this._map.enableScrollWheelZoom();var a,b=this._graphic,c=this._toolbar,e=c._geo?t.geographicToWebMercator(b.geometry):b.geometry,g=e.spatialReference,f=b.getDojoShape(),h=f.getTransform(),l=b.getLayer()._div.getTransform();this._isTextPoint?(a=this._graphic.symbol,8===d.host._index?a.angle+=this._getAngle(this._startLine,this._moveLine):a.font.setSize(Math.round(a.font.size*
this._scaleRatio*100)/100),this._graphic.setSymbol(a)):(e=e.toJson(),this._updateSegments(e.paths||e.rings,h,l,g),f.setTransform(null),e=B.fromJson(e),b.setGeometry(c._geo?t.webMercatorToGeographic(e,!0):e));this._draw();this._startLine=this._moveLine=this._startBox=this._moveBox=this._xfactor=this._yfactor=null;c._endOperation("BOX");this._defaultEventArgs.transform=h;c["on"+(8===d.host._index?this._rotateEvent:this._scaleEvent)+"Stop"](this._graphic,this._defaultEventArgs)},_updateSegments:function(d,
a,b,c){var e=this._map,g=this._wrapOffset||0;h.forEach(d,function(d){h.forEach(d,function(d){this._updatePoint(d,c,g,m,e,b,a)},this)},this)},_updatePoint:function(d,a,b,c,e,g,f){a=e.toScreen({x:d[0],y:d[1],spatialReference:a},!0);a.x+=b;a=c.multiplyPoint([g,f,c.invert(g)],a);a.x-=b;b=e.toMap(a);d[0]=b.x;d[1]=b.y},_getAngle:function(d,a){var b=180*Math.atan2(d[0].y-d[1].y,d[0].x-d[1].x)/Math.PI;return 180*Math.atan2(a[0].y-a[1].y,a[0].x-a[1].x)/Math.PI-b},_deNormalizePoint:function(d,a){var b=this._map._getFrameWidth();
if(-1===b)return d;for(var c={x:d.x,y:d.y};Math.abs(c.x-a.x)>=b;)c.x<a.x?c.x+=b:c.x-=b;var e=Math.abs(c.x-a.x);return Math.abs(c.x-a.x+b)<e?c.x+=b:Math.abs(c.x-a.x-b)<e&&(c.x-=b),c}});return v("extend-esri")&&l.setObject("toolbars._Box",p,y),p});