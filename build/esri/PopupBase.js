//>>built
define("esri/PopupBase","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/Color dojo/_base/Deferred dojo/has ./kernel ./graphic ./geometry/Point ./geometry/jsonUtils ./geometry/mathUtils ./geometry/webMercatorUtils ./symbols/SimpleMarkerSymbol ./symbols/SimpleLineSymbol ./symbols/CartographicLineSymbol ./symbols/SimpleFillSymbol ./tasks/query ./Evented require".split(" "),function(r,m,g,p,x,y,z,A,B,C,D,u,v,q,t,w,E,F){function G(a){return"sizeInfo"===a.type}r=r(F,{declaredClass:"esri.PopupBase",
_featureLayers:{},_updateEndHandles:[],_evtMap:{"set-features":!0,"clear-features":!0,"selection-change":!0,"dfd-complete":!0},onSetFeatures:function(){},onClearFeatures:function(){},onSelectionChange:function(){},onDfdComplete:function(){},initialize:function(){this.count=0;this.selectedIndex=-1;this.on("clear-features",m.hitch(this,this._resetUpdateEndListeners));this.on("dfd-complete",m.hitch(this,this._processFeatures));this.on("set-features",m.hitch(this,this._processFeatures))},cleanup:function(){this.features=
this.deferreds=null;this._resetUpdateEndListeners()},setFeatures:function(a){if(a&&a.length){this.clearFeatures();var b,c;a[0]instanceof x?c=a:b=a;b?this._updateFeatures(null,b):(this.deferreds=c,c=c.slice(0),g.forEach(c,function(a){a.addBoth(m.hitch(this,this._updateFeatures,a))},this))}},clearFeatures:function(){this.features=this.deferreds=this._marked=null;this.count=0;var a=this.selectedIndex;this.selectedIndex=-1;-1<a&&this.onSelectionChange();this.onClearFeatures()},getSelectedFeature:function(){var a=
this.features;return a?a[this.selectedIndex]:void 0},select:function(a){0>a||a>=this.count||(this.selectedIndex=a,this.onSelectionChange())},enableHighlight:function(a){(this._highlighted=a.graphics.add(new A(new B(0,0,a.spatialReference))),this._highlighted.hide(),this.markerSymbol)||(a=this.markerSymbol=new v,a.setStyle(v.STYLE_TARGET),a._setDim(16,16,0),a.setOutline(new t(q.STYLE_SOLID,new p([0,255,255]),2,t.CAP_ROUND,t.JOIN_ROUND)),a.setColor(new p([0,0,0,0])));this.lineSymbol||(this.lineSymbol=
new q(q.STYLE_SOLID,new p([0,255,255]),2));this.fillSymbol||(this.fillSymbol=new w(w.STYLE_NULL,new q(q.STYLE_SOLID,new p([0,255,255]),2),new p([0,0,0,0])))},disableHighlight:function(a){var b=this._highlighted;b&&(b.hide(),a.graphics.remove(b),delete this._highlighted);this.markerSymbol=this.lineSymbol=this.fillSymbol=null},showHighlight:function(){var a=this.features&&this.features[this.selectedIndex];this._highlighted&&a&&a.geometry&&this._highlighted.show()},hideHighlight:function(){this._highlighted&&
this._highlighted.hide()},updateHighlight:function(a,b){var c=b.geometry,f=this._highlighted;if(!c||!f)return void(f&&f.hide());f.hide();!f._graphicsLayer&&a&&a.graphics.add(f);f.setGeometry(C.fromJson(c.toJson()));var e;switch(c.type){case "point":case "multipoint":var h=b.getLayer(),c=b.symbol||h&&h._getSymbol(b);if(h&&c){var d,k,n=0,g=0,l=0;e=b.symbol?null:h._getRenderer(b);if(h=this._getSizeInfo(e))d=k=e.getSize(b,{sizeInfo:h,shape:c.style,resolution:a&&a.getResolutionInMeters&&a.getResolutionInMeters()});
else switch(c.type){case "simplemarkersymbol":d=k=c.size||0;break;case "picturemarkersymbol":d=c.width||0,k=c.height||0}n=c.xoffset||0;g=c.yoffset||0;l=c.angle||0;e=this.markerSymbol;e.setOffset(0,0);e.setAngle(0);d&&k&&e._setDim(d+1,k+1,0);e.setOffset(n,g);e.setAngle(l)}break;case "polyline":e=this.lineSymbol;break;case "polygon":e=this.fillSymbol}f.setSymbol(e)},showClosestFirst:function(a){var b=this.features;if(b&&b.length){if(1<b.length){var c,f,e,h,d,k=1/0,n=-1,g=D.getLength,l=a.spatialReference;
a=a.normalize();for(c=b.length-1;0<=c;c--)if(f=b[c].geometry){h=f.spatialReference;e=0;try{d="point"===f.type?f:f.getExtent().getCenter(),d=d.normalize(),l&&h&&!l.equals(h)&&l._canProject(h)&&(d=l.isWebMercator()?u.geographicToWebMercator(d):u.webMercatorToGeographic(d)),e=g(a,d)}catch(m){}0<e&&k>e&&(k=e,n=c)}0<n&&(b.splice(0,0,b.splice(n,1)[0]),this.select(0))}}else this.deferreds&&(this._marked=a)},_unbind:function(a){a=g.indexOf(this.deferreds,a);if(-1!==a)return this.deferreds.splice(a,1),this.deferreds.length?
1:(this.deferreds=null,2)},_fireComplete:function(a){var b=this._marked;b&&(this._marked=null,this.showClosestFirst(b));this.onDfdComplete(a)},_updateFeatures:function(a,b){if(a){if(this.deferreds){var c=this._unbind(a);if(c){if(b&&b instanceof Error)return this._fireComplete(b),void(2===c&&this.onSetFeatures());if(b&&b.length)if(this.features){var f=g.filter(b,function(a){return-1===g.indexOf(this.features,a)},this);this.features=this.features.concat(f);this.count=this.features.length;this._fireComplete();
2===c&&this.onSetFeatures()}else this.features=b,this.count=b.length,this.selectedIndex=0,this._fireComplete(),2===c&&this.onSetFeatures(),this.select(0);else this._fireComplete(),2===c&&this.onSetFeatures()}}}else this.features=b,this.count=b.length,this.selectedIndex=0,this.onSetFeatures(),this.select(0)},_getSizeInfo:function(a){return a?a.sizeInfo||g.filter(a.visualVariables,G)[0]:null},_resetUpdateEndListeners:function(){this._featureLayers={};g.forEach(this._updateEndHandles,function(a){a.remove()});
this._updateEndHandles=[]},_processFeatures:function(){g.forEach(this.features,function(a){(a=a.getLayer())&&!this._featureLayers[a.id]&&(1===a.currentMode||0===a.currentMode&&6===a.mode)&&a.objectIdField&&a.hasXYFootprint&&a.queryFeatures&&("esriGeometryPolygon"===a.geometryType||"esriGeometryPolyline"===a.geometryType||a.hasXYFootprint())&&(this._featureLayers[a.id]=a,a=a.on("update-end",m.hitch(this,this._fLyrUpdateEndHandler)),this._updateEndHandles.push(a))},this)},_fLyrUpdateEndHandler:function(a){if(!a.error){var b=
this,c=a.target,f=c.getSelectedFeatures(),e=0===c.currentMode&&6===c.mode,h={},d=[];if(g.forEach(this.features,function(a){if(a.getLayer()===c){var b=a.attributes[c.objectIdField];h[b]=a;d.push(b)}}),d.length)a=new E,a.objectIds=d,c.queryFeatures(a,function(a){g.forEach(a.features,function(a){var b=h[a.attributes[c.objectIdField]],d=!1;b.geometry!==a.geometry?(b.setGeometry(a.geometry),d=!0):e&&f&&-1!==g.indexOf(f,a)&&(d=!0);d&&this._highlighted&&b===this.getSelectedFeature()&&this._highlighted.setGeometry(a.geometry)},
b)})}}});return y("extend-esri")&&(z.PopupBase=r),r});