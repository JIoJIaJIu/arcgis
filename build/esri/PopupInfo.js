//>>built
define("esri/PopupInfo","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/json dojo/i18n dojo/has dojo/Deferred dojo/sniff dojo/promise/all ./lang ./kernel ./request ./tasks/query ./tasks/QueryTask ./tasks/StatisticDefinition dojo/i18n!dojo/cldr/nls/number".split(" "),function(t,k,p,D,N,I,E,J,x,n,F,K,G,L,M,H){t=t(null,{declaredClass:"esri.PopupInfo",initialize:function(a,b){if(a){k.mixin(this,b);this.info=a;this.title=this.getTitle;this.content=this.getContent;var c=this._fieldLabels=
{},d=this._fieldsMap={};a.fieldInfos&&p.forEach(a.fieldInfos,function(a){var b=a.fieldName.toLowerCase();c[b]=a.label;d[b]=a});this._relatedFieldPrefix="relationships/";this.titleHasRelatedFields=!(!a.title||-1===a.title.indexOf("{"+this._relatedFieldPrefix))}},toJson:function(){return D.fromJson(D.toJson(this.info))},getTitle:function(){},getContent:function(){},getFieldInfo:function(a){var b;return p.some(this.info&&this.info.fieldInfos,function(c){return c.fieldName===a&&(b=c),!!b}),b},getComponents:function(a){var b,
c,d=this.info,f=new E;return d.fieldInfos&&(c=p.filter(d.fieldInfos,function(a){return-1!==a.fieldName.indexOf(this._relatedFieldPrefix)},this)),c&&0<c.length&&(b=this._getRelatedRecords({graphic:a,fieldsInfo:c})),b?b.always(k.hitch(this,function(){f.resolve(this._getPopupValues(a))})):f.resolve(this._getPopupValues(a)),f.promise},getAttachments:function(a){var b=a.getLayer();a=a.attributes;if(this.info.showAttachments&&b&&b.hasAttachments&&b.objectIdField&&(a=a&&a[b.objectIdField]))return b.queryAttachmentInfos(a)},
_getPopupValues:function(a,b){var c,d,f,e,q,l=this.info,h=a.getLayer(),g=k.clone(a.attributes)||{},m=k.clone(g),A=l.fieldInfos,r="",B="",u=h&&h._getDateOpts&&h._getDateOpts().properties,u=u&&u.slice(0),v={dateFormat:{properties:u,formatter:"DateFormat"+this._insertOffset(this._dateFormats.shortDateShortTime)}};if(this._relatedInfo)for(e in this._relatedInfo)if(this._relatedInfo.hasOwnProperty(e)){var w=this._relatedInfo[e],t=this._relatedLayersInfo[e];w&&(p.forEach(w.relatedFeatures,function(a){for(q in a.attributes)if(a.attributes.hasOwnProperty(q)&&
"esriRelCardinalityOneToOne"===t.relation.cardinality){var b=this._toRelatedFieldName([t.relation.id,q]);g[b]=m[b]=a.attributes[q]}},this),p.forEach(w.relatedStatsFeatures,function(a){for(q in a.attributes)if(a.attributes.hasOwnProperty(q)){var b=this._toRelatedFieldName([t.relation.id,q]);g[b]=m[b]=a.attributes[q]}},this))}if(A&&p.forEach(A,function(a){d=a.fieldName;var b=this._getLayerFieldInfo(h,d);b&&(d=a.fieldName=b.name);if(m[d]=this._formatValue(m[d],d,v),u&&a.format&&a.format.dateFormat)a=
p.indexOf(u,d),-1<a&&u.splice(a,1)},this),h){e=h.types;var x=(w=h.typeIdField)&&g[w];for(d in g)if(g.hasOwnProperty(d)&&-1===d.indexOf(this._relatedFieldPrefix)&&(f=g[d],n.isDefined(f))){var y=this._getDomainName(h,a,e,x,d,f);n.isDefined(y)?m[d]=y:d===w&&(y=this._getTypeName(h,a,f),n.isDefined(y)&&(m[d]=y))}}if(l.title&&(r=this._processFieldsInLinks(this._fixTokens(l.title,h),g),r=k.trim(n.substitute(m,r,v)||"")),b)return{title:r};l.description&&(B=this._processFieldsInLinks(this._fixTokens(l.description,
h),g),B=k.trim(n.substitute(m,B,v)||""));A&&(c=[],p.forEach(A,function(a){(d=a.fieldName)&&a.visible&&c.push([a.label||d,n.substitute(m,"${"+d+"}",v)||""])}));var z,C;return l.mediaInfos&&(z=[],p.forEach(l.mediaInfos,function(a){switch(C=0,f=a.value,a.type){case "image":var b=f.sourceURL,b=b&&k.trim(n.substitute(g,this._fixTokens(b,h)));C=!!b;break;case "piechart":case "linechart":case "columnchart":case "barchart":var c,b=f.normalizeField;f.fields=p.map(f.fields,function(a){return c=this._getLayerFieldInfo(h,
a),c?c.name:a},this);b&&(c=this._getLayerFieldInfo(h,b),f.normalizeField=c?c.name:b);C=p.some(f.fields,function(a){return n.isDefined(g[a])||-1!==a.indexOf(this._relatedFieldPrefix)&&this._relatedInfo},this);break;default:return}if(C){a=k.clone(a);f=a.value;var b=a.title?this._processFieldsInLinks(this._fixTokens(a.title,h),g):"",d=a.caption?this._processFieldsInLinks(this._fixTokens(a.caption,h),g):"";if(a.title=b?k.trim(n.substitute(m,b,v)||""):"",a.caption=d?k.trim(n.substitute(m,d,v)||""):"",
"image"===a.type)f.sourceURL=n.substitute(g,this._fixTokens(f.sourceURL,h)),f.linkURL&&(f.linkURL=k.trim(n.substitute(g,this._fixTokens(f.linkURL,h))||""));else{var e,l;p.forEach(f.fields,function(a,b){if(-1!==a.indexOf(this._relatedFieldPrefix))l=this._getRelatedChartInfos(a,f,g,v),l instanceof Array?f.fields=l:f.fields[b]=l;else{var c=g[a],c=void 0===c?null:c;e=g[f.normalizeField]||0;c&&e&&(c/=e);f.fields[b]={y:c,tooltip:(this._fieldLabels[a.toLowerCase()]||a)+":\x3cbr/\x3e"+this._formatValue(c,
a,v,!!e)}}},this)}z.push(a)}},this)),{title:r,description:B,hasDescription:!!l.description,fields:c&&c.length?c:null,mediaInfos:z&&z.length?z:null,formatted:m,editSummary:h&&h.getEditSummary?h.getEditSummary(a):""}},_getRelatedChartInfos:function(a,b,c,d){var f,e,q,l,h,g,m;return f=[],m=this._fromRelatedFieldName(a),h=m[0],e=this._relatedInfo[h],g=this._relatedLayersInfo[h],e&&p.forEach(e.relatedFeatures,function(e){var h,g=e.attributes;for(h in g)if(g.hasOwnProperty(h)&&h===m[1]){if(e={},l=g[h],
b.normalizeField&&(q=-1!==b.normalizeField.indexOf(this._relatedFieldPrefix)?g[this._fromRelatedFieldName(b.normalizeField)[1]]:c[b.normalizeField]),l&&q&&(l/=q),b.tooltipField)if(-1!==b.tooltipField.indexOf(this._relatedFieldPrefix)){var k=this._fromRelatedFieldName(b.tooltipField)[1];e.tooltip=g[k]&&"string"==typeof g[k]?g[k]+":\x3cbr/\x3e"+this._formatValue(l,g[k],d,!!q):k+":\x3cbr/\x3e"+this._formatValue(l,k,d,!!q)}else e.tooltip=(this._fieldLabels[a.toLowerCase()]||a)+":\x3cbr/\x3e"+this._formatValue(l,
b.tooltipField,d,!!q);else e.tooltip=l;e.y=l;f.push(e)}},this),"esriRelCardinalityOneToMany"===g.relation.cardinality||"esriRelCardinalityManyToMany"===g.relation.cardinality?f:f[0]},_dateFormats:{shortDate:"(datePattern: 'M/d/y', selector: 'date')",shortDateLE:"(datePattern: 'd/M/y', selector: 'date')",longMonthDayYear:"(datePattern: 'MMMM d, y', selector: 'date')",dayShortMonthYear:"(datePattern: 'd MMM y', selector: 'date')",longDate:"(datePattern: 'EEEE, MMMM d, y', selector: 'date')",shortDateShortTime:"(datePattern: 'M/d/y', timePattern: 'h:mm a', selector: 'date and time')",
shortDateLEShortTime:"(datePattern: 'd/M/y', timePattern: 'h:mm a', selector: 'date and time')",shortDateShortTime24:"(datePattern: 'M/d/y', timePattern: 'H:mm', selector: 'date and time')",shortDateLEShortTime24:"(datePattern: 'd/M/y', timePattern: 'H:mm', selector: 'date and time')",shortDateLongTime:"(datePattern: 'M/d/y', timePattern: 'h:mm:ss a', selector: 'date and time')",shortDateLELongTime:"(datePattern: 'd/M/y', timePattern: 'h:mm:ss a', selector: 'date and time')",shortDateLongTime24:"(datePattern: 'M/d/y', timePattern: 'H:mm:ss', selector: 'date and time')",
shortDateLELongTime24:"(datePattern: 'd/M/y', timePattern: 'H:mm:ss', selector: 'date and time')",longMonthYear:"(datePattern: 'MMMM y', selector: 'date')",shortMonthYear:"(datePattern: 'MMM y', selector: 'date')",year:"(datePattern: 'y', selector: 'date')"},_reHref:/href\s*=\s*\"([^\"]+)\"/gi,_reHrefApos:/href\s*=\s*\'([^\']+)\'/gi,_fixTokens:function(a,b){var c=this;return a.replace(/(\{([^\{\r\n]+)\})/g,function(a,f,e){a=c._getLayerFieldInfo(b,e);return"$"+(a?"{"+a.name+"}":f)})},_encodeAttributes:function(a){var b,
c,d=k.clone(a)||{};for(b in d)(a=d[b])&&"string"==typeof a&&(c=encodeURIComponent(a).replace(/\'/g,"\x26apos;"),d[b]=c);return d},_processFieldsInLinks:function(a,b){var c=this._encodeAttributes(b),d=this;return a&&(a=a.replace(this._reHref,function(a,e){return d._addValuesToHref(a,e,b,c)}).replace(this._reHrefApos,function(a,e){return d._addValuesToHref(a,e,b,c)})),a},_addValuesToHref:function(a,b,c,d){return b=b&&k.trim(b),n.substitute((b?0!==b.indexOf("${"):1)?d:c,a)},_getLayerFieldInfo:function(a,
b){return a&&a.getField?a.getField(b):null},_formatValue:function(a,b,c,d){var f=this._fieldsMap[b.toLowerCase()],e=f&&f.format;b=-1!==p.indexOf(c.dateFormat.properties,b);var q=!("number"!=typeof a||b||e&&e.dateFormat);if(!n.isDefined(a)||!f||!n.isDefined(e))return q?this._forceLTR(a):a;var l="",f=[],h=e.hasOwnProperty("places")||e.hasOwnProperty("digitSeparator"),g=e.hasOwnProperty("digitSeparator")?e.digitSeparator:!0;if(h&&!b)l="NumberFormat",f.push("places: "+(n.isDefined(e.places)&&(!d||0<e.places)?
Number(e.places):"Infinity")),f.length&&(l+="("+f.join(",")+")");else{if(!e.dateFormat)return q?this._forceLTR(a):a;l="DateFormat"+this._insertOffset(this._dateFormats[e.dateFormat]||this._dateFormats.shortDateShortTime)}var m=this._applyFormatting(a,l,c);return h&&-1<a.constructor.toString().indexOf("Array")&&(m="",p.forEach(a,k.hitch(this,function(a){m=m+this._applyFormatting(a,l,c)+" "}))),h&&!g&&H.group&&(m=m.replace(new RegExp("\\"+H.group,"g"),"")),q?this._forceLTR(m):m},_applyFormatting:function(a,
b,c){return n.substitute({myKey:a},"${myKey:"+b+"}",c)||""},_forceLTR:function(a){var b=J("ie");return b&&10>=b?a:"\x3cspan class\x3d'esriNumericValue'\x3e"+a+"\x3c/span\x3e"},_insertOffset:function(a){return a&&(a=n.isDefined(this.utcOffset)?a.replace(/\)\s*$/,", utcOffset:"+this.utcOffset+")"):a),a},_getDomainName:function(a,b,c,d,f,e){return(a=a.getDomain&&a.getDomain(f,{feature:b}))&&a.codedValues?a.getName(e):null},_getTypeName:function(a,b){var c=a.getType&&a.getType(b);return c&&c.name},_getRelatedRecords:function(a){var b,
c=a.graphic,d=new E;return this._relatedLayersInfo?this._queryRelatedLayers(c).then(k.hitch(this,function(a){this._setRelatedRecords(c,a);d.resolve(a)}),k.hitch(this,this._handlerErrorResponse,d)):this._getRelatedLayersInfo(a).then(k.hitch(this,function(a){for(b in a)a.hasOwnProperty(b)&&a[b]&&(this._relatedLayersInfo[b].relatedLayerInfo=a[b]);this._queryRelatedLayers(c).then(k.hitch(this,function(a){this._setRelatedRecords(c,a);d.resolve(a)}),k.hitch(this,this._handlerErrorResponse,d))}),k.hitch(this,
this._handlerErrorResponse,d)),d.promise},_getRelatedLayersInfo:function(a){var b,c,d=a.fieldsInfo,f={};b=a.graphic.getLayer();this._relatedLayersInfo||(this._relatedLayersInfo={});p.forEach(d,function(a){var c,d,e,f;c=this._fromRelatedFieldName(a.fieldName);d=c[0];c=c[1];d&&(this._relatedLayersInfo[d]||(p.some(b.relationships,function(a){return a.id==d?(f=a,!0):void 0}),f&&(this._relatedLayersInfo[d]={relation:f,relatedFields:[],outStatistics:[]})),this._relatedLayersInfo[d]&&(this._relatedLayersInfo[d].relatedFields.push(c),
a.statisticType&&(e=new M,e.statisticType=a.statisticType,e.onStatisticField=c,e.outStatisticFieldName=c,this._relatedLayersInfo[d].outStatistics.push(e))))},this);for(c in this._relatedLayersInfo)if(this._relatedLayersInfo.hasOwnProperty(c)){var e,k;this._relatedLayersInfo[c]&&(e=this._relatedLayersInfo[c].relation,k=b.url.replace(/[0-9]+$/,e.relatedTableId),this._relatedLayersInfo[c].relatedLayerUrl=k,f[c]=K({url:k,content:{f:"json"},callbackParamName:"callback"}))}return x(f)},_queryRelatedLayers:function(a){var b,
c={};for(b in this._relatedLayersInfo)this._relatedLayersInfo.hasOwnProperty(b)&&(c[b]=this._queryRelatedLayer({graphic:a,relatedInfo:this._relatedLayersInfo[b]}));return x(c)},_queryRelatedLayer:function(a){var b,c,d,f,e,k,l,h,g,m,n,r,t,u;return b=a.graphic,c=b.getLayer(),d=c.url.match(/[0-9]+$/g)[0],r=a.relatedInfo,m=r.relatedLayerInfo,t=r.relatedLayerUrl,u=r.relation,p.some(m.relationships,function(a){return a.relatedTableId===parseInt(d,10)?(f=a,!0):void 0},this),f&&(e=new G,p.some(m.fields,function(a){return a.name===
f.keyField?(h=-1!==p.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],a.type)?"number":"string",!0):void 0}),l="string"===h?f.keyField+"\x3d'"+b.attributes[u.keyField]+"'":f.keyField+"\x3d"+b.attributes[u.keyField],e.where=l,e.outFields=r.relatedFields,r.outStatistics&&0<r.outStatistics.length&&m.supportsStatistics&&(g=new G,g.where=e.where,g.outFields=e.outFields,g.outStatistics=r.outStatistics),k=new L(t),n=[],n.push(k.execute(e)),g&&n.push(k.execute(g))),
x(n)},_setRelatedRecords:function(a,b){this._relatedInfo=[];for(var c in b)if(b.hasOwnProperty(c)&&b[c]){var d=b[c];this._relatedInfo[c]={};this._relatedInfo[c].relatedFeatures=d[0].features;n.isDefined(d[1])&&(this._relatedInfo[c].relatedStatsFeatures=d[1].features)}},_handlerErrorResponse:function(a,b){a.reject(b)},_fromRelatedFieldName:function(a){var b,c=[];return-1!==a.indexOf(this._relatedFieldPrefix)&&(b=a.split("/"),c=b.slice(1)),c},_toRelatedFieldName:function(a){var b="";return a&&0<a.length&&
(b=this._relatedFieldPrefix+a[0]+"/"+a[1]),b}});return I("extend-esri")&&(F.PopupInfo=F.PopupInfoTemplate=t),t});