//>>built
!function(g,v){function w(a){var f=a.data,h=f.action;a=f.msgId;h&&a&&("initialize"==h?(u=new g.HeatmapCalculator(f),postMessage({msgId:a})):"calculate"==h&&(f=u.calculateImageData(f),postMessage({msgId:a,imageData:f},f)))}if("function"==typeof define&&define.amd?define("esri/workers/heatmapCalculator",[],v):g.HeatmapCalculator=v(),g.importScripts&&"function"==typeof g.importScripts){var u;g.addEventListener("message",w,!1)}}(this,function(){function g(a){a=a||{};this.radius=a.blurRadius||10;this.maxVal=
a.maxPixelIntensity;this.minVal=a.minPixelIntensity;this.field=a.field;this.fieldOffset=a.fieldOffset;this.width=a.width;this.height=a.height;this.gradient=a.gradient;this.stats=null}function v(a,f){for(var h=Array(a),b=0;a>b;b++)for(var c=h[b]=Array(f),d=0;f>d;d++)c[d]=0;return h}function w(a,f){return a-f}var u=window.ArrayBuffer?!0:!1;return g.prototype.calculateImageData=function(a){var f=this.radius=a.blurRadius||this.blurRadius;this.maxVal=null!=a.maxPixelIntensity?a.maxPixelIntensity:this.maxPixelIntensity;
this.minVal=null!=a.minPixelIntensity?a.minPixelIntensity:this.minPixelIntensity;var h=this.field="field"in a?a.field:this.field,b=this.fieldOffset="fieldOffset"in a?a.fieldOffset:this.fieldOffset,c=a.screenPoints,d=a.gradient;if(d)this.gradient=d;else{if(!this.gradient)return!1;d=this.gradient}var e=a.features,k=a.mapinfo;c||(e&&k?c=this.screenPoints=this._calculateScreenPoints(e,k):!k&&this.screenPoints&&(e=!0,a.width&&a.width!=this.width&&(e=!1,this.width=a.width),a.height&&a.height!=this.height&&
(e=!1,this.height=a.height),e?c=this.screenPoints:this.screenPoints=null));if(!c)return!1;e=k.width||a.width||this.width;a=k.height||a.height||this.height;f=this._calculateIntensityMatrix(c,e,a,f,h,b);this._lastMatrix=f.matrix;this._maxIntVal=f.max;return this._createImageData(e,a,this._lastMatrix,d)},g.prototype._calculateScreenPoints=function(a,f){var h=f.resolution,b=f.width,c=f.height,d=f.extent,e=[];if(!d)return!1;h||(h=c?Math.abs(d[3]-d[1])/c:Math.abs(d[2]-d[0])/b);b=0;for(c=a.length;c>b;b++){var k=
a[b];e[b]={x:Math.round((k.geometry.x-d[0])/h),y:Math.round((d[3]-k.geometry.y)/h),attributes:k.attributes}}return e},g.prototype._calculateIntensityMatrix=function(a,f,h,b,c,d){var e,k=v(h,f),p=Math.round(4.5*b),l=b*b,n=[],g=2*p+1,m=-1,q=1,x=-1/0;d=d||0;for(c=function(a){return"function"==typeof a?a:a?"abs"==d?function(b){return-1*+b.attributes[a]}:function(b){return+b.attributes[a]+d}:function(){return 1}}(c);++m<g;)n[m]=Math.exp(-Math.pow(m-p,2)/(2*l))/Math.sqrt(2*Math.PI)*(b/2);for(m=0;m<a.length;m++){var t=
a[m];b=t.x-p;var l=t.y-p,g=b,u=l;if(q=+c(t),!isNaN(q)&&null!==q)for(var w=Math.min(t.y+p,h-1),t=Math.min(t.x+p,f-1);w>=l;){for(var y=n[l-u];t>=b;)-1<b&&-1<l&&(e=k[l][b]+=y*n[b-g]*q,e>x&&(x=e)),b++;l++;b=g}}return{matrix:k,max:x}},g.prototype._createImageData=function(a,f,h,b){if(!u)return this._createPixelData(a,f,h,b);var c=new Uint32Array(a*f);b=new Uint32Array(b.buffer?b.buffer:(new Uint8Array(b)).buffer);for(var d=this.minVal,e=b.length/(this.maxVal-d),k=0;f>k;k++)for(var p=h[k],l=0;a>l;l++){var g=
Math.floor((p[l]-d)*e);c[k*a+l]=0>g?b[0]:g<b.length?b[g]:b[b.length-1]}return c},g.prototype._createPixelData=function(a,f,h,b){for(var c=Array(a*f*4),d=this.minVal,e=b.length/4/(this.maxVal-d),k=3,p=0;f>p;p++)for(var g=h[p],n=0;a>n;n++){var r=4*(p*a+n)+3,m=4*Math.floor((g[n]-d)*e)+3;3>m?m=3:m>b.length-1&&(m=b.length-1);for(k=4;k--;)c[r-k]=b[m-k]}return c},g.calculateStats=function(a,f){if(!a)return!1;for(var h,b,c,d,e,k=a.length,g=0,l=0,n=0,r=0,m=1/0,q=-1/0;k--;)for(c=a[k],h=c.length;h--;)e=c[h],
f&&!f(e)||(d||(d=e),b=e-d,r+=e,g+=b,l+=b*b,m>e&&(m=e),e>q&&(q=e),n++);return 0<n?{mean:r/n,stdDev:Math.sqrt((l-g*g/n)/n),min:m,max:q,mid:(q-m)/2}:{mean:0,stdDev:0,min:0,max:0,mid:0}},g.getBinnedValues=function(a){function f(){console.log("not enough information to determine bins for HeatmapCalculator.getBinnedValues")}function h(a,b,c){for(var d=[];b>a;a+=c)d.push(a);return d}a=a||{};var b=a.stats,c=a.min,d=a.max,e=a.bins,k=a.count,g=a.size;a=a.values;if(!a)return console.log("values are required for HeatmapCalculator.getBinnedValues function"),
!1;if(b&&null!=b.max&&null!=b.min&&(c=b.min,d=b.max),!e)if(g){if(null==c&&(c=0),null==d){if(null==k)return f(),!1;d=c+k*g}e=h(c,d,g)}else if(k){if(b&&null!=b.min&&null!=b.max?(c=b.min,d=b.max):null!=d&&0<d&&null==c&&(c=0),null==c||null==d)return f(),!1;e=h(c,d,(d-c)/k)}for(var k=e.length,l,n=v(k,0),r=a.length;r--;)for(c=a[r],b=c.length;b--;){d=c[b];for(g=1;k>g&&(l=e[g],!(l>d));g++);n[g-1].push(d)}return n.map(function(a){return a.sort(w)})},g.getHistogramData=function(a){a=a||{};var f=a.binnedData,
h=a.stats,b=a.byStdDev,c=a.matrix;a=a.binOptions||{};if(!f){if(!c)return console.log("no data provided to HeatmapCalculator.getHistogramData"),!1;if(a.values=c,b&&(h||(h=g.calculateStats(c)),a.size=h.stdDev),a.stats=h,f=g.getBinnedValues(a),!f)return!1}var d,e;if(a.bins)c=a.bins;else for(c=[],b=0;b<f.length;b++)e=f[b],c.push(e[0]);a=[];for(b=0;b<c.length-1;b++)e=c[b],a[b]={range:[e,c[b+1]],count:e.length};return h?d=h.max:(e=f[b],d=e[e.length-1]),e=c[b],a[b]={range:[e,d],count:e.length},a},g});