//>>built
define("esri/SnappingManager","dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/Color dojo/_base/Deferred dojo/has dojo/keys ./kernel ./graphic ./geometry/ScreenPoint ./geometry/Extent ./symbols/SimpleMarkerSymbol ./symbols/SimpleLineSymbol ./tasks/query".split(" "),function(z,d,v,A,E,K,F,G,L,M,H,w,I,J,x){z=z(null,{declaredClass:"esri.SnappingManager",constructor:function(a){if(a=a||{},a.map||console.error("map is not specified for SnappingManager"),this.map=a.map,
this.tolerance=a.tolerance||15,this.layerInfos=[],a.layerInfos)this.layerInfos=a.layerInfos;else{var c;for(c=0;c<this.map.graphicsLayerIds.length;c++){var b=this.map.getLayer(this.map.graphicsLayerIds[c]);this.layerInfos.push({layer:b})}if(this.map.loaded)this.layerInfos.push({layer:this.map.graphics});else var l=d.connect(this.map,"onLoad",this,function(){d.disconnect(l);l=null;this.layerInfos.push({layer:this.map.graphics});this.setLayerInfos(this.layerInfos)})}this.snapPointSymbol=a.snapPointSymbol?
a.snapPointSymbol:new I(I.STYLE_CROSS,15,new J(J.STYLE_SOLID,new E([0,255,255]),1),new E([0,255,0,0]));this.alwaysSnap=a.alwaysSnap?a.alwaysSnap:!1;this.snapKey=a.snapKey?a.snapKey:F("mac")?G.META:G.CTRL;this._SelectionLyrQuery=new x;this._SelectionLyrQuery.spatialRelationship=x.SPATIAL_REL_INTERSECTS;this._snappingGraphic=new M;this.setLayerInfos(this.layerInfos);this._currentGraphicOption={snapToPoint:!0,snapToVertex:!0,snapToEdge:!0};this._snappingCallback=v.hitch(this,this._snappingCallback)},
getSnappingPoint:function(a){var c=this.layers,b=this.tolerance,l=this.map,d=this.layerOptions,g=l.toMap(a.offset(-b,b)),b=l.toMap(a.offset(b,-b)),g=new w(g.x,g.y,b.x,b.y,l.spatialReference),r=new x;r.geometry=g;r.spatialRelationship=x.SPATIAL_REL_INTERSECTS;var k,q,t=[],y=[],B=this._extractPointsAndLines,C=new K,e=0,b=g.xmin,h=g.xmax;A.forEach(c,function(a){a.visible&&a.loaded&&"esri.layers.FeatureLayer"===a.declaredClass&&a.mode!==a.constructor.MODE_SELECTION&&e++});l.spatialReference._isWrappable()&&
(b=w.prototype._normalizeX(g.xmin,l.spatialReference._getInfo()).x,h=w.prototype._normalizeX(g.xmax,l.spatialReference._getInfo()).x);var m=new w(b,g.ymin,h,g.ymax,l.spatialReference);A.forEach(c,function(a,b){if("esri.layers.GraphicsLayer"===a.declaredClass&&a.visible){var c=[];A.forEach(a.graphics,function(a){a&&a.visible&&m.intersects(a.geometry)&&c.push(a)});var g=B(c,d[b]);t=t.concat(g[0]);y=y.concat(g[1])}});var f=v.hitch(this,function(b){(e--,b instanceof Error)?console.log("getSnappingPoint: query features failed"):
(b=B(b.features,d[q]),t=t.concat(b[0]),y=y.concat(b[1]));e||(k=this._getSnappingPoint(t,y,a),C.callback(k))}),p=!1;return A.forEach(c,function(a,b){a.visible&&a.loaded&&(q=b,"esri.layers.FeatureLayer"===a.declaredClass&&a.mode!==a.constructor.MODE_SELECTION&&(p=!0,a.queryFeatures(r,f,f)))}),p||(k=this._getSnappingPoint(t,y,a),C.callback(k)),C},setLayerInfos:function(a){this.layers=[];this.layerOptions=[];var c;for(c=0;c<a.length;c++)this.layers.push(a[c].layer),this.layerOptions.push({snapToPoint:!0,
snapToVertex:!0,snapToEdge:!0}),!1===a[c].snapToPoint&&(this.layerOptions[c].snapToPoint=a[c].snapToPoint),!1===a[c].snapToVertex&&(this.layerOptions[c].snapToVertex=a[c].snapToVertex),!1===a[c].snapToEdge&&(this.layerOptions[c].snapToEdge=a[c].snapToEdge);this._featurePtsFromSelectionLayer=[];this._featureLinesFromSelectionLayer=[];this._selectionLayers=[];this._selectionLayerOptions=[];A.forEach(this.layers,function(a,c){"esri.layers.FeatureLayer"===a.declaredClass&&a.mode===a.constructor.MODE_SELECTION&&
(this._selectionLayers.push(a),this._selectionLayerOptions.push(this.layerOptions[c]))},this);this.layerInfos=a},destroy:function(){d.disconnect(this._onExtentChangeConnect);this._killOffSnapping();this._featurePtsFromSelectionLayer=this._featureLinesFromSelectionLayer=this._currentFeaturePts=this._currentFeatureLines=this.layers=this.map=null},_startSelectionLayerQuery:function(){d.disconnect(this._onExtentChangeConnect);this._mapExtentChangeHandler(this._selectionLayers,this._selectionLayerOptions,
this.map.extent);this._onExtentChangeConnect=d.connect(this.map,"onExtentChange",v.hitch(this,"_mapExtentChangeHandler",this._selectionLayers,this._selectionLayerOptions))},_stopSelectionLayerQuery:function(){d.disconnect(this._onExtentChangeConnect)},_mapExtentChangeHandler:function(a,c,b){this._featurePtsFromSelectionLayer=[];this._featureLinesFromSelectionLayer=[];var l;this._SelectionLyrQuery.geometry=b;var d=v.hitch(this,function(a){a instanceof Error?console.log("getSnappingPoint: query features failed"):
(a=this._extractPointsAndLines(a.features,c[l]),this._featurePtsFromSelectionLayer=this._featurePtsFromSelectionLayer.concat(a[0]),this._featureLinesFromSelectionLayer=this._featureLinesFromSelectionLayer.concat(a[1]))});A.forEach(a,function(a,b){a.visible&&a.loaded&&(l=b,a.queryFeatures(this._SelectionLyrQuery,d,d))},this)},_extractPointsAndLines:function(a,c){var b,l,d=[],g=[];return A.forEach(a,function(a){if((!a._graphicsLayer||a.visible)&&a.geometry)if("point"===a.geometry.type&&c.snapToPoint)d.push(a.geometry);
else if("polyline"===a.geometry.type)for(b=0;b<a.geometry.paths.length;b++){g.push("lineStart");for(l=0;l<a.geometry.paths[b].length;l++){var k=a.geometry.getPoint(b,l);c.snapToVertex&&d.push(k);c.snapToEdge&&g.push(k)}g.push("lineEnd")}else if("polygon"===a.geometry.type)for(b=0;b<a.geometry.rings.length;b++){g.push("lineStart");for(l=0;l<a.geometry.rings[b].length;l++)k=a.geometry.getPoint(b,l),c.snapToVertex&&d.push(k),c.snapToEdge&&g.push(k);g.push("lineEnd")}}),[d,g]},_getSnappingPoint:function(a,
c,b){var d,z,g=this.tolerance,r=this.map,k=this.map._getFrameWidth();if(a=a.concat(this._featurePtsFromSelectionLayer),c=c.concat(this._featureLinesFromSelectionLayer),this._currentGraphic){var q=this._extractPointsAndLines([this._currentGraphic],this._currentGraphicOption);a=a.concat(q[0]);c=c.concat(q[1])}var t,y;if(A.forEach(a,function(a){a=r.toScreen(a,!0);if(-1!==k&&(a.x%=k,0>a.x&&(a.x+=k),r.width>k))for(var c=(r.width-k)/2;a.x<c;)a.x+=k;d=Math.sqrt((a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y));g>=
d&&(g=d,t=a.x,y=a.y)}),t)c=new H(t,y),z=c=r.toMap(c);else{var B,C,g=this.tolerance;for(a=0;a<c.length;a++)if("lineStart"===c[a])for(q=a+1;q<c.length;q++){if("lineEnd"!==c[q+1]&&"lineStart"!==c[q+1]&&"lineEnd"!==c[q]&&"lineStart"!==c[q]){var e=r.toScreen(c[q],!0),h=r.toScreen(c[q+1],!0),m=e.x>=h.x?e:h,f=e.x>=h.x?h:e;-1!==k&&(m.x%=k,0>m.x&&(m.x+=k),f.x%=k,0>f.x&&(f.x+=k),f.x>m.x&&(f.x-=k));var p,u,D,v,w,e=m.x,h=m.y,n=f.x,f=f.y;e===n?(m=e,p=b.y,u=D=e,v=f>=h?h:f,w=f>=h?f:h):h===f?(m=b.x,p=h,u=n>=e?e:
n,D=n>=e?n:e,v=w=h):(p=(f-h)/(n-e),u=(h*n-e*f)/(n-e),m=(u-(b.y*f-b.y*h-b.x*e+b.x*n)/(f-h))/((e-n)/(f-h)-p),p=p*m+u,u=n>=e?e:n,D=n>=e?n:e,v=f>=h?h:f,w=f>=h?f:h);if(m>=u&&D>=m&&p>=v&&w>=p)e=Math.sqrt((b.x-m)*(b.x-m)+(b.y-p)*(b.y-p)),g>=e&&(g=e,B=m,C=p);else{var x;u=Math.sqrt((e-b.x)*(e-b.x)+(h-b.y)*(h-b.y));D=Math.sqrt((n-b.x)*(n-b.x)+(f-b.y)*(f-b.y));D>=u?(x=u,m=e,p=h):(x=D,m=n,p=f);g>=x&&(g=x,B=m,C=p)}}if("lineEnd"===c[q]){a=q;break}}B&&(c=new H(B,C),z=c=r.toMap(c))}return z},_setGraphic:function(a){this._currentGraphic=
a},_addSnappingPointGraphic:function(){var a=this.map;this._snappingGraphic.setSymbol(this.snapPointSymbol);a.graphics.add(this._snappingGraphic)},_setUpSnapping:function(){var a=this.map;this._onSnapKeyDown_connect=d.connect(a,"onKeyDown",this,"_onSnapKeyDownHandler");this._onSnapKeyUp_connect=d.connect(a,"onKeyUp",this,"_onSnapKeyUpHandler");this._onSnappingMouseMove_connect=d.connect(a,"onMouseMove",this,"_onSnappingMouseMoveHandler");this._onSnappingMouseDrag_connect=d.connect(a,"onMouseDrag",
this,"_onSnappingMouseMoveHandler");this.alwaysSnap&&this._activateSnapping()},_killOffSnapping:function(){d.disconnect(this._onSnapKeyDown_connect);d.disconnect(this._onSnapKeyUp_connect);d.disconnect(this._onSnappingMouseMove_connect);d.disconnect(this._onSnappingMouseDrag_connect);this._deactivateSnapping()},_onSnapKeyDownHandler:function(a){a.keyCode===this.snapKey&&(d.disconnect(this._onSnapKeyDown_connect),this.alwaysSnap?this._deactivateSnapping():this._activateSnapping())},_activateSnapping:function(){this._snappingActive=
!0;this._addSnappingPointGraphic();this._currentLocation&&this._onSnappingMouseMoveHandler(this._currentLocation)},_onSnapKeyUpHandler:function(a){a.keyCode===this.snapKey&&(this._onSnapKeyDown_connect=d.connect(this.map,"onKeyDown",this,"_onSnapKeyDownHandler"),this.alwaysSnap?this._activateSnapping():this._deactivateSnapping())},_deactivateSnapping:function(){this._snappingActive=!1;this._snappingPoint=null;this.map.graphics.remove(this._snappingGraphic);this._snappingGraphic.setGeometry(null)},
_onSnappingMouseMoveHandler:function(a){if(this._currentLocation=a,this._snappingPoint=null,this._snappingActive)this._snappingGraphic.hide(),this.getSnappingPoint(a.screenPoint).addCallback(this._snappingCallback)},_snappingCallback:function(a){(this._snappingPoint=a)&&(this._snappingGraphic.show(),this._snappingGraphic.setGeometry(a))}});return F("extend-esri")&&(L.SnappingManager=z),z});