//>>built
define("esri/dijit/BrowseItems","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/window dojo/dom-class dojo/dom-style dojo/dom-attr dojo/string dojo/on dojo/aspect dojo/has dojo/dom dojo/dom-construct dojo/mouse dojo/query dojo/parser dijit/registry dijit/TooltipDialog dijit/popup dojo/promise/all dojo/Deferred dgrid/Grid dgrid/extensions/Pagination dgrid/extensions/DijitRegistry dgrid/OnDemandGrid dgrid/Selection dgrid/selector dgrid/Keyboard dgrid/util/mouse dgrid/util/touch put-selector/put dojo/store/Observable dijit/_WidgetBase dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dijit/_FocusMixin dijit/form/Select ../arcgis/Portal ../Evented ../PluginTarget dojo/i18n!../nls/jsapi ./_RefreshMixin ../kernel ../lang ../config ../geometry/webMercatorUtils ../tasks/GeometryService ../SpatialReference".split(" "),
function(m,d,A,p,t,Y,n,B,u,Z,C,v,D,E,e,aa,w,F,x,ba,y,G,H,I,ca,J,da,ea,z,fa,K,L,M,N,O,P,Q,g,ga,R,S,T,U,q,V,r,W){var X=m(null,{idProperty:"id",constructor:function(a){m.safeMixin(this,a)},get:function(a,b){return g.PortalUtil.request(this.portalUrl+"content/items/"+a,b).then(function(a){return new g.PortalItem(d.mixin(a,{portal:this.portal}))})},getIdentity:function(a){return a[this.idProperty]},query:function(a,b){var c=d.isObject(a)?a:{q:a};if(b&&(c=d.mixin(c,{num:b.count,start:(b.start||0)+1}),b.sort&&
b.sort.length))var h=b.sort[0],c=d.mixin(c,{sortField:encodeURIComponent("created"===h.attribute?"uploaded":h.attribute),sortOrder:h.descending?"desc":"asc"});b.useExtent&&b.extent&&(c.bbox=b.extent);c=this.portal.queryItems(c,!0).then(function(a){return a.results.total=a.total,a.results});return g.PortalResult(c)}});p=m([M,N,O,R,P],{templateString:'\x3cdiv\x3e\x3cp data-dojo-attach-point\x3d"messageNode" class\x3d"hide"\x3e\x3c/p\x3e\x3cdiv style\x3d"width:100%" class\x3d"esriLeadingMargin1"\x3e\x3cselect id\x3d"${id}_categorySelect"class\x3d"categorySelect"\x3e\x3c/select\x3e\x3cdiv id\x3d"${id}_search"class\x3d"esriTrailingMargin2 esriFloatTrailing searchBar"\x3e\x3cinput class\x3d"esriSearchBox dijitTextBox" type\x3d"text" placeholder:\'${i18n.searchFor}\'\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"${id}_grid"class\x3d"dgrid-autoheight"\x3e\x3c/div\x3e\x3cbr /\x3e\x3c/div\x3e',
_galleryTemplate:"\x3cdiv style\x3d'opacity:1;' class\x3d'grid-item gallery-view'\x3e${item:_formatItemTitle}${item:_formatThumbnail}\x3c/div\x3e",_popupTemplate:'\x3cdiv class\x3d"esriBrowsePopup quiet-scroll"\x3e\x3cp\x3e{summary}\x3c/p\x3e\x3c/div\x3e',baseClass:"esriBrowseItemsCtr",closePopupPerRow:!0,postMixInProperties:function(){this.inherited(arguments);this.i18n={};d.mixin(this.i18n,S.gallery)},postCreate:function(){this.inherited(arguments);this.self?(this._portal=new g.Portal({url:this.portalUrl,
self:this.self}),this._portal.on("load",d.hitch(this,this._fetchData))):(this._portal=new g.Portal(this.portalUrl),this._portal.signIn().then(d.hitch(this,this._fetchData)))},destroy:function(){this.inherited(arguments);this._grid&&this._grid.destroy();this._img_connect.remove();this._img_connect_error.remove();this._queryTimer&&clearTimeout(this._queryTimer);this._grid=this._portal=null},_setPortalUrlAttr:function(a){this.portalUrl=a},_setSelfAttr:function(a){this.self=a},_setPluginAttr:function(a){this.addPlugin(a)},
_setMessageAttr:function(a){n.set(this.messageNode,"innerHTML",a);t.remove(this.messageNode,"hide")},_setCategoriesAttr:function(a){this.categories=a},_setDisabledAttr:function(a){var b=w.findWidgets(this.domNode).concat(w.findWidgets(this._content));A.forEach(b,function(b){b.set("disabled",a)});t[a?"add":"remove"](this._interval.domNode,"dijitTextBoxDisabled")},_setSortAttr:function(a){this.sortAttribute=a},_setSortDescendingAttr:function(a){this.sortDescending=a},_getSelectionAttr:function(){var a=
this._grid.selection,b;for(b in a)if(a.hasOwnProperty(b))break;return b&&this._grid.row(b).data},_setGalleryTemplateAttr:function(a){q.isDefined(a)&&(this._galleryTemplate=a)},_setFormatThumbnailAttr:function(a){q.isDefined(a)&&"function"==typeof a&&(this._formatThumbnail=a)},_setFormatItemTitleAttr:function(a){q.isDefined(a)&&"function"==typeof a&&(this._formatItemTitle=a)},_setItemsPerPageAttr:function(a){this._set("itemsPerPage",a)},_setPagingLinksAttr:function(a){this._set("pagingLinks",a)},_setCategoryTypeAttr:function(a){this._set("categoryType",
a)},_getQueryAttr:function(){return this._grid&&this._grid.get("query")},_setQueryAttr:function(a){this._grid&&(this._grid.set("query",a),this.reset())},_setSelectedCategoryAttr:function(a){this._set("selectedCategory",a)},_setClosePopupPerRowAttr:function(a){this._set("closePopupPerRow",a)},_setExtentAttr:function(a){a&&this._set("extent",this._extentToString(a))},_setUseExtentAttr:function(a){this._set("useExtent",a)},_setFetchTimeoutAttr:function(a){this._set("fetchTimeout",a)},_validate:function(){return!!this.get("selection")},
reset:function(){this._grid&&(this._categorySelect&&(this._categorySelect.reset(),this.get("selectedCategory")?(this._origQuery=null,this._categorySelect.set("value",this.get("selectedCategory"))):(this._origQuery=null,this._categorySelect.set("value",this.categories[0].value))),e(".esriSearchBox",v.byId(this.id+"_search")).forEach(function(a){n.set(a,"value","")}))},_showPopup:function(a){if(!this._isInsideTooltipDialog){this._closePopup();var b=this._grid.row(a),c=e("img",b.element)[0];(b={summary:b.data.snippet},
b.summary)&&(this._tooltip=new F({content:d.replace(this._popupTemplate,b),onMouseEnter:d.hitch(this,function(){this._isInsideTooltipDialog=!0}),onMouseLeave:d.hitch(this,function(){this._isInsideTooltipDialog=!1;this._closePopup(a)})}),x.open({className:"esriBrowsePopupCtr",popup:this._tooltip,around:c,orient:["after-centered","before-centered"]}),this._onCloseConnect=e(".dijitDialogCloseIcon",this._tooltip.domNode).on("click",d.hitch(this,function(a){a.preventDefault();this._closePopup()})))}},
_closePopup:function(){this._tooltip&&(this._onCloseConnect.remove(),x.close(this._tooltip),this._tooltip.destroyRecursive(),this._tooltip=this._onCloseConnect=void 0)},_clearQueryTimeout:function(){clearTimeout(this._queryTimer)},_createGrid:function(){var a=m([G,H,J,T,I]),b=new L(new X({portal:this._portal})),c=this._currentFilter,h=d.hitch(this,function(a){a.snippet=a.snippet||"";var b=K("div");a=B.substitute(this._galleryTemplate,{item:a,i18n:this.i18n},null,this);return D.place(a,b),b}),f={};
this.get("useExtent")&&(f.extent=this.get("extent"),f.useExtent=this.get("useExtent"));this._grid=new a({store:b,className:"dgrid-autoheight",query:c,selectionMode:"single",pagingLinks:this.get("pagingLinks")||2,rowsPerPage:this.get("itemsPerPage")||6,loadingMessage:"Loading items...",showLoadingMessage:!1,renderRow:h,noDataMessage:this.i18n.noItemsToDisplay,sort:[{attribute:"title"}],queryOptions:f},this.id+"_grid");this._grid.startup();this.categories&&0<this.categories.length&&(this._categorySelect=
new Q({options:this.categories,sortByLabel:!1,"class":"categorySelect"},this.id+"_categorySelect"),this.own(this._categorySelect.on("change",d.hitch(this,function(a){var b;this._closePopup();this._origQuery||(this._origQuery=this._grid.get("query"));b=this._origQuery;a&&(b+=" AND ("+this.get("categoryType")+":"+a+")");this._fetchItems(b)}))));this.own(this._grid.on(z.enterRow,d.hitch(this,function(a){this._showPopup(a)})),this._grid.on(z.leaveRow,d.hitch(this,function(a){this.get("closePopupPerRow")&&
this._closePopup(a)})),u(e(".dgrid-footer,.dgrid-header",this._grid.domNode),E.leave,d.hitch(this,function(a){this._closePopup(a)})),this._grid.on("dgrid-refresh-complete",d.hitch(this,function(a){this._closePopup(a);e(".dgrid-footer",this.domNode)[this._grid._total<=this._grid.rowsPerPage?"addClass":"removeClass"]("hide")})),this._grid.on("refresh",d.hitch(this,function(){this._img_connect&&(this._img_connect.remove(),this._img_connect_error.remove(),this._img_connect=null,this._img_connect_error=
null);this._img_connect=e(".grid-item-thumb",this._grid.domNode).on("load",d.hitch(this,function(a){(a=this._grid.row(a))&&a.element&&e(".grid-item",a.element).addClass("fadeIn").style("opacity","1")}));this._img_connect_error=e(".grid-item-thumb",this._grid.domNode).on("error",d.hitch(this,function(a){n.set(a.target,"src",this._portal.staticImagesUrl+"/desktopapp.png")}))})),this._grid.on("dgrid-select,dgrid-deselect",d.hitch(this,function(){var a={selection:this.get("selection")};this.emit("select-change",
a)})),u(v.byId(this.id+"_search"),"keyup",d.hitch(this,function(a){a.preventDefault();this._closePopup();this._clearQueryTimeout();this._queryTimer=setTimeout(d.hitch(this,function(){this._fetchItems(this._currentFilter,n.get(a.target,"value"))}),this.searchKeypressDelay||250)})),this.watch("extent",d.hitch(this,function(){this._grid.queryOptions.extent=this.get("extent");this._grid.queryOptions.useExtent=this.get("useExtent");this._grid.refresh()})),this.watch("useExtent",d.hitch(this,function(a,
b,c){this._grid.queryOptions.extent=this.get("extent");this._grid.queryOptions.useExtent=c;this._grid.refresh()})))},_fetchData:function(){return this._user=this._portal.getPortalUser(),this.plugIn.fetchData()},_fetchItems:function(a,b){var c={sort:[{attribute:this.sortAttribute||"title",descending:this.sortDescending||!1}]},h=b?" title:"+b+"* ":"",f=new y;return this.get("extent")&&(c.extent=this.extent),c.useExtent=this.get("useExtent"),setTimeout(d.hitch(this,function(){this._currentFilter=a;this._grid?
this._grid.set("query",this._currentFilter+h,c):this._createGrid();f.resolve(this._grid)}),this.fetchTimeout||60),f},_formatThumbnail:function(a){return"\x3cimg class\x3d'grid-item-thumb' width\x3d'187px' height\x3d'125px' alt\x3d'' src\x3d'"+(a.thumbnailUrl||this._portal.staticImagesUrl+"/desktopapp.png")+"'\x3e"},_formatItemTitle:function(a){return"\x3ch5\x3e"+(a.title||a.name||"\x3cNo Title\x3e")+"\x3c/h5\x3e"},clear:function(){this._grid.clearSelection()},doProject:function(a,b){var c,d,f,e,k,
g=[102113,102100,3857],l=new y;return f=function(a,b){!(a&&0<a.length&&a[0]&&"extent"==a[0].type)||isNaN(a[0].xmin)||isNaN(a[0].ymin)||isNaN(a[0].xmax)||isNaN(a[0].ymax)?a&&0<a.length&&a[0]&&"point"==a[0].type&&!isNaN(a[0].x)&&!isNaN(a[0].y)&&l.resolve(a,b):l.resolve(a,b)},null!=a.spatialReference.wkid&&4326==a.spatialReference.wkid&&null!=b.wkid&&this.contains(g,b.wkid)?(a.ymin=Math.max(a.ymin,-89.99),a.ymax=Math.min(a.ymax,89.99),c=r.geographicToWebMercator(a),d=c.spatialReference._getInfo(),d&&
c.xmin>c.xmax&&(e=d.valid[1]-c.xmin,k=c.xmax-d.valid[0],e>k?c.xmax=d.valid[1]+k:c.xmin=d.valid[0]-e),c.spatialReference.wkid=b.wkid,l.resolve([c])):null!=a.spatialReference.wkid&&this.contains(g,a.spatialReference.wkid)&&null!=b.wkid&&4326==b.wkid?(c=r.webMercatorToGeographic(a),d=c.spatialReference._getInfo(),d&&c.xmin>c.xmax&&(e=d.valid[1]-c.xmin,k=c.xmax-d.valid[0],e>k?c.xmax=d.valid[1]+k:c.xmin=d.valid[0]-e),l.resolve([c])):(this.geometryService||(this.geometryService=new W(V.defaults.geometryService)),
this.geometryService.project([a],b,f)),l},contains:function(a,b){for(var c=a.length;c--;)if(a[c]===b)return!0;return!1},_extentToGCS:function(a){return a=a.shiftCentralMeridian(!0),r.webMercatorToGeographic(a)},_extentToString:function(a){var b="";return null!=a&&(a=this._extentToGCS(a),b=this._roundValue(a.xmin,1E4)+","+this._roundValue(a.ymin,1E4)+","+this._roundValue(a.xmax,1E4)+","+this._roundValue(a.ymax,1E4)),b},_roundValue:function(a,b){return Math.round(a*b)/b}});return C("extend-esri")&&
d.setObject("dijit.BrowseItems",p,U),p});