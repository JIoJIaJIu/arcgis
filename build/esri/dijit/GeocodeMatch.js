//>>built
define("esri/dijit/GeocodeMatch","require dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/dom-construct dojo/dom-style dojo/Evented dojo/on dojo/uacss dijit/_WidgetBase dijit/Menu dijit/MenuItem dgrid/OnDemandGrid dgrid/Selection dgrid/Keyboard dgrid/extensions/DijitRegistry dgrid/extensions/ColumnResizer dgrid/extensions/ColumnHider dojo/store/Memory ../kernel ../graphic ../InfoTemplate ../SpatialReference ../geometry/webMercatorUtils ../geometry/Extent ../geometry/Point ../layers/GraphicsLayer ../symbols/PictureMarkerSymbol ../tasks/locator ../tasks/AddressCandidate dijit/layout/BorderContainer dijit/layout/ContentPane dojo/i18n!../nls/jsapi ./GeocodeMatch/Popup".split(" "),
function(p,r,e,C,h,l,t,q,m,D,E,F,y,G,H,I,J,K,L,u,M,n,N,S,z,A,O,P,v,w,x,Q,B,f,R){q=r([E,q],{loaded:!1,singleLineInput:!0,_mapClickPause:!1,_defaultLocatorURL:"http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer",_customLocator:!1,_hasCustomPoint:!1,_hasDefaultPoint:!1,constructor:function(a){r.safeMixin(this,a);this.map&&(this.geocoder?(this._locator=new w(this.geocoder),this._customLocator=!0):(this._locator=new w(this._defaultLocatorURL),this._customLocator=!1),this._columns=[{label:"",
field:"matched",resizable:!1,formatter:function(a){return a},get:e.hitch(this,function(a){return a.matched?"\x3cimg src\x3d'"+p.toUrl("./GeocodeMatch/images/EsriGreenPinCircle26.png")+"' /\x3e":""})},{label:f.widgets.geocodeMatch.match.columnLabelAddress,field:"address",formatter:function(a){return a},get:e.hitch(this,function(a){var b="";return b="object"==typeof a.address?a.Match_Addr?a.Match_Addr:"":a.address,"DefaultMatch"===a.Addr_type||"Custom"===a.Addr_type?a.matched?f.widgets.geocodeMatch.popup.matchButtonLabel:
b+" ("+f.widgets.geocodeMatch.popup.matchButtonLabel+")":b})},{label:f.widgets.geocodeMatch.match.columnLabelType,field:"Addr_type",formatter:function(a){return a},get:e.hitch(this,function(a){var b,d=a.Addr_type;return"DefaultMatch"===a.Addr_type||"Custom"===a.Addr_type?"":(b=/([A-Z])([A-Z])([a-z])|([a-z])([A-Z])/g,d.replace(b,"$1$4 $2$3$5"))})},{label:f.widgets.geocodeMatch.match.columnLabelScore,field:"score",hidden:!0,formatter:function(a){return a},get:e.hitch(this,function(a){return 0<a.score&&
100>=a.score?a.score:" "})}],this.suggestionGraphic||(this.suggestionGraphic=new v(p.toUrl("./GeocodeMatch/images/EsriBluePinCircle26.png"),26,26),this.suggestionGraphic.setOffset(0,12)),this.matchGraphic||(this.matchGraphic=new v(p.toUrl("./GeocodeMatch/images/EsriGreenPinCircle26.png"),26,26),this.matchGraphic.setOffset(0,12)),this.highlightGraphic||(this.highlightGraphic=new v(p.toUrl("./GeocodeMatch/images/EsriYellowPinCircle26.png"),26,26),this.highlightGraphic.setOffset(0,12)))},postCreate:function(){this.inherited(arguments);
var a,c,b,d,k,g=this.map;a=this.graphicsLayer=new P;c=this._infoTemplate=new N;c.setTitle(null);c.setContent(e.hitch(this,this._getInfoTemplateContent));a.setInfoTemplate(c);g.addLayer(a);this._createContainerNodes();this._createGridMenu();c=r([G,J,H,I,K,L]);this.store=new u({data:"",idProperty:f.widgets.geocodeMatch.idProperty});k=this.grid=new c({store:this.store,sort:"sort",noDataMessage:f.widgets.geocodeMatch.match.noDataMsg,selectionMode:"extended",allowSelectAll:!0,cellNavigation:!1,columns:this._columns},
this._gridRef);this.resize();this._listenerHandles=[m(window,"resize",e.hitch(this,function(){this.resize()})),m(k,"dgrid-deselect",e.hitch(this,function(){this.currentSelectedRow=this.currentSelectedRowId=null})),m(k,"dgrid-select",e.hitch(this,function(d){h.forEach(a.graphics,e.hitch(this,function(b){b.attributes&&b.attributes.type===f.widgets.geocodeMatch.customLabel&&!1===b.attributes.matched&&(a.remove(b),g.infoWindow.hide())}));b=d.rows[0].data.location;this.currentSelectedRowId=d.rows[0].data.id;
this.currentSelectedRow=d.rows[0].data;g.centerAt(b).then(e.hitch(this,function(){g.infoWindow.setFeatures([a.graphics[this.currentSelectedRowId]]);g.infoWindow.show(b)}))})),m(g,"click",e.hitch(this,function(c){this._mapClickPause||(h.forEach(a.graphics,e.hitch(this,function(b){b.attributes&&b.attributes.type===f.widgets.geocodeMatch.customLabel&&!1===b.attributes.matched&&(a.remove(b),g.infoWindow&&g.infoWindow.hide())})),c.graphic?c.graphic.attributes&&c.graphic.attributes.id&&(k.clearSelection(),
k.select(c.graphic.attributes.id)):this.lastAddress&&(k.clearSelection(),b=new O(c.mapPoint.x,c.mapPoint.y,g.spatialReference),d=new n(b,this.highlightGraphic),d.setAttributes({type:f.widgets.geocodeMatch.customLabel,matched:!1,featureType:this.featureType}),a.add(d),g.infoWindow.setFeatures([d]),g.infoWindow.show(b)))}))];this.resize()},startup:function(){this.inherited(arguments);this.grid.startup();this.resize();this.map.loaded?(this.loaded=!0,this.emit("load",{})):m(this.map,"load",e.hitch(this,
function(){this.loaded=!0;this.emit("load",{})}))},updateLocatorURL:function(a){this._locator=new w(a)},geocodeAddress:function(a){this._resetMapState();this._resetAppState();var c,b,d,k=this.grid,g=new C;switch(typeof a){case "string":c=a;b={address:{SingleLine:c},outFields:["*"]};this.singleLineInput=!0;break;case "object":if(a.id&&(this.featureID=a.id),a.featureType&&(this.featureType=a.featureType),a.address)switch(typeof a.address){case "string":c=a.address;b={address:{SingleLine:c},outFields:["*"]};
this.singleLineInput=!0;break;case "object":Object.keys||(a.address,Object.keys=function(a){var b,d=[];for(b in a)a.hasOwnProperty(b)&&d.push(b);return d}),a.address.CountryCode&&a.address.Address&&2===Object.keys(a.address).length?(c=a.address.Address,b={address:{SingleLine:a.address.Address,CountryCode:a.address.CountryCode},outFields:["*"]},this.singleLineInput=!0):a.address.CountryCode&&2===Object.keys(a.address).length?(c=a.address,b={address:{SingleLine:a.address,CountryCode:a.address.CountryCode},
outFields:["*"]},this.singleLineInput=!0):(c=a.address,b={address:c,outFields:["*"]},this.singleLineInput=!1)}}return a.sourceCountry&&(b.address.CountryCode=a.sourceCountry),k.noDataMessage=f.widgets.geocodeMatch.popup.loadingPH,k.refresh(),this._locator.outSpatialReference=this.map.spatialReference,this._locator.addressToLocations(b).then(e.hitch(this,function(b){var e,h;for(e=0;e<b.length;e++)b[e].id=e,b[e].featureID=this.featureID,b[e].matched=!1,b[e].sort=e+2,b[e].Addr_type=b[e].attributes.Addr_type,
b[e].Match_addr=b[e].attributes.Match_addr,b[e].featureType=a.featureType;a.location?(!1===a.reviewed&&(h=b.length,this.currentMatch=h,this._hasDefaultPoint=!0,this.defaultGeometry=a.location,this.defaultGeometry.spatialReference.wkid!==this.map.spatialReference.wkid&&(this.defaultGeometry=z.geographicToWebMercator(this.defaultGeometry)),d=new x({id:h,address:c,Addr_type:f.widgets.geocodeMatch.match.defaultMatchType,location:this.defaultGeometry,featureID:this.featureID,featureType:a.featureType,
matched:!0,score:-1,sort:0}),b.push(d)),!0===a.reviewed&&(h=b.length,this.currentMatch=h,this._hasCustomPoint=!0,this.defaultGeometry=a.location,this.defaultGeometry.spatialReference.wkid!==this.map.spatialReference.wkid&&(this.defaultGeometry=z.geographicToWebMercator(this.defaultGeometry)),d=new x({id:h,address:c,Addr_type:f.widgets.geocodeMatch.customLabel,location:this.defaultGeometry,featureID:this.featureID,featureType:a.featureType,matched:!0,score:-1,sort:0}),b.push(d))):this.defaultGeometry=
null;this.store=new u({data:b});k.set("store",this.store);this._updateMapGraphics();this.lastGeocodeResults=b;this.lastAddress=c;g.resolve(b);k.noDataMessage="No Results.";k.refresh()}),function(){}),g.promise},pauseMapEvents:function(){this._mapClickPause=!0},resumeMapEvents:function(){this._mapClickPause=!1},refresh:function(){this.grid.refresh();this.matchWidgetBorderContainer.refresh();this.matchWidgetContentPane1.refresh();this.matchWidgetContentPane2.refresh()},resize:function(){this.matchWidgetBorderContainer.resize();
this.matchWidgetContentPane1.resize();this.matchWidgetContentPane2.resize();this.grid&&this.grid.resize()},destroy:function(){h.forEach(this._listenerHandles,function(a){a.remove()});this.Popup&&(this.Popup.destroy(),this.Popup=null);this.grid&&this.grid.destroy();this.store=this._columns=this.grid=null;this._gridMenuRef&&l.empty(this._gridMenuRef);this.gridMenu=null;this.map&&(this.map.infoWindow.clearFeatures(),this.map.infoWindow.hide(),this.map.removeLayer(this.graphicsLayer));this.map=this.graphicsLayer=
this._infoTemplate=this._locator=null;this.inherited(arguments)},reset:function(){this._resetAppState();this._resetMapState()},_matchCustomFeature:function(a){var c,b;!0===this._hasCustomPoint&&(h.forEach(this.store.data,e.hitch(this,function(a){a.Addr_type===f.widgets.geocodeMatch.customLabel&&this.store.data.splice(h.indexOf(this.store.data,a),1)})),h.forEach(this.graphicsLayer.graphics,e.hitch(this,function(a){a.attributes&&a.attributes.type===f.widgets.geocodeMatch.customLabel&&(a.attributes.matched=
!1)})),this.graphicsLayer.remove(this.graphicsLayer.graphics[this.currentMatch]),this.currentMatch=null);b=this.store.data.length;c=new x({id:b,Addr_type:f.widgets.geocodeMatch.customLabel,address:this.lastAddress,matched:!1,location:a.geometry,score:-1,sort:1,graphicSymbol:a.symbol});a.attributes.id=b;a.attributes.matched=!0;this.store.data.push(c);this._hasCustomPoint=!0;this._matchFeature(b)},_matchFeature:function(a){var c=this.store.data,b=this.graphicsLayer.graphics,d=this.currentMatch;null===
d?(c[a].matched=!0,!1!==this.map&&(b[a].attributes.matched=!0,b[a].attributes.id=a,b[a].setSymbol(this.matchGraphic),b[a].getDojoShape().moveToFront())):(c[a].matched=!0,c[d].matched=!1,b[d].attributes.matched=!1,b[d].setSymbol(this.suggestionGraphic),b[a].attributes.matched=!0,b[a].attributes.id=a,b[a].setSymbol(this.matchGraphic),b[a].getDojoShape().moveToFront(),b[d].attributes.type===f.widgets.geocodeMatch.customLabel&&b[a].attributes.type!==f.widgets.geocodeMatch.customLabel&&(this.graphicsLayer.remove(b[d]),
c.splice(h.indexOf(c,c[d]),1),this._hasCustomPoint=!1));this.currentMatch=a;this.emit("match",{id:a,featureID:this.featureID,address:this.lastAddress,oldLocation:this.defaultGeometry,featureType:this.featureType,newLocation:c[a].location,graphicSymbol:this.matchGraphic});this.grid.refresh()},_updateMapGraphics:function(){var a,c,b,d=this.store.data,f=this.suggestionGraphic,g=[];this.graphicsLayer.clear();1===d.length?(a=!0===d[0].matched?new n(d[0].location,this.matchGraphic):new n(d[0].location,
f),a.setAttributes({id:0,matched:d[0].matched,type:d[0].Addr_type}),g.push(a)):1<d.length&&h.forEach(d,e.hitch(this,function(b){a=!0===b.matched?new n(b.location,this.matchGraphic):new n(b.location,f);a.setAttributes({id:b.id,matched:b.matched,type:b.Addr_type});g.push(a)}));0!==d.length&&(c=this._calcGraphicsExtent(g),this.map.setExtent(c,!0).then(e.hitch(this,function(){for(b=0;b<g.length;b++)this.graphicsLayer.add(g[b])})));h.forEach(this.graphicsLayer.graphics,e.hitch(this,function(a){a.attributes&&
!0===a.attributes.matched&&a.getDojoShape().moveToFront()}))},_getInfoTemplateContent:function(a){return this.Popup=new R({geocodeMatch:this,geocodeAddress:this.lastAddress,rowData:this.store.data[a.attributes.id],map:this.map,graphicsLayer:this.graphicsLayer,graphic:a},l.create("div")),this.Popup.domNode},_createContainerNodes:function(){var a,c,b;t.set(this.domNode,"position","relative");t.set(this.domNode,"height","100%");t.set(this.domNode,"width","100%");a=this.matchWidgetBorderContainer=new Q({"class":"esriMatchContainer",
style:"height: 100%; width: 100%;",gutters:!1});c=this.matchWidgetContentPane1=new B({region:"top",style:"width: 100%; height: 30px;","class":"esriMatchHeader"});b=this.matchWidgetContentPane2=new B({region:"center",style:"width: 100%; height: 100%;"});this._gridMenuLeftSpanRef=l.create("span",{"class":"esriMatchTitle",innerHTML:f.widgets.geocodeMatch.gridTitle},c.domNode);this._gridMenuRightRef=l.create("div",{"class":"esriMatchOptions"},c.domNode);this._gridMenuRightSpanRef=l.create("span",{innerHTML:f.widgets.geocodeMatch.match.tableOptionsLabel},
this._gridMenuRightRef);this._gridMenuRightArrowRef=l.create("div",{"class":"esriSpriteArrow"},this._gridMenuRightRef);this._gridRef=l.create("div",{},b.domNode);a.addChild(c);a.addChild(b);a.placeAt(this.domNode);a.startup();this.resize()},_createGridMenu:function(){this.gridMenu=new F({targetNodeIds:[this._gridMenuRightRef],leftClickToOpen:"true"});this.gridMenu.addChild(new y({label:f.widgets.geocodeMatch.match.mapAllCandidatesLabel,onClick:e.hitch(this,function(){this._resetMapState();this._updateMapGraphics()})}));
this.gridMenu.addChild(new y({label:f.widgets.geocodeMatch.match.defaultSortOrderLabel,onClick:e.hitch(this,function(){this.grid.set("sort","sort")})}));this.gridMenu.startup()},_formatGeocodeResults:function(a){var c,b="";if("object"==typeof a){for(c in a)a.hasOwnProperty(c)&&(b+=a[c]+" ");a=b}else a=a.address&&"string"==typeof a.address?a.address:a;return a},_resetMapState:function(){this.Popup&&(this.Popup.map.infoWindow.hide(),this.Popup.map.infoWindow.clearFeatures());this.grid.clearSelection();
this.graphicsLayer.clear()},_resetAppState:function(){this.currentSelectedRow=this.lastGeocodeResults=this.lastAddress=this.currentMatch=null;this.store.data=null;this.store=new u({data:""});this.defaultGeometry=null;this._hasDefaultPoint=this._hasCustomPoint=!1;this.grid.noDataMessage="No Results.";this.grid.refresh()},_calcGraphicsExtent:function(a){var c,b,d=a[0].geometry,e=d.getExtent(),f=a.length;null===e&&(e=new A(d.x,d.y,d.x,d.y,d.spatialReference));for(b=1;f>b;b++)d=a[b].geometry,c=d.getExtent(),
null===c&&(c=new A(d.x,d.y,d.x,d.y,d.spatialReference)),e=e.union(c);return e}});return D("extend-esri")&&e.setObject("dijit.GeocodeMatch",q,M),q});