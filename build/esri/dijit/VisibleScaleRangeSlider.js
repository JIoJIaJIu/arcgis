//>>built
define("esri/dijit/VisibleScaleRangeSlider","../kernel ./_EventedWidget ./_Tooltip ./VisibleScaleRangeSlider/_RecommendedScaleRangeBounds ./VisibleScaleRangeSlider/_SlideEvent ./VisibleScaleRangeSlider/ScaleMenu ./VisibleScaleRangeSlider/ScalePreview ./VisibleScaleRangeSlider/ScaleRanges dijit/form/DropDownButton dijit/popup dojo/_base/array dojo/_base/lang dojo/aspect dojo/debounce dojo/Deferred dojo/dom-class dojo/dom-construct dojo/dom-geometry dojo/dom-style dojo/has dojo/on dojo/string dojox/form/HorizontalRangeSlider dojo/i18n!../nls/jsapi".split(" "),
function(r,e,t,u,v,l,w,m,n,h,x,d,g,y,z,A,p,k,B,C,D,E,F,G){e=e.createSubclass([t],{declaredClass:"esri.dijit.VisibleScaleRangeSlider",baseClass:"esriVisibleScaleRangeSlider",css:{currentScaleIndicator:"esriCurrentScaleIndicator",currentScaleIndicatorContainer:"esriCurrentScaleIndicatorContainer",scaleIndicator:"esriScaleIndicator",scaleIndicatorContainer:"esriScaleIndicatorContainer"},map:null,layer:null,region:"en-US",minScale:0,maxScale:0,intermediateChanges:!1,labels:G.widgets.visibleScaleRangeSlider,
_slider:null,_currentScaleIndicator:null,_scalePreview:null,_maxScaleButton:null,_minScaleButton:null,_mapUpdateHandler:null,_scaleRanges:null,_scheduleScaleRangeChangeEmit:null,_getSliderIndexRange:function(a){a=Math.floor(a);return{min:a,max:a+.99999}},_setMapAttr:function(a){this._set("map",a);this._mapUpdateHandler&&this._mapUpdateHandler.remove();this._slider.set("disabled",!0);this._ensureMapIsReady().then(this._updateFromMap)},_updateFromMap:function(a){var b,c=a.getMinScale(),q=a.getMaxScale();
this._slider.set("disabled",!1);this._scaleRanges.set("scaleRangeBounds",{minScale:c,maxScale:q});b=this._getSliderIndexRange(this._scaleRanges.length-1);this._slider.set("maximum",b.max);this._silentSliderUpdate({maxScale:q,minScale:c});this._updateCurrentScaleIndicator();a=a.on("zoom-end",d.hitch(this,function(){this._updateCurrentScaleIndicator()}));this.own(a);this._mapUpdateHandler=a},_ensureMapIsReady:function(){return this._ensureLoadedResource(this.map)},_ensureLoadedResource:function(a){var b=
new z;return a?a.loaded?b.resolve(a):a.on("load",function(){b.resolve(a)}):b.reject(Error("could not load resource")),b.promise},_updateCurrentScaleIndicator:function(){var a=this._scaleRanges.clampScale(this.map.getScale()),a=this._mapScaleToSlider(a)/this._slider.maximum;this.isLeftToRight()||(a=1-a);B.set(this._currentScaleIndicator,{left:100*a+"%"})},_setLayerAttr:function(a){this._set("layer",a);this._ensureMapIsReady().then(this._ensureLayerIsReady).then(this._updateMinMaxScaleFromLayer)},_ensureLayerIsReady:function(){return this._ensureLoadedResource(this.layer)},
_updateMinMaxScaleFromLayer:function(a){this.set({minScale:a.minScale,maxScale:a.maxScale})},_mapSliderToScale:function(a){var b=this._getSliderIndexRange(a),c=this._scaleRanges.findScaleRangeByIndex(a);return this._mapToRange(a,b.min,b.max,c.minScale,c.maxScale)},_mapToRange:function(a,b,c,d,f){return d+(a-b)*(f-d)/(c-b)},_setRegionAttr:function(a){this._set("region",a);this._scalePreview.set("source",m.getScalePreviewSource(a))},_getMinimumAttr:function(){return this._mapSliderToScale(this._slider.minimum)},
_getMaximumAttr:function(){return this._mapSliderToScale(this._slider.maximum)},_getActualMaxScaleAttr:function(){return this._scaleRanges.clampMaxScale(this.maxScale)},_setMaxScaleAttr:function(a){this._set("maxScale",a);this._ensureMapIsReady().then(d.hitch(this,function(){a=this._scaleRanges.clampMaxScale(a);this._set("maxScale",this._layerConstrainedMaxScale(a));this._silentSliderUpdate({maxScale:a});this._scheduleScaleRangeChangeEmit()}))},_silentSliderUpdate:function(a){var b,c,d=a.minScale;
a=a.maxScale;var f=this._scaleRanges,e=this._slider;void 0!==d&&(b=this._mapScaleToSlider(f.clampMinScale(d)),e.set("value",b,!1,!1));void 0!==a&&(c=this._mapScaleToSlider(f.clampMaxScale(a)),e.set("value",c,!1,!0))},_mapScaleToSlider:function(a){var b=this._scaleRanges.scaleToRangeIndex(a),c=this._getSliderIndexRange(b),b=this._scaleRanges.findScaleRangeByIndex(b);return this._mapToRange(a,b.minScale,b.maxScale,c.min,c.max)},_getActualMinScaleAttr:function(){return this._scaleRanges.clampMinScale(this.minScale)},
_setMinScaleAttr:function(a){this._set("minScale",a);this._ensureMapIsReady().then(d.hitch(this,function(){a=this._scaleRanges.clampMinScale(a);this._set("minScale",this._layerConstrainedMinScale(a));this._silentSliderUpdate({minScale:a});this._scheduleScaleRangeChangeEmit()}))},_emitScaleRangeChange:function(){this.emit("scale-range-change",{minScale:this.minScale,maxScale:this.maxScale})},_layerConstrainedMinScale:function(a){var b,c=d.getObject("tileInfo.lods",!1,this.layer)||[];return 0<c.length?
(b=c[0].scale,a>b?b:a):this._scaleRanges.beyondMinScale(a)?0:a},_layerConstrainedMaxScale:function(a){var b,c=d.getObject("tileInfo.lods",!1,this.layer)||[];return 0<c.length?(b=c[c.length-1].scale,b>a?b:a):this._scaleRanges.beyondMaxScale(a)?0:a},constructor:function(){this._scaleRanges=new (m.createSubclass([u]));this._scheduleScaleRangeChangeEmit=y(d.hitch(this,this._emitScaleRangeChange),0);this._ensureMapIsReady=d.hitch(this,this._ensureMapIsReady);this._ensureLayerIsReady=d.hitch(this,this._ensureLayerIsReady);
this._updateMinMaxScaleFromLayer=d.hitch(this,this._updateMinMaxScaleFromLayer);this._updateFromMap=d.hitch(this,this._updateFromMap)},buildRendering:function(){this.inherited(arguments);this._initSlider();this._initScalePreview();this._initScaleIndicators();this._initScaleMenus()},_initSlider:function(){var a=new (F.createSubclass([v]))({baseClass:"esriHorizontalSlider",showButtons:!1,intermediateChanges:this.intermediateChanges,disabled:!0});this._slider=a;a.placeAt(this.domNode);a.startup();this.own(a.on("slide-onmousemove, slidemax-onmousemove",
d.hitch(this,function(a){this._updateScalePreview(a.movable.handle)})),a.on("slide-onmovestop, slidemax-onmovestop",d.hitch(this,function(a){A.contains(a.movable.handle,"dijitSliderThumbHover")||this._closeScalePreview()})),a.on("change",d.hitch(this,function(){var a=Math.round(this._mapSliderToScale(this._getSliderMin())),c=Math.round(this._mapSliderToScale(this._getSliderMax()));this.set("minScale",a);this.set("maxScale",c)})),g.after(a,"_setValueAttr",d.hitch(this,this._updateLabelMenus)))},_getSliderMin:function(){var a=
this._slider.get("value");return this.isLeftToRight()?a[0]:a[1]},_getSliderMax:function(){var a=this._slider.get("value");return this.isLeftToRight()?a[1]:a[0]},_updateLabelMenus:function(){var a=this._maxScaleButton;this._minScaleButton.set("label",this._scaleRanges.getScaleRangeLabel(this._getSliderMin()));a.set("label",this._scaleRanges.getScaleRangeLabel(this._getSliderMax()))},_initScalePreview:function(){var a=new w;a.startup();h.moveOffScreen(a);x.forEach([this._slider._movable.handle,this._slider._movableMax.handle],
function(a){a.onmouseenter=d.hitch(this,function(){this._updateScalePreview(a)});a.onmouseleave=d.hitch(this,function(){this._closeScalePreview()})},this);this.own(a);this._scalePreview=a},_closeScalePreview:function(){h.close(this._scalePreview)},_updateScalePreview:function(a){var b,c,d=this._slider,f=this._scalePreview;b=a===d.sliderHandle?this._getSliderMin():this._getSliderMax();var e=k.position(a);c=k.position(f.domNode);var d=k.position(d.sliderBarContainer),g=this.isLeftToRight();f.set("backgroundPosition",
this._scaleRanges.getScalePreviewSpriteBackgroundPosition(b));b=e.x-d.x;c=.5*c.w;h.open({parent:this,popup:f,around:a,orient:c>b?g?["above","below"]:["above-alt","below-alt"]:b<d.w-c?["above-centered","below-centered"]:g?["above-alt","below-alt"]:["above","below"]})},_initScaleIndicators:function(){var a=p.create("div",{className:this.css.scaleIndicatorContainer+" "+this.css.currentScaleIndicatorContainer},this._slider.sliderBarContainer),b=p.create("div",{className:this.css.scaleIndicator+" "+this.css.currentScaleIndicator},
a);this._currentScaleIndicator=b;this.createTooltip(b);a=D(b,"mouseover",d.hitch(this,function(){var a=E.substitute(this.labels.currentScaleTooltip,{scaleLabel:this._scaleRanges.getScaleRangeLabel(this._mapScaleToSlider(this.map.getScale()))});this.findTooltip(b).set("label",a)}));this.own(a)},_initScaleMenus:function(){var a,b,c=new l,e=new l;this.own(c.on("scale-selected",d.hitch(this,function(b){a.closeDropDown();this.set("minScale",b.scale)})));this.own(e.on("scale-selected",d.hitch(this,function(a){b.closeDropDown();
this.set("maxScale",a.scale)})));a=new n({baseClass:"esriScaleMenuButton esriMinScaleMenuButton",dropDown:c,dropDownPosition:["below","above"]});a.toggleDropDown();a.toggleDropDown();b=new n({baseClass:"esriScaleMenuButton esriMaxScaleMenuButton",dropDown:e,dropDownPosition:["below","above"]});b.toggleDropDown();b.toggleDropDown();this.own(g.before(a,"openDropDown",d.hitch(this,function(){var b=this._scaleRanges.findScaleRange(this.get("actualMaxScale")).minScale;c.set("options",{label:a.label,scale:{current:this.get("actualMinScale"),
map:this.map.getScale(),min:this.get("minimum"),max:b}})})));this.own(g.before(b,"openDropDown",d.hitch(this,function(){var a=this._scaleRanges.findScaleRange(this.get("actualMinScale")).maxScale;e.set("options",{label:b.label,scale:{current:this.get("actualMaxScale"),map:this.map.getScale(),min:a,max:this.get("maximum")}})})));a.placeAt(this.domNode);b.placeAt(this.domNode);c.startup();e.startup();a.startup();b.startup();this._minScaleButton=a;this._maxScaleButton=b},startup:function(){this.inherited(arguments);
this.watch("intermediateChanges",function(a,b,c){this._slider.set(a,c)})}});return C("extend-esri")&&d.setObject("dijit.VisibleScaleRangeSlider",e,r),e});