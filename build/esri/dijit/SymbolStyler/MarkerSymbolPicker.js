//>>built
require({cache:{"url:esri/dijit/SymbolStyler/templates/MarkerSymbolPicker.html":'\x3cdiv\x3e\n  \x3cdiv data-dojo-type\x3d"dijit/form/Select" data-dojo-attach-point\x3d"dap_markerCategoryInput" class\x3d"${css.typeInput}"\x3e\x3c/div\x3e\n  \x3cdiv class\x3d"${css.container}" data-dojo-attach-point\x3d"dap_symbolViewport"\x3e\n    \x3cdiv data-dojo-attach-point\x3d"dap_templatePicker"\x3e\x3c/div\x3e\n  \x3c/div\x3e\n\x3c/div\x3e\n'}});
define("esri/dijit/SymbolStyler/MarkerSymbolPicker","../../arcgis/Portal ../../domUtils ../../kernel ../../request ../../symbols/jsonUtils ../_EventedWidget ../_Tooltip ../editing/TemplatePicker ../util/busyIndicator ./symbolUtil dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dojo/_base/array dojo/_base/declare dojo/_base/kernel dojo/_base/lang dojo/Deferred dojo/dom-class dojo/dom-construct dojo/dom-style dojo/promise/all dojo/sniff dojo/store/Memory dojo/store/Observable dojox/gfx dojo/i18n!../../nls/jsapi dojo/text!./templates/MarkerSymbolPicker.html dijit/form/Select".split(" "),function(n,
p,q,u,r,g,v,w,x,y,z,A,k,B,C,c,l,f,e,D,E,m,t,F,G,H,I){g=B("esri.dijit.SymbolStyler.MarkerSymbolPicker",[g,z,A,v],{baseClass:"esriMarkerSymbolPicker",templateString:I,labels:H.widgets.symbolEditor,css:{noSymbols:"esriNoSymbols",defaultSymbols:"esriDefaultSymbols",loadingIndicator:"esriLoadingIndicator",loading:"esriLoading",typeInput:"esriTypeInput",container:"esriContainer",overlay:"esriOverlay",content:"esriContent",centerContainer:"esriCenterContainer",table:"esriTable",tableCell:"esriTableCell",
centerBlock:"esriCenterBlock"},portal:"http://arcgis.com/",displayMode:"portal",_symbolTypesStore:null,_symbolItemStore:null,_noSymbolsOverlay:null,_templatePicker:null,_portal:null,_portalLoadTimeoutInMs:3E3,_loadingIndicator:null,_storageItemKeyBase:"markerSymbolPicker/symbol",_defaultSimpleMarkerSymbols:[{name:"Circle",type:"esriSMS",style:"esriSMSCircle",color:[0,0,128,128],size:18,outline:{color:[0,0,128,255],width:1}},{name:"Square",type:"esriSMS",style:"esriSMSSquare",color:[0,0,128,128],size:18,
outline:{color:[0,0,128,255],width:1}},{name:"Diamond",type:"esriSMS",style:"esriSMSDiamond",color:[0,0,128,128],size:18,outline:{color:[0,0,128,255],width:1}},{name:"Cross",type:"esriSMS",style:"esriSMSCross",color:[0,0,128,128],size:18,outline:{color:[0,0,128,255],width:1}},{name:"X",type:"esriSMS",style:"esriSMSX",color:[0,0,128,128],size:18,outline:{color:[0,0,128,255],width:1}}],postCreate:function(){this.inherited(arguments);this._symbolTypesStore=new F(new t);this._symbolItemStore=new t;this.dap_markerCategoryInput.set({labelAttr:"name",
sortByLabel:!1});this.createTooltip(this.dap_markerCategoryInput,this.labels.selectCategoryTooltip)},_updateTemplatePickerIfHeightless:function(){0===D.get(this._templatePicker.domNode,"height")&&this._templatePicker.update()},startup:function(){this.inherited(arguments);var a=new w({rows:"auto",columns:6,items:[],emptyMessage:""},this.dap_templatePicker);a.startup();this._templatePicker=a;a.on("selection-change",c.hitch(this,function(){var b,d=a.getSelected();d&&(b=y.cloneSymbol(d.item.symbol),this.emit("symbol-select",
{selection:b}))}));this._loadingIndicator=x.create(this.dap_symbolViewport);this.own(this._loadingIndicator);this.dap_markerCategoryInput.on("change",c.hitch(this,function(a){this.clearSelection();this._fetchSymbols(a)}));this._normalizeSymbolStorage();this._loadStoredSymbolItems();this._setUpSymbolCategories().then(c.hitch(this,this.updateDisplay))},_fetchSymbols:function(a){var b,d;return this._templatePicker.items=[],(b=this._symbolItemStore.query({id:a})[0])?(this._saveRecentItem(b),void this._updateSymbolOptions(b.items)):
(d=this._symbolTypesStore.query({id:a}),this._showLoadingIndicator(),void this._getSymbolListData(d).then(c.hitch(this,this._symbolItemsFromJson)).then(c.hitch(this,function(b){var d,c={id:a,items:b};return this._symbolItemStore.put(c),this._saveRecentItem(c),d=this._symbolTypesStore.query({defaultType:!0})[0],d&&d.id===a&&this._saveDefaultItem(c),b})).then(c.hitch(this,this._updateSymbolOptions)))},_saveRecentItem:function(a){a={id:a.id,items:this._symbolItemsToJson(a.items)};sessionStorage.setItem(this._getRecentItemKey(),
JSON.stringify(a))},_getRecentItemKey:function(){return this._toItemKey("/recent")},_toItemKey:function(a){return this._storageItemKeyBase+a},_getDefaultItemKey:function(){return this._toItemKey("/default")},_getTypesItemKey:function(){return this._toItemKey("/types")},_getVersionItemKey:function(){return this._toItemKey("/version")},_saveDefaultItem:function(a){a={id:a.id,items:this._symbolItemsToJson(a.items)};localStorage.setItem(this._getDefaultItemKey(),JSON.stringify(a))},_showNoSymbolsMessage:function(){this._hideLoadingIndicator();
f.add(this.domNode,this.css.noSymbols);this._placeNoSymbolsOverlay()},_placeNoSymbolsOverlay:function(){var a,b,d,c,h;this._noSymbolsOverlay||(h=this.css,a=e.create("div",{"class":h.overlay}),c=e.create("div",{"class":h.centerContainer+" "+h.table},a),d=e.create("div",{"class":h.tableCell},c),b=e.create("div",{"class":h.centerBlock},d),e.create("div",{"class":h.content,innerHTML:this.labels.symbolLoadError},b),e.place(a,this.domNode),this._noSymbolsOverlay=a)},_getStorageVersionKey:function(){return q.version+
"|"+C.locale},_normalizeSymbolStorage:function(){var a=localStorage.getItem(this._getVersionItemKey()),b=this._getStorageVersionKey();a!==b&&(localStorage.setItem(this._getVersionItemKey(),b),localStorage.removeItem(this._getTypesItemKey()),localStorage.removeItem(this._getDefaultItemKey()),sessionStorage.removeItem(this._getRecentItemKey()))},_loadStoredSymbolItems:function(){var a=this._loadDefaultSymbolItem(),b=this._loadRecentSymbolItem();a&&this._symbolItemStore.put(this._symbolItemsFromSymbolItemJson(a));
b&&this._symbolItemStore.put(this._symbolItemsFromSymbolItemJson(b))},_loadDefaultSymbolItem:function(){var a=localStorage.getItem(this._getDefaultItemKey());return a?JSON.parse(a):void 0},_loadRecentSymbolItem:function(){var a=sessionStorage.getItem(this._getRecentItemKey());return a?JSON.parse(a):void 0},_loadSymbolTypes:function(){var a=localStorage.getItem(this._getTypesItemKey());return a?JSON.parse(a):void 0},_saveSymbolTypes:function(a){localStorage.setItem(this._getTypesItemKey(),JSON.stringify(a))},
_symbolItemsFromSymbolItemJson:function(a){return a.items=k.map(a.items,function(a){return{symbol:r.fromJson(a.symbol)}}),a},_fetchSymbolTypes:function(){var a=new l,b=this._loadSymbolTypes();return b?(a.resolve(b),a.promise):this._getSymbolListGroupId().then(c.hitch(this,this._getSymbolListItems)).then(c.hitch(this,function(a){return this._saveSymbolTypes(a),a}))},_setUpSymbolCategories:function(){return this._showLoadingIndicator(),this._initPortal().then(c.hitch(this,this._fetchSymbolTypes)).then(c.hitch(this,
this._setUpSymbolSelect),c.hitch(this,function(){this._showNoSymbolsMessage()}))},_setUpSymbolSelect:function(a){var b,d,c=this._symbolTypesStore;c.setData(a);k.forEach(a,function(a){a.defaultType&&(b=a.id)});(a=this._loadRecentSymbolItem())&&(d=c.query({id:a.id})[0],d&&(b=a.id));this.dap_markerCategoryInput.set("store",c);this.dap_markerCategoryInput.set("value",b,!1)},_showLoadingIndicator:function(){8>=m("ie")?f.add(this.domNode,this.css.loading):this._loadingIndicator.show()},_hideLoadingIndicator:function(){8>=
m("ie")?f.remove(this.domNode,this.css.loading):this._loadingIndicator.hide()},_initPortal:function(){var a,b=new l,d=this.portal||"http://arcgis.com/";return a="string"==typeof d?new n.Portal(d):d.declaredClass?d:new n.Portal({self:d}),a.loaded?(this._portal=a,b.resolve(),b.promise):(this.own(a.on("load",c.hitch(this,function(){this._portal=a;b.resolve()}))),setTimeout(function(){b.reject()},this._portalLoadTimeoutInMs),b.promise)},_getSymbolListGroupId:function(){var a=new l;return this._portal.queryGroups({q:this._portal.symbolSetsGroupQuery}).then(function(b){a.resolve(b.results[0].id)},
function(){a.reject()}),a.promise},_getSymbolListItems:function(a){var b=new l,d=this._portal;a="group:"+a+' AND type:"Symbol Set"';var e=[];return a+="vml"===G.renderer?' AND -typekeywords:"by value"':' AND (typekeywords:"by value" AND typekeywords:"marker")',d.queryItems({q:a,num:20,sortField:"title"}).then(c.hitch(this,function(a){var c,d,f,g;k.forEach(a.results,function(a){c=a.typeKeywords.join(" ");-1<c.indexOf("marker")&&(d=a.title,f={name:d,id:a.id,title:a.title,keywords:c,dataUrl:a.itemDataUrl},
g=-1<c.indexOf("default"),g?(f.defaultType=!0,e.unshift(f)):e.push(f))},this);0<e.length?b.resolve(e):b.reject()}),function(){b.reject()}),b.promise},_getSymbolListData:function(a){a=k.map(a,function(a){return u({url:a.dataUrl}).promise});return E(a).then(function(a){return a[0]})},_symbolItemsFromJson:function(a){return k.map(a,function(a){return{symbol:r.fromJson(a)}})},_symbolItemsToJson:function(a){return k.map(a,function(a){return{symbol:a.symbol.toJson()}})},_updateSymbolOptions:function(a){var b=
this._templatePicker;b.items=a;b.update();b.domNode.parentNode.scrollTop=0;this._hideLoadingIndicator()},_setDisplayModeAttr:function(a){this.displayMode!==a&&(this._set("displayMode",a),this.updateDisplay(a))},updateDisplay:function(){var a=this.dap_markerCategoryInput;this.clearSelection();"portal"===this.displayMode?(this._fetchSymbols(a.value),p.show(a.domNode),f.remove(this.domNode,this.css.defaultSymbols)):"default"===this.displayMode&&(this._updateSymbolOptions(this._symbolItemsFromJson(this._defaultSimpleMarkerSymbols)),
p.hide(a.domNode),f.add(this.domNode,this.css.defaultSymbols))},clearSelection:function(){this._templatePicker.clearSelection()},resetSelection:function(){var a=this.dap_markerCategoryInput,b=a.get("options");a.set("value",b[0]);this.clearSelection()}});return m("extend-esri")&&c.setObject("dijit.SymbolStyler.MarkerSymbolPicker",g,q),g});