//>>built
require({cache:{"url:esri/dijit/editing/templates/TemplatePicker.html":'\x3cdiv class\x3d"templatePicker"\x3e\n\n  \x3ctable dojoType\x3d"dojox.grid.DataGrid" noDataMessage\x3d"${emptyMessage}" selectionMode\x3d"none" autoHeight\x3d"${_rows}" autoWidth\x3d"${_autoWidth}"\n         query\x3d"{ query: \'*\' }" dojoAttachPoint\x3d"grid" class\x3d"grid"\x3e\n  \x3c/table\x3e\n  \n\x3c/div\x3e'}});
define("esri/dijit/editing/TemplatePicker","dojo/_base/declare dojo/_base/lang dojo/_base/connect dojo/_base/html dojo/_base/array dojo/_base/json dojo/_base/kernel dojo/has dojo/query dojo/sniff dojo/dom-class dojo/dom-construct dojo/dom-geometry dojo/dom-style dijit/_Widget dijit/_Templated dojo/data/ItemFileReadStore dojox/grid/DataGrid dojox/gfx ../../layers/FeatureLayer ../../symbols/SimpleMarkerSymbol ../../symbols/PictureMarkerSymbol ../../symbols/SimpleFillSymbol ../../symbols/SimpleLineSymbol ./TemplatePickerItem ../../kernel ../../lang ../../request ../_EventedWidget dojo/i18n!../../nls/jsapi dojo/text!./templates/TemplatePicker.html".split(" "),function(G,
m,k,y,f,z,A,r,T,U,B,C,t,u,H,I,J,K,V,L,D,E,F,M,N,O,v,P,Q,R,S){var x=G([Q,H,I],{declaredClass:"esri.dijit.editing.TemplatePicker",widgetsInTemplate:!0,templateString:S,featureLayers:null,items:null,grouping:!0,showTooltip:!1,maxLabelLength:0,rows:4,_rows:0,columns:3,surfaceWidth:30,surfaceHeight:30,emptyMessage:"",useLegend:!0,legendCache:{},_uniqueId:{id:0},_assumedCellWidth:90,_initialAutoWidth:300,_initialAutoHeight:200,_ieTimer:150,constructor:function(a){a=a||{};a.items||a.featureLayers||console.error("TemplatePicker: please provide 'featureLayers' or 'items' parameter in the constructor");
this._dojo14x=4<=A.version.minor;this._itemWidgets={};a.featureLayers&&a.featureLayers.length&&(this._flChanged=1);this._nls=R.widgets.templatePicker;this.emptyMessage=a.emptyMessage||this._nls&&this._nls.creationDisabled||""},postMixInProperties:function(){this.inherited(arguments);this._preprocess()},startup:function(){if(this.inherited(arguments),"auto"===this.rows&&"auto"===this.columns){var a=t.getContentBox(this.domNode);a.w||(this.domNode.style.width=this._initialAutoWidth+"px");(!a.h||1>=
a.h)&&(this.domNode.style.height=this._initialAutoHeight+"px");a=t.getContentBox(this.domNode);this._columns=Math.floor(a.w/this._assumedCellWidth)||1}this._applyGridPatches();this._setGridLayout();k.connect(this.grid,"onRowClick",this,this._rowClicked);this._setGridData();this._toggleTooltip();9>r("ie")&&(this._repaintItems=m.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this.showTooltip=!1;this._toggleTooltip();this._clearLegendInfo();this.featureLayers=
this.items=this.grid=this._flItems=this._itItems=this._groupRowIndices=this._selectedCell=this._selectedInfo=this._selectedItem=null;this.inherited(arguments)},getSelected:function(){return this._selectedCell?this._selectedItem:null},clearSelection:function(){var a=this._selectedCell,b=this._selectedInfo;a&&this._rowClicked({cellNode:a,rowIndex:b.selRow,cellIndex:b.selCol})},update:function(a){var b;a="auto"===this.rows&&"auto"===this.columns&&a?!0:!1;var d=this.grid;if(a){var c;b=this.domNode;c=
A.query("#"+b.id+".templatePicker div.item")[0];b=t.getContentBox(b);c=(c=c&&c.parentNode)?y.coords(c).w:this._assumedCellWidth;this._columns=(this._columns=Math.floor((b.w-d.views.views[0].getScrollbarWidth())/c))||1}c=this._rows;this._preprocess();var e=this._rows;this._setGridLayout();this._setGridData();e!==c&&d.set("autoHeight",this._rows,!1);a?(d._resize({w:b.w,h:b.h}),d.viewsHeaderNode.style.display="none"):d.update();this._toggleTooltip();var g=this,h=this.getSelected();h&&d.store.fetch({onComplete:function(a){var b=
(a=g._locate(h,g._selectedInfo,a))&&d.views.views[0].getCellNode(a[0],a[1]);b&&g._rowClicked({cellNode:b,rowIndex:a[0],cellIndex:a[1]},!0)}});9>r("ie")&&setTimeout(this._repaintItems,this._ieTimer);b=this.featureLayers;a=this.items;b&&b.length||a&&a.length||!d||!this.emptyMessage||d.showMessage(this.emptyMessage)},_eventMap:{"selection-change":!0},onSelectionChange:function(){},_setUseLegendAttr:function(a){var b=this.useLegend;this._started&&b===a||(a?this._flChanged=1:this._clearLegendInfo());this.useLegend=
a},_setFeatureLayersAttr:function(a){var b=this.featureLayers;this._started&&b===a||(this._flChanged=1);this.featureLayers=a},_adjustRowsCols:function(a){if("auto"===this.rows&&"auto"===this.columns)return void(this._started||(this._rows=!1,this._columns=null,this._autoWidth=!1));var b=0;this._rows=this.rows;this._columns=this.columns;"auto"===this.rows?(this.featureLayers?this.grouping?(b=a.length,f.forEach(a,function(a){b+=Math.ceil(a.length/this.columns)},this)):(f.forEach(a,function(a){b+=a.length},
this),b=Math.ceil(b/this.columns)):b=Math.ceil(a.length/this.columns),this._rows=b):"auto"===this.columns&&(this.featureLayers?this.grouping?b=3:(f.forEach(a,function(a){b+=a.length},this),b=Math.ceil(b/this.rows)):b=Math.ceil(a.length/this.rows),this._columns=b)},_preprocess:function(){this.items&&(this.grouping=!1);this._autoWidth=!1;"auto"!==this.rows&&"auto"!==this.columns||(this._autoWidth=!0);var a;if(this.featureLayers)if(this.useLegend&&this._flChanged&&(this._legendIndices=[],this._loadingIndices=
[],this._legendSymbols={},this._ignoreLegends(),this._loadingLegends=[],clearTimeout(this._legendTimer),this._legendTimer=null,this._processSelectionLayers(),this._flChanged=0),f.every(this.featureLayers,function(a){return a.loaded}))a=this._flItems=this._getItemsFromLayers(this.featureLayers),this._adjustRowsCols(a);else{var b=this.featureLayers.length;f.forEach(this.featureLayers,function(a){if(a.loaded)b--;else var c=k.connect(a,"onLoad",this,function(){k.disconnect(c);c=null;b--;b||this.update()})},
this)}else a=this._itItems=this._getItemsFromItems(this.items),this._adjustRowsCols(a)},_processSelectionLayers:function(){var a,b,d,c,e,g,h,n={};f.forEach(this.featureLayers,function(e,h){e.mode===L.MODE_SELECTION&&e._map&&e.url&&e._params.drawMode&&!e.source&&(b=m.trim(e._url.path).replace(/\/(MapServer|FeatureServer).*/gi,"/MapServer").replace(/^https?:\/\//gi,"").toLowerCase(),d=n[b]=n[b]||{},c=d.featureLayers=d.featureLayers||{},g=d.indices=d.indices||[],c[h]=e,g.push(h),a=e._map)});a&&f.forEach(a.layerIds,
function(c){(c=a.getLayer(c))&&c.url&&(c.getImageUrl||c.getTileUrl)&&c.loaded&&10.1<=c.version&&(b=m.trim(c._url.path).replace(/(\/MapServer).*/gi,"$1"),e=b.replace(/^https?:\/\//gi,"").toLowerCase(),n[e]&&!n[e].mapServiceUrl&&(d=n[e],d.mapServiceUrl=b,d.mapServiceLayer=c,this._legendIndices=this._legendIndices.concat(d.indices),h=this._fetchLegend({pickerInstance:this,info:d},e),h.then?(this._loadingIndices=this._loadingIndices.concat(d.indices),this._loadingLegends.push(h)):this._processLegendResponse(h,
d)))},this)},_fetchLegend:function(a,b){var d=x.prototype,c=d.legendCache[b];return c?c.then&&c._contexts.push(a):(c=d.legendCache[b]=P({url:a.info.mapServiceUrl+"/legend",content:{f:"json"},callbackParamName:"callback"}),c._contexts=[a],c.addBoth(function(a){if(!c.canceled){d.legendCache[b]=a;var g=c._contexts;c._contexts=null;f.forEach(g,function(b){var d,g=b.pickerInstance;b=b.info;g._destroyed||(f.forEach(b.indices,function(a){d=f.indexOf(g._loadingIndices,a);-1<d&&g._loadingIndices.splice(d,
1)}),d=f.indexOf(g._loadingLegends,c),-1<d&&g._loadingLegends.splice(d,1),g._processLegendResponse(a,b))})}})),c},_clearLegendInfo:function(){clearTimeout(this._legendTimer);this._ignoreLegends();this._legendIndices=this._loadingIndices=this._legendSymbols=this._loadingLegends=this._legendTimer=null},_ignoreLegends:function(){this._loadingLegends&&f.forEach(this._loadingLegends,function(a){var b=-1;f.some(a._contexts,function(a,c){return a.pickerInstance===this&&(b=c),-1<b},this);-1<b&&a._contexts.splice(b,
1)},this)},_processLegendResponse:function(a,b){if(!a||a instanceof Error){var d;f.forEach(b.indices,function(a){d=f.indexOf(this._legendIndices,a);-1<d&&this._legendIndices.splice(d,1)},this)}else f.forEach(b.indices,function(c){var d,h,n,q,w,p=b.featureLayers[c].layerId,k=b.mapServiceUrl+"/"+p+"/images/",l=b.mapServiceLayer._getToken();this._legendSymbols[c]||(h=null,f.some(a.layers,function(a){return a.layerId==p&&(h=a),!!h}),h&&(n=this._legendSymbols[c]={},f.forEach(h.legend,function(a){if(q=
a.values,q&&q.length)for(d=0;d<q.length;d++)n[q[d]]=a;else n.defaultSymbol=a;(w=a.url)&&!a._fixed&&(a._fixed=1,-1===w.search(/https?\:/)&&(a.url=k+w),l&&-1!==a.url.search(/https?\:/)&&(a.url+=(-1<a.url.indexOf("?")?"\x26":"?")+"token\x3d"+l))})))},this);var c=this;c._started&&!c._legendTimer&&(c._legendTimer=setTimeout(function(){clearTimeout(c._legendTimer);c._legendTimer=null;c._destroyed||c.update()},0))},_applyGridPatches:function(){var a,b,d,c=this.grid,e=c.adaptWidth;if(c.adaptWidth=function(){a=
this.views.views;for(b=0;d=a[b];b++)u.set(d.headerNode,"display","block");e.apply(this,arguments);for(b=0;d=a[b];b++)u.set(d.headerNode,"display","none")},this._dojo14x){if("auto"!==this.rows&&"auto"!==this.columns)var g=k.connect(c,"_onFetchComplete",this,function(){k.disconnect(g);this.grid.set("autoHeight",this._rows)});k.connect(c,"_onDelete",this,this._destroyItems);k.connect(c,"_clearData",this,this._destroyItems);k.connect(c,"destroy",this,this._destroyItems);(c=c.focus)&&c.findAndFocusGridCell&&
(c.findAndFocusGridCell=function(){return!1})}},_setGridLayout:function(){var a,b=function(a){return function(b,c){return this._cellGet(a,b,c)}},d=m.hitch(this,this._cellFormatter),c=[],e=this._columns;for(a=0;e>a;a++)c.push({field:"cell"+a,get:m.hitch(this,b(a)),formatter:d});a={cells:[c]};this.grouping&&(e={field:"groupName",colSpan:e,get:m.hitch(this,this._cellGetGroup),formatter:m.hitch(this,this._cellGroupFormatter)},a.cells.push([e]));e=this.grid;b=K.prototype.rowsPerPage;e.set("rowsPerPage",
this._rows>b?this._rows:b);e.set("structure",a)},_setGridData:function(){var a=[];if(this.grouping){this._groupRowIndices=[];var b,d,c=this._columns;f.forEach(this._flItems,function(e,h){a.push({});var f=0===h?0:b+d+1;this._groupRowIndices.push(f);b=f;d=Math.ceil(e.length/c);a=a.concat(this._getStoreItems(e))},this)}else this.featureLayers?(f.forEach(this._flItems,function(b){a=a.concat(b)}),a=this._getStoreItems(a)):a=this._getStoreItems(this._itItems);var e=new J({data:{items:a}});this.grid.setStore(e)},
_toggleTooltip:function(){if(this.showTooltip){if(!this.tooltip){this.tooltip=C.create("div",{"class":"tooltip"},this.domNode);this.tooltip.style.display="none";this.tooltip.style.position="fixed";var a=this.grid;this._mouseOverConnect=k.connect(a,"onCellMouseOver",this,this._cellMouseOver);this._mouseOutConnect=k.connect(a,"onCellMouseOut",this,this._cellMouseOut)}}else this.tooltip&&(k.disconnect(this._mouseOverConnect),k.disconnect(this._mouseOutConnect),C.destroy(this.tooltip),this.tooltip=null)},
_rowClicked:function(a,b){var d=a.cellNode,c=a.rowIndex,e=a.cellIndex,g=this._getCellInfo(d,c,e);if(g){var h=this.grid.store;h.getValue(g,"loadingCell")||(this._selectedCell&&B.remove(this._selectedCell,"selectedItem"),d!==this._selectedCell?(B.add(d,"selectedItem"),this._selectedCell=d,this._selectedItem={featureLayer:h.getValue(g,"layer"),type:h.getValue(g,"type"),template:h.getValue(g,"template"),symbolInfo:h.getValue(g,"symbolInfo"),item:this._getItem(g)},this._selectedInfo={selRow:c,selCol:e,
index1:h.getValue(g,"index1"),index2:h.getValue(g,"index2"),index:h.getValue(g,"index")}):this._selectedCell=this._selectedInfo=this._selectedItem=null,b||this.onSelectionChange())}},_locate:function(a,b,d){var c,e=this.grid.store,g=Array(this._columns),h=b.index1,n=b.index2,q=b.index,k=a.item;return f.some(d,function(a,b){return f.some(g,function(d,g){var f=e.getValue(a,"cell"+g);return f&&(k?q===e.getValue(f,"index"):h===e.getValue(f,"index1")&&n===e.getValue(f,"index2"))?(c=[b,g],!0):!1})}),c},
_getCellInfo:function(a,b,d){if(a)return a=this.grid,b=a.getItem(b),a.store.getValue(b,"cell"+d)},_getItem:function(a){var b=this.items;return b?b[this.grid.store.getValue(a,"index")]:void 0},_cellMouseOver:function(a){var b=this.tooltip,d=a.cellNode,c=this._getCellInfo(d,a.rowIndex,a.cellIndex);if(b&&c){var e=this.grid.store;a=e.getValue(c,"template");var g=e.getValue(c,"type"),f=e.getValue(c,"symbolInfo"),e=e.getValue(c,"layer");a=(c=this._getItem(c))&&c.label+(c.description?": "+c.description:
"")||a&&a.name+(a.description?": "+a.description:"")||g&&g.name||f&&f.label+(f.description?": "+f.description:"")||(e&&e.name+": ")+"Default";b.style.display="none";b.innerHTML=a;d=y.coords(d.firstChild);u.set(b,{left:d.x+"px",top:d.y+d.h+5+"px"});b.style.display=""}},_cellMouseOut:function(){var a=this.tooltip;a&&(a.style.display="none")},_destroyItems:function(){var a,b=this._itemWidgets;for(a in b)b[a]&&(b[a].destroy(),delete b[a])},_repaintItems:function(){var a,b=this._itemWidgets;for(a in b){var d=
b[a];d&&d._repaint(d._surface)}},_getStoreItems:function(a){var b=this._uniqueId;a=f.map(a,function(a){return m.mixin({surfaceId:"tpick-surface-"+b.id++},a)});for(var d,c=a.length,e=0,g={},h=0,n=[],q=!0,k=this._columns;c>e;)q=!0,d="cell"+h,g[d]=a[e],e++,h++,0===h%k&&(q=!1,n.push(g),g={},h=0);return q&&c&&n.push(g),n},_getItemsFromLayers:function(a){var b=[];return f.forEach(a,function(a,c){b.push(this._getItemsFromLayer(a,c))},this),b},_getItemsFromLayer:function(a,b){var d=[];if(this.useLegend&&
-1<f.indexOf(this._loadingIndices,b))return[{label:this._nls&&this._nls.loading||"",symbol:null,layer:a,type:null,template:null,index1:b,index2:0,loadingCell:1}];var c=[],c=c.concat(a.templates);f.forEach(a.types,function(a){var b=a.templates;f.forEach(b,function(b){b._type_=a});c=c.concat(b)});var c=f.filter(c,v.isDefined),e=a.renderer;if(e){var g=e.declaredClass.replace("esri.renderer.","");if(0<c.length)f.forEach(c,function(c){var h=c.prototype;if(h){var k;if(k=e.valueExpression?this._createSimpleSymbol(a):
this._isUnclassedRenderer(e)?e.infos[0].symbol:e.getSymbol(h)){var p,m,l=null;if(this.useLegend&&-1<f.indexOf(this._legendIndices,b)){if(m=this._legendSymbols&&this._legendSymbols[b])switch(g){case "SimpleRenderer":l=m.defaultSymbol;break;case "UniqueValueRenderer":f.some(e.infos,function(a){return a.symbol===k&&(l=m[a.value]),!!l});break;case "ClassBreaksRenderer":f.some(e.infos,function(a){return a.symbol===k&&(l=m[a.maxValue]),!!l})}l&&(p=z.fromJson(z.toJson(E.defaultProps)),p.url=l.url,p.imageData=
l.imageData,p.contentType=l.contentType,p.width=l.width,p.height=l.height,v.isDefined(p.width)&&v.isDefined(p.height)||(p.width=15,p.height=15),l=new E(p))}d.push({label:this._trimLabel(c.name),symbol:l||k,legendOverride:!!l,layer:a,type:c._type_,template:c,index1:b,index2:d.length})}else switch(g){case "HeatmapRenderer":d.push({label:this._trimLabel(c.name),symbol:new D,legendOverride:!!l,layer:a,type:c._type_,template:c,index1:b,index2:d.length})}}delete c._type_},this);else{var h=[];switch("TemporalRenderer"===
g&&(e=e.observationRenderer,e&&(g=e.declaredClass.replace("esri.renderer.",""))),g){case "SimpleRenderer":h=[{symbol:e.symbol,label:e.label,description:e.description}];break;case "UniqueValueRenderer":case "ClassBreaksRenderer":h=e.infos}d=f.map(h,function(c,d){return{label:this._trimLabel(c.label),description:c.description,symbolInfo:m.mixin({constructor:function(){}},c),symbol:c.symbol,layer:a,index1:b,index2:d}},this)}}return d},_isUnclassedRenderer:function(a){return!!((a.hasVisualVariables("sizeInfo",
!1)||a.hasVisualVariables("colorInfo",!1)||a.hasVisualVariables("opacityInfo",!1))&&a.addBreak&&a.infos&&1===a.infos.length)},_createSimpleSymbol:function(a){var b;switch(a.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":b=new D;break;case "esriGeometryPolyline":b=new M;break;case "esriGeometryPolygon":b=new F;break;default:a.hasXYFootprint&&a.hasXYFootprint()&&(b=new F)}return b},_getItemsFromItems:function(a){return f.map(a,function(a,d){return a=m.mixin({index:d},a),a.label=
this._trimLabel(a.label),a},this)},_trimLabel:function(a){var b=this.maxLabelLength;return b&&a&&a.length>b&&(a=a.substr(0,b)+"..."),a||""},_cellGet:function(a,b,d){return d?this.grid.store.getValue(d,"cell"+a):""},_cellFormatter:function(a){if(a){var b=this._itemWidgets,d=this.grid.store,c=d.getValue(a,"surfaceId"),e=b[c];return e||(e=b[c]=new N({id:c,label:d.getValue(a,"label"),symbol:d.getValue(a,"symbol"),legendOverride:d.getValue(a,"legendOverride"),surfaceWidth:this.surfaceWidth,surfaceHeight:this.surfaceHeight,
template:d.getValue(a,"template")})),e||""}return""},_cellGetGroup:function(a,b){if(!this._groupRowIndices)return"";var d,c=f.indexOf(this._groupRowIndices,a);return b&&-1!==c?(d=this.featureLayers[c],d&&(this.groupLabelFunction?this.groupLabelFunction(d):d.name)||""):""},_cellGroupFormatter:function(a){return a?"\x3cdiv class\x3d'groupLabel'\x3e"+a+"\x3c/div\x3e":""}});return r("extend-esri")&&m.setObject("dijit.editing.TemplatePicker",x,O),x});